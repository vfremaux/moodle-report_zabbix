define(["jquery","core/notification","core/str","core/form-autocomplete","core/ajax","mod_assign/grading_form_change_checker"],function(d,a,o,t,i,n){function e(e){this._regionSelector=e,this._region=d(e),this._filters=[],this._users=[],this._filteredUsers=[],this._loadAllUsers(),this._region.find('[data-action="previous-user"]').on("click",this._handlePreviousUser.bind(this)),this._region.find('[data-action="next-user"]').on("click",this._handleNextUser.bind(this)),this._region.find('[data-action="change-user"]').on("change",this._handleChangeUser.bind(this)),this._region.find('[data-region="user-filters"]').on("click",this._toggleExpandFilters.bind(this)),d(document).on("user-changed",this._refreshSelector.bind(this)),d(document).on("done-saving-show-next",this._handleNextUser.bind(this)),e=this._region.find('[data-region="user-filters"]'),d(document.getElementById(e.attr("aria-controls"))).on("change",'[type="checkbox"]',this._filterChanged.bind(this)),(e=d('[data-region="grading-navigation-panel"]').data("first-userid"))&&this._selectUserById(e),o.get_string("changeuser","mod_assign").done(function(e){t.enhance("[data-action=change-user]",!1,"mod_assign/participant_selector",e)}).fail(a.exception),d(document).bind("start-loading-user",function(){this._isLoading=!0}.bind(this)),d(document).bind("finish-loading-user",function(){this._isLoading=!1}.bind(this))}return e.prototype._isLoading=!1,e.prototype._regionSelector=null,e.prototype._filters=null,e.prototype._users=null,e.prototype._region=null,e.prototype._loadAllUsers=function(){var e=this._region.find("[data-action=change-user]"),t=e.attr("data-assignmentid"),e=e.attr("data-groupid");i.call([{methodname:"mod_assign_list_participants",args:{assignid:t,groupid:e,filter:"",onlyids:!0},done:this._usersLoaded.bind(this),fail:a.exception}])},e.prototype._usersLoaded=function(e){this._filteredUsers=this._users=e,this._users.length?(e=this._region.find('[data-region="user-filters"]'),d(document.getElementById(e.attr("aria-controls"))).find('[type="checkbox"]').trigger("change")):this._selectNoUser(),this._triggerNextUserEvent()},e.prototype._checkClickOutsideConfigureFilters=function(e){var t=this._region.find('[data-region="configure-filters"]');t.is(e.target)||0!==t.has(e.target).length||(e=this._region.find('[data-region="user-filters"]'),t.hide(),t.attr("aria-hidden","true"),e.attr("aria-expanded","false"),d(document).unbind("click.mod_assign_grading_navigation"))},e.prototype._filterChanged=function(e){var t=d(e.target).attr("name").split("_").pop(),i=(d(e.target).prop("checked")?-1==this._filters.indexOf(t)&&(this._filters[this._filters.length]=t):-1!=(e=this._filters.indexOf(t))&&this._filters.splice(e,1),[]);this._region.find('[data-region="configure-filters"]').find('[type="checkbox"]').each(function(e,t){d(t).prop("checked")&&(i[i.length]=d(t).closest("label").text())}),i.length?this._region.find('[data-region="user-filters"] span').text(i.join(", ")):o.get_string("nofilters","mod_assign").done(function(e){this._region.find('[data-region="user-filters"] span').text(e)}.bind(this)).fail(a.exception);var s=this._region.find("[data-action=change-user]").attr("data-selected"),r=0;this._filteredUsers=[],d.each(this._users,function(e,i){var n=!0;d.each(this._filters,function(e,t){"submitted"==t?"0"==i.submitted&&(n=!1):"notsubmitted"==t?"1"==i.submitted&&(n=!1):"requiregrading"==t?"0"==i.requiregrading&&(n=!1):"grantedextension"==t&&"0"==i.grantedextension&&(n=!1)}),n&&(this._filteredUsers[this._filteredUsers.length]=i,s==i.id&&(r=this._filteredUsers.length-1))}.bind(this)),this._filteredUsers.length?this._selectUserById(this._filteredUsers[r].id):this._selectNoUser(),this._triggerNextUserEvent()},e.prototype._selectNoUser=function(){this._isLoading||(n.checkFormForChanges('[data-region="grade-panel"] .gradeform')?o.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(e){a.confirm(e[0],e[1],e[2],e[3],function(){d(document).trigger("save-changes",-1)})}):d(document).trigger("user-changed",-1))},e.prototype._selectUserById=function(e){var t=this._region.find("[data-action=change-user]"),i=parseInt(e,10);this._isLoading||(n.checkFormForChanges('[data-region="grade-panel"] .gradeform')?o.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(e){a.confirm(e[0],e[1],e[2],e[3],function(){d(document).trigger("save-changes",i)})}):(t.attr("data-selected",e),!isNaN(i)&&0<i&&d(document).trigger("user-changed",e)))},e.prototype._toggleExpandFilters=function(e){e.preventDefault();var t=d(e.target).closest('[data-region="user-filters"]'),i="true"==t.attr("aria-expanded"),n=d(document.getElementById(t.attr("aria-controls")));i?(n.hide(),n.attr("aria-hidden","true"),t.attr("aria-expanded","false"),d(document).unbind("click.mod_assign_grading_navigation")):(n.css("display","inline-block"),n.attr("aria-hidden","false"),t.attr("aria-expanded","true"),e.stopPropagation(),d(document).on("click.mod_assign_grading_navigation",this._checkClickOutsideConfigureFilters.bind(this)))},e.prototype._handlePreviousUser=function(e){e.preventDefault();for(var t=this._region.find("[data-action=change-user]").attr("data-selected"),i=0,n=0,i=0;i<this._filteredUsers.length;i++)if(this._filteredUsers[i].id==t){n=i;break}var e=this._filteredUsers.length,s=n-1;s<0&&(s=e-1),e&&this._selectUserById(this._filteredUsers[s].id)},e.prototype._handleNextUser=function(e,t){e.preventDefault();for(var e=this._region.find("[data-action=change-user]"),i=e.attr("data-selected"),n=0,s=0,n=0;n<this._filteredUsers.length;n++)if(this._filteredUsers[n].id==i){s=n;break}var r,a=this._filteredUsers.length,o=(s+1)%a;t&&a?(t=this._filteredUsers[o].id,r=parseInt(t,10),e.attr("data-selected",t),!isNaN(r)&&0<r&&d(document).trigger("user-changed",t)):a&&this._selectUserById(this._filteredUsers[o].id)},e.prototype._refreshCount=function(){var e=this._region.find("[data-action=change-user]").attr("data-selected"),t=0,i=0;if(isNaN(e)||e<=0)this._region.find('[data-region="user-count"]').hide();else{for(this._region.find('[data-region="user-count"]').show(),t=0;t<this._filteredUsers.length;t++)if(this._filteredUsers[t].id==e){i=t;break}var n=this._filteredUsers.length;n&&(i+=1),o.get_string("xofy","mod_assign",{x:i,y:n}).done(function(e){this._region.find('[data-region="user-count-summary"]').text(e)}.bind(this)).fail(a.exception)}},e.prototype._refreshSelector=function(e,t){var i=this._region.find("[data-action=change-user]");t=parseInt(t,10),!isNaN(t)&&0<t&&i.attr("data-selected",t),this._refreshCount()},e.prototype._triggerNextUserEvent=function(){1<this._filteredUsers.length?d(document).trigger("next-user",{nextUserId:null,nextUser:!0}):d(document).trigger("next-user",{nextUser:!1})},e.prototype._handleChangeUser=function(){var e=this._region.find("[data-action=change-user]"),t=parseInt(e.val(),10);this._isLoading||(n.checkFormForChanges('[data-region="grade-panel"] .gradeform')?o.get_strings([{key:"unsavedchanges",component:"mod_assign"},{key:"unsavedchangesquestion",component:"mod_assign"},{key:"saveandcontinue",component:"mod_assign"},{key:"cancel",component:"core"}]).done(function(e){a.confirm(e[0],e[1],e[2],e[3],function(){d(document).trigger("save-changes",t)})}):!isNaN(t)&&0<t&&(e.attr("data-selected",t),d(document).trigger("user-changed",t)))},e});