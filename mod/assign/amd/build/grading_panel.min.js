define(["jquery","core/yui","core/notification","core/templates","core/fragment","core/ajax","core/str","mod_assign/grading_form_change_checker","mod_assign/grading_events"],function(r,i,a,d,l,s,c,g,t){function e(e){this._regionSelector=e,this._region=r(e),this._userCache=[],this.registerEventListeners()}return e.prototype._regionSelector=null,e.prototype._lastUserId=0,e.prototype._lastAttemptNumber=-1,e.prototype._region=null,e.prototype.nextUserId=null,e.prototype.nextUser=!1,e.prototype._niceReplaceNodeContents=function(e,t,n){var o=r.Deferred();return e.fadeOut("fast",function(){d.replaceNodeContents(e,t,n),e.fadeIn("fast",function(){o.resolve()})}),o.promise()},e.prototype._saveFormState=function(){void 0!==window.tinyMCE&&window.tinyMCE.triggerSave();var e=r('[data-region="grading-actions-form"] [name="sendstudentnotifications"]').prop("checked");r('.gradeform [name="sendstudentnotifications"]').val(e)},e.prototype._submitForm=function(e,t,n){var o=r(this._region.find("form.gradeform")),o=(r('[data-region="overlay"]').show(),o.trigger("save-form-state"),o.serialize()),i=this._region.attr("data-assignmentid");s.call([{methodname:"mod_assign_submit_grading_form",args:{assignmentid:i,userid:this._lastUserId,jsonformdata:JSON.stringify(o)},done:this._handleFormSubmissionResponse.bind(this,o,t,n),fail:a.exception}])},e.prototype._handleFormSubmissionResponse=function(e,t,n,o){void 0===t&&(t=this._lastUserId),o.length?r(document).trigger("reset",[this._lastUserId,e]):(c.get_strings([{key:"changessaved",component:"core"},{key:"gradechangessaveddetail",component:"mod_assign"}]).done(function(e){a.alert(e[0],e[1])}).fail(a.exception),i.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()}),t==this._lastUserId?r(document).trigger("reset",t):n?r(document).trigger("done-saving-show-next",!0):r(document).trigger("user-changed",t)),r('[data-region="overlay"]').hide()},e.prototype._resetForm=function(e,t,n){var o=r.Event("custom");void 0===t&&(t=this._lastUserId),this._lastUserId=0,this._refreshGradingPanel(o,t,n)},e.prototype._chooseAttempt=function(e){var e=r(e.target).data("submissions"),t=r(document.getElementById(e)).clone().wrap(r("<form/>")).html();c.get_strings([{key:"viewadifferentattempt",component:"mod_assign"},{key:"view",component:"core"},{key:"cancel",component:"core"}]).done(function(e){a.confirm(e[0],t,e[1],e[2],function(){var e=r("input:radio[name='select-attemptnumber']:checked").val();this._refreshGradingPanel(null,this._lastUserId,"",e)}.bind(this))}.bind(this)).fail(a.exception)},e.prototype._addPopoutButtons=function(e){var t=r(e);d.render("mod_assign/popout_button",{}).done(function(e){t.find('[data-fieldtype="filemanager"],[data-fieldtype="editor"],[data-fieldtype="grading"]').closest(".fitem").addClass("has-popout").find("label").parent().append(e),t.on("click",'[data-region="popout-button"]',this._togglePopout.bind(this))}.bind(this)).fail(a.exception)},e.prototype._togglePopout=function(e){e.preventDefault();e=r(e.target).closest(".fitem");e.hasClass("popout")?r(".popout").removeClass("popout"):(r(".popout").removeClass("popout"),e.addClass("popout"),e.addClass("moodle-has-zindex"))},e.prototype._refreshGradingPanel=function(e,n,o,i){var s=this._region.attr("data-contextid");void 0===o&&(o=""),void 0===i&&(i=-1),this._lastUserId==n&&this._lastAttemptNumber==i&&""===o||(this._lastUserId=n,this._lastAttemptNumber=i,r(document).trigger("start-loading-user"),window.M.util.js_pending("mod-assign-loading-user"),d.render("mod_assign/loading",{}).done(function(e,t){this._niceReplaceNodeContents(this._region,e,t).done(function(){var e;0<n?(this._region.show(),e={userid:n,attemptnumber:i,jsonformdata:JSON.stringify(o)},l.loadFragment("mod_assign","gradingpanel",s,e).done(function(e,t){this._niceReplaceNodeContents(this._region,e,t).done(function(){g.saveFormState('[data-region="grade-panel"] .gradeform'),r(document).on("editor-content-restored",function(){g.saveFormState('[data-region="grade-panel"] .gradeform')}),r('[data-region="attempt-chooser"]').on("click",this._chooseAttempt.bind(this)),this._addPopoutButtons('[data-region="grade-panel"] .gradeform'),r(document).trigger("finish-loading-user"),window.M.util.js_complete("mod-assign-loading-user")}.bind(this)).fail(a.exception)}.bind(this)).fail(a.exception),r('[data-region="review-panel"]').show()):(this._region.hide(),r('[data-region="review-panel"]').hide(),r(document).trigger("finish-loading-user"),window.M.util.js_complete("mod-assign-loading-user"))}.bind(this))}.bind(this)).fail(a.exception))},e.prototype._getNextUser=function(e,t){this.nextUserId=t.nextUserId,this.nextUser=t.nextUser},e.prototype._handleSaveAndShowNext=function(){this._submitForm(null,this.nextUserId,this.nextUser)},e.prototype.getPanelElement=function(){return r('[data-region="grade-panel"]')},e.prototype.collapsePanel=function(){this.getPanelElement().addClass("collapsed")},e.prototype.expandPanel=function(){this.getPanelElement().removeClass("collapsed")},e.prototype.registerEventListeners=function(){var e=r(document);r(this._region).on("submit","form",function(e){e.preventDefault()}),e.on("next-user",this._getNextUser.bind(this)),e.on("user-changed",this._refreshGradingPanel.bind(this)),e.on("save-changes",this._submitForm.bind(this)),e.on("save-and-show-next",this._handleSaveAndShowNext.bind(this)),e.on("reset",this._resetForm.bind(this)),e.on("save-form-state",this._saveFormState.bind(this)),e.on(t.COLLAPSE_GRADE_PANEL,function(){this.collapsePanel()}.bind(this)),e.on(t.COLLAPSE_REVIEW_PANEL,function(){this.expandPanel()}.bind(this)),e.on(t.EXPAND_GRADE_PANEL,function(){this.expandPanel()}.bind(this))},e});