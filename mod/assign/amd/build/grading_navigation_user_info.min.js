define(["jquery","core/notification","core/ajax","core/templates"],function(r,o,a,d){function e(e){this._regionSelector=e,this._region=r(e),this._userCache={},r(document).on("user-changed",this._refreshUserInfo.bind(this))}return e.prototype._regionSelector=null,e.prototype._userCache=null,e.prototype._region=null,e.prototype._lastUserId=0,e.prototype._getAssignmentId=function(){return this._region.attr("data-assignmentid")},e.prototype._refreshUserInfo=function(e,t){var s=r.Deferred();this._region.attr("data-userid",t),this._lastUserId!=t&&(this._lastUserId=t,d.render("mod_assign/loading",{}).done(function(e,i){var n;this._region.fadeOut("fast",function(){d.replaceNodeContents(this._region,e,i),this._region.fadeIn("fast")}.bind(this)),t<0?d.render("mod_assign/grading_navigation_no_users",{}).done(function(e,i){this._region.fadeOut("fast",function(){d.replaceNodeContents(this._region,e,i),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(o.exception):(void 0!==this._userCache[t]?s.resolve(this._userCache[t]):(n=this._getAssignmentId(),a.call([{methodname:"mod_assign_get_participant",args:{userid:t,assignid:n,embeduser:!0}}])[0].done(function(e){e.hasOwnProperty("id")?(this._userCache[t]=e,s.resolve(this._userCache[t])):s.reject("No users")}.bind(this)).fail(o.exception)),s.done(function(n){var e=r("[data-showuseridentity]").data("showuseridentity").split(","),t=[];n.courseid=r('[data-region="grading-navigation-panel"]').attr("data-courseid"),n.user&&(r.each(e,function(e,i){void 0!==n.user[i]&&""!==n.user[i]&&(n.hasidentity=!0,t.push(n.user[i]))}),n.identity=t.join(", "),n.user.profileimageurl&&(n.profileimageurl=n.user.profileimageurl)),d.render("mod_assign/grading_navigation_user_summary",n).done(function(e,i){this._region.fadeOut("fast",function(){d.replaceNodeContents(this._region,e,i),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(o.exception)}.bind(this)).fail(function(){d.render("mod_assign/grading_navigation_no_users",{}).done(function(e,i){this._region.fadeOut("fast",function(){d.replaceNodeContents(this._region,e,i),this._region.fadeIn("fast")}.bind(this))}.bind(this)).fail(o.exception)}.bind(this)))}.bind(this)).fail(o.exception))},e});