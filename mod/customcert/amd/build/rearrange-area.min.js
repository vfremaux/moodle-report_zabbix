define(["jquery","core/yui","core/fragment","mod_customcert/dialogue","core/notification","core/str","core/templates","core/ajax"],function(a,d,t,o,n,r,i,s){function _(e){this._node=a(e),this._setEvents()}return _.prototype.CUSTOMCERT_REF_POINT_TOPLEFT=0,_.prototype.CUSTOMCERT_REF_POINT_TOPCENTER=1,_.prototype.CUSTOMCERT_REF_POINT_TOPRIGHT=2,_.prototype.PIXELSINMM=3.779527559055,_.prototype._setEvents=function(){this._node.on("click",".element",this._editElement.bind(this))},_.prototype._editElement=function(e){var i=e.currentTarget.id.substr(8),e=this._node.attr("data-contextid");t.loadFragment("mod_customcert","editelement",e,{elementid:i}).done(function(t,n){r.get_string("editelement","mod_customcert").done(function(e){d.use("moodle-core-formchangechecker",function(){new o(e,"<div id='elementcontent'></div>",this._editElementDialogueConfig.bind(this,i,t,n),void 0,!0)}.bind(this))}.bind(this))}.bind(this)).fail(n.exception)},_.prototype._editElementDialogueConfig=function(o,e,t,r){i.replaceNode("#elementcontent",e,t),this._setPositionInForm(o);e=a(r.getContent());e.on("click","#id_submitbutton",function(e){M.core_formchangechecker.reset_form_dirty_state(),this._saveElement(o).then(function(){this._getElementHTML(o).done(function(e){var t=this._node.find("#element-"+o),n=parseInt(a("#id_refpoint").val()),i="",e=(n==this.CUSTOMCERT_REF_POINT_TOPLEFT?i="refpoint-left":n==this.CUSTOMCERT_REF_POINT_TOPCENTER?i="refpoint-center":n==this.CUSTOMCERT_REF_POINT_TOPRIGHT&&(i="refpoint-right"),t.empty().append(e),t.removeClass(),t.addClass("element "+i),t.attr("data-refpoint",n),a("#editelementform #id_posx").val()),i=a("#editelementform #id_posy").val();this._setPosition(o,n,e,i),r.close()}.bind(this))}.bind(this)).fail(n.exception),e.preventDefault()}.bind(this)),e.on("click","#id_cancel",function(e){r.close(),e.preventDefault()})},_.prototype._setPosition=function(e,t,n,i){var e=d.one("#element-"+e),o=(n=d.one("#pdf").getX()+n*this.PIXELSINMM,i=d.one("#pdf").getY()+i*this.PIXELSINMM,parseFloat(e.getComputedStyle("width"))),r=e.width*this.PIXELSINMM;switch(r&&r<o&&(o=r),t){case this.CUSTOMCERT_REF_POINT_TOPCENTER:n-=o/2;break;case this.CUSTOMCERT_REF_POINT_TOPRIGHT:n=n-o+2}e.setX(n),e.setY(i)},_.prototype._setPositionInForm=function(e){var t=a("#editelementform #id_posx"),n=a("#editelementform #id_posy");if(t.length&&n.length){var e=d.one("#element-"+e),i=e.getX()-d.one("#pdf").getX(),o=e.getY()-d.one("#pdf").getY(),r=parseInt(e.getData("refpoint")),s=parseFloat(e.getComputedStyle("width"));switch(r){case this.CUSTOMCERT_REF_POINT_TOPCENTER:i+=s/2;break;case this.CUSTOMCERT_REF_POINT_TOPRIGHT:i+=s}i=Math.round(parseFloat(i/this.PIXELSINMM)),o=Math.round(parseFloat(o/this.PIXELSINMM)),t.val(i),n.val(o)}},_.prototype._getElementHTML=function(e){var t=this._node.attr("data-templateid");return s.call([{methodname:"mod_customcert_get_element_html",args:{templateid:t,elementid:e}}])[0]},_.prototype._saveElement=function(e){var t=this._node.attr("data-templateid"),n=a("#editelementform").serializeArray();return s.call([{methodname:"mod_customcert_save_element",args:{templateid:t,elementid:e,values:n}}])[0]},{init:function(e){new _(e)}}});