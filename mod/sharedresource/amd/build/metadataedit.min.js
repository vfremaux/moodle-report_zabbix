define(["jquery","core/str","core/log","core/config","mod_sharedresource/metadata"],function(c,t,l,o,m){var a,u,b={bind_tabs:function(){l.debug("AMD Mod sharedresource metadata edition binding tab events"),c(".mtd-tab").bind("click",this.switch_tab),c(".mtd-tab a").bind("click",function(e){e.preventDefault()})},bind_all:function(){l.debug("AMD Mod sharedresource metadata edition binding all events"),c(".mtd-form-input").off("change"),c(".taxonomy-source").off("change"),c(".mtd-form-addbutton").off("click"),c(".mtd-form-element select").off("change"),c(".mtd-form-element textarea").off("keyup"),c('.mtd-form-element input[type="text"]').off("keyup"),c(".mtd-tab").off("click"),c(".mtd-tab a").off("click"),c('.mtd-form-element input[type="text"]').bind("keyup",this.check_empty),c(".mtd-form-element select").bind("change",this.check_empty),c(".mtd-form-element textarea").bind("keyup",this.check_empty),c(".mtd-form-addbutton").bind("click",this.add_node);var e="."+a+"-system-read";c(e=e+(",."+a+"-indexer-read")+(",."+a+"-author-read")).off("change"),c(e).bind("change",this.enable_search_widget_checkbox),c(".taxonomy-source").bind("change",this.reload_taxonomy),c("#id-mtd-form").on("change",".taxonomy-source",null,this.reload_taxonomy)},trigger_all:function(){l.debug("AMD Mod sharedresource metadata edition triggering changes"),c('.mtd-form-element input[type="text"]').trigger("keyup"),c(".mtd-form-element textarea").trigger("keyup")},init:function(e){a=e;t.get_strings([{key:"fillprevious",component:"sharedresource"},{key:"fillcategory",component:"sharedresource"}]).done(function(e){u=e}),l.debug("AMD Mod sharedresource BIND ALL CALL"),b.bind_all(),b.bind_tabs(),b.trigger_all(),c(".mtd-form-addbutton").each(b.check_button_status),l.debug("AMD Mod sharedresource metadata edition form initialized"),c(".mtd-tab").removeClass("here"),c(".mtd-tab").removeClass("current"),c("#id-menu-1").addClass("here"),c("#id-menu-1").addClass("current"),c(".mtd-content").removeClass("active"),c(".mtd-content").removeClass("on"),c(".mtd-content").addClass("off"),c("#id-tab-1").addClass("active"),c("#id-tab-1").removeClass("off"),c("#id-tab-1").addClass("on"),l.debug("AMD Mod sharedresource metadata default switch to tab General")},check_button_status:function(){for(var e=c(this),t=(l.debug("Check add button "+e.attr("id")),e.attr("id").replace("id-add-","")),a=e.attr("data").split(";"),d=!1,r="",n=a.shift();void 0!==n;){if(r=c("#"+n),l.debug("   Check button dep "+r.attr("id")),r.parent(".mtd-form-element").hasClass("is-empty")){d=!0;break}n=a.shift()}d?e.prop("disabled",!0):e.prop("disabled",!1),b.activate_up_chain(t)},switch_tab:function(e){e.stopPropagation();var e=c(this),t=(e=e.attr("id")?e:e.parent()).attr("id"),e="id-tab-"+e.attr("id").match(/id-menu-([^-]+)$/)[1];c(".mtd-tab").removeClass("here"),c(".mtd-tab").removeClass("current"),c("#"+t).addClass("here"),c("#"+t).addClass("current"),c(".mtd-content").removeClass("active"),c(".mtd-content").removeClass("on"),c(".mtd-content").addClass("off"),c("#"+e).addClass("active"),c("#"+e).removeClass("off"),c("#"+e).addClass("on")},add_node:function(e){e.stopPropagation();var e=c(this),t=e.attr("name").match(/btn-([^-]+)-([^-]+)/),a=t[1],t=t[2],d="",r=e.attr("data-occur");if(l.debug("found real occur as "+r),"category"!=t){switch(t){case"text":case"codetext":if(""===c("#"+a).val())return void window.alert(u[0]);break;case"select":if("basicvalue"===c("#"+a).val())return void window.alert(u[0]);break;case"date":if("- Year -"===c("#"+a+"_dateyear").val())return void window.alert(u[0]);break;case"duration":if(!(""!==c("#"+a+"_Day").val()&&"0"!==c("#"+a+"_Day").val()||""!==c("#"+a+"_Hou").val()&&"0"!==c("#"+a+"_Hou").val()||""!==c("#"+a+"_Min").val()&&"0"!==c("#"+a+"_Min").val()||""!==c("#"+a+"_Sec").val()&&"0"!==c("#"+a+"_Sec").val()))return void window.alert(u[0]);break;case"vcard":if(d=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===c("#"+a).val().replace(d,"").replace(/ /g,""))return void window.alert(u[0])}b.add_list_item(a,r)}else{for(var n,i=e.attr("data").split(" "),o=0,s=0;s<i.length;s++)n=i[s],""===c("#"+n).val()&&o++,"basicvalue"===c("#"+n).val()&&o++,"-year-"===c("#"+n+"_dateyear").val()&&o++,""!==c("#"+n+"_Day").val()&&"0"!==c("#"+n+"_Day").val()||""!==c("#"+n+"_Hou").val()&&"0"!==c("#"+n+"_Hou").val()||""!==c("#"+n+"_Min").val()&&"0"!==c("#"+n+"_Min").val()||""!==c("#"+n+"_Sec").val()&&"0"!==c("#"+n+"_Sec").val()||o++,"undefined"===c("#"+n).val()&&(d=new RegExp("(\r\n|\r|\n)","g"),"BEGIN:VCARDVERSION:FN:N:END:VCARD"===c("#"+n).val().replace(d,"").replace(/ /g,"")&&o++);o==i.length?window.alert(u[1]):(t=e.attr("data").split(" ").pop(),l.debug("Get source taxon in #"+m.parent_name(t)+"_1n0"),e=c("#"+m.parent_name(t)+"_1n0").val(),l.debug("Resulting taxonresourceid  = "+e),b.add_list_item(a,r,e))}},add_list_item:function(a,d,e){var r="id-add-"+a,n=c("#"+r).attr("data"),i=m.next_occurrence_name(a),t=(d++,l.debug("Next real occur is "+d),"elementname="+i),e=(e&&(t+="&taxonsourceid="+e),t+="&realoccur="+d,o.wwwroot+"/mod/sharedresource/ajax/getformelement.php?"+t);c.get(e,function(e){var t="#add-zone-"+a,t=(c(e.html).insertBefore(t),r=CSS.escape(r),"id-add-"+i),t=CSS.escape(t);c("#"+r).attr("name","btn-"+e.name),c("#"+r).attr("id",t),c("#"+t).prop("disabled",!0),c("#"+t).attr("data-occur",d),l.debug("Shifting button "+t+" real occur as "+d),c("#add-zone-"+a).attr("id","add-zone-"+i),c("#"+t).attr("data",n),b.bind_all(),b.bind_tabs()},"json")},activate_up_chain:function(e){var t=e;for(l.debug("Processing to elementkey "+e),t=m.parent_name(t);t;)l.debug("Escalading to parentkey "+t),l.debug("Detected "+c("#id-add-"+t).attr("name")),l.debug("Detected "+c("#id-add-"+t).prop("disabled")),c("#id-add-"+CSS.escape(t)).prop("disabled",!1),t=m.parent_name(t)},reload_taxonomy:function(e){e.stopPropagation();var a=c(this),e=o.wwwroot+"/mod/sharedresource/ajax/gettaxonomymenu.php?id="+a.val();c.get(e,function(e){var t=m.parent_name(a.attr("id"));c('[data-source="'+t+'"]').each(function(){c(this).html(e),c(this).val("")})},"html")},check_empty:function(){var e,t=c(this),a=(l.debug("Check "+t.attr("id")),t.attr("id").substring(0,1));t.val()?(t.parent(".mtd-form-element").removeClass("is-empty"),(e=c(".mtd-form-element.is-mandatory-"+a+".is-empty"))&&0!==e.length||c("#id-menu-"+a).removeClass("is-empty"),(e=c(".mtd-form-element.is-mandatory.is-empty"))&&0!==e.length||(c("#id-mtd-submit").attr("disabled",!1),c("#id-mtd-submit").removeClass("is-disabled"))):(t.parent(".mtd-form-element").addClass("is-empty"),t.hasClass("is-mandatory")&&(c("#id-mtd-submit").attr("disabled",!0),c("#id-mtd-submit").addClass("is-disabled"),c("#id-menu-"+a).addClass("is-empty"))),c('input[name^="btn-'+t.attr("id")+'-"]').each(b.check_button_status)}};return b});