define(["jquery","core/ajax","core/notification","core/templates","mod_lti/tool_type","mod_lti/events","mod_lti/keys","core/str"],function(r,e,c,o,l,E,s,C){function t(e){e.removeClass("announcement loading success fail capabilities")}function n(a){var n,e,t=a.find(u.DELETE_BUTTON),o=(t.click(function(e){var n,t,o;e.preventDefault(),n=a,t=r.Deferred(),o=m(n),D(n),""===o?r.Deferred().resolve():C.get_strings([{key:"delete",component:"mod_lti"},{key:"delete_confirmation",component:"mod_lti"},{key:"delete",component:"mod_lti"},{key:"cancel",component:"core"}]).done(function(e){c.confirm(e[0],e[1],e[2],e[3],function(){l.delete(o).done(function(){v(n),_(n).done(function(){n.remove()}).fail(c.exception).always(function(){t.resolve()})}).fail(function(e){N(n),t.reject(e)})},function(){v(n),t.resolve()})}).fail(function(e){v(n),c.exception(e),t.reject(e)})}),t.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=s.ENTER&&e.keyCode!=s.SPACE||(e.preventDefault(),t.click())}),d(a)),i=(o.focus(function(e){var n;e.preventDefault(),(e=d(e=a)).hasClass("loading")||(n=e.text().trim(),I(e,n))}),o.blur(function(e){e.preventDefault();var n,e=a,t=m(e);""===t||(n=d(e)).hasClass("loading")?r.Deferred().resolve():(e=n.text().trim(),k(n)!=e?(n.addClass("loading"),(t=l.update({id:t,description:e})).done(function(e){n.removeClass("loading"),n.text(e.description)}).fail(c.exception),t.fail(function(){n.removeClass("loading")})):r.Deferred().resolve())}),o.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode==s.ENTER&&(e.preventDefault(),o.blur())}),f(a));i.focus(function(e){var n;e.preventDefault(),(e=f(e=a)).hasClass("loading")||(n=e.text().trim(),I(e,n))}),i.blur(function(e){e.preventDefault();var n,e=a,t=m(e);""===t||(n=f(e)).hasClass("loading")?r.Deferred().resolve():(e=n.text().trim(),k(n)!=e?(n.addClass("loading"),(t=l.update({id:t,name:e})).done(function(e){n.removeClass("loading"),n.text(e.name)}),t.fail(function(){n.removeClass("loading")})):r.Deferred().resolve())}),i.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode==s.ENTER&&(e.preventDefault(),i.blur())}),p(a).length&&((n=p(a)).click(function(e){e.preventDefault(),(T(e=a)?g:A)(e)}),n.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=s.ENTER&&e.keyCode!=s.SPACE||(e.preventDefault(),n.click())})),T(a)&&((e=y(a)).on(E.CAPABILITIES_AGREE,function(){A(a)}),e.on(E.CAPABILITIES_DECLINE,function(){a.removeClass("announcement capabilities")}))}var u={DELETE_BUTTON:".delete",NAME_ELEMENT:".name",DESCRIPTION_ELEMENT:".description",CAPABILITIES_CONTAINER:".capabilities-container",ACTIVATE_BUTTON:".tool-card-footer a.activate"},f=function(e){return e.find(u.NAME_ELEMENT)},d=function(e){return e.find(u.DESCRIPTION_ELEMENT)},p=function(e){return e.find(u.ACTIVATE_BUTTON)},y=function(e){return e.find(u.CAPABILITIES_CONTAINER)},T=function(e){return!!y(e).length},m=function(e){return e.attr("data-type-id")},D=function(e){t(e),e.addClass("announcement loading")},v=function(e){e.removeClass("announcement loading")},_=function(e){var n=r.Deferred();return t(e),e.addClass("announcement success"),setTimeout(function(){e.removeClass("announcement success"),n.resolve()},2e3),n},N=function(e){var n=r.Deferred();return t(e),e.addClass("announcement fail"),setTimeout(function(){e.removeClass("announcement fail"),n.resolve()},2e3),n},I=function(e,n){e.attr("data-val-snapshot",n)},k=function(e){return e.attr("data-val-snapshot")},A=function(t){var e=m(t);if(""===e)return r.Deferred().resolve();D(t);e=l.update({id:e,state:l.constants.state.configured});return e.then(function(e){return v(t),_(t),e}).then(function(e){return o.render("mod_lti/tool_card",e)}).then(function(e){var n=e[0],e=e[1];o.replaceNode(t,n,e)}).catch(function(){v(t),N(t)}),e},g=function(e){e.addClass("announcement capabilities")};return{init:function(e){n(e)}}});