define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/keys","mod_lti/tool_type","mod_lti/tool_proxy","core/str"],function(r,c,i,T,o,_,u,E,O){function I(){N(),C(),a().removeClass("hidden"),d(a())}function A(){var t=r.Deferred(),o=n();G(o),r.when(u.query(),E.query({orphanedonly:!0})).done(function(n,e){T.render("mod_lti/tool_list",{tools:n,proxies:e}).done(function(n,e){o.empty(),o.append(n),T.runTemplateJS(e),t.resolve()}).fail(t.reject)}).fail(t.reject),t.fail(i.exception).always(function(){S(o)})}function l(){r(document).on(o.NEW_TOOL_TYPE,function(){A()}),r(document).on(o.START_EXTERNAL_REGISTRATION,function(){C(),m(),e().removeClass("hidden"),d(e()),r(R.TOOL_URL).val(""),n().addClass("hidden")}),r(document).on(o.STOP_EXTERNAL_REGISTRATION,function(){n().removeClass("hidden"),I()}),r(document).on(o.START_CARTRIDGE_REGISTRATION,function(n,e){e=e,N(),m(),t().removeClass("hidden"),t().find(R.CARTRIDGE_REGISTRATION_FORM).attr("data-cartridge-url",e),d(t())}),r(document).on(o.STOP_CARTRIDGE_REGISTRATION,function(){t().find(R.CARTRIDGE_REGISTRATION_FORM).removeAttr("data-cartridge-url"),I()}),r(document).on(o.REGISTRATION_FEEDBACK,function(n,e){var t;t=e.error?"error":"success",i.addNotification({message:e.message,type:t})}),r(R.ADD_TOOL_FORM).submit(function(n){n.preventDefault();var e,t=r.trim(f());""!==t?(e=s(),G(e),(n=u.isCartridge(t)).always(function(){S(e)}),n.done(function(n){n.iscartridge?(r(R.TOOL_URL).val(""),r(document).trigger(o.START_CARTRIDGE_REGISTRATION,t)):r(document).trigger(o.START_EXTERNAL_REGISTRATION,{url:t})}),n.fail(function(){O.get_string("errorbadurl","mod_lti").done(function(n){r(document).trigger(o.REGISTRATION_FEEDBACK,{message:n,error:!0})}).fail(i.exception)})):r.Deferred().resolve()})}var R={EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-container",EXTERNAL_REGISTRATION_PAGE_CONTAINER:"#external-registration-page-container",CARTRIDGE_REGISTRATION_CONTAINER:"#cartridge-registration-container",CARTRIDGE_REGISTRATION_FORM:"#cartridge-registration-form",ADD_TOOL_FORM:"#add-tool-form",TOOL_LIST_CONTAINER:"#tool-list-container",TOOL_CREATE_BUTTON:"#tool-create-button",REGISTRATION_CHOICE_CONTAINER:"#registration-choice-container",TOOL_URL:"#tool-url"},s=function(){return r(R.TOOL_CREATE_BUTTON)},n=function(){return r(R.TOOL_LIST_CONTAINER)},e=function(){return r(R.EXTERNAL_REGISTRATION_CONTAINER)},t=function(){return r(R.CARTRIDGE_REGISTRATION_CONTAINER)},a=function(){return r(R.REGISTRATION_CHOICE_CONTAINER)},f=function(){return r(R.TOOL_URL).val()},N=function(){e().addClass("hidden")},C=function(){t().addClass("hidden")},m=function(){a().addClass("hidden")},d=function(n){n.children().detach().appendTo(n)},G=function(n){n.addClass("loading")},S=function(n){n.removeClass("loading")};return{init:function(){l(),A()}}});