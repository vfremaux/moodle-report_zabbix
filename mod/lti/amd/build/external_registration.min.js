define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/tool_proxy","mod_lti/tool_type","mod_lti/keys","core/str"],function(i,n,a,c,l,E,r,o,s){function T(){return i(u.EXTERNAL_REGISTRATION_CONTAINER)}function e(){return i(u.TOOL_TYPE_CAPABILITIES_CONTAINER)}function _(){i(document).on(l.START_EXTERNAL_REGISTRATION,function(e,t){var n,o;t&&(t.url&&(n=t.url,o=i.Deferred(),n&&""!==n?E.create({regurl:n}).done(function(e){S(),o=w(e.id)}).fail(function(e){f();var t={message:e.message,error:!0};i(document).trigger(l.REGISTRATION_FEEDBACK,t),o.reject(e)}):o.resolve()),t.proxyid&&w(t.proxyid))});var e=t();e.click(function(e){e.preventDefault(),f()}),e.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=o.ENTER&&e.keyCode!=o.SPACE||(e.preventDefault(),f())}),window.triggerExternalRegistrationComplete=function(e){var t,n=i.Deferred(),o={message:"",error:!1};return"success"==e.status?(s.get_string("successfullycreatedtooltype","mod_lti").done(function(e){o.message=e}).fail(a.exception),n.done(function(){h(),i(document).trigger(l.REGISTRATION_FEEDBACK,o),i(document).trigger(l.NEW_TOOL_TYPE)}).fail(a.exception),x()&&(t=d(),r.getFromToolProxyId(t).done(function(e){var t,o,r;e&&e.length&&(t=e[0]).hascapabilitygroups?(o=t,r=i.Deferred(),c.render("mod_lti/tool_type_capabilities_agree",o).done(function(e,t){var n=I(),e=(y(),C(),c.replaceNodeContents(n,e,t),n.find(u.CAPABILITIES_AGREE_CONTAINER));e.on(l.CAPABILITIES_AGREE,function(){N(),D(o).always(function(){R(),n.empty(),r.resolve()})}),e.on(l.CAPABILITIES_DECLINE,function(){n.empty(),r.resolve()})}).fail(r.reject),r.done(function(){m()}).fail(a.exception),r.always(function(){n.resolve()})):n.resolve()}).fail(function(){n.resolve()}))):(o.message=e.error,o.error=!0,n.done(function(){f().always(function(){i(document).trigger(l.REGISTRATION_FEEDBACK,o)})}).fail(a.exception),n.resolve()),n}}var u={EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-page-container",EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER:"#external-registration-template-container",EXTERNAL_REGISTRATION_CANCEL_BUTTON:"#cancel-external-registration",TOOL_TYPE_CAPABILITIES_CONTAINER:"#tool-type-capabilities-container",TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER:"#tool-type-capabilities-template-container",CAPABILITIES_AGREE_CONTAINER:".capabilities-container"},t=function(){return i(u.EXTERNAL_REGISTRATION_CANCEL_BUTTON)},A=function(){return i(u.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER)},I=function(){return i(u.TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER)},N=function(){e().addClass("loading")},R=function(){e().removeClass("loading")},p=function(){t().addClass("loading")},g=function(){t().removeClass("loading")},m=function(){e().addClass("hidden")},C=function(){e().removeClass("hidden")},y=function(){T().addClass("hidden")},O=function(e){t().attr("data-tool-proxy-id",e)},d=function(){return t().attr("data-tool-proxy-id")},v=function(){t().removeAttr("data-tool-proxy-id")},L=function(){return!!d()},x=function(){return t().attr("data-tool-proxy-new")&&L()},S=function(){return t().attr("data-tool-proxy-new","new")},P=function(){return t().removeAttr("data-tool-proxy-new")},G=function(e){return n.call([{methodname:"mod_lti_get_tool_proxy_registration_request",args:{id:e}}])[0]},f=function(){p();var e,t=i.Deferred();return x()?(e=d(),E.delete(e).done(function(){t.resolve()}).fail(function(e){t.reject(e)})):t.resolve(),t.done(function(){h(),g()}).fail(function(e){a.exception(e),h(),g(),s.get_string("failedtodeletetoolproxy","mod_lti").done(function(e){e={message:e,error:!0};i(document).trigger(l.REGISTRATION_FEEDBACK,e)}).fail(a.exception)}),t},B=function(e){e=c.render("mod_lti/tool_proxy_registration_form",e);return e.done(function(e,t){var n=A();n.append(e),c.runTemplateJS(t),n.find("form").submit(),T().removeClass("hidden")}).fail(a.exception),e},D=function(e){return r.update({id:e.id,state:r.constants.state.configured})},w=function(e){var t=i.Deferred();return O(e),G(e).done(function(e){B(e).done(function(){t.resolve()}).fail(t.fail)}).fail(t.fail),t},h=function(){L()&&v(),P(!1),y(),A().empty(),i(document).trigger(l.STOP_EXTERNAL_REGISTRATION)};return{init:function(){_()}}});