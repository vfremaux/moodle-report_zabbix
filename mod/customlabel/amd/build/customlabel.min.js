define(["jquery","core/config","core/str","core/log"],function(b,f,e,v){var y={strs:[],context:[],init:function(t){y.context=t;e.get_strings([{key:"changetypeadvice",component:"customlabel"}]).done(function(t){y.strs=t}),b(".customctl").bind("click",this.togglecustom),b(".customctl-string").bind("click",this.togglecustomstring),b(".customlabel-constraint").bind("click",this.constraint_colorize),b("select.constrained").bind("change",this.applyconstraints),b("select.constrained").prop("disabled",null),b("#id_labelclass").bind("change",this.typechangesubmit),b("#id_level0").trigger("change"),b("#id_level1").trigger("change"),b("#id_level2").trigger("change"),v.debug("AMD Customlabels initialized")},rebindconstraints:function(){b("select.constrained").off("change"),b("select.constrained").bind("change",this.applyconstraints),v.debug("AMD Customlabels constraints rebound")},togglecustom:function(){var t=b(this),e=t.attr("id").replace("customctl-","custom-thumb-"),s=t.attr("id").replace("customctl-","custom-");b("#"+s).hasClass("hidden")?(b("#"+s).removeClass("hidden"),b("#"+e).removeClass("hidden"),t.attr("src",f.wwwroot+"/mod/customlabel/pix/plus.gif")):(b("#"+s).addClass("hidden"),b("#"+e).addClass("hidden"),t.attr("src",f.wwwroot+"/mod/customlabel/pix/minus.gif"))},togglecustomstring:function(){var t=b(this),e=t.attr("id").replace("customctl-","custom-"),s=t.attr("data-labels").split(",");b("#"+e).hasClass("hidden")?(b("#"+e).removeClass("hidden"),t.html(s[1])):(b("#"+e).addClass("hidden"),t.html(s[2]))},constraint_colorize:function(){1==b(this).val()?this.addclass("green"):this.addclass("red")},applyconstraints:function(){var t=b(this),c=t.attr("data-constraints"),d=t.attr("data-label-type"),u=t.attr("data-cmid"),e=(v.debug("Applying constraints on "+t.attr("id")),0);if(""!==c){function p(){o[e].push(b(this).val()),l[n[s]].push(b(this).val())}var s,n=c.split(","),i=[],h=(b("#"+t.attr("id")+" option").each(function(){b(this).prop("selected")&&i.push(b(this).val())}),i.join(",")),o=[],l=[],a=[];for(s in n){l[n[s]]=[];var r="level"+n[s];o[e]=r,a.push(b("#id_"+r).first()),o[++e]=[],b("#id_"+r+" option:selected").each(p),e++}b.each(a,function(t,e){e.prop("disabled",!0)});var m=encodeURIComponent(JSON.stringify(o)),g=f.wwwroot+"/mod/customlabel/ajax/applyconstraints.php?";g+="selector="+t.attr("name"),b.get((g+="&targets="+c)+("&type="+d)+("&cmid="+u)+("&constraints="+h)+("&selection="+m),"",function(t){var e,s,n,i=t,o=c.split(",");for(e in o)i[o[e]]&&(s='<input type="hidden" name="level'+o[e],s=(s+='" value="_qf__force_multiselect_submission">')+i[o[e]],b("#fitem_id_level"+o[e]+" .felement.fselect").html(s));for(n in y.rebindconstraints(),l){var a=l[n][0];0<a&&b("#id_level"+n+" option[value="+a+"]").attr("selected",!0)}b("select.constrained").prop("disabled",!1)},"json")}else v.debug("No targets ")},typechangesubmit:function(){var t,e=b(this);confirm(y.strs[0])&&(t=y.context.updatelabelid?(t=f.wwwroot+"/mod/customlabel/mod.php?",(t=(t=(t=(t+="update="+y.context.updatelabelid)+"&sesskey="+f.sesskey)+"&sr="+y.context.section)+"&returntomod="+y.context.returntomod)+"&type="+e.val()):(t=f.wwwroot+"/course/mod.php?",(t=(t=(t=(t+="id="+y.context.courseid)+"&section="+y.context.section)+"&sesskey="+f.sesskey)+"&add=customlabel&returntomod="+y.context.returntomod)+"&type="+e.val()),document.location.href=t)}};return y});