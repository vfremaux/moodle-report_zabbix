define(["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core/str","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_constants","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_router","core_message/message_drawer_routes"],function(D,y,n,O,N,M,t,b,S,B,V,P,p,r,w){function a(e,n){var t=(t=e.members.filter(function(e){return e.id!=n})).length?t[0]:null,r=e.name,s=e.imageurl,t=(e.type==X.PRIVATE&&(r=r||t?t.fullname:"",s=s||t?t.profileimageurl:""),p.addMembers(R,e.members)),t=p.setName(t,r);return t=p.setSubname(t,e.subname),t=p.setType(t,e.type),t=p.setImageUrl(t,s),t=p.setTotalMemberCount(t,e.membercount),t=p.setIsFavourite(t,e.isfavourite),p.addMessages(t,e.messages)}function u(n){var e=R.loggedInUserId;return b.markAllConversationMessagesAsRead(e,n).then(function(){var e=p.markMessagesAsRead(R,R.messages);return M.publish(S.CONVERSATION_READ,n),L(e)})}function F(n){return f(n).then(function(){var e=p.addPendingBlockUsersById(R,[n]);return L(e)})}function k(n){return f(n).then(function(){var e=p.addPendingUnblockUsersById(R,[n]);return L(e)})}function q(n){return f(n).then(function(){var e=p.addPendingRemoveContactsById(R,[n]);return L(e)})}function G(n){return f(n).then(function(){var e=p.addPendingAddContactsById(R,[n]);return L(e)})}function e(t){return function(e,n){R.loadingConfirmAction||t(H()).catch(function(e){var n=p.setLoadingConfirmAction(R,!1);L(n),N.exception(e)}),n.originalEvent.preventDefault()}}var x={},R=null,s=!1,i=0,Q=null,W=!0,c=!1,L=null,K=B.NEWEST_MESSAGES_FIRST,j=B.LOAD_MESSAGE_LIMIT,o=B.INITIAL_NEW_MESSAGE_POLL_TIMEOUT,U=B.SELECTORS,X=B.CONVERSATION_TYPES,H=function(){if(!R||R.type!=X.PRIVATE)return null;var n=R.loggedInUserId,e=Object.keys(R.members).filter(function(e){return n!=e});return e.length?e[0]:null},Y=function(){return i},z=function(e){i=e,x[R.id].messagesOffset=e},J=function(){return s},Z=function(e){s=e,x[R.id].loadedAllMessages=e},$=function(e){return e.find(U.MESSAGES_CONTAINER)},d=function(t){return{id:t.id,name:t.name,subname:t.subname,imageUrl:t.imageUrl,isFavourite:t.isFavourite,type:t.type,totalMemberCount:t.totalMemberCount,loggedInUserId:t.loggedInUserId,messages:t.messages.map(function(e){return D.extend({},e)}),members:Object.keys(t.members).reduce(function(e,n){return e[n]=D.extend({},t.members[n]),e[n].contactrequests=t.members[n].contactrequests.map(function(e){return D.extend({},e)}),e},{})}},ee=function(t,e){var n=t.id,r=p.setLoadingMembers(R,!0),r=p.setLoadingMessages(r,!0);return L(r).then(function(){return b.getMemberInfo(n,[e],!0,!0)}).then(function(e){if(e.length)return e[0];throw new Error("Unable to load other user profile")}).then(function(e){var n=p.addMembers(R,[e,t]),n=p.setLoadingMembers(n,!1);return n=p.setLoadingMessages(n,!1),n=p.setName(n,e.fullname),n=p.setType(n,1),n=p.setImageUrl(n,e.profileimageurl),n=p.setTotalMemberCount(n,2),L(n).then(function(){return e})}).catch(function(e){var n=p.setLoadingMembers(R,!1);L(n),N.exception(e)})},ne=function(e,t,n,r,s){var i=t.id,o=p.setLoadingMembers(R,!0),o=p.setLoadingMessages(o,!0);return L(o).then(function(){return b.getConversation(i,e,!0,!0,0,0,n+1,r,s)}).then(function(e){return e.messages.length>n?e.messages=e.messages.slice(1):Z(!0),z(r+n),e}).then(function(e){e.members.filter(function(e){return e.id==t.id}).length<1&&(e.members=e.members.concat([t]));var n=a(e,t.id),n=p.setLoadingMembers(n,!1);return n=p.setLoadingMessages(n,!1),L(n).then(function(){return e})}).then(function(){return u(e)}).catch(function(e){var n=p.setLoadingMembers(R,!1),n=p.setLoadingMessages(n,!1);L(n),N.exception(e)})},g=function(n,t,r,s){n.members.filter(function(e){return e.id==t.id}).length<1&&(n.members=n.members.concat([t]));var e=a(n,t.id),e=p.setLoadingMembers(e,!1),i=(e=p.setLoadingMessages(e,!0),n.messages.length);return L(e).then(function(){var e;return i<r?te(n.id,r,i,s,[]).then(function(e){return e.messages}):(e=p.setLoadingMessages(R,!1),L(e).then(function(){return n.messages}))}).then(function(e){return z(e.length),e}).then(function(){return u(n.id)}).catch(N.exception)},te=function(e,n,t,r,s,i){return b.getMessages(R.loggedInUserId,e,n&&n+1,t,r,i).then(function(e){return e.messages.length&&s.length&&(e.messages=e.messages.filter(function(e){return s.indexOf(parseInt(e.id,10))<0})),e}).then(function(e){return n&&(e.messages.length>n?e.messages=e.messages.slice(0,-1):Z(!0)),e}).then(function(e){var n=e.members.filter(function(e){return!(e.id in R.members)}),n=p.addMembers(R,n),n=p.addMessages(n,e.messages);return n=p.setLoadingMessages(n,!1),L(n).then(function(){return e})}).catch(function(e){var n=p.setLoadingMessages(R,!1);throw L(n),e})},l=function(i,o){return function(){var e=R.messages,n=e.length?e[e.length-1]:null;if(!n||W||c)return D.Deferred().resolve().promise();for(var t=[],r=e.length-1;0<=r;r--){var s=e[r];if(s.timeCreated!==n.timeCreated)break;t.push(s.id)}return te(i,0,0,o,t,n.timeCreated).then(function(e){var n;return e.messages.length?(Q.restart(),n=d(R),M.publish(S.CONVERSATION_NEW_LAST_MESSAGE,n),u(i)):e})}},f=function(e){var n=R.pendingDeleteMessageIds,t=p.removePendingAddContactsById(R,[e]),t=p.removePendingRemoveContactsById(t,[e]);return t=p.removePendingUnblockUsersById(t,[e]),t=p.removePendingBlockUsersById(t,[e]),t=p.removePendingDeleteMessagesById(t,n),t=p.setPendingDeleteConversation(t,!1),L(t)},re=function(e,n){var t,r,s,e=D(e.target).closest(U.FOOTER_CONTAINER).find(U.MESSAGE_TEXT_AREA).val().trim();""!==e&&(t=R.id,r=e,c=!0,e=p.setSendingMessage(R,!0),s=null,L(e).then(function(){var e;return t||R.type!=X.PRIVATE?b.sendMessageToConversation(t,r):(e=H(),b.sendMessageToUser(e,r).then(function(e){return s=parseInt(e.conversationid,10),e}))}).then(function(e){var e=p.addMessages(R,[e]),e=p.setSendingMessage(e,!1),n=d(e);return e.id||(e=p.setId(e,s),n.id=s,ae(s),M.publish(S.CONVERSATION_CREATED,n)),L(e).then(function(){c=!1,M.publish(S.CONVERSATION_NEW_LAST_MESSAGE,n)})}).catch(function(e){c=!1;var n=p.setSendingMessage(R,!1);L(n),N.exception(e)})),n.originalEvent.preventDefault()},se=[[U.ACTION_REQUEST_BLOCK,e(F)],[U.ACTION_REQUEST_UNBLOCK,e(k)],[U.ACTION_REQUEST_ADD_CONTACT,e(G)],[U.ACTION_REQUEST_REMOVE_CONTACT,e(q)],[U.ACTION_REQUEST_DELETE_CONVERSATION,e(function(e){return f(e).then(function(){var e=p.setPendingDeleteConversation(R,!0);return L(e)})})],[U.ACTION_CANCEL_EDIT_MODE,function(e,n){f(H()).then(function(){var e=p.removeSelectedMessagesById(R,R.selectedMessageIds);return L(e)}).catch(N.exception),n.originalEvent.preventDefault()}],[U.ACTION_VIEW_CONTACT,function(e,n){var t=H(),t=R.members[t];r.go(w.VIEW_CONTACT,t),n.originalEvent.preventDefault()}],[U.ACTION_VIEW_GROUP_INFO,function(e,n){r.go(w.VIEW_GROUP_INFO,{id:R.id,name:R.name,subname:R.subname,imageUrl:R.imageUrl,totalMemberCount:R.totalMemberCount},R.loggedInUserId),n.originalEvent.preventDefault()}],[U.ACTION_CONFIRM_FAVOURITE,function(e,n){var t,r;t=R.loggedInUserId,r=R.id,b.setFavouriteConversations(t,[r]).then(function(){var e=p.setIsFavourite(R,!0);return L(e)}).then(function(){return M.publish(S.CONVERSATION_SET_FAVOURITE,d(R))}).catch(N.exception),n.originalEvent.preventDefault()}],[U.ACTION_CONFIRM_UNFAVOURITE,function(e,n){var t,r;t=R.loggedInUserId,r=R.id,b.unsetFavouriteConversations(t,[r]).then(function(){var e=p.setIsFavourite(R,!1);return L(e)}).then(function(){return M.publish(S.CONVERSATION_UNSET_FAVOURITE,d(R))}).catch(N.exception),n.originalEvent.preventDefault()}]],ie=[[U.ACTION_CANCEL_CONFIRM,e(f)],[U.ACTION_CONFIRM_BLOCK,e(function(n){var e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.blockUser(R.loggedInUserId,n)}).then(function(e){e=p.addMembers(R,[e]),e=p.removePendingBlockUsersById(e,[n]);return e=p.setLoadingConfirmAction(e,!1),M.publish(S.CONTACT_BLOCKED,n),L(e)})})],[U.ACTION_CONFIRM_UNBLOCK,e(function(n){var e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.unblockUser(R.loggedInUserId,n)}).then(function(e){e=p.addMembers(R,[e]),e=p.removePendingUnblockUsersById(e,[n]);return e=p.setLoadingConfirmAction(e,!1),M.publish(S.CONTACT_UNBLOCKED,n),L(e)})})],[U.ACTION_CONFIRM_ADD_CONTACT,e(function(t){var e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.createContactRequest(R.loggedInUserId,t)}).then(function(e){if(!e.request)throw new Error(e.warnings[0].message);return e.request}).then(function(e){var n=p.removePendingAddContactsById(R,[t]),n=p.addContactRequests(n,[e]);return n=p.setLoadingConfirmAction(n,!1),L(n)})})],[U.ACTION_CONFIRM_REMOVE_CONTACT,e(function(n){var e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.deleteContacts(R.loggedInUserId,[n])}).then(function(e){e=p.addMembers(R,e),e=p.removePendingRemoveContactsById(e,[n]);return e=p.setLoadingConfirmAction(e,!1),M.publish(S.CONTACT_REMOVED,n),L(e)})})],[U.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,e(function(){var r=R.pendingDeleteMessageIds,e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.deleteMessages(R.loggedInUserId,r)}).then(function(){var e=p.removeMessagesById(R,r),e=p.removePendingDeleteMessagesById(e,r),n=(e=p.removeSelectedMessagesById(e,r),e=p.setLoadingConfirmAction(e,!1),R.messages[R.messages.length-1]),t=e.messages.length?e.messages[e.messages.length-1]:null;return t&&t.id!=n.id?(t=d(e),M.publish(S.CONVERSATION_NEW_LAST_MESSAGE,t)):e.messages.length||M.publish(S.CONVERSATION_DELETED,e.id),L(e)})})],[U.ACTION_CONFIRM_DELETE_CONVERSATION,e(function(){var e=p.setLoadingConfirmAction(R,!0);return L(e).then(function(){return b.deleteConversation(R.loggedInUserId,R.id)}).then(function(){var e=p.removeMessages(R,R.messages),e=p.removeSelectedMessagesById(e,R.selectedMessageIds);return e=p.setPendingDeleteConversation(e,!1),e=p.setLoadingConfirmAction(e,!1),M.publish(S.CONVERSATION_DELETED,e.id),L(e)})})],[U.ACTION_REQUEST_ADD_CONTACT,e(G)],[U.ACTION_ACCEPT_CONTACT_REQUEST,e(function(e){var n=R.loggedInUserId,t=R.members[e].contactrequests.filter(function(e){return e.requesteduserid==n})[0],r=p.setLoadingConfirmAction(R,!0);return L(r).then(function(){return b.acceptContactRequest(e,n)}).then(function(e){p.removeContactRequests(R,[t]);e=p.addMembers(R,[e]);return e=p.setLoadingConfirmAction(e,!1),L(e)}).then(function(){M.publish(S.CONTACT_ADDED,R.members[e]),M.publish(S.CONTACT_REQUEST_ACCEPTED,t)})})],[U.ACTION_DECLINE_CONTACT_REQUEST,e(function(e){var n=R.loggedInUserId,t=R.members[e].contactrequests.filter(function(e){return e.requesteduserid==n})[0],r=p.setLoadingConfirmAction(R,!0);return L(r).then(function(){return b.declineContactRequest(e,n)}).then(function(e){p.removeContactRequests(R,[t]);e=p.addMembers(R,[e]);return e=p.setLoadingConfirmAction(e,!1),L(e)}).then(function(){M.publish(S.CONTACT_REQUEST_DECLINED,t)})})],[U.MESSAGE,function(e,n){var t=window.getSelection(),e=D(e.target);""==t.toString()&&(e.is("a")||(t=e.closest(U.MESSAGE),e=parseInt(t.attr("data-message-id"),10),t=e,e=-1<(e=R).selectedMessageIds.indexOf(t)?p.removeSelectedMessagesById(R,[t]):p.addSelectedMessagesById(R,[t]),L(e).catch(N.exception),n.originalEvent.preventDefault()))}]],oe=[[U.SEND_MESSAGE_BUTTON,re],[U.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,e(function(e){var n=R.selectedMessageIds;return f(e).then(function(){var e=p.addPendingDeleteMessagesById(R,n);return L(e)})})],[U.ACTION_REQUEST_ADD_CONTACT,e(G)],[U.ACTION_REQUEST_UNBLOCK,e(k)]],ae=function(e){Q&&Q.stop(),(Q=new n(l(e,K),function(e){return e?2*e:o})).start()},ue=function(e,n,t){t=t.id,e=parseInt(e.attr("data-midnight"),10),e=p.buildInitialState(e,t,n);return R=R||e,Q&&Q.stop(),L(e)},ce=function(e,n,t){var r=null;return n.id in x&&(r=x[n.id]),ue(e,n.id,t).then(function(){var e;return r?(e=r.state,e=p.setLoadingMessages(e,!1),e=p.setLoadingMembers(e,!1),z(r.messagesOffset),Z(r.loadedAllMessages),L(e)):g(n,t,j,K)}).then(function(){return ae(n.id)})};return{show:function(d,e,n,t,g,r){var l,f,m,s,i,E,C,v,_,I,T,o,A,a,u=null,c=null;if(!(c=t&&null!==t&&"object"==typeof t?(u=t,parseInt(u.id,10)):(u=null,c=parseInt(t,10),isNaN(c)?null:c))&&g&&r&&(l=r,c=Object.keys(x).reduce(function(e,n){return e||(n=x[n].state).type==X.PRIVATE&&l in n.members&&(e=n.id),e},null)),e.attr("data-init")||(f=E=d,s=v=n,i=!(L=function(e){var n=V.buildPatch(R,e);return P.render(E,C,v,n).then(function(){(R=e).id&&(x[e.id]={state:e,messagesOffset:Y(),loadedAllMessages:J()})})}),t=$(m=C=e),y.init(s),O.define(f,[O.events.activate]),O.define(m,[O.events.activate]),O.define(s,[O.events.activate,O.events.enter]),O.define(t,[O.events.scrollTop,O.events.scrollLock]),t.on(O.events.scrollTop,function(e,n){var t=1<Object.keys(R.members).length;W||i||J()||!t||(i=!0,t=p.setLoadingMessages(R,!0),L(t).then(function(){return te(R.id,j,Y(),K,[])}).then(function(){i=!1,z(Y()+j)}).catch(function(e){i=!1,N.exception(e)})),n.originalEvent.preventDefault()}),se.forEach(function(e){var n=e[0],e=e[1];f.on(O.events.activate,n,e)}),ie.forEach(function(e){var n=e[0],e=e[1];m.on(O.events.activate,n,e)}),oe.forEach(function(e){var n=e[0],e=e[1];s.on(O.events.activate,n,e)}),s.on(O.events.enter,U.MESSAGE_TEXT_AREA,function(e,n){var t=s.attr("data-enter-to-send");t&&"false"!=t&&"0"!=t&&re(e,n)}),M.subscribe(S.ROUTE_CHANGED,function(e){Q&&e.route!=w.VIEW_CONVERSATION&&Q.stop()}),e.attr("data-init",!0)),!R||R.id!=c||r&&r!=H())return W=!0,n={id:parseInt(e.attr("data-user-id"),10),fullname:null,profileimageurl:null,profileimageurlsmall:null,isonline:null,showonlinestatus:null,isblocked:null,iscontact:null,isdeleted:null,canmessage:null,requirescontact:null,contactrequests:[]},(u?ce(e,u,n,r):c?(t=e,A=n,a=null,(o=c)in x&&(a=x[o]),ue(t,o,A).then(function(){var e;return a?(e=a.state,e=p.setLoadingMessages(e,!1),e=p.setLoadingMembers(e,!1),z(a.messagesOffset),Z(a.loadedAllMessages),L(e)):ne(o,A,j,0,K)}).then(function(){return ae(o)})):(T=r,ue(_=e,null,I=n).then(function(){return b.getConversationBetweenUsers(I.id,T,!0,!0,0,0,j,0,K).then(function(e){return ce(_,e,I)}).catch(function(){return ee(I,T)})}))).then(function(){W=!1,d.find(B.SELECTORS.CAN_RECEIVE_FOCUS).first().focus()}).catch(function(e){W=!1,N.exception(e)});if(ae(c),R.type==X.PRIVATE&&g){var h=H();switch(g){case"block":return F(h);case"unblock":return k(h);case"add-contact":return G(h);case"remove-contact":return q(h)}}return D.Deferred().resolve().promise()},description:function(){return t.get_string("messagedrawerviewconversation","core_message",R.name)}}});