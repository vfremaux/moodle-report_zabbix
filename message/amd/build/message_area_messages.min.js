define(["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events","core/auto_rows","core_message/message_area_actions","core/modal_factory","core/modal_events","core/str","core_message/message_area_events","core/backoff_timer"],function(o,g,n,d,s,t,m,c,l,_,a,f){var u=500,p="[data-region='blocktime']",v="[data-action='cancel-delete-messages']",A="[data-region='contact']",M="[data-region='contacts'][data-region-content='conversations']",E="[data-action='delete-all-messages']",b="[data-action='delete-messages']",y=".loading-icon",h="[data-region='message']",D="[data-region='response']",r="[data-region='messages']",i="[data-region='messages-area']",T="[data-region='messaging-area']",C="[data-action='send-message']",S="[data-region='send-message-txt']",k="[data-action='show-contacts']",w="[data-action='start-delete-messages']",L=1e3;function e(e){this.messageArea=e,this._init()}return e.prototype._isSendingMessage=!1,e.prototype._isLoadingMessages=!1,e.prototype._numMessagesDisplayed=0,e.prototype._messageQueue=[],e.prototype._numMessagesToRetrieve=20,e.prototype._confirmationModal=null,e.prototype._latestMessageTimestamp=0,e.prototype._backoffTimer=null,e.prototype.messageArea=null,e.prototype._init=function(){s.define(this.messageArea.node,[s.events.activate,s.events.up,s.events.down,s.events.enter]),o(window).height()<=670&&(u=400),t.init(this.messageArea.node),this.messageArea.onCustomEvent(a.CONVERSATIONSELECTED,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(a.SENDMESSAGE,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(a.CHOOSEMESSAGESTODELETE,this._chooseMessagesToDelete.bind(this)),this.messageArea.onCustomEvent(a.CANCELDELETEMESSAGES,this._hideDeleteAction.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,C,this._sendMessage.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,w,this._startDeleting.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,b,this._deleteMessages.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,E,this._deleteAllMessages.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,v,this._triggerCancelMessagesToDelete.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,h,this._toggleMessage.bind(this)),this.messageArea.onDelegateEvent(s.events.activate,k,this._hideMessagingArea.bind(this)),this.messageArea.onDelegateEvent(s.events.up,h,this._selectPreviousMessage.bind(this)),this.messageArea.onDelegateEvent(s.events.down,h,this._selectNextMessage.bind(this)),this.messageArea.onDelegateEvent("focus",S,this._setMessaging.bind(this)),this.messageArea.onDelegateEvent("blur",S,this._clearMessaging.bind(this)),o(document).on(t.events.ROW_CHANGE,this._adjustMessagesAreaHeight.bind(this));var e=this.messageArea.find(r);e.length&&(this._addScrollEventListener(e.find(h).length),this._latestMessageTimestamp=e.find(h+":last").data("timecreated")),this._backoffTimer=new f(this._loadNewMessages.bind(this),f.getIncrementalCallback(this.messageArea.pollmin*L,L,this.messageArea.pollmax*L,this.messageArea.polltimeout*L)),this._backoffTimer.start()},e.prototype._viewMessages=function(e,s){this._numMessagesDisplayed=0,this._backoffTimer.stop(),this._latestMessageTimestamp=0;var t=g.call([{methodname:"core_message_mark_all_messages_as_read",args:{useridto:this.messageArea.getCurrentUserId(),useridfrom:s}}]),a=0;return n.render("core/loading",{}).then(function(e,s){return n.replaceNodeContents(this.messageArea.find(i),e,s),t[0]}.bind(this)).then(function(){var e=this.messageArea.find(M+" "+A+"[data-userid='"+s+"']");return e.hasClass("unread")&&(e.removeClass("unread"),o(document).trigger("messagearea:conversationselected",s)),this._getMessages(s)}.bind(this)).then(function(e){return a=e.messages.length,n.render("core_message/message_area_messages_area",e)}).then(function(e,s){n.replaceNodeContents(this.messageArea.find(i),e,s),this._addScrollEventListener(a),this._backoffTimer.restart(),this.messageArea.find(S).focus()}.bind(this)).fail(d.exception)},e.prototype._loadMessages=function(){if(this._isLoadingMessages)return!1;this._isLoadingMessages=!0;var a=0;return n.render("core/loading",{}).then(function(e,s){return n.prependNodeContents(this.messageArea.find(r),"<div style='text-align:center'>"+e+"</div>",s),this._getMessages(this._getUserId())}.bind(this)).then(function(e){return a=e.messages.length,n.render("core_message/message_area_messages",e)}).then(function(e,s){var t;this.messageArea.find(r+" "+y).remove(),0<a&&(t=o("<div>"+e+"</div>"),this._hasMatchingBlockTime(this.messageArea.node,t,!0)&&this.messageArea.node.find(p+":first").remove(),t=this.messageArea.find(r)[0].scrollHeight,n.prependNodeContents(this.messageArea.find(r),e,s),e=this.messageArea.find(r)[0].scrollHeight,this.messageArea.find(r).scrollTop(e-t),this._numMessagesDisplayed+=a),this._isLoadingMessages=!1}.bind(this)).fail(d.exception)},e.prototype._loadNewMessages=function(){if(this._isLoadingMessages)return!1;if(!this._getUserId())return!1;var e,s,t=!(this._isLoadingMessages=!0),a=this.messageArea.find(r);return 0!==a.length&&(e=a.scrollTop(),s=a.innerHeight(),a[0].scrollHeight<=e+s&&(t=!0)),this._getMessages(this._getUserId(),!0).then(function(e){return this._addMessagesToDom(e.messages,t)}.bind(this)).always(function(){this._isLoadingMessages=!1}.bind(this)).fail(d.exception)},e.prototype._getMessages=function(e,s){e={currentuserid:this.messageArea.getCurrentUserId(),otheruserid:e,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve,newest:!0};return s&&(e.timefrom=this._latestMessageTimestamp,e.limitfrom=0,e.limitnum=0),g.call([{methodname:"core_message_data_for_messagearea_messages",args:e}])[0].then(function(e){var s=e.messages;return s&&s.length&&((s=s[s.length-1]).timecreated>this._latestMessageTimestamp&&(this._latestMessageTimestamp=s.timecreated+1)),e}.bind(this)).fail(function(e){this._backoffTimer.stop(),d.exception(e)}.bind(this))},e.prototype._sendMessage=function(){var e=this.messageArea.find(S),s=e.val().trim();if(""===s)return!1;if(this._isSendingMessage)return!1;this._isSendingMessage=!0;var t=g.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:this._getUserId(),text:s}]}}]);return e.prop("disabled",!0),t[0].then(function(e){if(e.length<0)throw new Error("Invalid response");if(e[0].errormessage)throw new Error(e[0].errormessage);return this.messageArea.trigger(a.MESSAGESENT,[this._getUserId(),s]),this._addLastMessageToDom()}.bind(this)).then(function(){this._isSendingMessage=!1}.bind(this)).always(function(){e.prop("disabled",!1),e.focus()}).fail(d.exception)},e.prototype._chooseMessagesToDelete=function(){this.messageArea.find(i).addClass("editing"),this.messageArea.find(h).attr("role","checkbox").attr("aria-checked","false")},e.prototype._deleteMessages=function(){var i=this.messageArea.getCurrentUserId(),e=this.messageArea.find(h+"[aria-checked='true']"),n=[],r=[];e.each(function(e,s){var s=o(s),t=s.data("messageid"),a=s.data("messageread")?1:0;r.push(s),n.push({methodname:"core_message_delete_message",args:{messageid:t,userid:i,read:a}})}),0<n.length?o.when(g.call(n)).then(function(){var e=null,s=this.messageArea.find(h).last(),t=r[r.length-1];o.each(r,function(e,s){s.remove()}),s.data("id")===t.data("id")&&(e=this.messageArea.find(h).last()),o.each(r,function(e,s){s=s.data("blocktime");0===this.messageArea.find(h+"[data-blocktime='"+s+"']").length&&this.messageArea.find(p+"[data-blocktime='"+s+"']").remove()}.bind(this)),0===this.messageArea.find(h).length&&this.messageArea.find(M+" "+A+"[data-userid='"+this._getUserId()+"']").remove(),this.messageArea.trigger(a.MESSAGESDELETED,[this._getUserId(),e])}.bind(this)).catch(d.exception):this.messageArea.trigger(a.MESSAGESDELETED,this._getUserId()),this._hideDeleteAction()},e.prototype._addScrollEventListener=function(e){this._scrollBottom(),this._numMessagesDisplayed=e,s.define(this.messageArea.find(r),[s.events.scrollTop]),this.messageArea.onCustomEvent(s.events.scrollTop,this._loadMessages.bind(this))},e.prototype._deleteAllMessages=function(){var e,s;this._confirmationModal?this._confirmationModal.show():(e=_.get_strings([{key:"confirm"},{key:"deleteallconfirm",component:"message"},{key:"delete"}]),s=c.create({type:c.types.SAVE_CANCEL},this.messageArea.find(E)),o.when(e,s).then(function(e,s){s.setTitle(e[0]),s.setBody(e[1]),s.setSaveButtonText(e[2]),(this._confirmationModal=s).getRoot().on(l.save,function(){var e=this._getUserId(),s={methodname:"core_message_delete_conversation",args:{userid:this.messageArea.getCurrentUserId(),otheruserid:e}};g.call([s])[0].then(function(){this.messageArea.find(i).empty(),this.messageArea.trigger(a.CONVERSATIONDELETED,e),this._hideDeleteAction()}.bind(this)).catch(d.exception)}.bind(this)),s.show()}.bind(this)).catch(d.exception))},e.prototype._hideDeleteAction=function(){this.messageArea.find(h).removeAttr("role").removeAttr("aria-checked"),this.messageArea.find(i).removeClass("editing")},e.prototype._triggerCancelMessagesToDelete=function(){this.messageArea.trigger(a.CANCELDELETEMESSAGES)},e.prototype._addMessagesToDom=function(e,t){var a,i=this.messageArea.find(r);return e=e.filter(function(e){e=""+e.id+e.isread;if(this._messageQueue[e])return!1;var s=i.find(h+'[data-id="'+e+'"]');return s.length||(this._messageQueue[e]=!0),!s.length}.bind(this)),a=e.length,n.render("core_message/message_area_messages",{messages:e}).then(function(e,s){0<a&&(e=o("<div>"+e+"</div>"),this._hasMatchingBlockTime(this.messageArea.node,e,!1)&&e.find(p+":first").remove(),n.appendNodeContents(this.messageArea.find(r),e,s),t&&this._scrollBottom(),this._numMessagesDisplayed+=a,this._backoffTimer.restart())}.bind(this))},e.prototype._addLastMessageToDom=function(){return g.call([{methodname:"core_message_data_for_messagearea_get_most_recent_message",args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:this._getUserId()}}])[0].then(function(e){return this._addMessagesToDom([e],!0)}.bind(this)).always(function(){this.messageArea.find(S).val("").trigger("input")}.bind(this)).fail(d.exception)},e.prototype._getUserId=function(){return this.messageArea.find(r).data("userid")},e.prototype._scrollBottom=function(){var e=this.messageArea.find(r);0!==e.length&&e.scrollTop(e[0].scrollHeight)},e.prototype._selectPreviousMessage=function(e,s){for(var t=o(e.target).closest(h);(t=t.prev()).length&&!t.is(h););t.focus(),s.originalEvent.preventDefault(),s.originalEvent.stopPropagation()},e.prototype._selectNextMessage=function(e,s){for(var t=o(e.target).closest(h);(t=t.next()).length&&!t.is(h););t.focus(),s.originalEvent.preventDefault(),s.originalEvent.stopPropagation()},e.prototype._setMessaging=function(e){o(e.target).closest(D).addClass("messaging")},e.prototype._clearMessaging=function(e){o(e.target).closest(D).removeClass("messaging")},e.prototype._startDeleting=function(e){new m(this.messageArea).chooseMessagesToDelete(),e.preventDefault()},e.prototype._isEditing=function(){return this.messageArea.find(i).hasClass("editing")},e.prototype._toggleMessage=function(e){this._isEditing()&&("true"===(e=o(e.target).closest(h)).attr("aria-checked")?e.attr("aria-checked","false"):e.attr("aria-checked","true"))},e.prototype._adjustMessagesAreaHeight=function(){var e=this.messageArea.find(r),s=this.messageArea.find(D).outerHeight(),s=u-(s-50);e.outerHeight(s)},e.prototype._sendMessageHandler=function(e,s){s.originalEvent.preventDefault(),this._sendMessage()},e.prototype._hideMessagingArea=function(){this.messageArea.find(T).removeClass("show-messages").addClass("hide-messages")},e.prototype._hasMatchingBlockTime=function(e,s,t){var t=t?(a=":first",":last"):(a=":last",":first"),e=e.find(p+a),a=s.find(p+t);return!(!e.length||!a.length)&&e.data("blocktime")==a.data("blocktime")},e});