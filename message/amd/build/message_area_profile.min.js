define(["jquery","core/ajax","core/templates","core/notification","core/str","core/config","core/custom_interaction_events","core_message/message_area_events"],function(d,r,s,o,c,e,t,n){var a="[data-region='profile']",u="[data-action='profile-add-contact']",h="[data-action='profile-block-contact']",l="[data-action='profile-remove-contact']",f="[data-action='profile-send-message']",_="[data-action='profile-unblock-contact']",m="[data-action='profile-view']",p="[data-action='show-contacts']",i="[data-region='messages-area']",v="[data-region='messaging-area']";function g(e){this.messageArea=e,this._init()}return g.prototype.messageArea=null,g.prototype._init=function(){t.define(this.messageArea.node,[t.events.activate]),this.messageArea.onCustomEvent(n.CONTACTSELECTED,this._viewProfile.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,m,function(e,t){this._viewFullProfile(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,f,function(e,t){this._sendMessage(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,_,function(e,t){this._unblockContact(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,h,function(e,t){this._blockContact(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,u,function(e,t){this._addContact(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,l,function(e,t){this._removeContact(),t.originalEvent.preventDefault()}.bind(this)),this.messageArea.onDelegateEvent(t.events.activate,p,this._hideMessagingArea.bind(this))},g.prototype._viewProfile=function(e,t){return s.render("core/loading",{}).done(function(e,t){s.replaceNodeContents(this.messageArea.find(i),e,t)}.bind(this)),r.call([{methodname:"core_message_data_for_messagearea_get_profile",args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:t}}])[0].then(function(e){return s.render("core_message/message_area_profile",e)}).then(function(e,t){s.replaceNodeContents(this.messageArea.find(i),e,t)}.bind(this)).fail(o.exception)},g.prototype._viewFullProfile=function(){window.location.href=e.wwwroot+"/user/profile.php?id="+this._getUserId()},g.prototype._sendMessage=function(){this.messageArea.trigger(n.SENDMESSAGE,this._getUserId())},g.prototype._blockContact=function(){return this._performAction("core_message_block_user","unblockcontact","profile-block-contact","profile-unblock-contact","").then(function(){this.messageArea.trigger(n.CONTACTBLOCKED,this._getUserId())}.bind(this))},g.prototype._unblockContact=function(){return this._performAction("core_message_unblock_user","blockcontact","profile-unblock-contact","profile-block-contact","danger").then(function(){this.messageArea.trigger(n.CONTACTUNBLOCKED,this._getUserId())}.bind(this))},g.prototype._addContact=function(){return this._performAction("core_message_create_contact_request","removecontact","profile-add-contact","profile-remove-contact","danger").then(function(){this.messageArea.trigger(n.CONTACTADDED,this._getUserId())}.bind(this))},g.prototype._removeContact=function(){return this._performAction("core_message_delete_contacts","addcontact","profile-remove-contact","profile-add-contact","").then(function(){this.messageArea.trigger(n.CONTACTREMOVED,this._getUserId())}.bind(this))},g.prototype._performAction=function(e,t,s,n,a){var i="";switch(e){case"core_message_block_user":i={userid:this.messageArea.getCurrentUserId(),blockeduserid:this._getUserId()};break;case"core_message_unblock_user":i={userid:this.messageArea.getCurrentUserId(),unblockeduserid:this._getUserId()};break;case"core_message_create_contact_request":i={userid:this.messageArea.getCurrentUserId(),requesteduserid:this._getUserId()};break;default:i={userid:this.messageArea.getCurrentUserId(),userids:[this._getUserId()]}}return r.call([{methodname:e,args:i}])[0].then(function(){return c.get_string(t,"message")}).then(function(e){this._changeText(e,s,n,a)}.bind(this)).fail(o.exception)},g.prototype._changeText=function(e,t,s,n){t=this.messageArea.find("[data-action='"+t+"']");t.text(e),t.removeClass(),n&&t.addClass(n),t.attr("data-action",s)},g.prototype._getUserId=function(){return this.messageArea.find(a).data("userid")},g.prototype._hideMessagingArea=function(){this.messageArea.find(v).removeClass("show-messages").addClass("hide-messages")},g});