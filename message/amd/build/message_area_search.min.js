define(["jquery","core/ajax","core/templates","core/notification","core/str","core/custom_interaction_events","core_message/message_area_events"],function(d,s,r,i,u,e,t){var _="[data-region='contacts'][data-region-content='contacts']",g="[data-region='contacts-area']",m="[data-region='contacts'][data-region-content='conversations']",l="[data-region='search-filter-area']",A=".loading-icon",n="[data-region='search-box']",f="[data-region='search-filter']",a="[data-region='search-filter-area']",h="[data-region='search-results-area']",o="[data-region='search-text-area']",S="[data-action='search-users-in-course']";function c(e){this.messageArea=e,this._init()}return c.prototype.messageArea=null,c.prototype._searchArea=null,c.prototype._courseid=null,c.prototype._isLoading=!1,c.prototype._numMessagesDisplayed=0,c.prototype._numMessagesToRetrieve=20,c.prototype._numUsersDisplayed=0,c.prototype._numUsersToRetrieve=20,c.prototype._searchAreas={MESSAGES:"messages",USERS:"users",USERSINCOURSE:"usersincourse"},c.prototype._requestTimeout=null,c.prototype._init=function(){this.messageArea.find(o).on("input",this._searchRequest.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,S,function(e){this._setFilter(d(e.currentTarget).html()),this._setPlaceholderText("searchforuser"),this._clearSearchArea(),this._searchArea=this._searchAreas.USERSINCOURSE,this._courseid=d(e.currentTarget).data("courseid"),this._searchUsersInCourse(),this.messageArea.find(n).focus()}.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,l,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.USERS,this._setPlaceholderText("searchforuserorcourse"),this.messageArea.trigger(t.USERSSEARCHCANCELED),this.messageArea.find(n).focus()}.bind(this)),this.messageArea.onCustomEvent(t.CONVERSATIONSSELECTED,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.MESSAGES,this._setPlaceholderText("searchmessages")}.bind(this)),this.messageArea.onCustomEvent(t.CONTACTSSELECTED,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.USERS,this._setPlaceholderText("searchforuserorcourse")}.bind(this)),this.messageArea.onCustomEvent(t.MESSAGESENT,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.MESSAGES,this._setPlaceholderText("searchmessages")}.bind(this)),e.define(this.messageArea.find(h),[e.events.scrollBottom]),this.messageArea.onDelegateEvent(e.events.scrollBottom,h,function(){this._searchArea==this._searchAreas.MESSAGES?this._searchMessages():this._searchArea==this._searchAreas.USERSINCOURSE&&this._searchUsersInCourse()}.bind(this)),this._searchArea=this.messageArea.showContactsFirst()?this._searchAreas.USERS:this._searchAreas.MESSAGES},c.prototype._searchRequest=function(){var e=this.messageArea.find(o+" input").val();this._requestTimeout&&clearTimeout(this._requestTimeout),""!==e.trim()?(this.messageArea.find(m).hide(),this.messageArea.find(_).hide(),this.messageArea.find(h).show(),this._searchArea==this._searchAreas.MESSAGES?this._requestTimeout=setTimeout(function(){this._clearSearchArea(),this._numMessagesDisplayed=0,this._searchMessages()}.bind(this),300):this._searchArea==this._searchAreas.USERSINCOURSE?this._requestTimeout=setTimeout(function(){this._clearSearchArea(),this._numUsersDisplayed=0,this._searchUsersInCourse()}.bind(this),300):this._requestTimeout=setTimeout(function(){this._clearSearchArea(),this._numUsersDisplayed=0,this._searchUsers()}.bind(this),300)):this._searchArea==this._searchAreas.MESSAGES?(this._hideSearchResults(),this.messageArea.trigger(t.MESSAGESEARCHCANCELED)):this._searchArea==this._searchAreas.USERS?(this._hideSearchResults(),this.messageArea.trigger(t.USERSSEARCHCANCELED)):this._searchArea==this._searchAreas.USERSINCOURSE&&(this._clearSearchArea(),this._searchUsersInCourse())},c.prototype._searchMessages=function(){if(this._isLoading)return!1;var e=this.messageArea.find(n).val(),t=(this._isLoading=!0,s.call([{methodname:"core_message_data_for_messagearea_search_messages",args:{userid:this.messageArea.getCurrentUserId(),search:e,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve}}])),a=0;return r.render("core/loading",{}).then(function(e,s){return r.appendNodeContents(this.messageArea.find(h),"<div style='text-align:center'>"+e+"</div>",s),t[0]}.bind(this)).then(function(e){return a=e.contacts.length,r.render("core_message/message_area_message_search_results",e)}).then(function(e,s){this.messageArea.find(h+" "+A).remove(),0<a?(r.appendNodeContents(this.messageArea.find(h),e,s),this._numMessagesDisplayed+=a):0==this._numMessagesDisplayed&&r.replaceNodeContents(this.messageArea.find(h),e,s),this._isLoading=!1}.bind(this)).fail(i.exception)},c.prototype._searchUsers=function(){var e=this.messageArea.find(n).val(),t=s.call([{methodname:"core_message_data_for_messagearea_search_users",args:{userid:this.messageArea.getCurrentUserId(),search:e,limitnum:this._numUsersToRetrieve}}]);return r.render("core/loading",{}).then(function(e,s){return r.replaceNodeContents(this.messageArea.find(h),"<div style='text-align:center'>"+e+"</div>",s),t[0]}.bind(this)).then(function(e){return 0<e.contacts.length&&(e.hascontacts=!0),0<e.courses.length&&(e.hascourses=!0),0<e.noncontacts.length&&(e.hasnoncontacts=!0),r.render("core_message/message_area_user_search_results",e)}).then(function(e,s){r.replaceNodeContents(this.messageArea.find(h),e,s)}.bind(this)).fail(i.exception)},c.prototype._searchUsersInCourse=function(){if(this._isLoading)return!1;var e=this.messageArea.find(n).val(),t=(this._isLoading=!0,s.call([{methodname:"core_message_data_for_messagearea_search_users_in_course",args:{userid:this.messageArea.getCurrentUserId(),courseid:this._courseid,search:e,limitfrom:this._numUsersDisplayed,limitnum:this._numUsersToRetrieve}}])),a=0;return r.render("core/loading",{}).then(function(e,s){return r.appendNodeContents(this.messageArea.find(h),"<div style='text-align:center'>"+e+"</div>",s),t[0]}.bind(this)).then(function(e){return 0<(a=e.contacts.length)&&(e.hascontacts=!0),r.render("core_message/message_area_user_search_results",e)}).then(function(e,s){this.messageArea.find(h+" "+A).remove(),0<a?(r.appendNodeContents(this.messageArea.find(h),e,s),this._numUsersDisplayed+=a):0==this._numUsersDisplayed&&r.replaceNodeContents(this.messageArea.find(h),e,s),this._isLoading=!1}.bind(this)).fail(i.exception)},c.prototype._setPlaceholderText=function(e){return u.get_string(e,"message").then(function(e){this.messageArea.find(o+" input").attr("placeholder",e)}.bind(this))},c.prototype._setFilter=function(e){this.messageArea.find(n).val(""),this.messageArea.find(g).addClass("searchfilter"),this.messageArea.find(a).show(),this.messageArea.find(f).html(e),u.get_string("removecoursefilter","message",e).then(function(e){this.messageArea.find(a).attr("aria-label",e)}.bind(this)).catch(i.exception)},c.prototype._clearFilters=function(){this.messageArea.find(g).removeClass("searchfilter"),this.messageArea.find(f).empty(),this.messageArea.find(a).hide(),this.messageArea.find(a).removeAttr("aria-label")},c.prototype._clearSearchArea=function(){this.messageArea.find(h).empty()},c.prototype._hideSearchResults=function(){this._clearFilters(),this.messageArea.find(o+" input").val(""),this._clearSearchArea(),this.messageArea.find(h).hide()},c});