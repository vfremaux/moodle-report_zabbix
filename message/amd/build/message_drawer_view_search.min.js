define(["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core_message/message_repository","core_message/message_drawer_events"],function(r,e,c,C,t,o,f,N){function a(n){return n.find(O.EMPTY_MESSAGE_CONTAINER)}function d(n){return n.find(O.LOADING_ICON_CONTAINER)}function s(n){return n.find(O.LOADING_PLACEHOLDER)}function A(n){return n.find(O.SEARCH_ICON_CONTAINER)}function _(n){return n.find(O.SEARCH_RESULTS_CONTAINER)}function u(n){return n.find(O.CONTACTS_CONTAINER)}function S(n){return n.find(O.NON_CONTACTS_CONTAINER)}function l(n){a(n).addClass("hidden")}function h(n){n.find(O.CONTACTS_LIST).empty(),n.find(O.NON_CONTACTS_LIST).empty(),n.find(O.MESSAGES_LIST).empty();var e=n;(e=_(e)).find(O.ALL_CONTACTS_CONTAINER).removeClass("hidden"),e.find(O.MESSAGES_CONTAINER).removeClass("hidden"),e.find(O.NO_RESULTS_CONTAINTER).addClass("hidden"),_(n).find(O.ALL_CONTACTS_CONTAINER).removeClass("hidden"),_(n).find(O.CONTACTS_CONTAINER).removeClass("hidden"),_(n).find(O.NON_CONTACTS_CONTAINER).removeClass("hidden"),_(n).find(O.MESSAGES_CONTAINER).removeClass("hidden"),n.find(O.LOAD_MORE_USERS).removeClass("hidden"),n.find(O.LOAD_MORE_MESSAGES).removeClass("hidden")}function I(n,e){A(n).addClass("hidden"),l(e),P(e),d(n).removeClass("hidden"),s(e).removeClass("hidden"),E(n).prop("disabled",!0)}function R(n,e){y(n),l(e),_(e).removeClass("hidden"),H(n),w(e),E(n).prop("disabled",!1)}function v(n){(n=n.find(O.LOAD_MORE_USERS)).prop("disabled",!1),n.find(O.BUTTON_TEXT).removeClass("hidden"),n.find(O.LOADING_ICON_CONTAINER).addClass("hidden")}function L(n){(n=n.find(O.LOAD_MORE_MESSAGES)).prop("disabled",!1),n.find(O.BUTTON_TEXT).removeClass("hidden"),n.find(O.LOADING_ICON_CONTAINER).addClass("hidden")}function i(n,e){return n.find('[data-contact-user-id="'+e+'"]')}function g(n,e){var t=n.find(O.MESSAGES_CONTAINER).find(O.LIST);return o.render(U,{messages:e}).then(function(n){return t.append(n),n})}function m(t,i){function n(n,e){""!==(s=d.val().trim())&&V(t,i,s,D,r=o=0,T,o).then(function(){d.focus(),r+=D,o+=T}).catch(c.exception),e.originalEvent.preventDefault()}var a=b(i),d=E(t),s="",o=0,r=0;e.define(d,[e.events.enter]),e.define(t,[e.events.activate]),e.define(i,[e.events.activate]),d.on(e.events.enter,n),t.on(e.events.activate,O.SEARCH_ACTION,n),i.on(e.events.activate,O.LOAD_MORE_MESSAGES,function(n,e){""!==s&&q(i,a,s,T,o).then(function(){o+=T}).catch(c.exception),e.originalEvent.preventDefault()}),i.on(e.events.activate,O.LOAD_MORE_USERS,function(n,e){""!==s&&k(i,a,s,p,r).then(function(){r+=p}).catch(c.exception),e.originalEvent.preventDefault()}),t.on(e.events.activate,O.CANCEL_SEARCH_BUTTON,function(){K(t),B(i),y(t),P(i),H(t),w(i),o=r=0}),C.subscribe(N.CONTACT_ADDED,function(n){X(i,n)}),C.subscribe(N.CONTACT_REMOVED,function(n){x(i,n)}),C.subscribe(N.CONTACT_BLOCKED,function(n){Y(i,n)}),C.subscribe(N.CONTACT_UNBLOCKED,function(n){j(i,n)})}var T=50,p=50,D=3,O={BLOCK_ICON_CONTAINER:'[data-region="block-icon-container"]',CANCEL_SEARCH_BUTTON:'[data-action="cancel-search"]',CONTACTS_CONTAINER:'[data-region="contacts-container"]',CONTACTS_LIST:'[data-region="contacts-container"] [data-region="list"]',EMPTY_MESSAGE_CONTAINER:'[data-region="empty-message-container"]',LIST:'[data-region="list"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',LOADING_PLACEHOLDER:'[data-region="loading-placeholder"]',MESSAGES_LIST:'[data-region="messages-container"] [data-region="list"]',MESSAGES_CONTAINER:'[data-region="messages-container"]',NON_CONTACTS_CONTAINER:'[data-region="non-contacts-container"]',NON_CONTACTS_LIST:'[data-region="non-contacts-container"] [data-region="list"]',SEARCH_ICON_CONTAINER:'[data-region="search-icon-container"]',SEARCH_ACTION:'[data-action="search"]',SEARCH_INPUT:'[data-region="search-input"]',SEARCH_RESULTS_CONTAINER:'[data-region="search-results-container"]',LOAD_MORE_USERS:'[data-action="load-more-users"]',LOAD_MORE_MESSAGES:'[data-action="load-more-messages"]',BUTTON_TEXT:'[data-region="button-text"]',NO_RESULTS_CONTAINTER:'[data-region="no-results-container"]',ALL_CONTACTS_CONTAINER:'[data-region="all-contacts-container"]'},M="core_message/message_drawer_contacts_list",G="core_message/message_drawer_non_contacts_list",U="core_message/message_drawer_messages_list",b=function(n){return n.attr("data-user-id")},E=function(n){return n.find(O.SEARCH_INPUT)},B=function(n){a(n).removeClass("hidden")},H=function(n){d(n).addClass("hidden")},w=function(n){s(n).addClass("hidden")},y=function(n){A(n).removeClass("hidden")},P=function(n){_(n).addClass("hidden")},K=function(n){E(n).val("")},X=function(n,e){var t=S(n),e=i(t,e.userid);e.length&&(e.remove(),(n=u(n)).removeClass("hidden"),n.find(O.LIST).append(e)),t.find(O.LIST).children().length||t.addClass("hidden")},x=function(n,e){var t=u(n),e=i(t,e);e.length&&(e.remove(),(n=S(n)).removeClass("hidden"),n.find(O.LIST).append(e)),t.find(O.LIST).children().length||t.addClass("hidden")},Y=function(n,e){n=i(n,e);n.length&&n.find(O.BLOCK_ICON_CONTAINER).removeClass("hidden")},j=function(n,e){n=i(n,e);n.length&&n.find(O.BLOCK_ICON_CONTAINER).addClass("hidden")},k=function(s,n,e,t,i){var a=!1,d=s;return(d=d.find(O.LOAD_MORE_USERS)).prop("disabled",!0),d.find(O.BUTTON_TEXT).addClass("hidden"),d.find(O.LOADING_ICON_CONTAINER).removeClass("hidden"),f.searchUsers(n,e,t+1,i).then(function(n){var e=n.contacts,n=n.noncontacts;return e.length<=t&&n.length<=t?(a=!0,{contacts:e,noncontacts:n}):{contacts:e.slice(0,t),noncontacts:n.slice(0,t)}}).then(function(n){var e,t,i,a=n.contacts.length,d=n.noncontacts.length;return r.when(!a||(t=n.contacts,i=u(s).find(O.LIST),o.render(M,{contacts:t}).then(function(n){return i.append(n),n})),!d||(t=n.noncontacts,e=S(s).find(O.LIST),o.render(G,{noncontacts:t}).then(function(n){return e.append(n),n}))).then(function(){return{contactsCount:a,nonContactsCount:d}})}).then(function(n){return v(s),a&&s.find(O.LOAD_MORE_USERS).addClass("hidden"),n}).catch(function(n){throw v(s),n})},q=function(e,n,t,i,a){var d=!1,s=e;return(s=s.find(O.LOAD_MORE_MESSAGES)).prop("disabled",!0),s.find(O.BUTTON_TEXT).addClass("hidden"),s.find(O.LOADING_ICON_CONTAINER).removeClass("hidden"),f.searchMessages(n,t,i+1,a).then(function(n){n=n.contacts;return n.length<=i?(d=!0,n):n.slice(0,i)}).then(function(n){return n.length&&g(e,n).then(function(){return n.length})}).then(function(n){return L(e),d&&e.find(O.LOAD_MORE_MESSAGES).addClass("hidden"),n}).catch(function(n){throw L(e),n})},V=function(i,a,n,e,t,d,s){var o=b(a);return I(i,a),h(a),r.when(k(a,o,n,e,t),q(a,o,n,d,s)).then(function(n,e){var t=n.contactsCount,n=n.nonContactsCount;R(i,a),t||n||e?(t||n?(t||_(a).find(O.CONTACTS_CONTAINER).addClass("hidden"),n||_(a).find(O.NON_CONTACTS_CONTAINER).addClass("hidden")):_(a).find(O.ALL_CONTACTS_CONTAINER).addClass("hidden"),e||_(a).find(O.MESSAGES_CONTAINER).addClass("hidden")):((t=_(t=a)).find(O.ALL_CONTACTS_CONTAINER).addClass("hidden"),t.find(O.MESSAGES_CONTAINER).addClass("hidden"),t.find(O.NO_RESULTS_CONTAINTER).removeClass("hidden"))})};return{show:function(n,e){return e.attr("data-init")||(m(n,e),e.attr("data-init",!0)),E(n).focus(),r.Deferred().resolve().promise()},description:function(n){n=E(n).val().trim();return t.get_string("messagedrawerviewsearch","core_message",n)}}});