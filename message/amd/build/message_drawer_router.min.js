define(["jquery","core/pubsub","core/str","core_message/message_drawer_events"],function(s,c,a,u){function t(){var e,t=s(document.activeElement),n=function(r){var o,e=[].slice.call(arguments,1),t=s.Deferred().resolve().promise();if(Object.keys(l).forEach(function(e){var t=l[e],n=e===r;n&&(o=t),t.elements.forEach(function(e){e.removeClass("previous"),n?(e.removeClass("hidden"),e.attr("aria-hidden",!1)):(e.addClass("hidden"),e.attr("aria-hidden",!0))})}),o&&o.onGo){for(var t=o.onGo.apply(void 0,o.elements.concat(e)),n=s(document.activeElement),a=!1,i=0;i<o.elements.length;i++)if(o.elements[i].has(n).length){a=!0;break}a||o.elements[0].find(f.CAN_RECEIVE_FOCUS).filter(":visible").first().focus()}e={route:r,params:e,renderPromise:t};return c.publish(u.ROUTE_CHANGED,e),e}.apply(null,arguments),r=!1,o=(i=i.reduce(function(e,t){return(r=t.route===n.route?!0:r)||e.push(t),e},[])).length?i[i.length-1]:null;return o&&((e=l[o.route]).elements.forEach(function(e){e.addClass("previous")}),o.focusElement=t,e.getDescription&&e.getDescription.apply(null,e.elements.concat(o.params)).then(function(e){return a.get_string("backto","core_message",e)}).then(function(t){return n.renderPromise.then(function(){l[n.route].elements.forEach(function(e){e.find(f.ROUTES_BACK).attr("aria-label",t)})})}).catch(function(){})),i.push(n),n}var l={},i=[],f={CAN_RECEIVE_FOCUS:'input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]',ROUTES_BACK:"[data-route-back]"};return{add:function(e,t,n,r){l[e]={elements:t,onGo:n,getDescription:r}},go:t,back:function(){var e;i.length&&(i.pop(),(e=i.pop())&&(t.apply(void 0,[e.route].concat(e.params)),window.setTimeout(function(){e.focusElement.focus()},50)))}}});