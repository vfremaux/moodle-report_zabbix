define(["jquery","core/notification","core/str","core/templates","core/user_date","core_message/message_drawer_view_conversation_constants"],function(c,d,u,s,l,n){function e(n){return n.find(E.CONTENT_MESSAGES_FOOTER_CONTAINER)}function t(n){return n.find(E.CONTENT_MESSAGES_FOOTER_EDIT_MODE_CONTAINER)}function r(n){return n.find(E.PLACEHOLDER_CONTAINER)}function N(n){return n.find(E.CONTENT_MESSAGES_FOOTER_REQUIRE_UNBLOCK_CONTAINER)}function T(n){return n.find(E.CONTENT_MESSAGES_FOOTER_UNABLE_TO_MESSAGE_CONTAINER)}function O(n){return n.find(E.CONTENT_PLACEHOLDER_CONTAINER)}function m(n){return n.find(E.MESSAGE_TEXT_AREA)}function h(n,e){return f(n).find('[data-day-id="'+e+'"]')}function A(n){return n.find(E.MORE_MESSAGES_LOADING_ICON_CONTAINER)}function S(n){var e=(n=C(n)).siblings(":not(.hidden)");e.attr("aria-hidden",!0),e.attr("tabindex",-1),e.attr("data-confirm-dialogue-hidden",!0),n.removeClass("hidden")}function I(n){var e=(n=C(n)).siblings('[data-confirm-dialogue-hidden="true"]');e.removeAttr("aria-hidden"),e.removeAttr("tabindex"),e.removeAttr("data-confirm-dialogue-hidden"),n.addClass("hidden")}function v(n,e){return n.map(function(n){return{id:n.id,isread:n.isRead,fromloggedinuser:n.fromLoggedInUser,userfrom:n.userFrom,text:n.text,formattedtime:e[n.timeCreated]}})}function g(e,t,d,r){var n=[],i=0<r.days.add.length,a=0<r.messages.add.length,s=[],o=c.Deferred().resolve({}).promise();return i&&(s=s.concat(r.days.add.reduce(function(n,e){return n.concat(e.value.messages.map(function(n){return n.timeCreated}))},[]))),(s=a?s.concat(r.messages.add.map(function(n){return n.value.timeCreated})):s).length&&(o=u.get_string("strftimetime24","core_langconfig").then(function(e){var n=s.map(function(n){return{timestamp:n,format:e}});return l.get(n)}).then(function(d){return s.reduce(function(n,e,t){return n[e]=d[t],n},{})})),i&&n.push(o.then(function(n){return pn(e,t,d,r.days.add,n)})),a&&n.push(o.then(function(n){return Mn(e,t,d,r.messages.add,n)})),0<r.days.remove.length&&Dn(t,r.days.remove),0<r.messages.remove.length&&Ln(t,r.messages.remove),c.when.apply(c,n)}function R(n,e,t,d){var r=En(n),n=o.HEADER_PUBLIC;return d.type==z.PRIVATE&&(n=d.showControls?o.HEADER_PRIVATE:o.HEADER_PRIVATE_NO_CONTROLS),s.render(n,d.context).then(function(n,e){s.replaceNodeContents(r,n,e)})}function p(n,e,r,t){switch(cn(r),t.type){case"placeholder":return tn(r);case"add-contact":return u.get_strings([{key:"requirecontacttomessage",component:"core_message",param:t.user.fullname},{key:"isnotinyourcontacts",component:"core_message",param:t.user.fullname}]).then(function(n){var e=n[1],t=n[0],d=dn(r);return d.find(E.TITLE).text(e),d.find(E.TEXT).text(t),rn(r),n});case"edit-mode":return en(r);case"content":return nn(r);case"unblock":return an(r);case"unable-to-message":return sn(r)}return!0}function M(n,e,t,d){var r=f(e);(e=a(e,d).position())&&(d=r.scrollTop()+e.top,r.scrollTop(d))}function D(n,e,t,d){d?(_n(n),mn(n)):(Cn(n),hn(n))}function L(n,e,t,d){d?(W(e),un(e)):(J(e),fn(e))}function U(n,e,t,d){(d?An:Sn)(e)}function G(n,e,t,d){d?In(t):(vn(t),gn(t))}function F(e,t,d,n){return n?u.get_string("blockuserconfirm","core_message",n.fullname).then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_BLOCK],n,"",!0,!1)}):_(e,t,d)}function b(e,t,d,n){return n?u.get_string("unblockuserconfirm","core_message",n.fullname).then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_UNBLOCK],n,"",!0,!1)}):_(e,t,d)}function y(e,t,d,n){return n?u.get_string("addcontactconfirm","core_message",n.fullname).then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_ADD_CONTACT],n,"",!0,!1)}):_(e,t,d)}function B(e,t,d,n){return n?u.get_string("removecontactconfirm","core_message",n.fullname).then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_REMOVE_CONTACT],n,"",!0,!1)}):_(e,t,d)}function k(e,t,d,n){return n?u.get_string("deleteselectedmessagesconfirm","core_message").then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES],n,"",!0,!1)}):_(e,t,d)}function x(e,t,d,n){return n?u.get_string("deleteallconfirm","core_message").then(function(n){return i(e,t,d,[E.ACTION_CONFIRM_DELETE_CONVERSATION],n,"",!0,!1)}):_(e,t,d)}function w(t,d,r,n){return n?u.get_string("userwouldliketocontactyou","core_message",n.fullname).then(function(n){var e=[E.ACTION_ACCEPT_CONTACT_REQUEST,E.ACTION_DECLINE_CONTACT_REQUEST];return i(t,d,r,e,n,"",!1,!0)}):_(t,d,r)}function Q(n,e,t,d){d?(n.find(E.ACTION_REQUEST_BLOCK).addClass("hidden"),n.find(E.ACTION_REQUEST_UNBLOCK).removeClass("hidden")):(n.find(E.ACTION_REQUEST_BLOCK).removeClass("hidden"),n.find(E.ACTION_REQUEST_UNBLOCK).addClass("hidden"))}function V(n,e,t,d){var r=n.find(E.FAVOURITE_ICON_CONTAINER),i=n.find(E.ACTION_CONFIRM_FAVOURITE),a=n.find(E.ACTION_CONFIRM_UNFAVOURITE);switch(d){case"hide":r.addClass("hidden"),i.addClass("hidden"),a.addClass("hidden");break;case"show-add":r.addClass("hidden"),i.removeClass("hidden"),a.addClass("hidden");break;case"show-remove":r.removeClass("hidden"),i.addClass("hidden"),a.removeClass("hidden")}}function H(n,e,t,d){var r=n.find(E.ACTION_REQUEST_ADD_CONTACT),i=n.find(E.ACTION_REQUEST_REMOVE_CONTACT);switch(d){case"pending-contact":r.addClass("hidden"),i.addClass("hidden");break;case"contact":r.addClass("hidden"),i.removeClass("hidden");break;case"non-contact":r.removeClass("hidden"),i.addClass("hidden")}}function P(n,e,t,d){var r=(e=C(e)).find("button"),i=e.find(E.CONFIRM_DIALOGUE_BUTTON_TEXT),e=e.find(E.LOADING_ICON_CONTAINER);d?(r.prop("disabled",!0),i.addClass("hidden"),e.removeClass("hidden")):(r.prop("disabled",!1),i.removeClass("hidden"),e.addClass("hidden"))}function q(n,e,t,d){var r=null;d?((r=e.find(E.MESSAGE_NOT_SELECTED)).find(E.MESSAGE_NOT_SELECTED_ICON).removeClass("hidden"),_n(n),Nn(n)):((r=f(e)).find(E.MESSAGE_NOT_SELECTED_ICON).addClass("hidden"),r.find(E.MESSAGE_SELECTED_ICON).addClass("hidden"),Cn(n),Tn(n))}function K(n,e,t,d){var r=0<d.count;d.add.length&&d.add.forEach(function(n){n=a(e,n);n.find(E.MESSAGE_NOT_SELECTED_ICON).addClass("hidden"),n.find(E.MESSAGE_SELECTED_ICON).removeClass("hidden"),n.attr("aria-checked",!0)}),d.remove.length&&d.remove.forEach(function(n){n=a(e,n);r&&n.find(E.MESSAGE_NOT_SELECTED_ICON).removeClass("hidden"),n.find(E.MESSAGE_SELECTED_ICON).addClass("hidden"),n.attr("aria-checked",!1)}),Rn(n,d.count)}function X(t,d,r,n){return n.show&&!n.hasMessages?u.get_strings([{key:"requirecontacttomessage",component:"core_message",param:n.user.fullname},{key:"isnotinyourcontacts",component:"core_message",param:n.user.fullname}]).then(function(n){var e=n[1],n=n[0];return i(t,d,r,[E.ACTION_REQUEST_ADD_CONTACT],n,e,!1,!0)}):_(t,d,r)}function Y(n,e,t,d){var r=Z(e);return d?u.get_string("yourcontactrequestpending","core_message",d).then(function(n){return r.find(E.TEXT).text(n),r.removeClass("hidden"),n}):(r.addClass("hidden"),!0)}function j(n,e,t){return _(n,e,t),$(e),on(n),mn(n),cn(t),tn(t),!0}var E=n.SELECTORS,o=n.TEMPLATES,z=n.CONVERSATION_TYPES,f=function(n){return n.find(E.CONTENT_MESSAGES_CONTAINER)},J=function(n){f(n).removeClass("hidden")},W=function(n){f(n).addClass("hidden")},Z=function(n){return n.find(E.CONTACT_REQUEST_SENT_MESSAGE_CONTAINER)},$=function(n){return Z(n).addClass("hidden")},nn=function(n){e(n).removeClass("hidden")},en=function(n){t(n).removeClass("hidden")},tn=function(n){r(n).removeClass("hidden")},dn=function(n){return n.find(E.CONTENT_MESSAGES_FOOTER_REQUIRE_CONTACT_CONTAINER)},rn=function(n){dn(n).removeClass("hidden")},an=function(n){N(n).removeClass("hidden")},sn=function(n){T(n).removeClass("hidden")},on=function(n){_n(n),Tn(n),hn(n)},cn=function(n){e(n).addClass("hidden"),t(n).addClass("hidden"),r(n).addClass("hidden"),dn(n).addClass("hidden"),N(n).addClass("hidden"),T(n).addClass("hidden")},un=function(n){O(n).removeClass("hidden")},fn=function(n){O(n).addClass("hidden")},En=function(n){return n.find(E.HEADER)},Cn=function(n){En(n).removeClass("hidden")},_n=function(n){En(n).addClass("hidden")},ln=function(n){return n.find(E.HEADER_EDIT_MODE)},Nn=function(n){ln(n).removeClass("hidden")},Tn=function(n){ln(n).addClass("hidden")},On=function(n){return n.find(E.HEADER_PLACEHOLDER_CONTAINER)},mn=function(n){On(n).removeClass("hidden")},hn=function(n){On(n).addClass("hidden")},a=function(n,e){return f(n).find('[data-message-id="'+e+'"]')},An=function(n){A(n).removeClass("hidden")},Sn=function(n){A(n).addClass("hidden")},In=function(n){var e;(e=n).find(E.SEND_MESSAGE_BUTTON).prop("disabled",!0),m(e).prop("disabled",!0),n.find(E.SEND_MESSAGE_ICON_CONTAINER).addClass("hidden"),n.find(E.LOADING_ICON_CONTAINER).removeClass("hidden")},vn=function(n){var e;(e=n).find(E.SEND_MESSAGE_BUTTON).prop("disabled",!1),m(e).prop("disabled",!1),n.find(E.SEND_MESSAGE_ICON_CONTAINER).removeClass("hidden"),n.find(E.LOADING_ICON_CONTAINER).addClass("hidden")},gn=function(n){n=m(n);n.val(""),n.focus()},C=function(n){return n.find(E.CONFIRM_DIALOGUE_CONTAINER)},Rn=function(n,e){ln(n).find(E.MESSAGES_SELECTED_COUNT).text(e)},pn=function(n,d,e,t,r){var i=f(d),a=t.map(function(n){return s.render(o.DAY,{timestamp:n.value.timestamp,messages:v(n.value.messages,r)})});return c.when.apply(c,a).then(function(){t.forEach(function(t,n){a[n].then(function(n){var e;return t.before?(e=h(d,t.before.timestamp),c(n).insertBefore(e)):i.append(n)}).catch(function(){})})})},Mn=function(n,r,e,t,d){var i=t.map(function(n){return n.value}),i=v(i,d);return s.render(o.MESSAGES,{messages:i}).then(function(n){var d=c(n);t.forEach(function(n){var e,t=d.find('[data-message-id="'+n.value.id+'"]');return n.before?(e=a(r,n.before.id),t.insertBefore(e)):h(r,n.day.timestamp).find(E.DAY_MESSAGES_CONTAINER).append(t)})})},Dn=function(e,n){n.forEach(function(n){h(e,n.timestamp).remove()})},Ln=function(e,n){n.forEach(function(n){a(e,n.id).remove()})},i=function(n,e,t,d,r,i,a,u){var s=C(e),d=d.map(function(n){return s.find(n)}),o=s.find(E.CONFIRM_DIALOGUE_CANCEL_BUTTON),f=s.find(E.CONFIRM_DIALOGUE_TEXT),c=s.find(E.CONFIRM_DIALOGUE_HEADER);s.find("button").addClass("hidden"),a?o.removeClass("hidden"):o.addClass("hidden"),i?(c.removeClass("hidden"),c.text(i)):(c.addClass("hidden"),c.text("")),d.forEach(function(n){n.removeClass("hidden")}),f.text(r),S(t),S(e),u||S(n),s.find(E.CAN_RECEIVE_FOCUS).filter(":visible").first().focus()},_=function(n,e,t){var d=C(e),r=d.find(E.CONFIRM_DIALOGUE_CANCEL_BUTTON),i=d.find(E.CONFIRM_DIALOGUE_TEXT),a=d.find(E.CONFIRM_DIALOGUE_HEADER);return I(e),I(t),I(n),d.find("button").addClass("hidden"),r.removeClass("hidden"),i.text(""),a.addClass("hidden"),a.text(""),n.find(E.CAN_RECEIVE_FOCUS).first().focus(),!0};return{render:function(i,a,s,o){function e(n){var e,t,d,r=[];for(e in o)n.hasOwnProperty(e)&&(t=n[e],d=o[e],r.push(t(i,a,s,d)));return r}var t=[{reset:j},{conversation:g,header:R,footer:p,confirmBlockUser:F,confirmUnblockUser:b,confirmAddContact:y,confirmRemoveContact:B,confirmDeleteSelectedMessages:k,confirmDeleteConversation:x,confirmContactRequest:w,requireAddContact:X,contactRequestSent:Y},{loadingMembers:D,loadingFirstMessages:L,loadingMessages:U,sendingMessage:G,isBlocked:Q,isContact:H,isFavourite:V,loadingConfirmAction:P,inEditMode:q},{scrollToMessage:M,selectedMessages:K}],n=(n=e(t[0])).concat(e(t[1]));return c.when.apply(c,n).then(function(){for(var n=2;n<t.length;n++)e(t[n])}).catch(d.exception)}}});