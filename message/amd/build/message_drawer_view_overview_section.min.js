define(["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core/user_date","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_lazy_load_list","core_message/message_drawer_view_conversation_constants"],function(m,E,O,T,o,N,i,S,f,I,R,C,r){function p(e){return C.getRoot(e).hasClass("show")}function a(e){return e.find(A.SECTION_TOTAL_COUNT)}function t(e){var n;x&&(e=e.find(A.SECTION_UNREAD_COUNT),n=parseInt(e.text()),e.text(n-=1),n<1&&e.addClass("hidden"))}var A={TOGGLE:'[data-region="toggle"]',CONVERSATION:"[data-conversation-id]",BLOCKED_ICON_CONTAINER:'[data-region="contact-icon-blocked"]',LAST_MESSAGE:'[data-region="last-message"]',LAST_MESSAGE_DATE:'[data-region="last-message-date"]',UNREAD_COUNT:'[data-region="unread-count"]',SECTION_TOTAL_COUNT:'[data-region="section-total-count"]',SECTION_TOTAL_COUNT_CONTAINER:'[data-region="section-total-count-container"]',SECTION_UNREAD_COUNT:'[data-region="section-unread-count"]',PLACEHOLDER_CONTAINER:'[data-region="placeholder-container"]'},v={CONVERSATIONS_LIST:"core_message/message_drawer_conversations_list",CONVERSATIONS_LIST_ITEMS_PLACEHOLDER:"core_message/message_drawer_conversations_list_items_placeholder"},L=50,b={},V=!1,x=!1,U=function(e){e.addClass("expanded")},D=function(e){e.removeClass("expanded")},y=function(n,e,a){e=e.map(function(e){var n,t=e.messages.length?e.messages[e.messages.length-1]:null,s={id:e.id,imageurl:e.imageurl,name:e.name,subname:e.subname,unreadcount:e.unreadcount,lastmessagedate:t?t.timecreated:null,sentfromcurrentuser:t?t.useridfrom==a:null,lastmessage:t?m(t.text).text()||t.text:null};return e.type==r.CONVERSATION_TYPES.PRIVATE&&(n=e.members.reduce(function(e,n){return e=e||n.id==a?e:n},null),s.userid=n.id,s.showonlinestatus=n.showonlinestatus,s.isonline=n.isonline,s.isblocked=n.isblocked),e.type==r.CONVERSATION_TYPES.PUBLIC&&(s.lastsendername=e.members.reduce(function(e,n){return e=e||n.id!=t.useridfrom?e:n.fullname},null)),s});return N.render(v.CONVERSATIONS_LIST,{conversations:e}).then(function(e){return n.append(e),e}).catch(O.exception)},h=function(e,n){return e.find('[data-conversation-id="'+n+'"]')},w=function(e,n){return e.find('[data-user-id="'+n+'"]')},P=function(e){e.find(A.BLOCKED_ICON_CONTAINER).removeClass("hidden")},G=function(e){e.find(A.BLOCKED_ICON_CONTAINER).addClass("hidden")},M=function(n,t){var s=t.messages[t.messages.length-1],a="",e=s.fromLoggedInUser?{key:"you",component:"core_message"}:{key:"sender",component:"core_message",param:s.userFrom.fullname};return o.get_strings([e,{key:"strftimetime24",component:"core_langconfig"}]).then(function(e){return a=e[0],i.get([{timestamp:s.timeCreated,format:e[1]}])}).then(function(e){return e[0]}).then(function(e){n.find(A.LAST_MESSAGE_DATE).text(e).removeClass("hidden");e=(a=s.fromLoggedInUser||t.type!==r.CONVERSATION_TYPES.PRIVATE?a:"")+" <span class='text-muted'>"+m(s.text).text()+"</span>";return n.find(A.LAST_MESSAGE).html(e)})},k=function(t,e){var n="",s=(t.find(A.CONVERSATION).length||(s=C.getRoot(t),C.showContent(s),C.hideEmptyMessage(s)),e.messages.length),s=s?e.messages[s-1]:null,s=(s&&(n=m(s.text).text()||s.text),{id:e.id,name:e.name,subname:e.subname,lastmessagedate:s?s.timeCreated:null,sentfromcurrentuser:s?s.fromLoggedInUser:null,lastmessage:n,imageurl:e.imageUrl});return b[e.id]=e,N.render(v.CONVERSATIONS_LIST,{conversations:[s]}).then(function(e){return C.getContentContainer(t).prepend(e)}).then(function(){var e,n;e=t,V&&(e=a(e),n=parseInt(e.text()),e.text(n+=1))}).catch(O.exception)},B=function(e,n){var t;n.remove(),n=e,V&&(n=a(n),t=parseInt(n.text()),n.text(t-=1)),e.find(A.CONVERSATION).length||(n=C.getRoot(e),C.hideContent(n),C.showEmptyMessage(n))},F=function(e,n){n=n.find(A.UNREAD_COUNT);n.text("0"),n.addClass("hidden"),t(e)};return{show:function(s,e,n,d,l){var t,a,r,o,i,c,_,g,u;(s=m(s)).attr("data-init")||(u=0,a=s,r=t=function(n,e){return S.getConversations(e,_,L+1,u,g).then(function(e){e=e.conversations;return e.length>L?e=e.slice(0,-1):C.setLoadedAll(n,!0),u+=L,e.forEach(function(e){b[e.id]=e}),e}).catch(O.exception)},o=_=e,i=g=n,c=C.getRoot(a),e=a.find(A.TOGGLE),a.css("min-height",e.outerHeight()),a.on("show.bs.collapse",function(){U(a),C.show(c,r,y)}),a.on("hidden.bs.collapse",function(){D(a)}),T.subscribe(f.CONTACT_BLOCKED,function(e){e=w(a,e);e.length&&P(e)}),T.subscribe(f.CONTACT_UNBLOCKED,function(e){e=w(a,e);e.length&&G(e)}),T.subscribe(f.CONVERSATION_NEW_LAST_MESSAGE,function(e){var n;o&&e.type!=o||i&&!e.isFavourite||!i&&e.isFavourite||(n=e.id,(n=h(a,n)).length?M(n,e):k(a,e))}),T.subscribe(f.CONVERSATION_DELETED,function(e){e=h(a,e);e.length&&B(a,e)}),T.subscribe(f.CONVERSATION_READ,function(e){e=h(a,e);e.length&&F(a,e)}),T.subscribe(f.CONVERSATION_SET_FAVOURITE,function(e){var n=null;!i||o&&o!=e.type?o==e.type&&(n=h(a,e.id)).length&&B(a,n):(n=h(a,e.id)).length||k(a,e)}),T.subscribe(f.CONVERSATION_UNSET_FAVOURITE,function(e){var n=null;i?(n=h(a,e.id)).length&&B(a,n):o==e.type&&((n=h(a,e.id)).length||k(a,e))}),E.define(a,[E.events.activate]),a.on(E.events.activate,A.CONVERSATION,function(e,n){e=m(e.target).closest(A.CONVERSATION).attr("data-conversation-id"),e=b[e];I.go(R.VIEW_CONVERSATION,e),n.originalEvent.preventDefault()}),p(s)&&(U(s),n=C.getRoot(s),C.show(n,t,y)),d.then(function(e){var n=s,t=n.find(A.SECTION_TOTAL_COUNT_CONTAINER);t.find(A.SECTION_TOTAL_COUNT).text(e),t.removeClass("hidden"),t=Array.apply(null,Array(20<e?20:e)).map(function(){return!0}),N.render(v.CONVERSATIONS_LIST_ITEMS_PLACEHOLDER,{placeholders:t}).then(function(e){n.find(A.PLACEHOLDER_CONTAINER).html(e)}).catch(function(){}),V=!0}).catch(function(){}),l.then(function(e){var n=s;(n=n.find(A.SECTION_UNREAD_COUNT)).text(e),0<e&&n.removeClass("hidden"),x=!0}).catch(function(){}),s.attr("data-init",!0))},isVisible:p}});