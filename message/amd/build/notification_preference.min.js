define(["jquery","core/ajax","core/notification","core_message/notification_processor"],function(n,t,i,o){function e(e,t){this.root=n(e),this.userId=t}var r="[data-processor-name]",s="[data-state] input";return e.prototype.getPreferenceKey=function(){return this.root.attr("data-preference-key")},e.prototype.getLoggedInPreferenceKey=function(){return this.getPreferenceKey()+"_loggedin"},e.prototype.getLoggedOffPreferenceKey=function(){return this.getPreferenceKey()+"_loggedoff"},e.prototype.getProcessors=function(){return this.root.find(r).map(function(e,t){return new o(n(t))})},e.prototype.startLoading=function(){this.root.addClass("loading"),this.root.find(s).prop("disabled",!0)},e.prototype.stopLoading=function(){this.root.removeClass("loading"),this.root.find(s).prop("disabled",!1)},e.prototype.isLoading=function(){return this.root.hasClass("loading")},e.prototype.save=function(){if(this.isLoading())return n.Deferred().resolve();this.startLoading();var o="",r="",e=(this.getProcessors().each(function(e,t){t.isLoggedInEnabled()&&(""===o?o=t.getName():o+=","+t.getName()),t.isLoggedOffEnabled()&&(""===r?r=t.getName():r+=","+t.getName())}),""===o&&(o="none"),""===r&&(r="none"),{userid:this.userId,preferences:[{type:this.getLoggedInPreferenceKey(),value:o},{type:this.getLoggedOffPreferenceKey(),value:r}]});return t.call([{methodname:"core_user_update_user_preferences",args:e}])[0].fail(i.exception).always(function(){this.stopLoading()}.bind(this))},e});