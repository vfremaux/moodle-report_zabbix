define(["jquery","core/notification","core/str","core/pubsub","core/templates","core_message/message_repository","core/custom_interaction_events","core_message/message_drawer_events"],function(c,a,e,t,s,i,o,r){function E(e,n){return i.savePreferences(e,n).then(function(){t.publish(r.PREFERENCES_UPDATED,n)}).catch(a.exception)}var d={CHECKBOX:'input[type="checkbox"]',SETTINGS:'[data-region="settings"]',PRIVACY_PREFERENCE:'[data-preference="blocknoncontacts"] input[type="radio"]',NOTIFICATIONS_PREFERENCE:'[data-preference="notifications"] input[type="checkbox"]',ENTER_TO_SEND_PREFERENCE:'[data-preference="entertosend"] input[type="checkbox"]',NOTIFICATION_PREFERENCES_CONTAINER:'[data-region="notification-preference-container"]',CONTENT_CONTAINER:'[data-region="content-container"]',PLACEHOLDER_CONTAINER:'[data-region="placeholder-container"]'},_={NOTIFICATION_PREFERENCES:"core_message/message_drawer_view_settings_body_content_notification_preferences"},p="message_provider_moodle_instantmessage",N=function(e,t){e.find(d.PRIVACY_PREFERENCE).each(function(e,n){(n=c(n)).val()==t?n.prop("checked",!0):n.prop("checked",!1)})},f=function(e,n){e=e.find(d.ENTER_TO_SEND_PREFERENCE);n?e.prop("checked",!0):e.prop("checked",!1)},g=function(e,n){e=e.find(d.SETTINGS);o.define(e,[o.events.activate]),e.on(o.events.activate,d.NOTIFICATIONS_PREFERENCE,function(e){var e=c(e.target).closest(d.NOTIFICATION_PREFERENCES_CONTAINER).find(d.CHECKBOX);e.length&&(e=(e=e.toArray().reduce(function(e,n){return(n=c(n)).prop("checked")&&e.push(n.attr("data-name")),e},[])).length?e.join(","):"none",E(n,[{type:"message_provider_moodle_instantmessage_loggedoff",value:e},{type:"message_provider_moodle_instantmessage_loggedin",value:e}]))}),e.on(o.events.activate,d.PRIVACY_PREFERENCE,function(e){e=c(e.target).val();E(n,[{type:"message_blocknoncontacts",value:e}])}),e.on(o.events.activate,d.ENTER_TO_SEND_PREFERENCE,function(e){e=c(e.target).prop("checked");E(n,[{type:"message_entertosend",value:e}])})};return{show:function(e,n,t){var o,r;return n.attr("data-init")||(o=n,r=t,i.getUserMessagePreferences(r).then(function(e){N(o,e.blocknoncontacts),f(o,e.entertosend);var n=[],t=(e.preferences.components.length&&e.preferences.components.forEach(function(e){e.notifications.length&&e.notifications.filter(function(e){return e.preferencekey==p}).length&&(e=e.notifications[0],n=e.processors.map(function(e){var n=e.loggedin.checked||e.loggedoff.checked;return{displayname:e.displayname,name:e.name,checked:n,locked:e.locked,lockedmessage:e.lockedmessage||null}}))}),o.find(d.NOTIFICATION_PREFERENCES_CONTAINER));return!n.length||(t.removeClass("hidden"),s.render(_.NOTIFICATION_PREFERENCES,{processors:n}).then(function(e){return t.append(e),e}))}).then(function(){o.find(d.CONTENT_CONTAINER).removeClass("hidden"),o.find(d.PLACEHOLDER_CONTAINER).addClass("hidden"),g(o,r)}).catch(a.exception),n.attr("data-init",!0)),c.Deferred().resolve().promise()},description:function(){return e.get_string("messagedrawerviewsettings","core_message")}}});