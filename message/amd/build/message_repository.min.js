define(["jquery","core/ajax","core/notification"],function(r,c,n){function s(n,e){return e=e.map(function(e){return{touserid:n,text:e}}),c.call([{methodname:"core_message_send_instant_messages",args:{messages:e}}])[0].then(function(e){var n=e.reduce(function(e,n){return n.errormessage&&e.push(n.errormessage),e},[]);if(n.length)throw new Error(n.join("\n"));return e}).then(function(e){return e.map(function(e){return{id:e.msgid,text:e.text,timecreated:e.timecreated,useridfrom:e.useridfrom,conversationid:e.conversationid}})})}function t(e,n){return n=n.map(function(e){return{text:e}}),c.call([{methodname:"core_message_send_messages_to_conversation",args:{conversationid:e,messages:n}}])[0]}var o=1;return{query:function(e){void 0===e.limit&&(e.limit=0),void 0===e.offset&&(e.offset=0),void 0===e.type&&(e.type=null),void 0===e.favouritesonly&&(e.favouritesonly=!1),e.limitfrom=e.offset,e.limitnum=e.limit,delete e.limit,delete e.offset;e=c.call([{methodname:"core_message_data_for_messagearea_conversations",args:e}])[0];return e.fail(n.exception),e},countUnreadConversations:function(e){e=c.call([{methodname:"core_message_get_unread_conversations_count",args:e}])[0];return e.fail(n.exception),e},markAllAsRead:function(e){e=c.call([{methodname:"core_message_mark_all_messages_as_read",args:e}])[0];return e.fail(n.exception),e},getContacts:function(e,n,r){e={userid:e};return void 0!==n&&(e.limitnum=n),void 0!==r&&(e.limitfrom=r),c.call([{methodname:"core_message_get_user_contacts",args:e}])[0]},getProfile:function(e,n){return c.call([{methodname:"core_message_data_for_messagearea_get_profile",args:{currentuserid:e,otheruserid:n}}])[0]},blockUser:function(e,n){return r.when.apply(null,c.call([{methodname:"core_message_block_user",args:{userid:e,blockeduserid:n}},{methodname:"core_message_get_member_info",args:{referenceuserid:e,userids:[n],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(e,n){return n.length?n[0]:{}})},unblockUser:function(e,n){return r.when.apply(null,c.call([{methodname:"core_message_unblock_user",args:{userid:e,unblockeduserid:n}},{methodname:"core_message_get_member_info",args:{referenceuserid:e,userids:[n],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(e,n){return n.length?n[0]:{}})},createContactRequest:function(e,n){return c.call([{methodname:"core_message_create_contact_request",args:{userid:e,requesteduserid:n}}])[0]},deleteContacts:function(e,n){return r.when.apply(null,c.call([{methodname:"core_message_delete_contacts",args:{userid:e,userids:n}},{methodname:"core_message_get_member_info",args:{referenceuserid:e,userids:n,includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(e,n){return n})},getMessages:function(e,n,r,s,t,o){e={currentuserid:e,convid:n,newest:!!t};return void 0!==r&&(e.limitnum=r),void 0!==s&&(e.limitfrom=s),void 0!==o&&(e.timefrom=o),c.call([{methodname:"core_message_get_conversation_messages",args:e}])[0]},searchUsers:function(e,n,r,s){e={userid:e,search:n};return void 0!==r&&(e.limitnum=r),void 0!==s&&(e.limitfrom=s),c.call([{methodname:"core_message_message_search_users",args:e}])[0]},searchMessages:function(e,n,r,s){e={userid:e,search:n};return void 0!==r&&(e.limitnum=r),void 0!==s&&(e.limitfrom=s),c.call([{methodname:"core_message_data_for_messagearea_search_messages",args:e}])[0]},sendMessagesToUser:s,sendMessageToUser:function(e,n){return s(e,[n]).then(function(e){return e[0]})},sendMessagesToConversation:t,sendMessageToConversation:function(e,n){return t(e,[n]).then(function(e){return e[0]})},savePreferences:function(e,n){return c.call([{methodname:"core_user_update_user_preferences",args:{userid:e,preferences:n}}])[0]},getPreferences:function(e){return c.call([{methodname:"core_user_get_user_preferences",args:{userid:e}}])[0]},deleteMessages:function(n,e){return r.when.apply(null,c.call(e.map(function(e){return{methodname:"core_message_delete_message",args:{messageid:e,userid:n}}})))},deleteConversation:function(e,n){return c.call([{methodname:"core_message_delete_conversations_by_id",args:{userid:e,conversationids:[n]}}])[0]},getContactRequests:function(e){return c.call([{methodname:"core_message_get_contact_requests",args:{userid:e}}])[0]},acceptContactRequest:function(e,n){return r.when.apply(null,c.call([{methodname:"core_message_confirm_contact_request",args:{userid:e,requesteduserid:n}},{methodname:"core_message_get_member_info",args:{referenceuserid:n,userids:[e],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(e,n){return n.length?n[0]:{}})},declineContactRequest:function(e,n){return r.when.apply(null,c.call([{methodname:"core_message_decline_contact_request",args:{userid:e,requesteduserid:n}},{methodname:"core_message_get_member_info",args:{referenceuserid:n,userids:[e],includecontactrequests:!0,includeprivacyinfo:!0}}])).then(function(e,n){return n.length?n[0]:{}})},getConversation:function(e,n,r,s,t,o,a,i,u){e={userid:e,conversationid:n};return null!=r&&(e.includecontactrequests=r),null!=s&&(e.includeprivacyinfo=s),null!=t&&(e.memberlimit=t),null!=o&&(e.memberoffset=o),null!=a&&(e.messagelimit=a),null!=i&&(e.messageoffset=i),null!=u&&(e.newestmessagesfirst=u),c.call([{methodname:"core_message_get_conversation",args:e}])[0]},getConversationBetweenUsers:function(e,n,r,s,t,o,a,i,u){e={userid:e,otheruserid:n};return null!=r&&(e.includecontactrequests=r),null!=s&&(e.includeprivacyinfo=s),null!=t&&(e.memberlimit=t),null!=o&&(e.memberoffset=o),null!=a&&(e.messagelimit=a),null!=i&&(e.messageoffset=i),null!=u&&(e.newestmessagesfirst=u),c.call([{methodname:"core_message_get_conversation_between_users",args:e}])[0]},getConversations:function(e,n,r,s,t){e={userid:e,type:n};return null!=r&&(e.limitnum=r),null!=s&&(e.limitfrom=s),null!=t&&(e.favourites=t),c.call([{methodname:"core_message_get_conversations",args:e}])[0].then(function(e){return e.conversations.length&&(e.conversations=e.conversations.map(function(e){var n;return e.type!=o||(n=e.members.length?e.members[0]:null)&&(e.name=e.name||n.fullname,e.imageurl=e.imageurl||n.profileimageurl),e})),e})},getConversationMembers:function(e,n,r,s,t){n={userid:n,conversationid:e};return null!=r&&(n.limitnum=r),null!=s&&(n.limitfrom=s),null!=t&&(n.includecontactrequests=t),c.call([{methodname:"core_message_get_conversation_members",args:n}])[0]},setFavouriteConversations:function(e,n){return c.call([{methodname:"core_message_set_favourite_conversations",args:{userid:e,conversations:n}}])[0]},unsetFavouriteConversations:function(e,n){return c.call([{methodname:"core_message_unset_favourite_conversations",args:{userid:e,conversations:n}}])[0]},getMemberInfo:function(e,n,r,s){e={referenceuserid:e,userids:n};return void 0!==r&&(e.includecontactrequests=r),void 0!==s&&(e.includeprivacyinfo=s),c.call([{methodname:"core_message_get_member_info",args:e}])[0]},markAllConversationMessagesAsRead:function(e,n){return c.call([{methodname:"core_message_mark_all_conversation_messages_as_read",args:{userid:e,conversationid:n}}])[0]},getUserMessagePreferences:function(e){return c.call([{methodname:"core_message_get_user_message_preferences",args:{userid:e}}])[0]},getTotalConversationCounts:function(e){return c.call([{methodname:"core_message_get_conversation_counts",args:{userid:e}}])[0]},getUnreadConversationCounts:function(e){return c.call([{methodname:"core_message_get_unread_conversation_counts",args:{userid:e}}])[0]},getAllConversationCounts:function(e){return r.when.apply(null,c.call([{methodname:"core_message_get_conversation_counts",args:{userid:e}},{methodname:"core_message_get_unread_conversation_counts",args:{userid:e}}])).then(function(e,n){return{total:e,unread:n}})}}});