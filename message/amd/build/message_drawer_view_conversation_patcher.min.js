define(["jquery","core/user_date","core_message/message_drawer_view_conversation_constants"],function(n,a,o){function r(e,n){for(var s=0;s<e.length;s++){var t=e[s];if(n(t))return t}return null}function s(e,n){var s=e.messages.map(function(e){return e.id}),t=n.messages.map(function(e){return e.id});return B(s,t)?null:(s=i(e.messages,e.midnight),t=i(n.messages,n.midnight),e=u(s,t,function(e,n){return e.timestamp==n.timestamp}),{days:P(s,e),messages:S(e.matches)})}function l(e,n){var s=h(e,n),t=D(e,n),e=m(e),r=m(n),i=s&&s.show&&!s.hasMessages,s=s&&!s.show;return!e&&r||i||s||null!==t?{type:o.CONVERSATION_TYPES.PRIVATE,showControls:!i&&!t,context:{id:n.id,name:n.name,subname:n.subname,totalmembercount:n.totalMemberCount,imageurl:n.imageUrl,isfavourite:n.isFavourite,showfavourite:null!==n.id,userid:r.id,showonlinestatus:r.showonlinestatus,isonline:r.isonline,isblocked:r.isblocked,iscontact:r.iscontact}}:null}function d(e,n){return e.totalMemberCount!=n.totalMemberCount?{type:o.CONVERSATION_TYPES.PUBLIC,showControls:!0,context:{id:n.id,name:n.name,subname:n.subname,totalmembercount:n.totalMemberCount,imageurl:n.imageUrl,isfavourite:n.isFavourite,showfavourite:null!==n.id}}:null}function v(e,n){var s=e.messages;if((n=n.messages).length<1)return null;if(s.length<1)return n[n.length-1].id;var e=s[e.messages.length-1],t=n[n.length-1],s=s[0],n=n[0];return e.id!=t.id?t.id:s.id!=n.id?s.id:null}function p(e,n){return!(e.loadingMembers||!n.loadingMembers)||!(e.loadingMembers&&!n.loadingMembers)&&null}function b(e,n){return!(e.loadingMessages||!n.loadingMessages)||!(e.loadingMessages&&!n.loadingMessages)&&null}function M(e,n){return!(e.sendingMessage||!n.sendingMessage)||!(e.sendingMessage&&!n.sendingMessage)&&null}function C(e,n){var s;return n.pendingBlockUserIds.length?(s=n.pendingBlockUserIds[0],n.members[s]):!e.pendingBlockUserIds.length&&null}function I(e,n){var s;return n.pendingUnblockUserIds.length?(s=n.pendingUnblockUserIds[0],n.members[s]):!e.pendingUnblockUserIds.length&&null}function T(e,n){var s;return n.pendingRemoveContactIds.length?(s=n.pendingRemoveContactIds[0],n.members[s]):!e.pendingRemoveContactIds.length&&null}function k(e,n){return!!n.pendingDeleteMessageIds.length||!e.pendingDeleteMessageIds.length&&null}function y(e,n){return!(e.pendingDeleteConversation||!n.pendingDeleteConversation)||!(e.pendingDeleteConversation&&!n.pendingDeleteConversation)&&null}function U(e,n){return e=m(e),n=m(n),e||n?!e&&n?!!n.isblocked||null:!n&&e?!e.isblocked&&null:!(e.isblocked&&!n.isblocked)&&(!(e.isblocked||!n.isblocked)||null):null}function w(e,n){var s=e.isFavourite,t=n.isFavourite;return null===e.id&&null===n.id?null:null===e.id&&null!==n.id?"show-add":null!==e.id&&null===n.id?"hide":s==t?null:!s&&t?"show-remove":s&&!t?"show-add":null}function q(e,n){var s=e.loggedInUserId,t=m(e),r=m(n),e=t?t.contactrequests.filter(function(e){return e.userid==s&&e.requesteduserid==t.id||e.userid==t.id&&e.requesteduserid==s}):[],n=r?r.contactrequests.filter(function(e){return e.userid==s&&e.requesteduserid==r.id||e.userid==r.id&&e.requesteduserid==s}):[],e=0<e.length,n=0<n.length;return!t&&!r||e&&n?null:e||!n||r.iscontact?!t&&r?r.iscontact?"contact":null:!r&&t?t.iscontact?"non-contact":null:t.iscontact&&!r.iscontact?n?"pending-contact":"non-contact":!t.iscontact&&r.iscontact?"contact":null:"pending-contact"}function A(e,n){return!(e.loadingConfirmAction||!n.loadingConfirmAction)||!(e.loadingConfirmAction&&!n.loadingConfirmAction)&&null}function F(e,n){return e=e.selectedMessageIds,n=n.selectedMessageIds,B(e,n)?null:(e=u(e,n,function(e,n){return e==n}),{count:n.length,add:e.missingFromA,remove:e.missingFromB})}function E(e,s){var n=c(e,s),t=g(e,s),r=h(e,s),i=N(e,s),e=j(e,s),d=null!==r?r.show&&r.hasMessages:null,o=m(s);if(null===n&&null===t&&null===r&&null===i)return null;for(var u=[[n,{type:"placeholder"}],[t,{type:"edit-mode"}],[e,{type:"unable-to-message"}],[i,{type:"unblock"}],[d,{type:"add-contact",user:o}]],a=0;a<u.length;a++){var l=function(e,n){if(e)return n;if(null!==e&&!e){if(!o)return{type:"content"};if(o.isblocked)return{type:"unblock"};if(s.messages.length&&f(s.loggedInUserId,o))return{type:"add-contact",user:o};if(!o.canmessage||o.requirescontact&&!o.iscontact)return{type:"unable-to-message"}}return null}(u[a][0],u[a][1]);if(null!==l)return l}return{type:"content"}}function L(e,n){var s=c(e,n),e=g(e,n);return null===s&&null===e?null:s?{type:"placeholder"}:e?{type:"edit-mode"}:{type:"content"}}function O(e,n){var s=e.type,t=n.type,r=e.id,i=n.id,e=Object.keys(e.members),o=Object.keys(n.members),n=(e.sort(),o.sort(),e.every(function(e,n){return e==o[n]}));return s!=t||(!(!r||i)||(!(!r||!i||r==i)||(!(r||i||n)||null)))}function R(e,n){var s=n.loggedInUserId,t=m(e),n=m(n),r=t?t.contactrequests.filter(function(e){return e.userid==s}):[],i=n?n.contactrequests.filter(function(e){return e.userid==s}):[],r=0<r.length,i=0<i.length,o=0<e.messages.length,e=0<e.messages.length;return r||!i||n.iscontact||e?!(t&&!t.iscontact&&i&&n.iscontact)&&((!r||i)&&((o||!e)&&null)):n.fullname}var i=function(e,t){var n=e.reduce(function(e,n){var s=a.getUserMidnightForTimestamp(n.timeCreated,t);return e.hasOwnProperty(s)?e[s].push(n):e[s]=[n],e},{});return Object.keys(n).map(function(e){return{timestamp:e,messages:n[e]}})},u=function(e,r,i){r=r.slice();var o=[],u=[];return e.forEach(function(e){for(var n=!1,s=0;s<r.length;s++){var t=r[s];if(i(e,t)){n=!0,u.push({a:e,b:t});break}}n?r.splice(s,1):o.push(e)}),{missingFromA:r,missingFromB:o,matches:u}},B=function(e,s){e.sort(),s.sort();var n=e.length,t=s.length;return n<1&&t<1||n==t&&e.every(function(e,n){return e==s[n]})},P=function(e,n){return{remove:n.missingFromB,add:n.missingFromA.map(function(n){return{before:r(e,function(e){return n.timestamp<e.timestamp}),value:n}})}},S=function(e){var n=[],t=[];return e.forEach(function(e){var s=e.a,e=e.b,e=u(s.messages,e.messages,function(e,n){return e.id==n.id});n=n.concat(e.missingFromB),e.missingFromA.forEach(function(n){var e=r(s.messages,function(e){return n.timeCreated==e.timeCreated?n.id<e.id:n.timeCreated<e.timeCreated});t.push({before:e,value:n,day:s})})}),{add:t,remove:n}},c=function(e,n){return e.hasTriedToLoadMessages===n.hasTriedToLoadMessages?null:!(n.hasTriedToLoadMessages||!n.loadingMessages)||!(n.hasTriedToLoadMessages&&!n.loadingMessages)&&null},_=function(e,n){var s;return n.pendingAddContactIds.length?(s=n.pendingAddContactIds[0],n.members[s]):!e.pendingAddContactIds.length&&null},D=function(e,n){var s=e.loggedInUserId,t=m(e),r=m(n),e=t?t.contactrequests.filter(function(e){return e.requesteduserid==s&&e.userid==t.id}):[],n=r?r.contactrequests.filter(function(e){return e.requesteduserid==s&&e.userid==r.id}):[],e=e.length?e[0]:null,n=n.length?n[0]:null;return!e&&n?r:!(e&&!n)&&null},g=function(e,n){var s=0<e.selectedMessageIds.length,t=0<n.selectedMessageIds.length,e=e.messages.length!=n.messages.length;return!s&&t||(!s||t)&&(s&&e||null)},m=function(s){return Object.keys(s.members).reduce(function(e,n){return e=n==s.loggedInUserId||e?e:s.members[n]},null)},f=function(n,e){var s=0<e.contactrequests.filter(function(e){return e.userid==n||e.requesteduserid}).length;return e.requirescontact&&!e.iscontact&&!s},h=function(e,n){var s=m(e),t=m(n),r=0<e.messages.length,i=0<n.messages.length,o=n.loggedInUserId,u=s&&f(o,s),o=t&&f(o,t),a=_(e,n);if(!e.hasTriedToLoadMessages&&!n.hasTriedToLoadMessages)return null;if(!s&&!t)return null;if(!s&&o)return{show:!0,hasMessages:i,user:t};if(!1===a&&o)return{show:!0,hasMessages:i,user:t};if(e.hasTriedToLoadMessages&&n.hasTriedToLoadMessages){if(!u&&o)return{show:!0,hasMessages:i,user:t};if(u&&!o)return{show:!1,hasMessages:i}}return!e.hasTriedToLoadMessages&&n.hasTriedToLoadMessages&&o?{show:!0,hasMessages:i,user:t}:e.hasTriedToLoadMessages&&!n.hasTriedToLoadMessages&&u?{show:!1,hasMessages:r}:null},N=function(e,n){e=m(e),n=m(n);return e||n?e&&!n?!e.isblocked&&null:!e&&n?!!n.isblocked||null:!(e.isblocked||!n.isblocked)||!(e.isblocked&&!n.isblocked)&&null:null},j=function(e,n){e=m(e),n=m(n);return e||n?e&&!n?!e.canmessage||null:!e&&n?!n.canmessage||null:!(!e.canmessage&&n.canmessage)&&(!(!e.canmessage||n.canmessage)||null):null};return{buildPatch:function(t,r){var e={all:{reset:O,conversation:s,scrollToMessage:v,loadingMembers:p,loadingFirstMessages:c,loadingMessages:b,sendingMessage:M,confirmDeleteSelectedMessages:k,inEditMode:g,selectedMessages:F,isFavourite:w}},i=(e[o.CONVERSATION_TYPES.PRIVATE]={header:l,footer:E,confirmBlockUser:C,confirmUnblockUser:I,confirmAddContact:_,confirmRemoveContact:T,confirmContactRequest:D,confirmDeleteConversation:y,isBlocked:U,isContact:q,loadingConfirmAction:A,requireAddContact:h,contactRequestSent:R},e[o.CONVERSATION_TYPES.PUBLIC]={header:d,footer:L},n.extend({},e.all));return r.type&&r.type in e&&(i=n.extend(i,e[r.type])),Object.keys(i).reduce(function(e,n){var s=(0,i[n])(t,r);return null!==s&&(e[n]=s),e},{})}}});