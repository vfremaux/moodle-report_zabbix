define(["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events","core/str","core_message/message_area_events"],function(s,c,n,h,e,m,a){var i="[data-region='contact']",o="[data-region='contact-icon-blocked']",r="[data-region='contacts'][data-region-content='contacts']",v="[data-region='contacts-area']",d="[data-region='contacts'][data-region-content='conversations']",l="[data-region='course']",p="[data-region='last-message-text']",C="[data-region='last-message-user']",u=".loading-icon",_="[data-region='message-text']",f="[data-region='messaging-area']",E="[data-region=no-contacts]",A="[data-region='search-box']",y="[data-region='search-results-area']",D="[data-region='search-text-area']",N="[data-action='view-contact-msg'].selected",S="[data-action='view-contact-profile'].selected",T="[data-action='show-messages']",g="[data-action='view-contact-msg']",b="[data-action='view-contact-profile']";function t(e){this.messageArea=e,this._init()}return t.prototype._isLoadingConversations=!1,t.prototype._isLoadingContacts=!1,t.prototype._numContactsDisplayed=0,t.prototype._numContactsToRetrieve=20,t.prototype._numConversationsDisplayed=0,t.prototype._numConversationsToRetrieve=20,t.prototype._messageLength=60,t.prototype.messageArea=null,t.prototype._init=function(){e.define(this.messageArea.node,[e.events.activate,e.events.down,e.events.up]),this.messageArea.onCustomEvent(a.MESSAGESEARCHCANCELED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(a.USERSSEARCHCANCELED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(a.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(a.CONVERSATIONDELETED,this._deleteConversation.bind(this)),this.messageArea.onCustomEvent(a.CONVERSATIONSSELECTED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(a.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(a.MESSAGESDELETED,this._updateLastMessage.bind(this)),this.messageArea.onCustomEvent(a.MESSAGESENT,this._handleMessageSent.bind(this)),this.messageArea.onCustomEvent(a.CONTACTREMOVED,function(e,t){this._removeContact(r,t)}.bind(this)),this.messageArea.onCustomEvent(a.CONTACTADDED,function(e,t){this._addContact(t)}.bind(this)),this.messageArea.onCustomEvent(a.CONTACTBLOCKED,function(e,t){this._blockContact(t)}.bind(this)),this.messageArea.onCustomEvent(a.CONTACTUNBLOCKED,function(e,t){this._unblockContact(t)}.bind(this)),this.messageArea.onCustomEvent(a.CHOOSEMESSAGESTODELETE,this._startDeleting.bind(this)),this.messageArea.onCustomEvent(a.CANCELDELETEMESSAGES,this._stopDeleting.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,g,this._viewConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,b,this._viewContact.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,T,this._showMessagingArea.bind(this)),this.messageArea.onDelegateEvent(e.events.up,i,this._selectPreviousContact.bind(this)),this.messageArea.onDelegateEvent(e.events.down,i,this._selectNextContact.bind(this)),this.messageArea.onDelegateEvent(e.events.up,g,this._selectPreviousConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.down,g,this._selectNextConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.up,l,this._selectPreviousCourse.bind()),this.messageArea.onDelegateEvent(e.events.down,l,this._selectNextCourse.bind()),this.messageArea.onDelegateEvent("focus",A,this._setSearching.bind(this)),this.messageArea.onDelegateEvent("blur",A,this._clearSearching.bind(this)),e.define(this.messageArea.find(d),[e.events.scrollBottom]),e.define(this.messageArea.find(r),[e.events.scrollBottom]),this.messageArea.onDelegateEvent(e.events.scrollBottom,d,this._loadConversations.bind(this)),this.messageArea.onDelegateEvent(e.events.scrollBottom,r,this._loadContacts.bind(this)),this.messageArea.showContactsFirst()||(this._numConversationsDisplayed=20)},t.prototype._startDeleting=function(){this.messageArea.find(v).addClass("editing")},t.prototype._stopDeleting=function(){this.messageArea.find(v).removeClass("editing")},t.prototype._viewConversations=function(){0===this._numConversationsDisplayed&&this._loadConversations(),this.messageArea.find(r).hide(),this.messageArea.find(d).show()},t.prototype._viewContacts=function(){0===this._numContactsDisplayed&&this._loadContacts(),this.messageArea.find(d).hide(),this.messageArea.find(r).show()},t.prototype._handleMessageSent=function(e,t,s){this._viewConversations();var n=this._getUserNode(d,t);if(0===n.length){var a=this._getUserNode(r,t);if(0==(a=0===a.length?this._getUserNode(y,t):a).length)return;(n=a.clone()).attr("data-action","view-contact-msg"),this.messageArea.find(d+" "+E).remove(),this._numConversationsDisplayed++}n.prependTo(this.messageArea.find(d)),this.messageArea.find(d).scrollTop(0),this._updateContactText(n,s,!0),this._setSelectedUser("[data-userid='"+t+"']")},t.prototype._loadConversations=function(){if(this._isLoadingConversations)return!1;this._isLoadingConversations=!0;var s=0;return n.render("core/loading",{}).then(function(e,t){return this._numConversationsDisplayed?n.appendNodeContents(this.messageArea.find(d),"<div style='text-align:center'>"+e+"</div>",t):n.replaceNodeContents(this.messageArea.find(d),"<div style='text-align:center'>"+e+"</div>",t),this._getItems("core_message_data_for_messagearea_conversations",this._numConversationsDisplayed,this._numConversationsToRetrieve)}.bind(this)).then(function(e){return s=e.contacts.length,e.isconversation=!0,n.render("core_message/message_area_contacts",e)}).then(function(e,t){this.messageArea.find(d+" "+u).remove(),0<s?(n.appendNodeContents(this.messageArea.find(d),e,t),this._numConversationsDisplayed+=this._numConversationsToRetrieve):this._numConversationsDisplayed||n.replaceNodeContents(this.messageArea.find(d),e,t),this._isLoadingConversations=!1}.bind(this)).fail(h.exception)},t.prototype._loadContacts=function(){if(this._isLoadingContacts)return!1;this._isLoadingContacts=!0;var s=0;return n.render("core/loading",{}).then(function(e,t){return this._numContactsDisplayed?n.appendNodeContents(this.messageArea.find(r),"<div style='text-align:center'>"+e+"</div>",t):n.replaceNodeContents(this.messageArea.find(r),"<div style='text-align:center'>"+e+"</div>",t),this._getItems("core_message_data_for_messagearea_contacts",this._numContactsDisplayed,this._numContactsToRetrieve)}.bind(this)).then(function(e){return s=e.contacts.length,e.isconversation=!1,n.render("core_message/message_area_contacts",e)}).then(function(e,t){this.messageArea.find(r+" "+u).remove(),0<s?(n.appendNodeContents(this.messageArea.find(r),e,t),this._numContactsDisplayed+=s):this._numContactsDisplayed||n.replaceNodeContents(this.messageArea.find(r),e,t),this._isLoadingContacts=!1}.bind(this)).fail(h.exception)},t.prototype._viewConversation=function(e){this.messageArea.trigger(a.CANCELDELETEMESSAGES);var t=s(e.currentTarget).data("userid"),e=s(e.currentTarget).data("messageid"),e=e?"[data-messageid='"+e+"']":"[data-userid='"+t+"']";this._setSelectedUser(e),this.messageArea.trigger(a.CONVERSATIONSELECTED,t),this.messageArea.find(S).removeClass("selected"),this._showMessagingArea()},t.prototype._viewContact=function(e){this.messageArea.trigger(a.CANCELDELETEMESSAGES);e=s(e.currentTarget).data("userid");this._setSelectedUser("[data-userid='"+e+"']"),this.messageArea.trigger(a.CONTACTSELECTED,e),this.messageArea.find(N).removeClass("selected"),this._showMessagingArea()},t.prototype._getItems=function(e,t,s){return c.call([{methodname:e,args:{userid:this.messageArea.getCurrentUserId(),limitfrom:t,limitnum:s}}])[0]},t.prototype._deleteConversation=function(e,t){this._removeContact(d,t),this._numConversationsDisplayed--,this._hideMessagingArea(),this._stopDeleting()},t.prototype._updateLastMessage=function(e,t,s){var n,a,i;s&&(n=this._getUserNode(d,t),a=s.find(_).text().trim(),i=!1,s.data("useridto")==t&&(i=!0),this._updateContactText(n,a,i)),this._stopDeleting()},t.prototype._addContact=function(){this.messageArea.find(r).empty(),this._numContactsDisplayed=0,this._loadContacts()},t.prototype._removeContact=function(e,t){this._getUserNode(e,t).remove(),this._numContactsDisplayed--},t.prototype._blockContact=function(e){var t=this._getUserNode(r,e);t.find(o).removeClass("hidden"),(t=this._getUserNode(d,e)).find(o).removeClass("hidden"),(t=this._getUserNode(y,e)).find(o).removeClass("hidden")},t.prototype._unblockContact=function(e){var t=this._getUserNode(r,e);t.find(o).addClass("hidden"),(t=this._getUserNode(d,e)).find(o).addClass("hidden"),(t=this._getUserNode(y,e)).find(o).addClass("hidden")},t.prototype._getUserNode=function(e,t){return this.messageArea.find(e+" "+i+"[data-userid='"+t+"']")},t.prototype._setSelectedUser=function(e){this.messageArea.find(i).removeClass("selected"),this.messageArea.find(i).attr("aria-pressed",!1),this.messageArea.find(i+e).addClass("selected"),this.messageArea.find(i+e).attr("aria-pressed",!0)},t.prototype._getContactText=function(e){return e.length>this._messageLength&&(e=e.substr(0,this._messageLength-3),e+="..."),document.createTextNode(e)},t.prototype._updateContactText=function(t,e,s){e=this._getContactText(e),s?m.get_string("you","message").done(function(e){t.find(C).empty().append(e)}).always(function(){t.find(p).empty().append(e)}):(t.find(C).empty(),t.find(p).empty().append(e))},t.prototype._selectNextContact=function(e,t){s(e.target).closest(i).next().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._selectPreviousContact=function(e,t){s(e.target).closest(i).prev().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._selectNextCourse=function(e,t){s(e.target).closest(l).next().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._selectPreviousCourse=function(e,t){s(e.target).closest(l).prev().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._selectNextConversation=function(e,t){s(e.target).closest(g).next().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._selectPreviousConversation=function(e,t){s(e.target).closest(g).prev().focus(),t.originalEvent.preventDefault(),t.originalEvent.stopPropagation()},t.prototype._setSearching=function(){s(D).addClass("searching")},t.prototype._clearSearching=function(){s(D).removeClass("searching")},t.prototype._showMessagingArea=function(){this.messageArea.find(f).removeClass("hide-messages").addClass("show-messages")},t.prototype._hideMessagingArea=function(){this.messageArea.find(f).removeClass("show-messages").addClass("hide-messages")},t});