define(["jquery","core/ajax","core/templates","core/str","core/url","core/notification","core/custom_interaction_events","core/popover_region_controller","message_popup/notification_repository","message_popup/notification_area_events"],function(o,u,a,t,s,l,n,i,e,c){function r(t){i.call(this,t),this.markAllReadButton=this.root.find(d),this.unreadCount=0,this.userId=this.root.attr("data-userid"),this.container=this.root.find(f),this.limit=20,this.offset=0,this.loadedAll=!1,this.initialLoad=!1,this.unreadCount=this.root.find(h).html()}var d='[data-action="mark-all-read"]',f='[data-region="all-notifications"]',p='[data-region="notification-content-item-container"]',g='[data-region="notification-content-item-container"].unread',m='[data-action="content-item-link"]',h='[data-region="count-container"]';return((r.prototype=Object.create(i.prototype)).constructor=r).prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?t.get_string("hidenotificationwindow","message").done(function(t){this.menuToggle.attr("aria-label",t)}.bind(this)):this.unreadCount?t.get_string("shownotificationwindowwithcount","message",this.unreadCount).done(function(t){this.menuToggle.attr("aria-label",t)}.bind(this)):t.get_string("shownotificationwindownonew","message").done(function(t){this.menuToggle.attr("aria-label",t)}.bind(this))},r.prototype.getContent=function(){return this.container},r.prototype.getOffset=function(){return this.offset},r.prototype.incrementOffset=function(){this.offset+=this.limit},r.prototype.hasDoneInitialLoad=function(){return this.initialLoad},r.prototype.hasLoadedAllContent=function(){return this.loadedAll},r.prototype.setLoadedAllContent=function(t){this.loadedAll=t},r.prototype.renderUnreadCount=function(){var t=this.root.find(h);this.unreadCount?(t.text(this.unreadCount),t.removeClass("hidden")):t.addClass("hidden")},r.prototype.hideUnreadCount=function(){this.root.find(h).addClass("hidden")},r.prototype.getNotificationElement=function(t){t=this.root.find(p+'[data-id="'+t+'"]');return 1==t.length?t:null},r.prototype.renderNotifications=function(t,i){var e=[];return o.each(t,function(t,n){var i=this.getOffset()-this.limit,i=(n.viewmoreurl=s.relativeUrl("/message/output/popup/notifications.php",{notificationid:n.id,offset:i}),{notificationid:n.id}),i=(n.contexturl&&(i.redirecturl=encodeURIComponent(n.contexturl)),n.contexturl=s.relativeUrl("message/output/popup/mark_notification_read.php",i),a.render("message_popup/notification_content_item",n).then(function(t,n){return{html:t,js:n}}));e.push(i)}.bind(this)),o.when.apply(o,e).then(function(){o.each(arguments,function(t,n){i.append(n.html),a.runTemplateJS(n.js)})})},r.prototype.loadMoreNotifications=function(){if(this.isLoading||this.hasLoadedAllContent())return o.Deferred().resolve();this.startLoading();var t={limit:this.limit,offset:this.getOffset(),useridto:this.userId},i=this.getContent();return e.query(t).then(function(t){var n=t.notifications;return this.unreadCount=t.unreadcount,this.setLoadedAllContent(!n.length||n.length<this.limit),this.initialLoad=!0,this.updateButtonAriaLabel(),!!n.length&&(this.incrementOffset(),this.renderNotifications(n,i))}.bind(this)).always(function(){this.stopLoading()}.bind(this))},r.prototype.markAllAsRead=function(){return this.markAllReadButton.addClass("loading"),e.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.root.find(g).removeClass("unread")}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this))},r.prototype.registerEventListeners=function(){n.define(this.root,[n.events.activate]),this.root.on(n.events.activate,d,function(t,n){this.markAllAsRead(),t.stopPropagation(),n.originalEvent.preventDefault()}.bind(this)),this.root.on(n.events.activate,m,function(t){var n=o(t.target).closest(p);n.hasClass("unread")&&(this.unreadCount--,n.removeClass("unread")),t.stopPropagation()}.bind(this)),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.hasDoneInitialLoad()||this.loadMoreNotifications()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(this.events().startLoading,function(){this.getContent().attr("aria-busy","true")}.bind(this)),this.root.on(this.events().stopLoading,function(){this.getContent().attr("aria-busy","false")}.bind(this)),this.getContentContainer().on(n.events.scrollBottom,function(){this.isLoading||this.hasLoadedAllContent()||this.loadMoreNotifications()}.bind(this)),n.define(this.getContentContainer(),[n.events.scrollLock]),o(document).on(c.notificationShown,function(t,n){n.read||((n=this.getNotificationElement(n.id))&&n.removeClass("unread"),this.unreadCount--,this.renderUnreadCount())}.bind(this))},r});