define(["jquery","core/templates","core/notification","core/custom_interaction_events","message_popup/notification_repository","message_popup/notification_area_events"],function(e,s,f,t,i,o){function n(t,i){this.root=e(t),this.container=this.root.closest(r),this.userId=i,this.content=this.root.find(a),this.offset=0,this.limit=20,this.initialLoad=!1,this.isLoading=!1,this.loadedAll=!1,this.notifications={},this.registerEventListeners()}var r='[data-region="notification-area"]',a='[data-region="content"]',c='[data-region="notification-content-item-container"]',h='input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]',d="message_popup/notification_content_item";return n.prototype.getRoot=function(){return this.root},n.prototype.getContainer=function(){return this.container},n.prototype.getUserId=function(){return this.userId},n.prototype.getContent=function(){return this.content},n.prototype.getOffset=function(){return this.offset},n.prototype.getLimit=function(){return this.limit},n.prototype.setOffset=function(t){this.offset=t},n.prototype.setLimit=function(t){this.limit=t},n.prototype.incrementOffset=function(){this.offset+=this.limit},n.prototype.startLoading=function(){this.isLoading=!0,this.getRoot().addClass("loading")},n.prototype.stopLoading=function(){this.isLoading=!1,this.getRoot().removeClass("loading")},n.prototype.hasDoneInitialLoad=function(){return this.initialLoad},n.prototype.hasLoadedAllContent=function(){return this.loadedAll},n.prototype.setLoadedAllContent=function(t){this.loadedAll=t},n.prototype.setCacheNotification=function(t){this.notifications[t.id]=t},n.prototype.getCacheNotification=function(t){return this.notifications[t]},n.prototype.getNotificationElement=function(t){t=this.getRoot().find(c+'[data-id="'+t+'"]');return 1==t.length?t:null},n.prototype.scrollNotificationIntoView=function(t){var i=t.position(),o=this.getRoot();i.top-o.scrollTop()>o.innerHeight()&&(t=t.outerHeight(),i=i.top-(t*=4),o.scrollTop(i))},n.prototype.showNotification=function(t){var i;(t="object"!=typeof t?this.getNotificationElement(t):t)&&t.length&&(this.getRoot().find(c).removeClass("selected"),t.addClass("selected").find(h).focus(),i=t.attr("data-id"),i=this.getCacheNotification(i),this.scrollNotificationIntoView(t),this.getContainer().trigger(o.showNotification,[e.extend({},i)]))},n.prototype.markNotificationAsRead=function(t){return i.markAsRead(t.attr("data-id")).done(function(){t.removeClass("unread")})},n.prototype.renderNotifications=function(t){var n=[],o=this.getContent();return e.each(t,function(t,o){var e=o.contexturl,i=(delete o.contexturl,s.render(d,o).then(function(t,i){return o.contexturl=e,this.setCacheNotification(o),{html:t,js:i}}.bind(this)));n.push(i)}.bind(this)),e.when.apply(e,n).then(function(){e.each(arguments,function(t,i){o.append(i.html),s.runTemplateJS(i.js)})})},n.prototype.loadMoreNotifications=function(){if(this.isLoading||this.hasLoadedAllContent())return e.Deferred().resolve();this.startLoading();var t={limit:this.getLimit(),offset:this.getOffset(),useridto:this.getUserId()};return this.initialLoad||(t.limit=this.getOffset()+this.getLimit(),t.offset=0),i.query(t).then(function(t){var i=t.notifications;return this.unreadCount=t.unreadcount,this.setLoadedAllContent(!i.length||i.length<this.getLimit()),this.initialLoad=!0,!!i.length&&(this.incrementOffset(),this.renderNotifications(i))}.bind(this)).always(function(){this.stopLoading()}.bind(this))},n.prototype.registerEventListeners=function(){t.define(this.getRoot(),[t.events.activate,t.events.scrollBottom,t.events.scrollLock,t.events.up,t.events.down]),this.getRoot().on(t.events.scrollBottom,function(){this.loadMoreNotifications()}.bind(this)),this.getRoot().on(t.events.activate,c,function(t){t=e(t.target).closest(c);this.showNotification(t)}.bind(this)),this.getRoot().on(t.events.up,c,function(t,i){t=e(t.target).closest(c);this.showNotification(t.prev()),i.originalEvent.preventDefault()}.bind(this)),this.getRoot().on(t.events.down,c,function(t,i){t=e(t.target).closest(c);this.showNotification(t.next()),i.originalEvent.preventDefault()}.bind(this)),this.getContainer().on(o.notificationShown,function(t,i){var o;i.read||((o=this.getNotificationElement(i.id))&&this.markNotificationAsRead(o),(o=this.getCacheNotification(i.id))&&(o.read=!0))}.bind(this))},n});