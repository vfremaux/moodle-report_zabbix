define(["jquery","core/ajax","core/log","core/notification","core/templates","core/config","core/str"],function(l,a,r,i,p,n,m){function o(o){var e=(t=o.split("/")).shift(),t=t.shift(),e=a.call([{methodname:"core_output_load_template",args:{component:e,template:t,themename:n.theme,includecomments:!0}},{methodname:"tool_templatelibrary_load_canonical_template",args:{component:e,template:t}}],!0,!1);l.when.apply(l,e).done(function(e,t){var a=o;m.get_string("templateselected","tool_templatelibrary",a).done(function(e){l('[data-region="displaytemplateheader"]').text(e)}).fail(i.exception);(n=!1===(n=c(e,a))?c(t,a):n)&&(e=n),l('[data-region="displaytemplatesource"]').text(e);var t=e.match(/Example context \(json\):([\s\S]*)/),n=!1;if(t){e=t[1].trim();try{n=l.parseJSON(e)}catch(e){r.debug("Could not parse json example context for template."),r.debug(e)}}(n?p.render(a,n).done(function(e,t){p.replaceNodeContents(l('[data-region="displaytemplateexample"]'),e,t)}):m.get_string("templatehasnoexample","tool_templatelibrary").done(function(e){l('[data-region="displaytemplateexample"]').text(e)})).fail(i.exception)}).fail(i.exception)}var c=function(e,t){if(!e)return!1;var a,n="@template "+t,o=0;if(null!==(a=e.match(/{{!([\s\S]*?)}}/g)))for(o=0;o<a.length;o++){var l=a[o],r=l.indexOf(n);if(-1!==r)return l.substr(r=r+n.length+1,l.length-2-r)}return!1};return l('[data-region="list-templates"]').on("click","[data-templatename]",function(e){var t=l(this).data("templatename");e.preventDefault(),o(t)}),{}});