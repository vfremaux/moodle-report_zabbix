define(["jquery","core/str","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events","core/fragment","tool_dataprivacy/add_purpose","tool_dataprivacy/add_category"],function(i,t,n,r,a,o,p,s,e,m){function d(t,e,o){this.systemContextId=t,this.currentContextLevel=e,this.currentContextId=o,this.init()}var c="[data-context-tree-node=1]",l="#context-form-container";return d.prototype.systemContextId=0,d.prototype.currentContextLevel=0,d.prototype.currentContextId=0,d.prototype.addpurpose=null,d.prototype.addcategory=null,d.prototype.init=function(){this.addpurpose=e.getInstance(this.systemContextId),this.addcategory=m.getInstance(this.systemContextId);this.strings=t.get_strings([{key:"changessaved",component:"moodle"},{key:"contextpurposecategorysaved",component:"tool_dataprivacy"},{key:"noblockstoload",component:"tool_dataprivacy"},{key:"noactivitiestoload",component:"tool_dataprivacy"},{key:"nocoursestoload",component:"tool_dataprivacy"}]),this.registerEventListeners(),this.currentContextId?this.loadForm("context_form",[this.currentContextId],this.submitContextFormAjax.bind(this)):this.loadForm("contextlevel_form",[this.currentContextLevel],this.submitContextLevelFormAjax.bind(this))},d.prototype.registerEventListeners=function(){i(c).on("click",function(t){t.preventDefault();var e,t=i(t.currentTarget),o=(i(c).removeClass("active"),t.addClass("active"),t.data("contextlevel")),n=t.data("contextid");o?(window.history.pushState({},null,"?contextlevel="+o),this.addpurpose.removeListeners(),this.addcategory.removeListeners(),this.currentContextLevel=o,this.loadForm("contextlevel_form",[this.currentContextLevel],this.submitContextLevelFormAjax.bind(this))):n?(window.history.pushState({},null,"?contextid="+n),this.addpurpose.removeListeners(),this.addcategory.removeListeners(),this.currentContextId=n,this.loadForm("context_form",[this.currentContextId],this.submitContextFormAjax.bind(this))):(o=t.data("expandcontextid"),n=t.data("expandelement"),e=t.data("expanded"),n&&(e?this.collapse(t):!t.data("loaded")&&o&&n?(t.find("> i").removeClass("fa-plus"),t.find("> i").addClass("fa-circle-o-notch fa-spin"),this.loadExtra(t,o,n)):this.expand(t)))}.bind(this))},d.prototype.removeListeners=function(){i(c).off("click")},d.prototype.loadForm=function(t,e,o){this.clearForm(),s.loadFragment("tool_dataprivacy",t,this.systemContextId,e).done(function(t,e){i(l).html(t),a.runTemplateJS(e),this.addpurpose.registerEventListeners(),this.addcategory.registerEventListeners(),i(l).on("submit","form",o)}.bind(this)).fail(r.exception)},d.prototype.clearForm=function(){Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()}),i(l).off("submit","form")},d.prototype.submitForm=function(t){t.preventDefault(),i(l).find("form").submit()},d.prototype.submitContextLevelFormAjax=function(t){this.submitFormAjax(t,"tool_dataprivacy_set_contextlevel_form")},d.prototype.submitContextFormAjax=function(t){this.submitFormAjax(t,"tool_dataprivacy_set_context_form")},d.prototype.submitFormAjax=function(t,e){t.preventDefault();var o=i(l).find("form").serialize();return this.strings.then(function(t){n.call([{methodname:e,args:{jsonformdata:JSON.stringify(o)},done:function(){r.alert(t[0],t[1])},fail:r.exception}])}).catch(r.exception)},d.prototype.loadExtra=function(e,t,o){n.call([{methodname:"tool_dataprivacy_tree_extra_branches",args:{contextid:t,element:o},done:function(t){0!=t.branches.length?a.render("tool_dataprivacy/context_tree_branches",t).then(function(t){e.after(t),this.removeListeners(),this.registerEventListeners(),this.expand(e),e.data("loaded",1)}.bind(this)).fail(r.exception):this.noElements(e,o)}.bind(this),fail:r.exception}])},d.prototype.noElements=function(o,n){o.data("expandcontextid",""),o.data("expandelement",""),this.strings.then(function(t){var e=2;"module"==n?e=3:"course"==n&&(e=4),o.text(t[e])}).fail(r.exception)},d.prototype.collapse=function(t){t.data("expanded",0),t.siblings("nav").addClass("hidden"),t.find("> i").removeClass("fa-minus"),t.find("> i").addClass("fa-plus")},d.prototype.expand=function(t){t.data("expanded",1),t.siblings("nav").removeClass("hidden"),t.find("> i").removeClass("fa-plus"),t.find("> i").removeClass("fa-circle-o-notch fa-spin"),t.find("> i").addClass("fa-minus")},{init:function(t,e,o){return new d(t,e,o)}}});