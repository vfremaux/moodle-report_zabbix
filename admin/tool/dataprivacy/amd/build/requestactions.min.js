define(["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates","tool_dataprivacy/data_request_modal","tool_dataprivacy/events"],function(c,a,r,i,n,s,o,u,p){function e(){this.registerEvents()}var t='[data-action="approve"]',y='[data-action="deny"]',v='[data-action="view"]',f='[data-action="complete"]',m='[id="confirm-bulk-action"]',_='[data-action="selectall"]',l=1,k=2,h=".selectrequests";function g(e){return{wsfunction:"tool_dataprivacy_approve_data_request",wsparams:{requestid:e}}}function q(e){return{wsfunction:"tool_dataprivacy_deny_data_request",wsparams:{requestid:e}}}function d(e,t){var a=[];switch(e){case p.approve:a=[{key:"approverequest",component:"tool_dataprivacy"},{key:"confirmapproval",component:"tool_dataprivacy"}];break;case p.bulkApprove:a=[{key:"bulkapproverequests",component:"tool_dataprivacy"},{key:"confirmbulkapproval",component:"tool_dataprivacy"}];break;case p.deny:a=[{key:"denyrequest",component:"tool_dataprivacy"},{key:"confirmdenial",component:"tool_dataprivacy"}];break;case p.bulkDeny:a=[{key:"bulkdenyrequests",component:"tool_dataprivacy"},{key:"confirmbulkdenial",component:"tool_dataprivacy"}];break;case p.complete:a=[{key:"markcomplete",component:"tool_dataprivacy"},{key:"confirmcompletion",component:"tool_dataprivacy"}]}var o="";i.get_strings(a).then(function(e){o=e[0];e=e[1];return n.create({title:o,body:e,type:n.types.SAVE_CANCEL})}).then(function(e){e.setSaveButtonText(o),e.getRoot().on(s.save,function(){w(t.wsfunction,t.wsparams)}),e.getRoot().on(s.hidden,function(){e.destroy()}),e.show()}).catch(r.exception)}function w(e,t){a.call([{methodname:e,args:t}])[0].done(function(e){e.result?window.location.reload():r.addNotification({message:e.warnings[0].message,type:"error"})}).fail(r.exception)}return e.prototype.registerEvents=function(){c(v).click(function(e){e.preventDefault();var t=c(this).data("requestid"),e=a.call([{methodname:"tool_dataprivacy_get_data_request",args:{requestid:t}}]);c.when(e[0]).then(function(e){return e.result||(r.addNotification({message:e.warnings[0].message,type:"error"}),!1)}).then(function(e){var t=o.render("tool_dataprivacy/request_details",e),a={approvedeny:e.approvedeny,canmarkcomplete:e.canmarkcomplete};return n.create({title:e.typename,body:t,type:u.TYPE,large:!0,templateContext:a})}).then(function(e){e.getRoot().on(p.approve,function(){d(p.approve,g(t))}),e.getRoot().on(p.deny,function(){d(p.deny,q(t))}),e.getRoot().on(p.complete,function(){w("tool_dataprivacy_mark_complete",{requestid:t})}),e.getRoot().on(s.hidden,function(){e.destroy()}),e.show()}).catch(r.exception)}),c(t).click(function(e){e.preventDefault();e=c(this).data("requestid");d(p.approve,g(e))}),c(y).click(function(e){e.preventDefault();e=c(this).data("requestid");d(p.deny,q(e))}),c(f).click(function(e){e.preventDefault();e=c(this).data("requestid");d(p.complete,{wsfunction:"tool_dataprivacy_mark_complete",wsparams:{requestid:e}})}),c(m).click(function(){var e=[],t="",a={},o=[{key:"selectbulkaction",component:"tool_dataprivacy"},{key:"selectdatarequests",component:"tool_dataprivacy"},{key:"ok"}],n=parseInt(c("#bulk-action").val());if(n==l||n==k)if(c(".selectrequests:checked").each(function(){e.push(c(this).val())}),e.length<1)i.get_strings(o).done(function(e){r.alert("",e[1],e[2])}).fail(r.exception);else{switch(n){case l:t=p.bulkApprove,a={wsfunction:"tool_dataprivacy_bulk_approve_data_requests",wsparams:{requestids:e}};break;case k:t=p.bulkDeny,a={wsfunction:"tool_dataprivacy_bulk_deny_data_requests",wsparams:{requestids:e}}}d(t,a)}else i.get_strings(o).done(function(e){r.alert("",e[0],e[2])}).fail(r.exception)}),c(_).change(function(e){e.preventDefault();e=c(this).is(":checked");c(h).prop("checked",e)})},e});