define(["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events","core/templates"],function(l,d,s,u,p,v,_){function t(){this.registerEvents()}var e='[data-action="edit-level-defaults"]',o='[data-action="new-activity-defaults"]',a='[data-action="edit-activity-defaults"]',n='[data-action="delete-activity-defaults"]';function y(t,e,o,a,n,i,c,r){null!==o&&i.forEach(function(t){t.id===o&&(t.selected=!0)}),null!==a&&c.forEach(function(t){t.id===a&&(t.selected=!0)});e={contextlevel:e,categoryoptions:i,purposeoptions:c};null!==r&&r.length&&(null===n?e.newactivitydefaults=!0:r.forEach(function(t){n===t.name&&(t.selected=!0)}),e.modemodule=!0,e.activityoptions=r),p.create({title:t,body:_.render("tool_dataprivacy/category_purpose_form",e),type:p.types.SAVE_CANCEL,large:!0}).then(function(t){return t.getRoot().on(v.save,function(){var t=l("#activity"),t=void 0!==t?t.val():null,e=l("#override"),e=void 0!==e&&e.is(":checked");f(l("#contextlevel").val(),l("#category").val(),l("#purpose").val(),t,e)}),t.getRoot().on(v.hidden,function(){t.destroy()}),t.show(),t}).catch(s.exception)}function f(t,e,o,a,n){d.call([{methodname:"tool_dataprivacy_set_context_defaults",args:{contextlevel:t,category:e,purpose:o,override:n,activity:a}}])[0].done(function(t){t.result&&window.location.reload()})}return t.prototype.registerEvents=function(){l(e).click(function(t){t.preventDefault();var t=l(this),a=t.data("contextlevel"),n=t.data("category"),i=t.data("purpose"),t=d.call([{methodname:"tool_dataprivacy_get_category_options",args:{}},{methodname:"tool_dataprivacy_get_purpose_options",args:{}}]),e=u.get_string("editdefaults","tool_dataprivacy",l("#defaults-header").text());l.when(t[0],t[1],e).then(function(t,e,o){t=t.options,e=e.options;return y(o,a,n,i,null,t,e,null),!0}).catch(s.exception)}),l(o).click(function(t){t.preventDefault();var n=l(this).data("contextlevel"),t=d.call([{methodname:"tool_dataprivacy_get_category_options",args:{}},{methodname:"tool_dataprivacy_get_purpose_options",args:{}},{methodname:"tool_dataprivacy_get_activity_options",args:{nodefaults:!0}}]),e=u.get_string("addnewdefaults","tool_dataprivacy");l.when(t[0],t[1],t[2],e).then(function(t,e,o,a){t=t.options,e=e.options,o=o.options;return y(a,n,null,null,null,t,e,o),!0}).catch(s.exception)}),l(a).click(function(t){t.preventDefault();var t=l(this),n=t.data("contextlevel"),i=t.data("category"),c=t.data("purpose"),r=t.data("activityname"),t=d.call([{methodname:"tool_dataprivacy_get_category_options",args:{}},{methodname:"tool_dataprivacy_get_purpose_options",args:{}},{methodname:"tool_dataprivacy_get_activity_options",args:{}}]),e=u.get_string("editmoduledefaults","tool_dataprivacy");l.when(t[0],t[1],t[2],e).then(function(t,e,o,a){t=t.options,e=e.options,o=o.options;return y(a,n,i,c,r,t,e,o),!0}).catch(s.exception)}),l(n).click(function(t){t.preventDefault();var t=l(this),e=t.data("contextlevel"),o=t.data("activityname"),t=t.data("activitydisplayname");p.create({title:u.get_string("deletedefaults","tool_dataprivacy",t),body:_.render("tool_dataprivacy/delete_activity_defaults",{activityname:t}),type:p.types.SAVE_CANCEL,large:!0}).then(function(t){return t.setSaveButtonText(u.get_string("delete")),t.getRoot().on(v.save,function(){f(e,-1,-1,o,!1)}),t.getRoot().on(v.hidden,function(){t.destroy()}),t.show(),!0}).catch(s.exception)})},{init:function(){return new t}}});