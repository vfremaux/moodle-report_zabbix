define(["core/ajax","tool_usertours/tour","jquery","core/templates","core/str","core/log","core/notification"],function(e,r,n,u,t,o,i){var a={tourId:null,currentTour:null,context:null,init:function(t,e,o){a.tourId=t,a.context=o,(e=void 0===e?!0:e)&&a.fetchTour(t),a.addResetLink(),n("body").on("click",'[data-action="tool_usertours/resetpagetour"]',function(t){t.preventDefault(),a.resetTourState(a.tourId)})},fetchTour:function(o){M.util.js_pending("admin_usertour_fetchTour"+o),n.when(e.call([{methodname:"tool_usertours_fetch_and_start_tour",args:{tourid:o,context:a.context,pageurl:window.location.href}}])[0],u.render("tool_usertours/tourstep",{})).then(function(t,e){return a.startBootstrapTour(o,e[0],t.tourconfig)}).always(function(){M.util.js_complete("admin_usertour_fetchTour"+o)}).fail(i.exception)},addResetLink:function(){var o;M.util.js_pending("admin_usertour_addResetLink"),o=n(".tool_usertours-resettourcontainer").length?n(".tool_usertours-resettourcontainer"):n(".logininfo").length?n(".logininfo"):n("footer").length?n("footer"):n("body"),u.render("tool_usertours/resettour",{}).then(function(t,e){u.appendNodeContents(o,t,e)}).always(function(){M.util.js_complete("admin_usertour_addResetLink")}).fail()},startBootstrapTour:function(t,e,o){return a.currentTour&&(o.onEnd=null,a.currentTour.endTour(),delete a.currentTour),o.eventHandlers={afterEnd:[a.markTourComplete],afterRender:[a.markStepShown]},o.tourName=o.name,delete o.name,o.template=e,o.steps=o.steps.map(function(t){return void 0!==t.element&&(t.target=t.element,delete t.element),void 0!==t.reflex&&(t.moveOnClick=!!t.reflex,delete t.reflex),void 0!==t.content&&(t.body=t.content,delete t.content),t}),a.currentTour=new r(o),a.currentTour.startTour()},markStepShown:function(){var t=this.getStepConfig(this.getCurrentStepNumber());n.when(e.call([{methodname:"tool_usertours_step_shown",args:{tourid:a.tourId,context:a.context,pageurl:window.location.href,stepid:t.stepid,stepindex:this.getCurrentStepNumber()}}])[0]).fail(o.error)},markTourComplete:function(){var t=this.getStepConfig(this.getCurrentStepNumber());n.when(e.call([{methodname:"tool_usertours_complete_tour",args:{tourid:a.tourId,context:a.context,pageurl:window.location.href,stepid:t.stepid,stepindex:this.getCurrentStepNumber()}}])[0]).fail(o.error)},resetTourState:function(t){n.when(e.call([{methodname:"tool_usertours_reset_tour",args:{tourid:t,context:a.context,pageurl:window.location.href}}])[0]).then(function(t){t.startTour&&a.fetchTour(t.startTour)}).fail(i.exception)}};return{init:a.init,resetTourState:a.resetTourState}});