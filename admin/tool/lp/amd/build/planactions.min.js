define(["jquery","core/templates","core/ajax","core/notification","core/str","tool_lp/menubar","tool_lp/dialogue"],function(a,o,i,l,p,n,t){function e(e){if("plan"===(this._type=e))this._region='[data-region="plan-page"]',this._planNode='[data-region="plan-page"]',this._template="tool_lp/plan_page",this._contextMethod="tool_lp_data_for_plan_page";else{if("plans"!==e)throw new TypeError("Unexpected type.");this._region='[data-region="plans"]',this._planNode='[data-region="plan-node"]',this._template="tool_lp/plans_page",this._contextMethod="tool_lp_data_for_plans_page"}}return e.prototype._contextMethod=null,e.prototype._planNode=null,e.prototype._region=null,e.prototype._template=null,e.prototype._type=null,e.prototype._getContextArgs=function(e){var n={};return"plan"===this._type?n={planid:e.id}:"plans"===this._type&&(n={userid:e.userid}),n},e.prototype.refresh=function(e){e=this._findPlanData(a(e));this._callAndRefresh([],e)},e.prototype._renderView=function(e){var t=this;return o.render(t._template,e).then(function(e,n){a(t._region).replaceWith(e),o.runTemplateJS(n)})},e.prototype._callAndRefresh=function(e,n){var t="tool_lp/planactions:_callAndRefresh-"+Math.floor(Math.random()*Math.floor(1e3)),o=(M.util.js_pending(t),this);return e.push({methodname:o._contextMethod,args:o._getContextArgs(n)}),a.when.apply(a,i.call(e)).then(function(){return o._renderView(arguments[arguments.length-1])}).fail(l.exception).always(function(){return M.util.js_complete(t)})},e.prototype._doDelete=function(e){var n=[{methodname:"core_competency_delete_plan",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.deletePlan=function(n){var t=this;i.call([{methodname:"core_competency_read_plan",args:{id:n.id}}])[0].done(function(e){p.get_strings([{key:"confirm",component:"moodle"},{key:"deleteplan",component:"tool_lp",param:e.name},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],function(){t._doDelete(n)})}).fail(l.exception)}).fail(l.exception)},e.prototype._doReopenPlan=function(e){var n=[{methodname:"core_competency_reopen_plan",args:{planid:e.id}}];this._callAndRefresh(n,e)},e.prototype.reopenPlan=function(n){var t=this;i.call([{methodname:"core_competency_read_plan",args:{id:n.id}}])[0].done(function(e){p.get_strings([{key:"confirm",component:"moodle"},{key:"reopenplanconfirm",component:"tool_lp",param:e.name},{key:"reopenplan",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],function(){t._doReopenPlan(n)})}).fail(l.exception)}).fail(l.exception)},e.prototype._doCompletePlan=function(e){var n=[{methodname:"core_competency_complete_plan",args:{planid:e.id}}];this._callAndRefresh(n,e)},e.prototype.completePlan=function(n){var t=this;i.call([{methodname:"core_competency_read_plan",args:{id:n.id}}])[0].done(function(e){p.get_strings([{key:"confirm",component:"moodle"},{key:"completeplanconfirm",component:"tool_lp",param:e.name},{key:"completeplan",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],function(){t._doCompletePlan(n)})}).fail(l.exception)}).fail(l.exception)},e.prototype._doUnlinkPlan=function(e){var n=[{methodname:"core_competency_unlink_plan_from_template",args:{planid:e.id}}];this._callAndRefresh(n,e)},e.prototype.unlinkPlan=function(n){var t=this;i.call([{methodname:"core_competency_read_plan",args:{id:n.id}}])[0].done(function(e){p.get_strings([{key:"confirm",component:"moodle"},{key:"unlinkplantemplateconfirm",component:"tool_lp",param:e.name},{key:"unlinkplantemplate",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],function(){t._doUnlinkPlan(n)})}).fail(l.exception)}).fail(l.exception)},e.prototype._doRequestReview=function(e){var n=[{methodname:"core_competency_plan_request_review",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.requestReview=function(e){this._doRequestReview(e)},e.prototype._doCancelReviewRequest=function(e){var n=[{methodname:"core_competency_plan_cancel_review_request",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.cancelReviewRequest=function(e){this._doCancelReviewRequest(e)},e.prototype._doStartReview=function(e){var n=[{methodname:"core_competency_plan_start_review",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.startReview=function(e){this._doStartReview(e)},e.prototype._doStopReview=function(e){var n=[{methodname:"core_competency_plan_stop_review",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.stopReview=function(e){this._doStopReview(e)},e.prototype._doApprove=function(e){var n=[{methodname:"core_competency_approve_plan",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.approve=function(e){this._doApprove(e)},e.prototype._doUnapprove=function(e){var n=[{methodname:"core_competency_unapprove_plan",args:{id:e.id}}];this._callAndRefresh(n,e)},e.prototype.unapprove=function(e){this._doUnapprove(e)},e.prototype._showLinkedCoursesHandler=function(e){e.preventDefault();e=a(e.target).data("id");i.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:e}}])[0].done(function(e){o.render("tool_lp/linked_courses_summary",{courses:e}).done(function(n){p.get_string("linkedcourses","tool_lp").done(function(e){new t(e,n)}).fail(l.exception)}).fail(l.exception)}).fail(l.exception)},e.prototype._eventHandler=function(e,n){n.preventDefault();n=this._findPlanData(a(n.target));this[e](n)},e.prototype._findPlanData=function(e){var e=e.parentsUntil(a(this._region).parent(),this._planNode);if(1!=e.length)throw new Error("The plan node was not located.");if(void 0===(e=e.data())||void 0===e.id)throw new Error("Plan data could not be found.");return e},e.prototype.enhanceMenubar=function(e){n.enhance(e,{'[data-action="plan-delete"]':this._eventHandler.bind(this,"deletePlan"),'[data-action="plan-complete"]':this._eventHandler.bind(this,"completePlan"),'[data-action="plan-reopen"]':this._eventHandler.bind(this,"reopenPlan"),'[data-action="plan-unlink"]':this._eventHandler.bind(this,"unlinkPlan"),'[data-action="plan-request-review"]':this._eventHandler.bind(this,"requestReview"),'[data-action="plan-cancel-review-request"]':this._eventHandler.bind(this,"cancelReviewRequest"),'[data-action="plan-start-review"]':this._eventHandler.bind(this,"startReview"),'[data-action="plan-stop-review"]':this._eventHandler.bind(this,"stopReview"),'[data-action="plan-approve"]':this._eventHandler.bind(this,"approve"),'[data-action="plan-unapprove"]':this._eventHandler.bind(this,"unapprove")})},e.prototype.registerEvents=function(){var e=a(this._region);e.find('[data-action="plan-delete"]').click(this._eventHandler.bind(this,"deletePlan")),e.find('[data-action="plan-complete"]').click(this._eventHandler.bind(this,"completePlan")),e.find('[data-action="plan-reopen"]').click(this._eventHandler.bind(this,"reopenPlan")),e.find('[data-action="plan-unlink"]').click(this._eventHandler.bind(this,"unlinkPlan")),e.find('[data-action="plan-request-review"]').click(this._eventHandler.bind(this,"requestReview")),e.find('[data-action="plan-cancel-review-request"]').click(this._eventHandler.bind(this,"cancelReviewRequest")),e.find('[data-action="plan-start-review"]').click(this._eventHandler.bind(this,"startReview")),e.find('[data-action="plan-stop-review"]').click(this._eventHandler.bind(this,"stopReview")),e.find('[data-action="plan-approve"]').click(this._eventHandler.bind(this,"approve")),e.find('[data-action="plan-unapprove"]').click(this._eventHandler.bind(this,"unapprove")),e.find('[data-action="find-courses-link"]').click(this._showLinkedCoursesHandler.bind(this))},e});