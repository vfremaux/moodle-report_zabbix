define(["jquery","core/str","core/templates","tool_lp/competency_rule"],function(r,e,p,t){function n(){t.apply(this,arguments)}return(n.prototype=Object.create(t.prototype))._container=null,n.prototype._templateLoaded=!1,n.prototype.getConfig=function(){return JSON.stringify({base:{points:this._getRequiredPoints()},competencies:this._getCompetenciesConfig()})},n.prototype._getCompetenciesConfig=function(){var i=[];return this._container.find("[data-competency]").each(function(){var e=r(this),t=e.data("competency"),n=parseInt(e.find('[name="points"]').val(),10),e=e.find('[name="required"]').prop("checked");i.push({id:t,points:n,required:e?1:0})}),i},n.prototype._getRequiredPoints=function(){return parseInt(this._container.find('[name="requiredpoints"]').val()||1,10)},n.prototype.getType=function(){return"core_competency\\competency_rule_points"},n.prototype.injectTemplate=function(t){var i,n=this,e=this._tree.getChildren(this._competency.id),o={base:{points:2},competencies:[]};if(this._templateLoaded=!1,n._competency.ruletype==n.getType())try{o=JSON.parse(n._competency.ruleconfig)}catch(e){}return i={requiredpoints:o&&o.base?o.base.points:2,competency:n._competency,children:[]},r.each(e,function(e,t){var n={id:t.id,shortname:t.shortname,required:!1,points:0};o&&r.each(o.competencies,function(e,t){t.id==n.id&&(n.required=!!t.required,n.points=t.points)}),i.children.push(n)}),p.render("tool_lp/competency_rule_points",i).then(function(e){(n._container=t).html(e),t.find("input").change(function(){n._triggerChange()}),n._templateLoaded=!0,n._triggerChange()})},n.prototype.isValid=function(){if(!this._templateLoaded)return!1;var e=this._getRequiredPoints(),n=0,i=!0;return r.each(this._getCompetenciesConfig(),function(e,t){t.points<0&&(i=!1),n+=t.points}),i=i&&e<=n},n});