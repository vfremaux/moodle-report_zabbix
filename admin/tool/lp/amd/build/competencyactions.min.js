define(["jquery","core/url","core/templates","core/notification","core/str","core/ajax","tool_lp/dragdrop-reorder","tool_lp/tree","tool_lp/dialogue","tool_lp/menubar","tool_lp/competencypicker","tool_lp/competency_outcomes","tool_lp/competencyruleconfig"],function(d,o,i,l,p,m,e,u,f,y,_,g,h){function v(){function t(){var e=d.param(n);window.location=o.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)}var e=d('[data-region="competencyactions"]').data("competency"),n={competencyframeworkid:s.getCompetencyFrameworkId(),pagecontextid:O};null!==e&&(n.parentid=e.id),null!==e&&s.hasRule(e.id)?p.get_strings([{key:"confirm",component:"moodle"},{key:"addingcompetencywillresetparentrule",component:"tool_lp",param:e.shortname},{key:"yes",component:"core"},{key:"no",component:"core"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],t)}).fail(l.exception):t()}function k(e){var t=d(e.getContent()),n=t.find("[data-enhance=movetree]");new u(n,!1).on("selectionchanged",function(e,t){t=t.selected;a=d(t).data("id")}),n.show(),t.on("click",'[data-action="move"]',function(){e.close(),G()}),t.on("click",'[data-action="cancel"]',function(){e.close()})}function w(e){e.preventDefault();var a=d('[data-region="competencyactions"]').data("competency"),e=(r=a.id,m.call([{methodname:"core_competency_search_competencies",args:{competencyframeworkid:a.competencyframeworkid,searchtext:""}},{methodname:"core_competency_read_competency_framework",args:{id:a.competencyframeworkid}}]));d.when.apply(null,e).done(function(e,n){for(var o=[],t=0;t<e.length;t++){var c=e[t];"0"==c.parentid&&(c.children=[],c.haschildren=0,o[o.length]=c,H(c,e))}p.get_strings([{key:"movecompetency",component:"tool_lp",param:a.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(t){i.render("tool_lp/competencies_move_tree",{framework:n,competencies:o}).done(function(e){new f(t[0],e,k)}).fail(l.exception)}).fail(l.exception)}).fail(l.exception)}function x(){var e=d('[data-region="competencyactions"]').data("competency"),e={competencyframeworkid:s.getCompetencyFrameworkId(),id:e.id,parentid:e.parentid,pagecontextid:O},e=d.param(e);window.location=o.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)}function D(e){e.preventDefault(),e=d('[data-region="filtercompetencies"]').data("frameworkid"),m.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:e,search:d('[data-region="filtercompetencies"] input').val()}}])[0].done(n).fail(l.exception)}function C(){var e=d('[data-region="competencyactions"]').data("competency");m.call([{methodname:"core_competency_move_up_competency",args:{id:e.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:e.competencyframeworkid,search:d('[data-region="filtercompetencies"] input').val()}}])[1].done(n).fail(l.exception)}function b(){var e=d('[data-region="competencyactions"]').data("competency");m.call([{methodname:"core_competency_move_down_competency",args:{id:e.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:e.competencyframeworkid,search:d('[data-region="filtercompetencies"] input').val()}}])[1].done(n).fail(l.exception)}function T(){var e=d('[data-region="competencyactions"]').data("competency");m.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:e.id}}])[0].done(function(e){i.render("tool_lp/linked_courses_summary",{courses:e}).done(function(t){p.get_string("linkedcourses","tool_lp").done(function(e){new f(e,t,k)}).fail(l.exception)}).fail(l.exception)}).fail(l.exception)}function E(){var t=d('[data-region="competencyactions"]').data("competency"),e=m.call([{methodname:"core_competency_delete_competency",args:{id:t.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:t.competencyframeworkid,search:d('[data-region="filtercompetencies"] input').val()}}]);e[0].done(function(e){!1===e&&p.get_strings([{key:"competencycannotbedeleted",component:"tool_lp",param:t.shortname},{key:"cancel",component:"moodle"}]).done(function(e){l.alert(null,e[0])}).fail(l.exception)}).fail(l.exception),e[1].done(n).fail(l.exception)}function I(){var e=d('[data-region="competencyactions"]').data("competency"),t="deletecompetency";s.hasRule(e.parentid)&&(t="deletecompetencyparenthasrule"),p.get_strings([{key:"confirm",component:"moodle"},{key:t,component:"tool_lp",param:e.shortname},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],E)}).fail(l.exception)}function R(e){e.originalEvent.dataTransfer.setData("text",d(e.target).parent().data("id"))}function S(e){e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault()}function W(e){e.preventDefault(),d(this).addClass("currentdragtarget")}function J(e){e.preventDefault(),d(this).removeClass("currentdragtarget")}function N(e){e.preventDefault(),r=e.originalEvent.dataTransfer.getData("text"),a=d(e.target).parent().data("id"),d(this).removeClass("currentdragtarget"),G()}function j(o){var e=d.Deferred().resolve().promise(),t={};t.competency=o,t.showdeleterelatedaction=!0,t.showrelatedcompetencies=!0,t.showrule=!1,(e=o.ruleoutcome!=g.NONE?g.getString(o.ruleoutcome).then(function(e){var n;return d.each(L,function(e,t){t.type==o.ruletype&&(n=t.name)}),[e,n]}):e).then(function(e){return void 0!==e&&(t.showrule=!0,t.rule={outcome:e[0],type:e[1]}),t}).then(function(e){return i.render("tool_lp/competency_summary",e)}).then(function(e){return d('[data-region="competencyinfo"]').html(e),d('[data-action="deleterelation"]').on("click",K),i.render("tool_lp/loading",{})}).then(function(e,t){return i.replaceNodeContents('[data-region="relatedcompetencies"]',e,t),m.call([{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:o.id}}])[0]}).then(function(e){return i.render("tool_lp/related_competencies",e)}).then(function(e,t){d('[data-region="relatedcompetencies"]').replaceWith(e),i.runTemplateJS(t),M()}).catch(l.exception)}function F(e,t){var t=t.selected,n=d(t).data("id"),o=d('[data-region="competencyactions"] [data-action="add"]'),c=d('[data-region="competencyactionsmenu"]'),a=d('[data-region="selected-competency"]'),i=0,r=1;return y.closeAll(),void 0===n?(d('[data-region="competencyinfo"]').html(t.clone().children().remove().end().text()),d('[data-region="competencyactions"]').data("competency",null),c.hide()):(t=s.getCompetency(n),r=(i=s.getCompetencyLevel(n))+1,c.show(),d('[data-region="competencyactions"]').data("competency",t),j(t),(n=t).id!==z&&(z=n.id,m.call([{methodname:"core_competency_competency_viewed",args:{id:n.id}}]))),c=i,p.get_string("taxonomy_selected_"+P(c),"tool_lp").then(function(e){a.text(e)}).catch(l.exception),t=r,p.get_string("taxonomy_add_"+P(t),"tool_lp").then(function(e){o.show().find('[data-region="term"]').text(e)}).catch(l.exception),e.preventDefault(),!1}var O,U,q,c,A,L,s=null,r=null,a=null,z=null,B=function(){var e=d('[data-region="filtercompetencies"]').data("frameworkid");m.call([{methodname:"core_competency_set_parent_competency",args:{competencyid:r,parentid:a}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:e,search:d('[data-region="filtercompetencies"] input').val()}}])[1].done(n).fail(l.exception)},G=function(){var e,t,n,o;(a=void 0===a?0:a)!=r&&(e=s.getCompetency(a)||{},o=!(n="movecompetencywillresetrules"),(t=s.getCompetency(r)||{}).parentid!=a&&(e.path&&0<=e.path.indexOf("/"+t.id+"/")&&(n="movecompetencytochildofselfwillresetrules",o=o||s.hasRule(t.id)),(o=o||s.hasRule(e.id)||s.hasRule(t.parentid))?p.get_strings([{key:"confirm",component:"moodle"},{key:n,component:"tool_lp"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(e){l.confirm(e[0],e[1],e[2],e[3],B)}).fail(l.exception):B()))},H=function(e,t){for(var n=0;n<t.length;n++)t[n].parentid==e.id&&(e.haschildren=!0,t[n].children=[],t[n].haschildren=!1,e.children[e.children.length]=t[n],H(t[n],t))},n=function(e){i.render("tool_lp/manage_competencies_page",e).done(function(e,t){d('[data-region="managecompetencies"]').replaceWith(e),i.runTemplateJS(t)}).fail(l.exception)},K=function(e){e.preventDefault();var e=this.id.substr(11),t=d('[data-region="competencyactions"]').data("competency");m.call([{methodname:"core_competency_remove_related_competency",args:{relatedcompetencyid:e,competencyid:t.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:t.id}}])[1].done(function(e){i.render("tool_lp/related_competencies",e).done(function(e){d('[data-region="relatedcompetencies"]').replaceWith(e),M()}).fail(l.exception)}).fail(l.exception)},M=function(){d('[data-action="deleterelation"]').on("click",K)},P=function(e){return A[e]||"competency"};return{init:function(e,t,n,o){s=e,O=t,A=function(e){e=e.split(",");return e.unshift(""),delete e[0],e}(n),L=o,d('[data-region="competencyactions"] [data-action="add"]').on("click",v),y.enhance(".competencyactionsmenu",{'[data-action="edit"]':x,'[data-action="delete"]':I,'[data-action="move"]':w,'[data-action="moveup"]':C,'[data-action="movedown"]':b,'[data-action="linkedcourses"]':T,'[data-action="relatedcompetencies"]':function(){c=d('[data-region="competencyactions"]').data("competency"),U||(U=new _(O,c.competencyframeworkid)).on("save",function(e,t){var t=t.competencyIds,n=[];d.each(t,function(e,t){n.push({methodname:"core_competency_add_related_competency",args:{competencyid:t,relatedcompetencyid:c.id}})}),n.push({methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:c.id}}),m.call(n)[n.length-1].then(function(e){return i.render("tool_lp/related_competencies",e)}).then(function(e,t){d('[data-region="relatedcompetencies"]').replaceWith(e),i.runTemplateJS(t),M()}).catch(l.exception)}),U.setDisallowedCompetencyIDs([c.id]),U.display()}.bind(this),'[data-action="competencyrules"]':function(e){e.preventDefault(),c=d('[data-region="competencyactions"]').data("competency"),q.setTargetCompetencyId(c.id),q.display()}.bind(this)}),d('[data-region="competencyactionsmenu"]').hide(),d('[data-region="competencyactions"] [data-action="add"]').hide(),d('[data-region="filtercompetencies"]').on("submit",D),d('[data-region="managecompetencies"] [data-enhance="tree"]').on("dragstart","li>span",R).on("dragover","li>span",S).on("dragenter","li>span",W).on("dragleave","li>span",J).on("drop","li>span",N),e.on("selectionchanged",F),(q=new h(s,L)).on("save",function(e,t){var n={id:c.id,shortname:c.shortname,idnumber:c.idnumber,description:c.description,descriptionformat:c.descriptionformat,ruletype:t.ruletype,ruleoutcome:t.ruleoutcome,ruleconfig:t.ruleconfig};m.call([{methodname:"core_competency_update_competency",args:{competency:n}}])[0].then(function(e){e&&(c.ruletype=t.ruletype,c.ruleoutcome=t.ruleoutcome,c.ruleconfig=t.ruleconfig,j(c))}).catch(l.exception)}.bind(this))}}});