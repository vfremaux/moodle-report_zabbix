define(["jquery","core/notification","core/ajax","core/templates","core/str","tool_lp/competencypicker","tool_lp/dragdrop-reorder"],function(a,i,m,r,n,t,c){function e(e,t,o){this.itemid=e,this.itemtype=t,this.pageContextId=o,this.pickerInstance=null,a('[data-region="actions"] button').prop("disabled",!1),this.registerEvents(),this.registerDragDrop()}return e.prototype.registerDragDrop=function(){var o=this;n.get_string("movecompetency","tool_lp").done(function(e){c.dragdrop("movecompetency",e,{identifier:"movecompetency",component:"tool_lp"},{identifier:"movecompetencyafter",component:"tool_lp"},"drag-samenode","drag-parentnode","drag-handlecontainer",function(e,t){o.handleDrop(e,t)})}).fail(i.exception)},e.prototype.handleDrop=function(e,t){var e=a(e).data("id"),t=a(t).data("id"),o=this,c=[];if("course"==o.itemtype)c=m.call([{methodname:"core_competency_reorder_course_competency",args:{courseid:o.itemid,competencyidfrom:e,competencyidto:t}}]);else if("template"==o.itemtype)c=m.call([{methodname:"core_competency_reorder_template_competency",args:{templateid:o.itemid,competencyidfrom:e,competencyidto:t}}]);else{if("plan"!=o.itemtype)return;c=m.call([{methodname:"core_competency_reorder_plan_competency",args:{planid:o.itemid,competencyidfrom:e,competencyidto:t}}])}c[0].fail(i.exception)},e.prototype.pickCompetency=function(){var o,c,n,e,p=this;p.pickerInstance||("template"!==p.itemtype&&"course"!==p.itemtype||(e="parents"),p.pickerInstance=new t(p.pageContextId,!1,e),p.pickerInstance.on("save",function(e,t){t=t.competencyIds;"course"===p.itemtype?(o=[],a.each(t,function(e,t){o.push({methodname:"core_competency_add_competency_to_course",args:{courseid:p.itemid,competencyid:t}})}),o.push({methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:p.itemid}}),c="tool_lp/course_competencies_page",n="coursecompetenciespage"):"template"===p.itemtype?(o=[],a.each(t,function(e,t){o.push({methodname:"core_competency_add_competency_to_template",args:{templateid:p.itemid,competencyid:t}})}),o.push({methodname:"tool_lp_data_for_template_competencies_page",args:{templateid:p.itemid,pagecontext:{contextid:p.pageContextId}}}),c="tool_lp/template_competencies_page",n="templatecompetenciespage"):"plan"===p.itemtype&&(o=[],a.each(t,function(e,t){o.push({methodname:"core_competency_add_competency_to_plan",args:{planid:p.itemid,competencyid:t}})}),o.push({methodname:"tool_lp_data_for_plan_page",args:{planid:p.itemid}}),c="tool_lp/plan_page",n="plan-page"),m.call(o)[o.length-1].then(function(e){return r.render(c,e)}).then(function(e,t){a('[data-region="'+n+'"]').replaceWith(e),r.runTemplateJS(t)}).catch(i.exception)})),p.pickerInstance.display()},e.prototype.doDelete=function(e){var t=this,o=[],c="",n="";"course"==t.itemtype?(o=m.call([{methodname:"core_competency_remove_competency_from_course",args:{courseid:t.itemid,competencyid:e}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:t.itemid}}]),c="tool_lp/course_competencies_page",n="coursecompetenciespage"):"template"==t.itemtype?(o=m.call([{methodname:"core_competency_remove_competency_from_template",args:{templateid:t.itemid,competencyid:e}},{methodname:"tool_lp_data_for_template_competencies_page",args:{templateid:t.itemid,pagecontext:{contextid:t.pageContextId}}}]),c="tool_lp/template_competencies_page",n="templatecompetenciespage"):"plan"==t.itemtype&&(o=m.call([{methodname:"core_competency_remove_competency_from_plan",args:{planid:t.itemid,competencyid:e}},{methodname:"tool_lp_data_for_plan_page",args:{planid:t.itemid}}]),c="tool_lp/plan_page",n="plan-page"),o[1].done(function(e){r.render(c,e).done(function(e,t){a('[data-region="'+n+'"]').replaceWith(e),r.runTemplateJS(t)}).fail(i.exception)}).fail(i.exception)},e.prototype.deleteHandler=function(t){var o,c=this;if("course"==c.itemtype)o="unlinkcompetencycourse";else if("template"==c.itemtype)o="unlinkcompetencytemplate";else{if("plan"!=c.itemtype)return;o="unlinkcompetencyplan"}m.call([{methodname:"core_competency_read_competency",args:{id:t}}])[0].done(function(e){n.get_strings([{key:"confirm",component:"moodle"},{key:o,component:"tool_lp",param:e.shortname},{key:"confirm",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(e){i.confirm(e[0],e[1],e[2],e[3],function(){c.doDelete(t)})}).fail(i.exception)}).fail(i.exception)},e.prototype.registerEvents=function(){var o=this;"course"==o.itemtype&&a('[data-region="coursecompetenciespage"]').on("change",'select[data-field="ruleoutcome"]',function(e){var t=a(e.target).data("id"),e=a(e.target).val();m.call([{methodname:"core_competency_set_course_competency_ruleoutcome",args:{coursecompetencyid:t,ruleoutcome:e}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:o.itemid}}])[1].done(function(e){r.render("tool_lp/course_competencies_page",e).done(function(e,t){a('[data-region="coursecompetenciespage"]').replaceWith(e),r.runTemplateJS(t)}).fail(i.exception)}).fail(i.exception)}),a('[data-region="actions"] button').click(function(e){e.preventDefault(),o.pickCompetency()}),a('[data-action="delete-competency-link"]').click(function(e){e.preventDefault();e=a(e.target).closest("[data-id]").data("id");o.deleteHandler(e)})},e});