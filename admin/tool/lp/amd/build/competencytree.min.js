define(["core/ajax","core/notification","core/templates","tool_lp/tree","tool_lp/competency_outcomes","jquery"],function(o,c,i,m,n,a){function l(t){var c=a.Deferred();return i.render("tool_lp/loading",{}).done(function(e,n){i.replaceNodeContents(a(s),e,n),o.call([{methodname:"core_competency_search_competencies",args:{searchtext:t,competencyframeworkid:p}}])[0].done(function(e){u={};for(var n=0,n=0;n<e.length;n++)u[e[n].id]=e[n];var t,o=[];for(n=0;n<e.length;n++)t=e[n],0===parseInt(t.parentid,10)&&(o.push(t),C(t,e));var r={shortname:d,canmanage:f,competencies:o};i.render("tool_lp/competencies_tree_root",r).done(function(e,n){i.replaceNodeContents(a(s),a(e).html(),n);e=new m(s,!1);!h||(n=a(s).find("[data-id="+h+"]")).length&&(e.selectItem(n),e.updateFocus(n)),c.resolve(u)}).fail(c.reject)}).fail(c.reject)}),c.promise()}function g(e,n){n=n.selected,h=n.attr("data-id")}var u={},p=0,d="",s="",h="",f=!1,C=function(e,n){var t,o=0;for(e.haschildren=!1,e.children=[],o=0;o<n.length;o++)(t=n[o]).parentid==e.id&&(e.haschildren=!0,e.children.push(t),C(t,n))};return{init:function(e,n,t,o,r){p=e,d=n,f=r,s=o,l(t).fail(c.exception),this.on("selectionchanged",g)},on:function(e,n){a(s).on(e,n)},getChildren:function(t){var o=[];return a.each(u,function(e,n){n.parentid==t&&o.push(n)}),o},getCompetencyFrameworkId:function(){return p},getCompetency:function(e){return u[e]},getCompetencyLevel:function(e){return this.getCompetency(e).path.replace(/^\/|\/$/g,"").split("/").length},hasChildren:function(e){return 0<this.getChildren(e).length},hasRule:function(e){e=this.getCompetency(e);return!!e&&(e.ruleoutcome!=n.OUTCOME_NONE&&e.ruletype)},reloadCompetencies:function(){return l("").fail(c.exception)},listCompetencies:function(){return u}}});