define(["jquery","core/url","core/log"],function(o,t,i){function e(t,e){this.treeRoot=o(t),this.multiSelect=void 0===e||!0===e,this.items=this.treeRoot.find("li"),this.expandAll=this.items.length<20,this.parents=this.treeRoot.find("li:has(ul)"),e&&this.treeRoot.attr("aria-multiselectable","true"),this.items.attr("aria-selected","false"),this.visibleItems=null,this.activeItem=null,this.lastActiveItem=null,this.keys={tab:9,enter:13,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,eight:56,asterisk:106},this.init(),this.bindEventHandlers()}var s=o('<img alt="" src="'+t.imageUrl("t/expanded")+'"/>'),r=o('<img alt="" src="'+t.imageUrl("t/collapsed")+'"/>');return e.prototype.init=function(){this.parents.attr("aria-expanded","true"),this.parents.prepend(s.clone()),this.items.attr("role","tree-item"),this.items.attr("tabindex","-1"),this.parents.attr("role","group"),this.treeRoot.attr("role","tree"),this.visibleItems=this.treeRoot.find("li");var t=this;this.expandAll||(this.parents.each(function(){t.collapseGroup(o(this))}),this.expandGroup(this.parents.first()))},e.prototype.expandGroup=function(t){t.children("ul").show().attr("aria-hidden","false"),t.attr("aria-expanded","true"),t.children("img").attr("src",s.attr("src")),this.visibleItems=this.treeRoot.find("li:visible")},e.prototype.collapseGroup=function(t){t.children("ul").hide().attr("aria-hidden","true"),t.attr("aria-expanded","false"),t.children("img").attr("src",r.attr("src")),this.visibleItems=this.treeRoot.find("li:visible")},e.prototype.toggleGroup=function(t){"true"==t.attr("aria-expanded")?this.collapseGroup(t):this.expandGroup(t)},e.prototype.triggerChange=function(){var t=this.items.filter("[aria-selected=true]");this.multiSelect||(t=t.first()),this.treeRoot.trigger("selectionchanged",{selected:t})},e.prototype.multiSelectItem=function(t){if(this.multiSelect){if(null!==this.lastActiveItem){for(var e=this.visibleItems.index(this.lastActiveItem),i=this.visibleItems.index(this.activeItem);e<i;)o(this.visibleItems.get(e)).attr("aria-selected","true"),e++;for(;i<e;)o(this.visibleItems.get(e)).attr("aria-selected","true"),e--}}else this.items.attr("aria-selected","false");t.attr("aria-selected","true"),this.triggerChange()},e.prototype.selectItem=function(t){for(var e=t.parent();"tree"!=e.attr("role");)"false"==(e=e.parent()).attr("aria-expanded")&&this.expandGroup(e),e=e.parent();this.items.attr("aria-selected","false"),t.attr("aria-selected","true"),this.triggerChange()},e.prototype.toggleItem=function(t){var e;this.multiSelect?(e="true"===(e=t.attr("aria-selected"))?"false":"true",t.attr("aria-selected",e),this.triggerChange()):this.selectItem(t)},e.prototype.updateFocus=function(t){this.lastActiveItem=this.activeItem;for(var e=(this.activeItem=t).parent();"tree"!=e.attr("role");)"false"==(e=e.parent()).attr("aria-expanded")&&this.expandGroup(e),e=e.parent();this.items.attr("tabindex","-1"),t.attr("tabindex",0)},e.prototype.handleKeyDown=function(t,e){var i,s=this.visibleItems.index(t),r=null,a=e.shiftKey||e.ctrlKey||e.metaKey||e.altKey,n=this;switch(e.keyCode){case this.keys.home:return(r=this.parents.first()).focus(),e.shiftKey?this.multiSelectItem(r):a||this.selectItem(r),e.stopPropagation(),!1;case this.keys.end:return(r=this.visibleItems.last()).focus(),e.shiftKey?this.multiSelectItem(r):a||this.selectItem(r),e.stopPropagation(),!1;case this.keys.enter:case this.keys.space:return e.shiftKey?this.multiSelectItem(t):e.metaKey||e.ctrlKey?this.toggleItem(t):this.selectItem(t),e.stopPropagation(),!1;case this.keys.left:return t.has("ul")&&"true"==t.attr("aria-expanded")?this.collapseGroup(t):(i=t.parent().parent()).is("li")&&(i.focus(),e.shiftKey?this.multiSelectItem(i):a||this.selectItem(i)),e.stopPropagation(),!1;case this.keys.right:return t.has("ul")&&"false"==t.attr("aria-expanded")?this.expandGroup(t):0<(r=t.children("ul").children("li").first()).length&&(r.focus(),e.shiftKey?this.multiSelectItem(r):a||this.selectItem(r)),e.stopPropagation(),!1;case this.keys.up:return 0<s&&((i=this.visibleItems.eq(s-1)).focus(),e.shiftKey?this.multiSelectItem(i):a||this.selectItem(i)),e.stopPropagation(),!1;case this.keys.down:return s<this.visibleItems.length-1&&((i=this.visibleItems.eq(s+1)).focus(),e.shiftKey?this.multiSelectItem(i):a||this.selectItem(i)),e.stopPropagation(),!1;case this.keys.asterisk:return this.parents.each(function(){n.expandGroup(o(this))}),e.stopPropagation(),!1;case this.keys.eight:return e.shiftKey&&(this.parents.each(function(){n.expandGroup(o(this))}),e.stopPropagation()),!1}return!0},e.prototype.handleKeyPress=function(t,e){if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey)return!0;switch(e.keyCode){case this.keys.tab:return!0;case this.keys.enter:case this.keys.home:case this.keys.end:case this.keys.left:case this.keys.right:case this.keys.up:case this.keys.down:return e.stopPropagation(),!1;default:var i=String.fromCharCode(e.which),s=!1,r=this.visibleItems.index(t),a=this.visibleItems.length,n=r+1;for(n==a&&(n=0);n!=r;){var o=this.visibleItems.eq(n),h=o.text().charAt(0);if((h=o.has("ul")?o.find("span").text().charAt(0):h).toLowerCase()==i){s=!0;break}(n+=1)==a&&(n=0)}return!0===s&&this.updateFocus(this.visibleItems.eq(n)),e.stopPropagation(),!1}return!0},e.prototype.on=function(t,e){"selectionchanged"!==t?i.warning('Invalid custom event name for tree. Only "selectionchanged" is supported.'):this.treeRoot.on(t,e)},e.prototype.handleDblClick=function(t,e){return!!(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey)||(this.updateFocus(t),this.toggleGroup(t),e.stopPropagation(),!1)},e.prototype.handleExpandCollapseClick=function(t,e){return this.toggleGroup(t),e.stopPropagation(),!1},e.prototype.handleClick=function(t,e){return e.shiftKey?this.multiSelectItem(t):e.metaKey||e.ctrlKey?this.toggleItem(t):this.selectItem(t),this.updateFocus(t),e.stopPropagation(),!1},e.prototype.handleBlur=function(){return!0},e.prototype.handleFocus=function(t){return this.updateFocus(t),!0},e.prototype.bindEventHandlers=function(){var e=this;this.parents.dblclick(function(t){return e.handleDblClick(o(this),t)}),this.items.click(function(t){return e.handleClick(o(this),t)}),this.items.children("img").click(function(t){return e.handleExpandCollapseClick(o(this).parent(),t)}),this.items.keydown(function(t){return e.handleKeyDown(o(this),t)}),this.items.keypress(function(t){return e.handleKeyPress(o(this),t)}),this.items.focus(function(t){return e.handleFocus(o(this),t)}),this.items.blur(function(t){return e.handleBlur(o(this),t)})},e});