define(["jquery","core/notification","core/templates","tool_lp/dialogue","tool_lp/competency_outcomes","core/str"],function(r,e,n,o,i,t){function u(e,t){this._eventNode=r("<div></div>"),this._tree=e,this._rulesModules=t,this._setUp()}return u.prototype._competency=null,u.prototype._eventNode=null,u.prototype._outcomesOption=null,u.prototype._popup=null,u.prototype._ready=null,u.prototype._rules=null,u.prototype._rulesModules=null,u.prototype._tree=null,u.prototype._afterChange=function(){this._isValid()?this._find('[data-action="save"]').prop("disabled",!1):this._find('[data-action="save"]').prop("disabled",!0)},u.prototype._afterRuleConfigChange=function(e,t){t==this._getRule()&&this._afterChange()},u.prototype._afterRender=function(){var e=this;e._find('[name="outcome"]').on("change",function(){e._switchedOutcome()}).trigger("change"),e._find('[name="rule"]').on("change",function(){e._switchedRule()}).trigger("change"),e._find('[data-action="save"]').on("click",function(){e._trigger("save",e._getConfig()),e.close()}),e._find('[data-action="cancel"]').on("click",function(){e.close()})},u.prototype.canBeConfigured=function(){var n=!1;return r.each(this._rules,function(e,t){t.canConfig()&&(n=!0)}),n},u.prototype.close=function(){this._popup.close(),this._popup=null},u.prototype.display=function(){var n=this;return!!n._competency&&r.when(t.get_string("competencyrule","tool_lp"),n._render()).then(function(e,t){n._popup=new o(e,t[0],n._afterRender.bind(n))}).fail(e.exception)},u.prototype._find=function(e){return r(this._popup.getContent()).find(e)},u.prototype._getApplicableOutcomesOptions=function(){var n=this,o=[];return r.each(n._outcomesOption,function(e,t){o.push({code:t.code,name:t.name,selected:t.code==n._competency.ruleoutcome})}),o},u.prototype._getApplicableRulesOptions=function(){var n=this,o=[];return r.each(n._rules,function(e,t){t.canConfig()&&o.push({name:n._getRuleName(t.getType()),type:t.getType(),selected:t.getType()==n._competency.ruletype})}),o},u.prototype._getConfig=function(){var e=this._getRule();return{ruletype:e?e.getType():null,ruleconfig:e?e.getConfig():null,ruleoutcome:this._getOutcome()}},u.prototype._getOutcome=function(){return this._find('[name="outcome"]').val()},u.prototype._getRule=function(){var n,o=this._find('[name="rule"]').val();return r.each(this._rules,function(e,t){t.getType()==o&&(n=t)}),n},u.prototype._getRuleName=function(n){var o;return r.each(this._rulesModules,function(e,t){t.type==n&&(o=t.name)}),o},u.prototype._initOutcomes=function(){var t=this;return i.getAll().then(function(e){t._outcomesOption=e})},u.prototype._initRules=function(){var o=this,i=[];return r.each(o._rules,function(e,t){var n=t.init().then(function(){t.setTargetCompetency(o._competency),t.on("change",o._afterRuleConfigChange.bind(o))},function(){return o._rules.splice(e,1),r.when()});i.push(n)}),r.when.apply(r.when,i)},u.prototype._isValid=function(){var e=this._getOutcome(),t=this._getRule();return e==i.NONE||!!t&&t.isValid()},u.prototype.on=function(e,t){this._eventNode.on(e,t)},u.prototype._preRender=function(){return this.ready()},u.prototype.ready=function(){return this._ready.promise()},u.prototype._render=function(){var t=this;return this._preRender().then(function(){t.canBeConfigured()?((e={}).outcomes=t._getApplicableOutcomesOptions(),e.rules=t._getApplicableRulesOptions()):e=!1;var e={competencyshortname:t._competency.shortname,config:e};return n.render("tool_lp/competency_rule_config",e)})},u.prototype.setTargetCompetencyId=function(e){var n=this;n._competency=n._tree.getCompetency(e),r.each(n._rules,function(e,t){t.setTargetCompetency(n._competency)})},u.prototype._setUp=function(){var n=this,e=[],o=[];n._ready=r.Deferred(),n._rules=[],r.each(n._rulesModules,function(e,t){o.push(t.amd)}),require(o,function(){r.each(arguments,function(e,t){t=new t(n._tree);n._rules.push(t)}),e.push(n._initRules()),e.push(n._initOutcomes()),r.when.apply(r.when,e).always(function(){n._ready.resolve()})})},u.prototype._switchedOutcome=function(){var e=this;if(e._getOutcome()==i.NONE)return e._find('[data-region="rule-type"]').hide().find('[name="rule"]').val(-1),e._find('[data-region="rule-config"]').empty().hide(),void e._afterChange();e._find('[data-region="rule-type"]').show(),e._find('[data-region="rule-config"]').show(),e._afterChange()},u.prototype._switchedRule=function(){var e=this,t=e._find('[data-region="rule-config"]'),n=e._getRule();if(!n)return t.empty().hide(),void e._afterChange();n.injectTemplate(t).then(function(){t.show()}).always(function(){e._afterChange()}).catch(function(){t.empty().hide()})},u.prototype._trigger=function(e,t){this._eventNode.trigger(e,[t])},u});