define(["jquery","core/templates","core/ajax","core/notification","core/str","tool_lp/menubar","tool_lp/competencypicker_user_plans"],function(i,o,c,r,d,n,t){function e(e){if("evidence"===(this._type=e))this._region='[data-region="user-evidence-page"]',this._evidenceNode='[data-region="user-evidence-page"]',this._template="tool_lp/user_evidence_page",this._contextMethod="tool_lp_data_for_user_evidence_page";else{if("list"!==e)throw new TypeError("Unexpected type.");this._region='[data-region="user-evidence-list"]',this._evidenceNode='[data-region="user-evidence-node"]',this._template="tool_lp/user_evidence_list_page",this._contextMethod="tool_lp_data_for_user_evidence_list_page"}}return e.prototype._contextMethod=null,e.prototype._evidenceNode=null,e.prototype._region=null,e.prototype._template=null,e.prototype._type=null,e.prototype._getContextArgs=function(e){var t={};return"evidence"===this._type?t={id:e.id}:"list"===this._type&&(t={userid:e.userid}),t},e.prototype._renderView=function(e){var n=this;return o.render(n._template,e).then(function(e,t){o.replaceNode(i(n._region),e,t)})},e.prototype._callAndRefresh=function(e,t){var n=this;return e.push({methodname:n._contextMethod,args:n._getContextArgs(t)}),i.when.apply(i.when,c.call(e)).then(function(){return n._renderView(arguments[arguments.length-1])}).fail(r.exception)},e.prototype._doDelete=function(e){var t=[{methodname:"core_competency_delete_user_evidence",args:{id:e.id}}];this._callAndRefresh(t,e)},e.prototype.deleteEvidence=function(t){var n=this;c.call([{methodname:"core_competency_read_user_evidence",args:{id:t.id}}])[0].done(function(e){d.get_strings([{key:"confirm",component:"moodle"},{key:"deleteuserevidence",component:"tool_lp",param:e.name},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(e){r.confirm(e[0],e[1],e[2],e[3],function(){n._doDelete(t)})}).fail(r.exception)}).fail(r.exception)},e.prototype._deleteEvidenceHandler=function(e){e.preventDefault();e=this._findEvidenceData(i(e.target));this.deleteEvidence(e)},e.prototype._doCreateUserEvidenceCompetency=function(n,e){var o=[];i.each(e,function(e,t){o.push({methodname:"core_competency_create_user_evidence_competency",args:{userevidenceid:n.id,competencyid:t}})}),this._callAndRefresh(o,n)},e.prototype.createUserEvidenceCompetency=function(o){var i=this,e=new t(o.userid);e.on("save",function(e,t){var n=t.competencyIds;i._doCreateUserEvidenceCompetency(o,n,t.requestReview)}),e.display()},e.prototype._createUserEvidenceCompetencyHandler=function(e){e.preventDefault();e=this._findEvidenceData(i(e.target));this.createUserEvidenceCompetency(e)},e.prototype._doDeleteUserEvidenceCompetency=function(e,t){var n=[];n.push({methodname:"core_competency_delete_user_evidence_competency",args:{userevidenceid:e.id,competencyid:t}}),this._callAndRefresh(n,e)},e.prototype.deleteUserEvidenceCompetency=function(e,t){this._doDeleteUserEvidenceCompetency(e,t)},e.prototype._deleteUserEvidenceCompetencyHandler=function(e){var t=this._findEvidenceData(i(e.currentTarget)),n=i(e.currentTarget).data("id");e.preventDefault(),this.deleteUserEvidenceCompetency(t,n)},e.prototype._doReviewUserEvidenceCompetencies=function(e){var t=[{methodname:"core_competency_request_review_of_user_evidence_linked_competencies",args:{id:e.id}}];this._callAndRefresh(t,e)},e.prototype.reviewUserEvidenceCompetencies=function(t){var n=this;c.call([{methodname:"core_competency_read_user_evidence",args:{id:t.id}}])[0].done(function(e){d.get_strings([{key:"confirm",component:"moodle"},{key:"sendallcompetenciestoreview",component:"tool_lp",param:e.name},{key:"confirm",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(e){r.confirm(e[0],e[1],e[2],e[3],function(){n._doReviewUserEvidenceCompetencies(t)})}).fail(r.exception)}).fail(r.exception)},e.prototype._reviewUserEvidenceCompetenciesHandler=function(e){e.preventDefault();e=this._findEvidenceData(i(e.target));this.reviewUserEvidenceCompetencies(e)},e.prototype._findEvidenceData=function(e){var e=e.parentsUntil(i(this._region).parent(),this._evidenceNode);if(1!=e.length)throw new Error("The evidence node was not located.");if(void 0===(e=e.data())||void 0===e.id)throw new Error("Evidence data could not be found.");return e},e.prototype.enhanceMenubar=function(e){var t=this;n.enhance(e,{'[data-action="user-evidence-delete"]':t._deleteEvidenceHandler.bind(t),'[data-action="link-competency"]':t._createUserEvidenceCompetencyHandler.bind(t),'[data-action="send-competencies-review"]':t._reviewUserEvidenceCompetenciesHandler.bind(t)})},e.prototype.registerEvents=function(){var e=i(this._region),t=this;e.find('[data-action="user-evidence-delete"]').click(t._deleteEvidenceHandler.bind(t)),e.find('[data-action="link-competency"]').click(t._createUserEvidenceCompetencyHandler.bind(t)),e.find('[data-action="delete-competency-link"]').click(t._deleteUserEvidenceCompetencyHandler.bind(t)),e.find('[data-action="send-competencies-review"]').click(t._reviewUserEvidenceCompetenciesHandler.bind(t))},e});