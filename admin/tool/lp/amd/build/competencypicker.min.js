define(["jquery","core/notification","core/ajax","core/templates","tool_lp/dialogue","core/str","tool_lp/tree"],function(c,o,n,t,r,e,a){function i(e,t,n,o){var r=this;r._eventNode=c("<div></div>"),r._frameworks=[],r._reset(),r._pageContextId=e,r._pageContextIncludes=n||"children",r._multiSelect=void 0===o||!0===o,t&&(r._frameworkId=t,r._singleFramework=!0)}return i.prototype._competencies=null,i.prototype._disallowedCompetencyIDs=null,i.prototype._eventNode=null,i.prototype._frameworks=null,i.prototype._frameworkId=null,i.prototype._pageContextId=null,i.prototype._pageContextIncludes=null,i.prototype._popup=null,i.prototype._searchText="",i.prototype._selectedCompetencies=null,i.prototype._singleFramework=!1,i.prototype._multiSelect=!0,i.prototype._onlyVisible=!0,i.prototype._afterRender=function(){var i=this,n=new a(i._find("[data-enhance=linktree]"),i._multiSelect),e=(i._find("[data-enhance=linktree]").show(),n.on("selectionchanged",function(e,t){var t=t.selected,r=(e.preventDefault(),[]);c.each(t,function(e,t){var n=c(t).data("id"),o=!0;void 0===n?o=!1:c.each(i._disallowedCompetencyIDs,function(e,t){t==n&&(o=!1)}),o&&r.push(n)}),i._selectedCompetencies=r,i._selectedCompetencies.length?i._find('[data-region="competencylinktree"] [data-action="add"]').removeAttr("disabled"):i._find('[data-region="competencylinktree"] [data-action="add"]').attr("disabled","disabled")}),i._singleFramework||i._find('[data-action="chooseframework"]').change(function(e){i._frameworkId=c(e.target).val(),i._loadCompetencies().then(i._refresh.bind(i)).catch(o.exception)}),i._find('[data-region="filtercompetencies"] button').click(function(e){return e.preventDefault(),c(e.target).attr("disabled","disabled"),i._searchText=i._find('[data-region="filtercompetencies"] input').val()||"",i._refresh().always(function(){c(e.target).removeAttr("disabled")})}),i._find('[data-region="competencylinktree"] [data-action="cancel"]').click(function(e){e.preventDefault(),i.close()}),i._find('[data-region="competencylinktree"] [data-action="add"]').click(function(e){e.preventDefault(),i._selectedCompetencies.length&&(i._multiSelect?i._trigger("save",{competencyIds:i._selectedCompetencies}):i._trigger("save",{competencyId:i._selectedCompetencies[0]}),i.close())}),i._selectedCompetencies.slice(0));c.each(e,function(e,t){t=i._find("[data-id="+t+"]");t.length&&(n.toggleItem(t),n.updateFocus(t))})},i.prototype.close=function(){this._popup.close(),this._reset()},i.prototype.display=function(){var n=this;return c.when(e.get_string("competencypicker","tool_lp"),n._render()).then(function(e,t){n._popup=new r(e,t[0],n._afterRender.bind(n))}).catch(o.exception)},i.prototype._fetchCompetencies=function(e,t){var r=this;return n.call([{methodname:"core_competency_search_competencies",args:{searchtext:t,competencyframeworkid:e}}])[0].done(function(e){for(var t,n=[],o=0;o<e.length;o++)"0"==(t=e[o]).parentid&&(t.children=[],t.haschildren=0,function e(t,n){for(var o=0;o<n.length;o++)n[o].parentid==t.id&&(t.haschildren=!0,n[o].children=[],n[o].haschildren=!1,t.children[t.children.length]=n[o],e(n[o],n))}(n[n.length]=t,e));r._competencies=n}).fail(o.exception)},i.prototype._find=function(e){return c(this._popup.getContent()).find(e)},i.prototype._getFramework=function(n){var o;return c.each(this._frameworks,function(e,t){t.id==n&&(o=t)}),o},i.prototype._loadCompetencies=function(){return this._fetchCompetencies(this._frameworkId,this._searchText)},i.prototype._loadFrameworks=function(){var t=this;return 0<t._frameworks.length?c.when():(t._singleFramework?n.call([{methodname:"core_competency_read_competency_framework",args:{id:this._frameworkId}}])[0].then(function(e){return[e]}):n.call([{methodname:"core_competency_list_competency_frameworks",args:{sort:"shortname",context:{contextid:t._pageContextId},includes:t._pageContextIncludes,onlyvisible:t._onlyVisible}}])[0]).done(function(e){t._frameworks=e}).fail(o.exception)},i.prototype.on=function(e,t){this._eventNode.on(e,t)},i.prototype._preRender=function(){var e=this;return e._loadFrameworks().then(function(){return!e._frameworkId&&0<e._frameworks.length&&(e._frameworkId=e._frameworks[0].id),e._frameworkId?e._loadCompetencies():(e._frameworks=[],c.when())})},i.prototype._refresh=function(){var t=this;return t._render().then(function(e){t._find('[data-region="competencylinktree"]').replaceWith(e),t._afterRender()})},i.prototype._render=function(){var n=this;return n._preRender().then(function(){n._singleFramework||c.each(n._frameworks,function(e,t){t.id==n._frameworkId?t.selected=!0:t.selected=!1});var e={competencies:n._competencies,framework:n._getFramework(n._frameworkId),frameworks:n._frameworks,search:n._searchText,singleFramework:n._singleFramework};return t.render("tool_lp/competency_picker",e)})},i.prototype._reset=function(){this._competencies=[],this._disallowedCompetencyIDs=[],this._popup=null,this._searchText="",this._selectedCompetencies=[]},i.prototype.setDisallowedCompetencyIDs=function(e){this._disallowedCompetencyIDs=e},i.prototype._trigger=function(e,t){this._eventNode.trigger(e,[t])},i});