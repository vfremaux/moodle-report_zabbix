define(["jquery","core/notification","core/ajax","core/templates","core/str","tool_lp/tree","tool_lp/competencypicker"],function(r,t,o,n,e,a,p){function l(e,n,t){p.prototype.constructor.apply(this,[1,!1,"self",t]),this._userId=e,this._plans=[],n&&(this._planId=n,this._singlePlan=!0)}return(l.prototype=Object.create(p.prototype))._plans=null,l.prototype._planId=null,l.prototype._singlePlan=!1,l.prototype._userId=null,l.prototype._afterRender=function(){var n=this;p.prototype._afterRender.apply(n,arguments),n._singlePlan||n._find('[data-action="chooseplan"]').change(function(e){n._planId=r(e.target).val(),n._loadCompetencies().then(n._refresh.bind(n)).catch(t.exception)})},l.prototype._fetchCompetencies=function(e,r){var a=this;return o.call([{methodname:"core_competency_list_plan_competencies",args:{id:e}}])[0].done(function(e){for(var n,t=[],o=0;o<e.length;o++)(n=e[o].competency).shortname.toLowerCase().indexOf(r.toLowerCase())<0||(n.children=[],n.haschildren=0,t.push(n));a._competencies=t}).fail(t.exception)},l.prototype._getPlan=function(t){var o;return r.each(this._plans,function(e,n){n.id==t&&(o=n)}),o},l.prototype._loadCompetencies=function(){return this._fetchCompetencies(this._planId,this._searchText)},l.prototype._loadPlans=function(){var n=this;return 0<n._plans.length?r.when():(n._singlePlan?o.call([{methodname:"core_competency_read_plan",args:{id:this._planId}}])[0].then(function(e){return[e]}):o.call([{methodname:"core_competency_list_user_plans",args:{userid:n._userId}}])[0]).done(function(e){n._plans=e}).fail(t.exception)},l.prototype._preRender=function(){var e=this;return e._loadPlans().then(function(){return!e._planId&&0<e._plans.length&&(e._planId=e._plans[0].id),e._planId?e._loadCompetencies():(e._plans=[],r.when())})},l.prototype._render=function(){var t=this;return t._preRender().then(function(){t._singlePlan||r.each(t._plans,function(e,n){n.id==t._planId?n.selected=!0:n.selected=!1});var e={competencies:t._competencies,plan:t._getPlan(t._planId),plans:t._plans,search:t._searchText,singlePlan:t._singlePlan};return n.render("tool_lp/competency_picker_user_plans",e)})},l});