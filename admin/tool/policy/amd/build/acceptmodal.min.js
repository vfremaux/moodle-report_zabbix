define(["jquery","core/str","core/modal_factory","core/modal_events","core/notification","core/fragment","core/ajax","core/yui"],function(o,r,c,i,s,e,n,t){"use strict";function a(t){this.contextid=t,this.init()}return a.prototype.modal=null,a.prototype.contextid=-1,a.prototype.currentTrigger=null,a.prototype.triggers={SINGLE:"a[data-action=acceptmodal]",BULK:"input[data-action=acceptmodal]"},a.prototype.init=function(){o(this.triggers.SINGLE).on("click",function(t){t.preventDefault(),this.currentTrigger=o(t.currentTarget);t=o(t.currentTarget).attr("href"),t=t.slice(t.indexOf("?")+1);this.showFormModal(t)}.bind(this)),o(this.triggers.BULK).on("click",function(t){t.preventDefault(),this.currentTrigger=o(t.currentTarget);var t=o(t.currentTarget).closest("form");t.find('input[type=checkbox][name="userids[]"]:checked').length?(t=t.serialize(),this.showFormModal(t)):r.get_strings([{key:"notice"},{key:"selectusersforconsent",component:"tool_policy"},{key:"ok"}]).then(function(t){s.alert(t[0],t[1],t[2])}).fail(s.exception)}.bind(this))},a.prototype.showFormModal=function(i){for(var n,t=i.split("&"),o=0;o<t.length;o++){var e=t[o].split("=");"action"==e[0]&&(n=e[1])}r.get_strings([{key:"statusformtitleaccept",component:"tool_policy"},{key:"iagreetothepolicy",component:"tool_policy"},{key:"statusformtitlerevoke",component:"tool_policy"},{key:"irevokethepolicy",component:"tool_policy"},{key:"statusformtitledecline",component:"tool_policy"},{key:"declinethepolicy",component:"tool_policy"}]).then(function(t){var o,e;return"accept"==n?(o=t[0],e=t[1]):"revoke"==n?(o=t[2],e=t[3]):"decline"==n&&(o=t[4],e=t[5]),c.create({type:c.types.SAVE_CANCEL,title:o,body:""}).done(function(t){this.modal=t,this.setupFormModal(i,e)}.bind(this))}.bind(this)).catch(s.exception)},a.prototype.setupFormModal=function(t,o){var e=this.modal;e.setLarge(),e.setSaveButtonText(o),e.getRoot().on(i.hidden,this.destroy.bind(this)),e.setBody(this.getBody(t)),e.getRoot().on(i.save,this.submitForm.bind(this)),e.getRoot().on("submit","form",this.submitFormAjax.bind(this)),e.show()},a.prototype.getBody=function(t){void 0===t&&(t={});t={jsonformdata:JSON.stringify(t)};return e.loadFragment("tool_policy","accept_on_behalf",this.contextid,t)},a.prototype.submitFormAjax=function(t){t.preventDefault();var o=this.modal.getRoot().find("form").serialize();n.call([{methodname:"tool_policy_submit_accept_on_behalf",args:{jsonformdata:JSON.stringify(o)}}])[0].done(function(t){t.validationerrors?this.modal.setBody(this.getBody(o)):this.close()}.bind(this)).fail(s.exception)},a.prototype.submitForm=function(t){t.preventDefault(),this.modal.getRoot().find("form").submit()},a.prototype.close=function(){this.destroy(),document.location.reload()},a.prototype.destroy=function(){t.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()}),this.modal.destroy(),this.currentTrigger.focus()},{getInstance:function(t){return new a(t)}}});