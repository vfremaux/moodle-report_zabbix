define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function(a,i,r,c,l,d,h){function t(e){this.courseId=e.courseid,this.noteStateNames=e.noteStateNames,this.stateHelpIcon=e.stateHelpIcon,this.attachEventListeners()}var u="#formactionid",e="input.usercheckbox",o="input.usercheckbox[value='0']",s="input.usercheckbox:checked",n="#participantsform",g="#checkall",p="#checkallnos",m="#checkallonpage",f="#checknone";return t.prototype.modal=null,t.prototype.courseId=-1,t.prototype.noteStateNames={},t.prototype.stateHelpIcon="",t.prototype.attachEventListeners=function(){a(u).on("change",function(e){var o,t=a(e.target).val();-1!==t.indexOf("#")?(e.preventDefault(),o=[],a(s).each(function(e,t){t=a(t).attr("name").replace("user","");o.push(t)}),"#messageselect"==t?this.showSendMessage(o).fail(d.exception):"#addgroupnote"==t&&this.showAddNote(o).fail(d.exception),a(u+' option[value=""]').prop("selected","selected")):""!==t&&(0<a(s).length?a(n).submit():a(u+' option[value=""]').prop("selected","selected"))}.bind(this)),a(g).on("click",function(){var e=a(this).data("showallink");e&&(window.location=e)}),a(p).on("click",function(){a(o).prop("checked",!0)}),a(m).on("click",function(){a(e).prop("checked",!0)}),a(f).on("click",function(){a(e).prop("checked",!1)})},t.prototype.showAddNote=function(o){if(0==o.length)return a.Deferred().resolve().promise();var e,t=[];for(e in this.noteStateNames)switch(e){case"draft":t.push({value:"personal",label:this.noteStateNames[e]});break;case"public":t.push({value:"course",label:this.noteStateNames[e],selected:1});break;case"site":t.push({value:e,label:this.noteStateNames[e]})}var s={stateNames:t,stateHelpIcon:this.stateHelpIcon},n=null,n=1==o.length?i.get_string("addbulknotesingle","core_notes"):i.get_string("addbulknote","core_notes",o.length);return a.when(r.create({type:r.types.SAVE_CANCEL,body:l.render("core_user/add_bulk_note",s)}),n).then(function(e,t){return this.modal=e,this.modal.setTitle(t),this.modal.setSaveButtonText(t),this.modal.getRoot().on(c.hidden,function(){var e=a("#user-notifications [role=alert]");(e.length?e:a(u)).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(c.save,this.submitAddNote.bind(this,o)),this.modal.show(),this.modal}.bind(this))},t.prototype.submitAddNote=function(e){for(var t=this.modal.getRoot().find("form textarea").val(),o=this.modal.getRoot().find("form select").val(),s=[],n=0,n=0;n<e.length;n++)s.push({userid:e[n],text:t,courseid:this.courseId,publishstate:o});return h.call([{methodname:"core_notes_create_notes",args:{notes:s}}])[0].then(function(e){return 1==e.length?i.get_string("addbulknotedonesingle","core_notes"):i.get_string("addbulknotedone","core_notes",e.length)}).then(function(e){return d.addNotification({message:e,type:"success"}),!0}).catch(d.exception)},t.prototype.showSendMessage=function(o){if(0==o.length)return a.Deferred().resolve().promise();var e=null,e=1==o.length?i.get_string("sendbulkmessagesingle","core_message"):i.get_string("sendbulkmessage","core_message",o.length);return a.when(r.create({type:r.types.SAVE_CANCEL,body:l.render("core_user/send_bulk_message",{})}),e).then(function(e,t){return this.modal=e,this.modal.setTitle(t),this.modal.setSaveButtonText(t),this.modal.getRoot().on(c.hidden,function(){a(u).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(c.save,this.submitSendMessage.bind(this,o)),this.modal.show(),this.modal}.bind(this))},t.prototype.submitSendMessage=function(e){for(var t=this.modal.getRoot().find("form textarea").val(),o=[],s=0,s=0;s<e.length;s++)o.push({touserid:e[s],text:t});return h.call([{methodname:"core_message_send_instant_messages",args:{messages:o}}])[0].then(function(e){return 1==e.length?i.get_string("sendbulkmessagesentsingle","core_message"):i.get_string("sendbulkmessagesent","core_message",e.length)}).then(function(e){return d.addNotification({message:e,type:"success"}),!0}).catch(d.exception)},{init:function(e){return new t(e)}}});