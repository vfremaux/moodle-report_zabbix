define(["core/templates","jquery","core/str","core/config","core/notification","core/modal_factory","core/modal_events","core/fragment","core/ajax"],function(i,l,r,e,m,d,s,n,u){function t(e){this.contextid=e.contextid,this.courseid=e.courseid,this.bindEditEnrol(),this.bindUnenrol(),this.bindStatusDetails()}var c='[data-action="editenrolment"]',o='[data-action="showdetails"]',a='[data-action="unenrol"]';return t.prototype.courseid=0,t.prototype.bindEditEnrol=function(){var o=this;l(c).click(function(e){e.preventDefault();var e=l(this),t=e.parent().data("fullname"),n=e.attr("rel");l.when(r.get_string("edituserenrolment","enrol",t)).then(function(e){return d.create({large:!0,title:e,type:d.types.SAVE_CANCEL})}).done(function(t){t.getRoot().on(s.save,function(e){e.preventDefault(),o.submitEditFormAjax(t)}),t.getRoot().on(s.hidden,function(){t.destroy()}),t.setBody(o.getBody(n)),t.show()}).fail(m.exception)})},t.prototype.bindUnenrol=function(){var i=this;l(a).click(function(o){o.preventDefault();var a=l(this),e=a.parent(),e=[{key:"unenrol",component:"enrol"},{key:"unenrolconfirm",component:"enrol",param:{user:e.data("fullname"),course:e.data("coursename"),enrolinstancename:e.data("enrolinstancename")}}],t=d.create({type:d.types.SAVE_CANCEL});l.when(r.get_strings(e),t).done(function(e,t){var n=e[0],e=e[1];t.setTitle(n),t.setBody(e),t.setSaveButtonText(n),t.getRoot().on(s.save,function(){var e={ueid:l(a).attr("rel")};o.preventDefault(),i.submitUnenrolFormAjax(t,e)}),t.getRoot().on(s.hidden,function(){t.destroy()}),t.show()}).fail(m.exception)})},t.prototype.bindStatusDetails=function(){l(o).click(function(e){e.preventDefault();var e=l(this),t=e.parent(),o={fullname:t.data("fullname"),coursename:t.data("coursename"),enrolinstancename:t.data("enrolinstancename"),status:t.data("status"),statusclass:t.find("span").attr("class"),timestart:t.data("timestart"),timeend:t.data("timeend")},a=e.next(c),t=(a.length&&(o.editenrollink=l("<div>").append(a.clone()).html()),r.get_strings([{key:"enroldetails",component:"enrol"}])),e=d.create({large:!0,type:d.types.CANCEL});l.when(t,e).done(function(e,t){var n=i.render("core_user/status_details",o);t.setTitle(e[0]),t.setBody(n),a.length&&t.getRoot().on("click",c,function(e){e.preventDefault(),t.hide(),l(a).trigger("click")}),t.show(),t.getRoot().on(s.hidden,function(){t.destroy()})}).fail(m.exception)})},t.prototype.submitEditFormAjax=function(t){var e,n,o,a,i,r=this,d=t.getRoot().find("form"),s=l(d).find('[name="ue"]').val(),c=l(d).find('[name="status"]').val(),c={courseid:this.courseid,ueid:s,status:c};l(d).find('[name="timestart[enabled]"]').is(":checked")&&(a=l(d).find('[name="timestart[year]"]').val(),i=l(d).find('[name="timestart[month]"]').val()-1,e=l(d).find('[name="timestart[day]"]').val(),n=l(d).find('[name="timestart[hour]"]').val(),o=l(d).find('[name="timestart[minute]"]').val(),a=new Date(a,i,e,n,o),c.timestart=a.getTime()/1e3),l(d).find('[name="timeend[enabled]"]').is(":checked")&&(i=l(d).find('[name="timeend[year]"]').val(),e=l(d).find('[name="timeend[month]"]').val()-1,n=l(d).find('[name="timeend[day]"]').val(),o=l(d).find('[name="timeend[hour]"]').val(),a=l(d).find('[name="timeend[minute]"]').val(),i=new Date(i,e,n,o,a),c.timeend=i.getTime()/1e3),u.call([{methodname:"core_enrol_edit_user_enrolment",args:c}])[0].done(function(e){e.result?(t.hide(),void 0!==window.M.core_formchangechecker&&window.M.core_formchangechecker.reset_form_dirty_state(),window.location.reload()):(e=JSON.stringify(d.serialize()),t.setBody(r.getBody(s,e)))}).fail(m.exception)},t.prototype.submitUnenrolFormAjax=function(t,e){u.call([{methodname:"core_enrol_unenrol_user_enrolment",args:e}])[0].done(function(e){e.result?(t.hide(),void 0!==window.M.core_formchangechecker&&window.M.core_formchangechecker.reset_form_dirty_state(),window.location.reload()):m.alert(e.errors[0].key,e.errors[0].message)}).fail(m.exception)},t.prototype.getBody=function(e,t){e={ueid:e};return void 0!==t&&(e.formdata=t),n.loadFragment("enrol","user_enrolment_form",this.contextid,e).fail(m.exception)},{init:function(e){new t(e)}}});