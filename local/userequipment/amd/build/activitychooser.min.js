import*as ChooserDialogue from"core_course/local/activitychooser/dialogue";import*as Repository from"core_course/local/activitychooser/repository";import selectors from"core_course/local/activitychooser/selectors";import CustomEvents from"core/custom_interaction_events";import*as Templates from"core/templates";import*as ModalFactory from"core/modal_factory";import{get_string as getString}from"core/str";import Pending from"core/pending";const ALLACTIVITIESRESOURCES=0,ONLYALL=1,ACTIVITIESRESOURCES=2,ACTIVITY=0,RESOURCE=1,init=(e,t)=>{const s=new Pending;registerListenerEvents(e,t),s.resolve()},registerListenerEvents=(s,c)=>{const e=["click",CustomEvents.events.activate,CustomEvents.events.keyboardActivate],l=(()=>{let e=null;return()=>e=e||new Promise(e=>{e(Repository.activityModules(s))})})(),n=(()=>{let e=null;return t=>e=e||new Promise(e=>{e(Repository.fetchFooterData(s,t))})})();CustomEvents.define(document,e),e.forEach(e=>{document.addEventListener(e,async s=>{if(s.target.closest(selectors.elements.sectionmodchooser)){let e;const i=s.target.closest(selectors.elements.section);s=s.target.closest(selectors.elements.sectionmodchooser);e=null!==i&&i.hasAttribute("data-sectionid")?i:s;let t;var s=new Promise(e=>{t=e}),o=await n(e.dataset.sectionid),s=buildModal(s,o),r=await l(),a=sectionIdMapper(r,e.dataset.sectionid);ChooserDialogue.displayChooser(s,a,partiallyAppliedFavouriteManager(r,e.dataset.sectionid),o),t(await Templates.render("core_course/activitychooser",templateDataBuilder(a,c)))}})})},sectionIdMapper=(e,t)=>{const s=JSON.parse(JSON.stringify(e));return s.content_items.forEach(e=>{e.link+="&section="+t}),s.content_items},templateDataBuilder=(e,t)=>{let s=[],o=[],r=!0,a=!1,i=!1;var t=parseInt(t.tabmode),c=e.filter(e=>!0===e.favourite),l=e.filter(e=>!0===e.recommended),t=(t!==ALLACTIVITIESRESOURCES&&t!==ACTIVITIESRESOURCES||t===ONLYALL||(s=e.filter(e=>e.archetype===ACTIVITY),o=e.filter(e=>e.archetype===RESOURCE),a=!0,i=!0,t===ACTIVITIESRESOURCES&&(r=!1)),!!c.length),n=!1===r&&!1==t,d=!0===r&&!1==t;return{default:e,showAll:r,activities:s,showActivities:a,activitiesFirst:n,resources:o,showResources:i,favourites:c,recommended:l,favouritesFirst:t,fallback:d}},buildModal=(e,t)=>ModalFactory.create({type:ModalFactory.types.DEFAULT,title:getString("addresourceoractivity"),body:e,footer:t.customfootertemplate,large:!0,templateContext:{classes:"modchooser"}}).then(e=>(e.show(),e)),nullFavouriteDomManager=(e,t)=>{if(e.tabIndex=-1,e.classList.add("d-none"),e.classList.contains("active")){e.classList.remove("active"),e.setAttribute("aria-selected","false");const s=t.querySelector(selectors.regions.favouriteTab),o=(s.classList.remove("active"),t.querySelector(selectors.regions.defaultTabNav)),r=t.querySelector(selectors.regions.activityTabNav);if(!1===o.classList.contains("d-none")){o.classList.add("active"),o.setAttribute("aria-selected","true"),o.tabIndex=0,o.focus();const a=t.querySelector(selectors.regions.defaultTab);a.classList.add("active")}else{r.classList.add("active"),r.setAttribute("aria-selected","true"),r.tabIndex=0,r.focus();const i=t.querySelector(selectors.regions.activityTab);i.classList.add("active")}}},showModuleHelp=(e,t,s=null)=>{null!==s&&!0===t.showFooter&&s.setFooter(Templates.render("core_course/local/activitychooser/footer_partial",t));const o=e.find(selectors.regions.help)[0];o.innerHTML="",o.classList.add("m-auto");s=addIconToContainer(o);let r=null;var a=new Promise(e=>{r=e}),t=Templates.renderForPromise("core_course/local/activitychooser/help",t);Promise.all([t,s,a]).then(([{html:e,js:t}])=>Templates.replaceNodeContents(o,e,t)).then(()=>(o.querySelector(selectors.regions.chooserSummary.header).focus(),o)).catch(Notification.exception),e.one("slid.bs.carousel",()=>{r()}),e.carousel("next")},partiallyAppliedFavouriteManager=(d,u)=>async(t,e,s)=>{const o=s.querySelector(selectors.render.favourites);var r=s.querySelectorAll(`[data-internal="${t}"] `+selectors.actions.optionActions.manageFavourite);const a=s.querySelector(selectors.regions.favouriteTabNav),i=d.content_items.find(({name:e})=>e===t),c={};if(i)if(e){i.favourite=!0,c.content_items=d.content_items.filter(e=>!0===e.favourite);var e=sectionIdMapper(c,u),{html:e,js:l}=await Templates.renderForPromise("core_course/local/activitychooser/favourites",{favourites:e});await Templates.replaceNodeContents(o,e,l),Array.from(r).forEach(e=>{e.classList.remove("text-muted"),e.classList.add("text-primary"),e.dataset.favourited="true",e.setAttribute("aria-pressed",!0),e.firstElementChild.classList.remove("fa-star-o"),e.firstElementChild.classList.add("fa-star")}),a.classList.remove("d-none")}else{i.favourite=!1;const n=o.querySelector(`[data-internal="${t}"]`),c=(n.parentNode.removeChild(n),Array.from(r).forEach(e=>{e.classList.add("text-muted"),e.classList.remove("text-primary"),e.dataset.favourited="false",e.setAttribute("aria-pressed",!1),e.firstElementChild.classList.remove("fa-star"),e.firstElementChild.classList.add("fa-star-o")}),d.content_items.filter(e=>!0===e.favourite));0===c.length&&nullFavouriteDomManager(a,s)}};export{init};