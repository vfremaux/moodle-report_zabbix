define(["jquery","core/log","core/config","core/str"],function(d,s,c,e){var p={eulas:"required",shopid:0,units:0,required:0,assigned:0,endusermobilephonerequired:0,strings:[],init:function(t){e.get_strings([{key:"invalidemail",component:"local_shop"},{key:"notallassigned",component:"local_shop"},{key:"continue",component:"local_shop"},{key:"emptyorder",component:"local_shop"}]).done(function(t){p.strings=t}),d(".shop-description-toggle").bind("click",this.toggle_description),d(".local-shop-detail-delete").bind("click",this.clear_product),d(".local-shop-order-detail").bind("change",this.update_product),d(".local-shop-password").bind("keypress",this.check_pass_code),d(".local-shop-email").bind("change",this.check_email),d(".local-shop-add-unit").bind("click",this.add_unit),d(".local-shop-delete-unit").bind("click",this.delete_unit),d(".local-shop-add-assign").bind("change",this.add_assign),d(".local-shop-delete-assign").bind("click",this.delete_assign),d(".local-shop-toggle-invoiceinfo").bind("change",this.toggle_invoiceinfo),d(".local-shop-delete-user").bind("click",this.delete_user),d(".local-shop-add-user").bind("click",this.add_user),t&&(p.shopid=t.shopid,p.units=t.units,p.required=t.required,p.assigned=t.assigned,p.endusermobilephonerequired=t.endusermobilephonerequired),s.debug("AMD Local Shop Front initialized")},initeulas:function(t){d("#shop-eula-confirm").bind("click",this.accept_eulas),t&&("required"===t.eulas&&d("#region-pre").css("display","none"),p.eulas=t.eulas),s.debug("AMD Local Shop Front Eulas initialized")},toggle_description:function(){var t=d(this);t.attr("src").match("/open/")?(t.attr("src",t.attr("src").replace("open","close")),t.parent().parent().children(".shop-front-description").removeClass("shop-desc-gradient")):(t.attr("src",t.attr("src").replace("close","open")),t.parent().parent().children(".shop-front-description").addClass("shop-desc-gradient"))},toggle_invoiceinfo:function(){this.checked?(d("#shop-invoiceinfo-wrapper").css("display","block"),""==document.driverform.elements["invoiceinfo::organisation"].value&&(document.driverform.elements["invoiceinfo::organisation"].value=document.driverform.elements["customerinfo::organisation"].value),""==document.driverform.elements["invoiceinfo::city"].value&&(document.driverform.elements["invoiceinfo::city"].value=document.driverform.elements["customerinfo::city"].value)):d("#shop-invoiceinfo-wrapper").css("display","none")},accept_eulas:function(){var t=1==d("#shop-agreeeula").val()?(d("#euladiv").css("display","none"),d("#order").css("display","block"),d("#order").css("visibility","show"),d("#region-pre").css("display","block"),d("#region-pre").css("visibility","show"),t=c.wwwroot+"/local/shop/front/ajax/service.php",(t+="?what=agreeeulas")+"&service=order&id="+p.shopid):(t=c.wwwroot+"/local/shop/front/ajax/service.php",(t+="?what=reseteulas")+"&service=order&id="+p.shopid);d.get(t)},reset_eulas:function(){var t;"agreed"==p.eulas&&(t=c.wwwroot+"/local/shop/front/ajax/service.php",t=(t+="?what=reseteulas")+"&service=order&id="+p.shopid,d.get(t))},add_assign:function(){var a,i,t=d(this),e=t.attr("data-role"),s=t.attr("data-product"),o=c.wwwroot+"/local/shop/front/ajax/service.php",r=t.attr("data-requiredroles").split(",");for(i in r)a=r[i],d("#addassign"+a+"list"+s).html(p.waiter());d.post(o,{id:p.shopid,service:"users",what:"addassign",role:e,product:s,participantid:this.options[this.selectedIndex].value},function(t){var e=JSON.parse(t);for(i in r)a=r[i],d("#addassign"+a+"list"+s).html(e.content[a]);p.assigned++,p.assigned<p.required?(d("#next-button").css("opacity","0.5"),d("#next-button").removeClass("shop-active-button"),d("#next-button").attr("disabled","disabled"),d("#next-button").attr("title",p.strings[1])):(d("#next-button").css("opacity","1.0"),d("#next-button").addClass("shop-active-button"),d("#next-button").attr("disabled",null),d("#next-button").attr("title",p.strings[2]))},"html")},delete_assign:function(t,a,e){var i,s,o=d(this),t=o.attr("data-role"),a=o.attr("data-product"),e=o.attr("data-email"),r=c.wwwroot+"/local/shop/front/ajax/service.php",l=o.attr("data-requiredroles").split(",");for(s in l)i=l[s],d("#assignrole"+i+"list"+a).html(p.waiter());d.post(r,{id:p.shopid,service:"users",what:"deleteassign",role:t,product:a,participantid:e},function(t){var e=JSON.parse(t);for(s in l)i=l[s],d("#assignrole"+i+"list"+a).html(e.content[i]);p.assigned--,p.assigned<0&&(p.assigned=0),p.assigned<p.required?(d("#next-button").css("opacity","0.5"),d("#next-button").removeClass("shop-active-button"),d("#next-button").attr("disabled","disabled"),d("#next-button").attr("title",p.strings[1])):(d("#next-button").css("opacity","1.0"),d("#next-button").addClass("shop-active-button"),d("#next-button").attr("disabled",null),d("#next-button").attr("title",p.strings[2]))},"html")},add_unit:function(t){t.stopPropagation(),t.preventDefault();var a=d(this),i=a.attr("data-product"),t=c.wwwroot+"/local/shop/front/ajax/service.php",e=(d("#bag_"+i).html(p.waiter()),a.attr("data-seoalias"));e&&(e=c.wwwroot+"/local/shop/pro/front/product/"+e+"/add",d.get(e)),d.post(t,{id:p.shopid,service:"shop",what:"addunit",productname:i},function(t){var t=JSON.parse(t),e=(d("#bag_"+i).html(t.html),p.update_details(),p.update_totals(),a.attr("data-maxquant"));s.debug(e+">="+t.quant),0<e&&t.quant>=e&&(d("#ci-"+i).attr("disabled","disabled"),d("#cimod-"+i).attr("disabled","disabled"))},"html"),p.units++,d("#next-button").attr("disabled",null),d("#next-button").addClass("shop-active-button"),d("#next-button").css("opacity","1.0"),d("#next-button").attr("title",p.strings[2])},delete_unit:function(t){t.stopPropagation(),t.preventDefault();var t=d(this),e=t.attr("data-product"),a=c.wwwroot+"/local/shop/front/ajax/service.php",t=(d("#bag_"+e).html(p.waiter()),t.attr("data-seoalias"));t&&(t=c.wwwroot+"/local/shop/pro/front/product/"+t+"/delete",d.get(t)),d.post(a,{id:p.shopid,service:"shop",what:"deleteunit",productname:e,clearall:0},function(t){t=JSON.parse(t);d("#bag_"+e).html(t.html),p.update_details(),p.update_totals(),s.debug("enabling product add button "+e),d("#ci-"+e).attr("disabled",null),d("#cimod-"+e).attr("disabled",null)},"html"),p.units--,0==p.units&&(d("#next-button").attr("disabled","disabled"),d("#next-button").removeClass("shop-active-button"),d("#next-button").css("opacity","0.5"),d("#next-button").attr("title",p.strings[3]))},clear_product:function(t){t.stopPropagation(),t.preventDefault();var t=d(this),e=t.attr("data-product"),a=c.wwwroot+"/local/shop/front/ajax/service.php",t=(d("#bag_"+e).html(p.waiter()),t.attr("data-seoalias"));t&&(t=c.wwwroot+"/local/shop/pro/front/product/"+t+"/deleteall",d.get(t)),d("#id_"+e).val(0),d("#ci-"+e).attr("disabled",null),d("#id_total_"+e).val(0),d.post(a,{id:p.shopid,service:"shop",what:"deleteunit",productname:e,clearall:1},function(t){t=JSON.parse(t);d("#bag_"+e).html(t.html),p.update_details(),p.update_totals()},"html")},update_product:function(t){t.stopPropagation(),t.preventDefault();var t=d(this),e=t.attr("data-product"),t=t.attr("data-maxquant"),a=c.wwwroot+"/local/shop/front/ajax/service.php",i=d("#id_"+e).val();0<t&&t<i&&(i=t),d("#id_"+e).val(i),d("#bag_"+e).html(p.waiter()),d.post(a,{id:p.shopid,service:"shop",what:"setunits",productname:e,quant:i},function(t){t=JSON.parse(t);d("#bag_"+e).html(t.html),p.update_details(),p.update_totals()},"html")},update_totals:function(){var t=c.wwwroot+"/local/shop/front/ajax/service.php";d("#shop-ordertotals").html(p.waiter()),d.post(t,{id:p.shopid,service:"shop",what:"ordertotals"},function(t){t=JSON.parse(t);d("#shop-ordertotals").html(t.html),d(".local-shop-detail-delete").unbind("click"),d(".local-shop-detail-delete").bind("click",p.clear_product),d(".local-shop-order-detail").unbind("change"),d(".local-shop-order-detail").bind("change",p.update_product)},"html")},update_details:function(){var t=c.wwwroot+"/local/shop/front/ajax/service.php";d("#order-detail").html(p.waiter()),d.post(t,{id:p.shopid,service:"shop",what:"orderdetails"},function(t){t=JSON.parse(t);d("#order-detail").html(t.html),d(".local-shop-delete-unit").unbind("click"),d(".local-shop-delete-unit").bind("click",p.delete_unit)},"html")},add_user:function(){var i=d(this),t=document.forms.participant,s=c.wwwroot+"/local/shop/front/ajax/service.php",l=i.attr("data-requiredroles").split(","),n=i.attr("data-products").split(","),e=new Object;e.lastname=t.lastname.value,e.firstname=t.firstname.value,e.email=t.email.value,e.city=t.city.value,p.enduserorganisationrequired||(e.institution=t.institution.value),p.endusermobilephonerequired||(e.phone2=t.phone2.value),d("#participantlist").html(p.waiter()),d.post(s,{id:p.shopid,service:"users",what:"addparticipant",participant:JSON.stringify(e),roles:JSON.stringify(l)},function(t){d("#participantlist").html(t),d(".local-shop-delete-user").unbind("click"),d(".local-shop-delete-user").bind("click",p.delete_user),(t=document.forms.participant).lastname.value="",t.firstname.value="",t.email.value="",p.endusermobilephonerequired||(t.phone2.value="");var e,a,t=i.attr("data-availableseats");for(i.attr("data-availableseats",--t),0==t&&i.attr("disabled","disabled"),e=0;e<l.length;e++)for(a=0;a<n.length;a++)d("#"+l[e]+"list"+n[a]).html(p.waiter());d.post(s,{id:p.shopid,service:"users",what:"assignalllistobj"},function(t){for(var e,a,i,s,o=JSON.parse(t),r=0;r<l.length;r++)for(a=l[r],e=0;e<n.length;e++)i=n[e],s=o.content[a][i],d("#"+a+"list"+i).html(s);d(".local-shop-add-assign").unbind("change"),d(".local-shop-add-assign").bind("change",this.add_assign)},"html")},"html")},delete_user:function(){var i=d(this),t=i.attr("data-ptmail"),s=c.wwwroot+"/local/shop/front/ajax/service.php",l=i.attr("data-requiredroles").split(","),n=i.attr("data-products").split(",");d("#participantlist").html(p.waiter()),d.post(s,{id:p.shopid,service:"users",what:"deleteparticipant",participantid:t,roles:JSON.stringify(l)},function(t){d("#participantlist").html(t),d(".local-shop-delete-user").unbind("click"),d(".local-shop-delete-user").bind("click",p.delete_user);var e,a,t=i.attr("data-availableseats");for(i.attr("data-availableseats",t+1),i.attr("disabled",null),d("#addparticipant-line").css("display","block"),e=0;e<l.length;e++)for(a=0;a<n.length;a++)d("#"+l[e]+"list"+n[a]).html(p.waiter());d.post(s,{id:p.shopid,service:"users",what:"assignalllistobj"},function(t){for(var e,a,i,s,o=JSON.parse(t),r=0;r<l.length;r++)for(a=l[r],e=0;e<n.length;e++)i=n[e],s=o.content[a][i],d("#"+a+"list"+i).html(s);d(".local-shop-add-assign").unbind("change"),d(".local-shop-add-assign").bind("change",this.add_assign)},"html")})},check_pass_code:function(t){var e=d(this),a=e.attr("data-product"),i=c.wwwroot+"/local/shop/front/ajax/service.php",s='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/ajaxloader.gif" />',o='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/valid.png" />',r='<img width="14" height="14" src="'+c.wwwroot+'/local/shop/pix/invalid.png" />',s=(d("#ci-pass-status-"+a).html(s),d("#cimod-pass-status-"+a).html(s),e.val()+t.key);d.post(i,{id:p.shopid,service:"shop",what:"checkpasscode",productname:a,passcode:s},function(t){"passed"==JSON.parse(t).status?(d("#ci-"+a).attr("disabled",null),d("#ci-pass-status-"+a).html(o),d("#cimod-"+a).attr("disabled",null),d("#cimod-pass-status-"+a).html(o)):(d("#ci-pass-status-"+a).html(r),d("#cimod-pass-status-"+a).html(r))},"html")},check_email:function(){var t=d(this);return!!/^\w+([\.+-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(t.val())||(alert(p.strings[0]),t.val(""),!1)},waiter:function(){return'<div class="ajax-waiter"><center><img src="'+c.wwwroot+'/local/shop/pix/loading29.gif" /><center></div>'},open_popup:function(t){t=d(this).attr("data-target");window.open(t,"product","width=400,height=500,toolbar=0,menubar=0,statusbar=0")},openSalesPopup:function(){window.open(c.wwwroot+"/local/shop/popup.php?p=sales","sales","width=600,height=600,toolbar=0,menubar=0,statusbar=0, resizable=1,scrollbars=1")}};return p});