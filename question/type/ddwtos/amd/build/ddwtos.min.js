define(["jquery","core/dragdrop","core/key_codes"],function(i,r,s){"use strict";function o(e,t){this.containerId=e,t&&this.getRoot().addClass("qtype_ddwtos-readonly"),this.resizeAllDragsAndDrops(),this.cloneDrags(),this.positionDrags()}o.prototype.resizeAllDragsAndDrops=function(){var o=this;this.getRoot().find(".answercontainer > div").each(function(e,t){o.resizeAllDragsAndDropsInGroup(o.getClassnameNumericSuffix(i(t),"draggrouphomes"))})},o.prototype.resizeAllDragsAndDropsInGroup=function(e){var o=this,t=this.getRoot().find(".draggrouphomes"+e+" span.draghome"),n=0,r=0;t.each(function(e,t){n=Math.max(n,Math.ceil(t.offsetWidth)),r=Math.max(r,Math.ceil(0+t.offsetHeight))}),n+=8,r+=2,t.each(function(e,t){o.setElementSize(t,n,r)}),this.getRoot().find("span.drop.group"+e).each(function(e,t){o.setElementSize(t,n,r)})},o.prototype.setElementSize=function(e,t,o){i(e).width(t).height(o).css("lineHeight",o+"px")},o.prototype.cloneDrags=function(){var o=this;this.getRoot().find("span.draghome").each(function(e,t){o.cloneDragsForOneChoice(i(t))})},o.prototype.cloneDragsForOneChoice=function(e){if(e.hasClass("infinite"))for(var t=this.noOfDropsInGroup(this.getGroup(e)),o=0;o<t;o++)this.cloneDrag(e);else this.cloneDrag(e)},o.prototype.cloneDrag=function(e){var t=e.clone();t.removeClass("draghome").addClass("drag unplaced moodle-has-zindex").offset(e.offset()),this.getRoot().find("div.drags").append(t)},o.prototype.positionDrags=function(){var r=this,s=this.getRoot();s.find("span.drag").each(function(e,t){var t=i(t),o=r.getClassnameNumericSuffix(t,"inplace");t.addClass("unplaced").removeClass("placed").offset(r.getDragHome(r.getGroup(t),r.getChoice(t)).offset()),null!==o&&t.removeClass("inplace"+o)}),s.find("input.placeinput").each(function(e,t){var o,t=i(t),n=t.val();"0"!==n&&(o=r.getPlace(t),r.getUnplacedChoice(r.getGroup(t),n).removeClass("unplaced").addClass("placed inplace"+o).offset(s.find(".drop.place"+o).offset()))})},o.prototype.handleDragStart=function(e){var t,n=this,o=i(e.target).closest(".drag");r.prepare(e).start&&(null!==(t=this.getClassnameNumericSuffix(o,"inplace"))&&(this.setInputValue(t,0),o.removeClass("inplace"+t)),o.addClass("beingdragged"),r.start(e,o,function(e,t,o){n.dragMove(e,t,o)},function(e,t,o){n.dragEnd(e,t,o)}))},o.prototype.dragMove=function(o,n,e){var r=this;this.getRoot().find("span.drop.group"+this.getGroup(e)).each(function(e,t){t=i(t);r.isPointInDrop(o,n,t)?t.addClass("valid-drag-over-drop"):t.removeClass("valid-drag-over-drop")})},o.prototype.dragEnd=function(o,n,r){var s=this,e=this.getRoot(),a=!1;e.find("span.drop.group"+this.getGroup(r)).each(function(e,t){t=i(t);return!s.isPointInDrop(o,n,t)||(t.removeClass("valid-drag-over-drop"),s.sendDragToDrop(r,t),!(a=!0))}),a||this.sendDragHome(r)},o.prototype.sendDragToDrop=function(e,t){var o=this.getCurrentDragInPlace(this.getPlace(t));0!==o.length&&this.sendDragHome(o),0===e.length?this.setInputValue(this.getPlace(t),0):(this.setInputValue(this.getPlace(t),this.getChoice(e)),e.removeClass("unplaced").addClass("placed inplace"+this.getPlace(t)),this.animateTo(e,t))},o.prototype.sendDragHome=function(e){e.removeClass("placed").addClass("unplaced");var t=this.getClassnameNumericSuffix(e,"inplace");null!==t&&e.removeClass("inplace"+t),this.animateTo(e,this.getDragHome(this.getGroup(e),this.getChoice(e)))},o.prototype.handleKeyPress=function(e){var t=i(e.target).closest(".drop"),o=this.getCurrentDragInPlace(this.getPlace(t)),n=i();switch(e.keyCode){case s.space:case s.arrowRight:case s.arrowDown:n=this.getNextDrag(this.getGroup(t),o);break;case s.arrowLeft:case s.arrowUp:n=this.getPreviousDrag(this.getGroup(t),o);break;case s.escape:break;default:return}e.preventDefault(),this.sendDragToDrop(n,t)},o.prototype.getNextDrag=function(e,t){for(var o=this.noOfChoicesInGroup(e),n=0===t.length?1:this.getChoice(t)+1,r=this.getUnplacedChoice(e,n);0===r.length&&n<o;)r=this.getUnplacedChoice(e,++n);return r},o.prototype.getPreviousDrag=function(e,t){for(var o=0===t.length?this.noOfChoicesInGroup(e):this.getChoice(t)-1,n=this.getUnplacedChoice(e,o);0===n.length&&1<o;)n=this.getUnplacedChoice(e,--o);return n},o.prototype.animateTo=function(e,t){var o=e.offset(),n=t.offset();e.addClass("beingdragged"),e.animate({left:parseInt(e.css("left"))+n.left-o.left,top:parseInt(e.css("top"))+n.top-o.top},{duration:"fast",done:function(){e.removeClass("beingdragged"),e.offset(n)}})},o.prototype.isPointInDrop=function(e,t,o){var n=o.offset();return e>=n.left&&e<n.left+o.width()&&t>=n.top&&t<n.top+o.height()},o.prototype.setInputValue=function(e,t){this.getRoot().find("input.placeinput.place"+e).val(t)},o.prototype.getRoot=function(){return i(document.getElementById(this.containerId))},o.prototype.getDragHome=function(e,t){return this.getRoot().find(".draghome.group"+e+".choice"+t)},o.prototype.getUnplacedChoice=function(e,t){return this.getRoot().find(".drag.group"+e+".choice"+t+".unplaced").slice(0,1)},o.prototype.getCurrentDragInPlace=function(e){return this.getRoot().find("span.drag.inplace"+e)},o.prototype.noOfDropsInGroup=function(e){return this.getRoot().find(".drop.group"+e).length},o.prototype.noOfChoicesInGroup=function(e){return this.getRoot().find(".draghome.group"+e).length},o.prototype.getClassnameNumericSuffix=function(e,t){e=e.attr("class");if(""!==e)for(var o,n=e.split(" "),r=0;r<n.length;r++)if(new RegExp("^"+t+"([0-9])+$").test(n[r]))return o=new RegExp("([0-9])+$").exec(n[r]),Number(o[0]);return null},o.prototype.getChoice=function(e){return this.getClassnameNumericSuffix(e,"choice")},o.prototype.getGroup=function(e){return this.getClassnameNumericSuffix(e,"group")};var n={eventHandlersInitialised:!(o.prototype.getPlace=function(e){return this.getClassnameNumericSuffix(e,"place")}),questions:{},init:function(e,t){n.questions[e]=new o(e,t),n.eventHandlersInitialised||(n.setupEventHandlers(),n.eventHandlersInitialised=!0)},setupEventHandlers:function(){i("body").on("mousedown touchstart",".que.ddwtos:not(.qtype_ddwtos-readonly) span.drag",n.handleDragStart).on("keydown",".que.ddwtos:not(.qtype_ddwtos-readonly) span.drop",n.handleKeyPress),i(window).on("resize",n.handleWindowResize)},handleDragStart:function(e){e.preventDefault();var t=n.getQuestionForEvent(e);t&&t.handleDragStart(e)},handleKeyPress:function(e){var t=n.getQuestionForEvent(e);t&&t.handleKeyPress(e)},handleWindowResize:function(){for(var e in n.questions)n.questions.hasOwnProperty(e)&&n.questions[e].positionDrags()},getQuestionForEvent:function(e){e=i(e.currentTarget).closest(".que.ddwtos").attr("id");return n.questions[e]}};return{init:n.init}});