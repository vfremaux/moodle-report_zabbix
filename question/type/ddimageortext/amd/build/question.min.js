define(["jquery","core/dragdrop","core/key_codes"],function(d,a,i){"use strict";function n(e,t,o){this.containerId=e,M.util.js_pending("qtype_ddimageortext-init-"+this.containerId),this.places=o,this.allImagesLoaded=!1,this.imageLoadingTimeoutId=null,t&&this.getRoot().addClass("qtype_ddimageortext-readonly");var n=this;this.getNotYetLoadedImages().one("load",function(){n.waitForAllImagesToBeLoaded()}),this.waitForAllImagesToBeLoaded()}n.prototype.waitForAllImagesToBeLoaded=function(){var e=this;this.allImagesLoaded||(null!==this.imageLoadingTimeoutId&&clearTimeout(this.imageLoadingTimeoutId),0<this.getNotYetLoadedImages().length?this.imageLoadingTimeoutId=setTimeout(function(){e.waitForAllImagesToBeLoaded()},100):(this.allImagesLoaded=!0,e.setupQuestion()))},n.prototype.getNotYetLoadedImages=function(){var o=this;return this.getRoot().find(".ddarea img").not(function(e,t){return o.imageIsLoaded(t)})},n.prototype.imageIsLoaded=function(e){return e.complete&&0!==e.naturalHeight},n.prototype.setupQuestion=function(){this.resizeAllDragsAndDrops(),this.cloneDrags(),this.positionDragsAndDrops(),M.util.js_complete("qtype_ddimageortext-init-"+this.containerId)},n.prototype.resizeAllDragsAndDrops=function(){var o=this;this.getRoot().find(".draghomes > div").each(function(e,t){o.resizeAllDragsAndDropsInGroup(o.getClassnameNumericSuffix(d(t),"dragitemgroup"))})},n.prototype.resizeAllDragsAndDropsInGroup=function(e){var t,o,n,a=this.getRoot(),i=a.find(".dragitemgroup"+e+" .draghome"),r=0,s=0;for(t in i.each(function(e,t){r=Math.max(r,Math.ceil(t.offsetWidth)),s=Math.max(s,Math.ceil(t.offsetHeight))}),r+=10,s+=10,i.each(function(e,t){var o=Math.round((r-t.offsetWidth)/2),n=Math.floor((s-t.offsetHeight)/2);d(t).css({"padding-left":o+"px","padding-right":r-t.offsetWidth-o+"px","padding-top":n+"px","padding-bottom":s-t.offsetHeight-n+"px"})}),this.places)this.places.hasOwnProperty(t)&&(n=(o=this.places[t]).text,parseInt(o.group)===e&&(""===n&&(n=M.util.get_string("blank","qtype_ddimageortext")),a.find(".dropzones").append('<div class="dropzone group'+o.group+" place"+t+'" tabindex="0"><span class="accesshide">'+n+"</span>&nbsp;</div>"),a.find(".dropzone.place"+t).width(r-2).height(s-2)))},n.prototype.cloneDrags=function(){var o=this;this.getRoot().find(".ddarea .draghome").each(function(e,t){o.cloneDragsForOneChoice(d(t))})},n.prototype.cloneDragsForOneChoice=function(e){if(e.hasClass("infinite"))for(var t=this.noOfDropsInGroup(this.getGroup(e)),o=0;o<t;o++)this.cloneDrag(e);else this.cloneDrag(e)},n.prototype.cloneDrag=function(e){var t=e.clone();t.removeClass("draghome").addClass("drag unplaced moodle-has-zindex").offset(e.offset()),this.getRoot().find(".dragitems").append(t)},n.prototype.positionDragsAndDrops=function(){var a=this,i=this.getRoot(),n=this.bgImage().offset();i.find(".ddarea .dropzone").each(function(e,t){var t=d(t),o=a.places[a.getPlace(t)];t.offset({left:n.left+parseInt(o.xy[0]),top:n.top+parseInt(o.xy[1])})}),i.find(".ddarea .drag").each(function(e,t){var t=d(t),o=a.getClassnameNumericSuffix(t,"inplace");t.addClass("unplaced").removeClass("placed").offset(a.getDragHome(a.getGroup(t),a.getChoice(t)).offset()),null!==o&&t.removeClass("inplace"+o)}),i.find("input.placeinput").each(function(e,t){var o,t=d(t),n=t.val();"0"!==n&&(o=a.getPlace(t),a.getUnplacedChoice(a.getGroup(t),n).removeClass("unplaced").addClass("placed inplace"+o).offset(i.find(".dropzone.place"+o).offset()))}),this.bgImage().data("prev-top",n.top).data("prev-left",n.left)},n.prototype.fixLayoutIfBackgroundMoved=function(){var e=this.bgImage(),t=e.offset(),o=e.data("prev-top"),e=e.data("prev-left");void 0!==e&&void 0!==o&&(o===t.top&&e===t.left||this.positionDragsAndDrops())},n.prototype.handleDragStart=function(e){var t,n=this,o=d(e.target).closest(".drag");a.prepare(e).start&&(null!==(t=this.getClassnameNumericSuffix(o,"inplace"))&&(this.setInputValue(t,0),o.removeClass("inplace"+t)),o.addClass("beingdragged"),a.start(e,o,function(e,t,o){n.dragMove(e,t,o)},function(e,t,o){n.dragEnd(e,t,o)}))},n.prototype.dragMove=function(o,n,e){var a=this;this.getRoot().find(".dropzone.group"+this.getGroup(e)).each(function(e,t){t=d(t);a.isPointInDrop(o,n,t)?t.addClass("valid-drag-over-drop"):t.removeClass("valid-drag-over-drop")})},n.prototype.dragEnd=function(o,n,a){var i=this,e=this.getRoot(),r=!1;e.find(".dropzone.group"+this.getGroup(a)).each(function(e,t){t=d(t);return!i.isPointInDrop(o,n,t)||(t.removeClass("valid-drag-over-drop"),i.sendDragToDrop(a,t),!(r=!0))}),r||this.sendDragHome(a)},n.prototype.sendDragToDrop=function(e,t){var o=this.getCurrentDragInPlace(this.getPlace(t));0!==o.length&&this.sendDragHome(o),0===e.length?this.setInputValue(this.getPlace(t),0):(this.setInputValue(this.getPlace(t),this.getChoice(e)),e.removeClass("unplaced").addClass("placed inplace"+this.getPlace(t)),this.animateTo(e,t))},n.prototype.sendDragHome=function(e){e.removeClass("placed").addClass("unplaced");var t=this.getClassnameNumericSuffix(e,"inplace");null!==t&&e.removeClass("inplace"+t),this.animateTo(e,this.getDragHome(this.getGroup(e),this.getChoice(e)))},n.prototype.handleKeyPress=function(e){var t=d(e.target).closest(".dropzone"),o=this.getCurrentDragInPlace(this.getPlace(t)),n=d();switch(e.keyCode){case i.space:case i.arrowRight:case i.arrowDown:n=this.getNextDrag(this.getGroup(t),o);break;case i.arrowLeft:case i.arrowUp:n=this.getPreviousDrag(this.getGroup(t),o);break;case i.escape:break;default:return}e.preventDefault(),this.sendDragToDrop(n,t)},n.prototype.getNextDrag=function(e,t){for(var o=this.noOfChoicesInGroup(e),n=0===t.length?1:this.getChoice(t)+1,a=this.getUnplacedChoice(e,n);0===a.length&&n<o;)a=this.getUnplacedChoice(e,++n);return a},n.prototype.getPreviousDrag=function(e,t){for(var o=0===t.length?this.noOfChoicesInGroup(e):this.getChoice(t)-1,n=this.getUnplacedChoice(e,o);0===n.length&&1<o;)n=this.getUnplacedChoice(e,--o);return n},n.prototype.animateTo=function(e,t){var o=e.offset(),n=t.offset();e.addClass("beingdragged"),e.animate({left:parseInt(e.css("left"))+n.left-o.left,top:parseInt(e.css("top"))+n.top-o.top},{duration:"fast",done:function(){e.removeClass("beingdragged"),e.offset(n)}})},n.prototype.isPointInDrop=function(e,t,o){var n=o.offset();return e>=n.left&&e<n.left+o.width()&&t>=n.top&&t<n.top+o.height()},n.prototype.setInputValue=function(e,t){this.getRoot().find("input.placeinput.place"+e).val(t)},n.prototype.getRoot=function(){return d(document.getElementById(this.containerId))},n.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")},n.prototype.getDragHome=function(e,t){return this.getRoot().find(".ddarea .draghome.group"+e+".choice"+t)},n.prototype.getUnplacedChoice=function(e,t){return this.getRoot().find(".ddarea .drag.group"+e+".choice"+t+".unplaced").slice(0,1)},n.prototype.getCurrentDragInPlace=function(e){return this.getRoot().find(".ddarea .drag.inplace"+e)},n.prototype.noOfDropsInGroup=function(e){return this.getRoot().find(".dropzone.group"+e).length},n.prototype.noOfChoicesInGroup=function(e){return this.getRoot().find(".dragitemgroup"+e+" .draghome").length},n.prototype.getClassnameNumericSuffix=function(e,t){e=e.attr("class");if(""!==e)for(var o,n=e.split(" "),a=0;a<n.length;a++)if(new RegExp("^"+t+"([0-9])+$").test(n[a]))return o=new RegExp("([0-9])+$").exec(n[a]),Number(o[0]);return null},n.prototype.getChoice=function(e){return this.getClassnameNumericSuffix(e,"choice")},n.prototype.getGroup=function(e){return this.getClassnameNumericSuffix(e,"group")};var r={eventHandlersInitialised:!(n.prototype.getPlace=function(e){return this.getClassnameNumericSuffix(e,"place")}),questions:{},init:function(e,t,o){r.questions[e]=new n(e,t,o),r.eventHandlersInitialised||(r.setupEventHandlers(),r.eventHandlersInitialised=!0)},setupEventHandlers:function(){d("body").on("mousedown touchstart",".que.ddimageortext:not(.qtype_ddimageortext-readonly) .dragitems .drag",r.handleDragStart).on("keydown",".que.ddimageortext:not(.qtype_ddimageortext-readonly) .dropzones .dropzone",r.handleKeyPress),d(window).on("resize",r.handleWindowResize),setTimeout(r.fixLayoutIfThingsMoved,100)},handleDragStart:function(e){e.preventDefault();var t=r.getQuestionForEvent(e);t&&t.handleDragStart(e)},handleKeyPress:function(e){var t=r.getQuestionForEvent(e);t&&t.handleKeyPress(e)},handleWindowResize:function(){for(var e in r.questions)r.questions.hasOwnProperty(e)&&r.questions[e].positionDragsAndDrops()},fixLayoutIfThingsMoved:function(){for(var e in r.questions)r.questions.hasOwnProperty(e)&&r.questions[e].fixLayoutIfBackgroundMoved();setTimeout(r.fixLayoutIfThingsMoved,100)},getQuestionForEvent:function(e){e=d(e.currentTarget).closest(".que.ddimageortext").attr("id");return r.questions[e]}};return{init:r.init}});