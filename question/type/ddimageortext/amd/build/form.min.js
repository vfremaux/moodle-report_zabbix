define(["jquery","core/dragdrop"],function(f,t){"use strict";var g={maxBgImageSize:null,maxDragImageSize:null,fp:null,init:function(e,r){g.maxBgImageSize=e,g.maxDragImageSize=r,g.fp=g.filePickers(),f("#id_previewareaheader").append('<div class="ddarea">  <div class="droparea">    <img class="dropbackground" />    <div class="dropzones"></div>  </div>  <div class="dragitems"></div></div>'),g.updateVisibilityOfFilePickers(),g.setOptionsForDragItemSelectors(),g.setupEventHandlers(),g.waitForFilePickerToInitialise()},waitForFilePickerToInitialise:function(){null!==g.fp.file("bgimage").href?(M.util.js_pending("dragDropToImageForm"),f("form.mform").on("change",".filepickerhidden",function(){M.util.js_pending("dragDropToImageForm"),g.loadPreviewImage()}),g.loadPreviewImage()):setTimeout(g.waitForFilePickerToInitialise,1e3)},loadPreviewImage:function(){f("fieldset#id_previewareaheader .dropbackground").one("load",g.afterPreviewImageLoaded).attr("src",g.fp.file("bgimage").href)},afterPreviewImageLoaded:function(){var e=f("fieldset#id_previewareaheader .dropbackground");g.constrainImageSize(e,g.maxBgImageSize),g.createDropZones(),M.util.js_complete("dragDropToImageForm")},constrainImageSize:function(e,r){r=Math.max(e.width()/r.width,e.height()/r.height);1<r&&e.css("width",Math.floor(e.width()/r)),e.addClass("constrained")},createDropZones:function(){var e=f(".dropzones");if(e.empty(),null!==g.fp.file("bgimage").href){for(var r=g.form.getFormValue("nodropzone",[]),t=0;t<r;t++){var o,a,i=g.form.getFormValue("drops",[t,"choice"]);"0"!==i&&(i-=1,o=g.form.getFormValue("drags",[i,"draggroup"]),a=g.form.getFormValue("draglabel",[i]),"image"===g.form.getFormValue("drags",[i,"dragitemtype"])?null!==(i=g.fp.file("dragitem["+i+"]").href)&&e.append('<img class="droppreview group'+o+" drop"+t+'" src="'+i+'" alt="'+a+'" data-drop-no="'+t+'">'):""!==a&&e.append('<div class="droppreview group'+o+" drop"+t+'"  data-drop-no="'+t+'">'+a+"</div>"))}g.waitForAllDropImagesToBeLoaded()}},waitForAllDropImagesToBeLoaded:function(){0<f(".dropzones img").not(function(e,r){return g.imageIsLoaded(r)}).length?setTimeout(function(){g.waitForAllDropImagesToBeLoaded()},100):g.updateDropZones()},imageIsLoaded:function(e){return e.complete&&0!==e.naturalHeight},updateDropZones:function(){if(null!==g.fp.file("bgimage").href){for(var e=f("fieldset#id_previewareaheader .dropbackground").offset(),r=g.form.getFormValue("nodropzone",[]),t=0;t<r;t++){var o,a=f(".dropzones .drop"+t);0!==a.length&&(o=g.form.getFormValue("drops",[t,"choice"])-1,a.offset({left:e.left+parseInt(g.form.getFormValue("drops",[t,"xleft"])),top:e.top+parseInt(g.form.getFormValue("drops",[t,"ytop"]))}),o=g.form.getFormValue("draglabel",[o]),a.is("img")?a.attr("alt",o):a.html(o))}f(".dropzones .droppreview").css("padding","0");for(var i=f("select.draggroup").first().find("option").length,n=1;n<=i;n++)g.resizeAllDragsAndDropsInGroup(n)}},resizeAllDragsAndDropsInGroup:function(e){var e=f(".dropzones .droppreview.group"+e),a=0,i=0;e.each(function(e,r){a=Math.max(a,Math.ceil(r.offsetWidth)),i=Math.max(i,Math.ceil(r.offsetHeight))}),a+=10,i+=10,e.each(function(e,r){var t=Math.round((a-r.offsetWidth)/2),o=Math.floor((i-r.offsetHeight)/2);f(r).css({"padding-left":t+"px","padding-right":a-r.offsetWidth-t+"px","padding-top":o+"px","padding-bottom":i-r.offsetHeight-o+"px"})})},setupEventHandlers:function(){f("fieldset#id_draggableitemheader").on("change input","input, select",function(e){e=f(e.target).closest("select, input");e.hasClass("dragitemtype")&&g.updateVisibilityOfFilePickers(),g.setOptionsForDragItemSelectors(),e.is(".dragitemtype, .draggroup")?g.createDropZones():e.is(".draglabel")&&g.updateDropZones()}),f("fieldset#id_dropzoneheader").on("change input","input, select",function(e){f(e.target).closest("select, input").is("select")?g.createDropZones():g.updateDropZones()}),f("fieldset#id_previewareaheader").on("mousedown touchstart",".droppreview",function(e){g.dragStart(e)}),f(window).on("resize",function(){g.updateDropZones()})},updateVisibilityOfFilePickers:function(){for(var e=g.form.getFormValue("noitems",[]),r=0;r<e;r++){var t=f("input#id_dragitem_"+r).closest(".fitem_ffilepicker");"image"===g.form.getFormValue("drags",[r,"dragitemtype"])?t.show():t.hide()}},setOptionsForDragItemSelectors:function(){for(var e={0:""},r=g.form.getFormValue("noitems",[]),t=g.form.getFormValue("nodropzone",[]),o=0;o<r;o++){var a=g.form.getFormValue("draglabel",[o]),i=g.fp.file(g.form.toNameWithIndex("dragitem",[o]));"image"===g.form.getFormValue("drags",[o,"dragitemtype"])&&null!==i.name?e[o+1]=o+1+". "+a+" ("+i.name+")":""!==a&&(e[o+1]=o+1+". "+a)}for(var n=0;n<t;n++){var d,s,l=f("#id_drops_"+n+"_choice"),p=l.val();for(d in l.find("option").remove(),e)e.hasOwnProperty(d)&&(l.append('<option value="'+d+'">'+e[d]+"</option>"),s=l.find('option[value="'+d+'"]'),parseInt(d)===parseInt(p)?s.attr("selected",!0):g.isItemUsed(parseInt(d))&&s.attr("disabled",!0))}},isItemUsed:function(t){return 0!==t&&(!g.form.getFormValue("drags",[t-1,"infinite"])&&0!==f("fieldset#id_dropzoneheader select").filter(function(e,r){return parseInt(f(r).val())===t}).length)},dragStart:function(e){var r=f(e.target).closest(".droppreview");t.prepare(e).start&&t.start(e,r,function(e,r,t){g.dragMove(t)},function(){g.dragEnd()})},dragMove:function(e){var r=f("fieldset#id_previewareaheader .dropbackground"),t=r.offset(),o=e.data("dropNo"),a=e.offset(),i=Math.round(a.left-t.left),a=Math.round(a.top-t.top),i=Math.max(0,Math.min(i,r.width()-e.width()-10)),a=Math.max(0,Math.min(a,r.height()-e.height()-10));g.form.setFormValue("drops",[o,"xleft"],i),g.form.setFormValue("drops",[o,"ytop"],a)},dragEnd:function(){g.updateDropZones()},form:{toNameWithIndex:function(e,r){for(var t=e,o=0;o<r.length;o++)t=t+"["+r[o]+"]";return t},getEl:function(e,r){return document.getElementById("mform1").elements[this.toNameWithIndex(e,r)]},getFormValue:function(e,r){e=this.getEl(e,r);return"checkbox"===(e=e.type?e:e[e.length-1]).type?e.checked:e.value},setFormValue:function(e,r,t){e=this.getEl(e,r);"checkbox"===e.type?e.checked=t:e.value=t}},filePickers:function(){var t={},o={};return f("form.mform input.filepickerhidden").each(function(e,r){t[r.value]=r.name,o[r.name]=r.parentNode}),{file:function(e){e=f(o[e]).find("div.filepicker-filelist a");return e.length?{href:e.get(0).href,name:e.get(0).innerHTML}:{href:null,name:null}},name:function(e){return t[e]}}}};return{init:g.init}});