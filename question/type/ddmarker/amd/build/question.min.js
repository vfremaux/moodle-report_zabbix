define(["jquery","core/dragdrop","qtype_ddmarker/shapes","core/key_codes"],function(d,o,g,n){"use strict";function i(e,t,o,r){this.containerId=e,this.visibleDropZones=r,o&&this.getRoot().addClass("qtype_ddmarker-readonly"),this.loadImage(t)}i.prototype.loadImage=function(e){var t=this;this.getRoot().find(".dropbackground").one("load",function(){0<t.visibleDropZones.length&&t.drawDropzones(),t.repositionDrags()}).attr("src",e).css({border:"1px solid #000","max-width":"none"})},i.prototype.drawDropzones=function(){for(var e=this.getRoot().find("img.dropbackground"),t=(this.getRoot().find("div.dropzones").html('<svg xmlns="http://www.w3.org/2000/svg" class="dropzones" width="'+e.outerWidth()+'" height="'+e.outerHeight()+'"></svg>'),this.getRoot().find("svg.dropzones")),o=(t.css("position","absolute"),0),r=0;r<this.visibleDropZones.length;r++){var n="color"+o,o=(o+1)%8;this.addDropzone(t,r,n)}},i.prototype.addDropzone=function(e,t,o){var r,n=this.visibleDropZones[t],i=g.make(n.shape,"");i.parse(n.coords)&&((r=this.getRoot().find("div.markertexts span.markertext"+t)).length?""!==n.markertext?r.html(n.markertext):r.remove():""!==n.markertext&&(r="markertext markertext"+t,this.getRoot().find("div.markertexts").append('<span class="'+r+'">'+n.markertext+"</span>")),i.makeSvg(e[0]).setAttribute("class","dropzone "+o))},i.prototype.repositionDropZones=function(){var e=this.getRoot().find("svg.dropzones");if(0!==e.length){var t=this.convertToWindowXY(new g.Point(-1,0));e.offset({left:t.x,top:t.y});for(var o=0;o<this.visibleDropZones.length;o++){var r,n,i=this.getRoot().find("div.ddarea div.markertexts span.markertext"+o);0!==i.length&&(r=this.visibleDropZones[o],(n=g.make(r.shape,"")).parse(r.coords)&&(r=n.getHandlePositions(),n=this.convertToWindowXY(r.moveHandle.offset(-i.outerWidth()/2,-i.outerHeight()/2)),i.offset({left:n.x-4,top:n.y})))}}},i.prototype.repositionDrags=function(){var e=this.getRoot(),a=this,e=(e.find("div.dragitems .dragitem").each(function(e,t){d(t).addClass("unneeded")}),e.find("input.choices").each(function(e,t){for(var o=a.getChoiceNoFromElement(t),r=a.getCoords(t),n=a.dragHome(o),i=0;i<r.length;i++){var s=a.dragItem(o,i);!s.length||s.hasClass("beingdragged")?s=a.cloneNewDragItem(n,i):s.removeClass("unneeded"),s.offset({left:r[i].x,top:r[i].y})}}),e.find("div.dragitems .dragitem").each(function(e,t){t=d(t);t.hasClass("unneeded")&&!t.hasClass("beingdragged")&&t.remove()}),this.repositionDropZones(),this.bgImage()),t=e.offset();e.data("prev-top",t.top).data("prev-left",t.left)},i.prototype.getCoords=function(e){var t=this.getRoot(),o=this.getChoiceNoFromElement(e),r=Number(this.getClassnameNumericSuffix(e,"noofdrags")),t=0<t.find("span.dragitem.beingdragged.choice"+o).length,n=[],i=d(e).val();if(""!==i)for(var s=i.split(";"),a=0;a<s.length;a++)n[a]=this.convertToWindowXY(g.Point.parse(s[a]));i=n.length+(t?1:0);return(d(e).hasClass("infinite")||i<r)&&(n[n.length]=this.dragHomeXY(o)),n},i.prototype.convertToWindowXY=function(e){var t=this.bgImage();return e.offset(t.offset().left+1,t.offset().top+1)},i.prototype.convertToBgImgXY=function(e){var t=this.bgImage();return e.offset(-t.offset().left-1,-t.offset().top-1)},i.prototype.coordsInBgImg=function(e){var t=this.bgImage();return 0<e.x&&e.x<=t.width()&&0<e.y&&e.y<=t.height()},i.prototype.dragHomeXY=function(e){e=this.dragHome(e);return new g.Point(e.offset().left,e.offset().top)},i.prototype.getRoot=function(){return d(document.getElementById(this.containerId))},i.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")},i.prototype.dragHome=function(e){return this.getRoot().find("div.dragitems span.draghome.choice"+e)},i.prototype.dragItem=function(e,t){return this.getRoot().find("div.dragitems span.dragitem.choice"+e+".item"+t)},i.prototype.cloneNewDragItem=function(e,t){var o=e.clone(!0);return o.removeClass("draghome").addClass("dragitem").addClass("item"+t),e.after(o),o.attr("tabIndex",0),o},i.prototype.handleDragStart=function(e){var r=this,t=d(e.target).closest(".dragitem");o.prepare(e).start&&(t.addClass("beingdragged"),o.start(e,t,function(){},function(e,t,o){r.dragEnd(o)}))},i.prototype.dragEnd=function(e){e.removeClass("beingdragged");var t=this.getChoiceNoFromElement(e);this.saveCoordsForChoice(t,e),this.repositionDrags()},i.prototype.saveCoordsForChoice=function(e,t){for(var o,r=[],n=this.getRoot().find("span.dragitem.choice"+e).length,i=!0,s=0;s<=n;s++){var a=this.dragItem(e,s);0!==a.length&&(a.hasClass("beingdragged")||(o=this.convertToBgImgXY(new g.Point(a.offset().left,a.offset().top)),this.coordsInBgImg(o)&&(r[r.length]=o)),t&&0!==t.length&&t[0].innerText===a[0].innerText&&(i=!1))}i&&(o=this.convertToBgImgXY(new g.Point(t.offset().left,t.offset().top)),this.coordsInBgImg(o)&&(r[r.length]=o)),this.getRoot().find("input.choice"+e).val(r.join(";"))},i.prototype.handleKeyPress=function(e){var t=d(e.target).closest(".dragitem"),o=new g.Point(t.offset().left,t.offset().top),r=this.getChoiceNoFromElement(t);switch(e.keyCode){case n.arrowLeft:case 65:--o.x;break;case n.arrowRight:case 68:o.x+=1;break;case n.arrowDown:case 83:o.y+=1;break;case n.arrowUp:case 87:--o.y;break;case n.space:case n.escape:o=null;break;default:return}e.preventDefault(),o=null!==o?this.constrainToBgImg(o):this.dragHomeXY(r),t.offset({left:o.x,top:o.y}),this.saveCoordsForChoice(r,t),this.repositionDrags()},i.prototype.constrainToBgImg=function(e){var t=this.bgImage(),e=this.convertToBgImgXY(e);return e.x=Math.max(0,e.x),e.y=Math.max(0,e.y),e.x=Math.min(t.width(),e.x),e.y=Math.min(t.height(),e.y),this.convertToWindowXY(e)},i.prototype.getChoiceNoFromElement=function(e){return Number(this.getClassnameNumericSuffix(e,"choice"))},i.prototype.getClassnameNumericSuffix=function(e,t){e=d(e).attr("class");if(void 0!==e&&""!==e)for(var o,r=e.split(" "),n=0;n<r.length;n++)if(new RegExp("^"+t+"([0-9])+$").test(r[n]))return o=new RegExp("([0-9])+$").exec(r[n]),Number(o[0]);return null},i.prototype.handleResize=function(){this.repositionDrags()};var s={eventHandlersInitialised:!(i.prototype.fixLayoutIfBackgroundMoved=function(){var e=this.bgImage(),t=e.offset(),o=e.data("prev-top"),e=e.data("prev-left");void 0!==e&&void 0!==o&&(o===t.top&&e===t.left||this.repositionDrags())}),questions:{},init:function(e,t,o,r){s.questions[e]=new i(e,t,o,r),s.eventHandlersInitialised||(s.setupEventHandlers(),s.eventHandlersInitialised=!0)},setupEventHandlers:function(){d("body").on("mousedown touchstart",".que.ddmarker:not(.qtype_ddmarker-readonly) div.dragitems .dragitem",s.handleDragStart).on("keydown keypress",".que.ddmarker:not(.qtype_ddmarker-readonly) div.dragitems .dragitem",s.handleKeyPress),d(window).on("resize",s.handleWindowResize),setTimeout(s.fixLayoutIfThingsMoved,100)},handleDragStart:function(e){e.preventDefault();var t=s.getQuestionForEvent(e);t&&t.handleDragStart(e)},handleKeyPress:function(e){var t=s.getQuestionForEvent(e);t&&t.handleKeyPress(e)},handleWindowResize:function(){for(var e in s.questions)s.questions.hasOwnProperty(e)&&s.questions[e].handleResize()},fixLayoutIfThingsMoved:function(){for(var e in s.questions)s.questions.hasOwnProperty(e)&&s.questions[e].fixLayoutIfBackgroundMoved();setTimeout(s.fixLayoutIfThingsMoved,100)},getQuestionForEvent:function(e){e=d(e.currentTarget).closest(".que.ddmarker").attr("id");return s.questions[e]}};return{init:s.init}});