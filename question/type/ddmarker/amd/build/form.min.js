define(["jquery","core/dragdrop","qtype_ddmarker/shapes"],function(h,p,r){"use strict";function t(e){this.dropzoneNo=e,this.svgEl=null,this.shape=r.make(this.getShapeType(),this.getLabel()),this.updateCoordinatesFromForm()}t.prototype.updateCoordinatesFromForm=function(e){var t=this.getCoordinates(),o="polygon"===this.shape.getType()&&this.shape.points.length;this.shape.getCoordinates()!==t&&this.shape.parse(t)&&("polygon"===this.shape.getType()&&o!==this.shape.points.length?(t=this.isActive(),this.removeFromSvg(),e&&(this.addToSvg(e),t&&this.setActive())):this.updateSvgEl())},t.prototype.updateLabel=function(){var e=this.getLabel();this.shape.label!==e&&(this.shape.label=e,this.updateSvgEl())},t.prototype.changeShape=function(e){var t=this.getShapeType(),o=this.isActive();t!==this.shape.getType()&&(this.removeFromSvg(),this.shape=r.getSimilar(t,this.shape),e&&(this.addToSvg(e),o&&this.setActive()),this.setCoordinatesInForm())},t.prototype.addToSvg=function(e){if(null!==this.svgEl)throw new Error("this.svgEl already set");if(this.svgEl=this.shape.makeSvg(e),this.svgEl){this.svgEl.setAttribute("class","dropzone"),this.svgEl.setAttribute("data-dropzone-no",this.dropzoneNo);var t=this.shape.getHandlePositions();if(null!==t){e=r.createSvgElement(this.svgEl,"circle");e.setAttribute("cx",t.moveHandle.x),e.setAttribute("cy",t.moveHandle.y),e.setAttribute("r",7),e.setAttribute("class","handle move");for(var o=0;o<t.editHandles.length;++o)this.makeEditHandle(o,t.editHandles[o])}}},t.prototype.makeEditHandle=function(e,t){var o=r.createSvgElement(this.svgEl,"rect");o.setAttribute("x",t.x-6),o.setAttribute("y",t.y-6),o.setAttribute("width",11),o.setAttribute("height",11),o.setAttribute("class","handle edit"),o.setAttribute("data-edit-handle-no",e)},t.prototype.removeFromSvg=function(){null!==this.svgEl&&(this.svgEl.parentNode.removeChild(this.svgEl),this.svgEl=null)},t.prototype.updateSvgEl=function(){if(null!==this.svgEl){this.shape.updateSvg(this.svgEl);var e=this.shape.getHandlePositions();if(null!==e){this.svgEl.childNodes[2].setAttribute("cx",e.moveHandle.x),this.svgEl.childNodes[2].setAttribute("cy",e.moveHandle.y);for(var t=0;t<e.editHandles.length;++t)this.svgEl.childNodes[3+t].setAttribute("x",e.editHandles[t].x-6),this.svgEl.childNodes[3+t].setAttribute("y",e.editHandles[t].y-6)}}},t.prototype.isActive=function(){return null!==this.svgEl&&this.svgEl.getAttribute("class").match(/\bactive\b/)},t.prototype.setActive=function(){var e=this.svgEl.parentNode;e.removeChild(this.svgEl),e.appendChild(this.svgEl),this.svgEl.setAttribute("class",this.svgEl.getAttribute("class")+" active")},t.prototype.setCoordinatesInForm=function(){g.form.setFormValue("drops",[this.dropzoneNo,"coords"],this.shape.getCoordinates())},t.prototype.getCoordinates=function(){return g.form.getFormValue("drops",[this.dropzoneNo,"coords"]).replace(/\s*/g,"")},t.prototype.getChoiceNo=function(){return g.form.getFormValue("drops",[this.dropzoneNo,"choice"])},t.prototype.getLabel=function(){return g.form.getMarkerText(this.getChoiceNo())},t.prototype.getShapeType=function(){return g.form.getFormValue("drops",[this.dropzoneNo,"shape"])},t.prototype.handleMove=function(e){var o,r,i,t,a,s,n=p.prepare(e);n.start&&(r=n.x,i=n.y,t=(o=this).makeDragProxy(n.x,n.y),n=h("fieldset#id_previewareaheader .dropbackground"),a=n.width(),s=n.height(),p.start(e,h(t),function(e,t){o.shape.move(e-r,t-i,a,s),r=e,i=t,o.updateSvgEl(),o.setCoordinatesInForm()},function(){document.body.removeChild(t)}))},t.prototype.handleEdit=function(e,o,t){var r,i,a,s,n,d,l=p.prepare(e);l.start&&("polygon"===this.shape.getType()&&(e.ctrlKey||e.metaKey)&&(this.shape.addNewPointAfter(o),this.removeFromSvg(),this.addToSvg(t),this.setActive()),i=l.x,a=l.y,s=(r=this).makeDragProxy(l.x,l.y),t=h("fieldset#id_previewareaheader .dropbackground"),n=t.width(),d=t.height(),p.start(e,h(s),function(e,t){r.shape.edit(o,e-i,t-a,n,d),i=e,a=t,r.updateSvgEl(),r.setCoordinatesInForm()},function(){document.body.removeChild(s),r.shape.normalizeShape(),r.updateSvgEl(),r.setCoordinatesInForm()}))},t.prototype.makeDragProxy=function(e,t){var o=document.createElement("div");return o.style.position="absolute",o.style.top=t+"px",o.style.left=e+"px",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),o};var g={maxSizes:null,fp:null,noDropZones:null,dropZones:[],init:function(e){g.maxSizes=e,g.fp=g.filePickers(),g.noDropZones=g.form.getFormValue("nodropzone",[]),g.setupPreviewArea(),g.setOptionsForDragItemSelectors(),g.createShapes(),g.setupEventHandlers(),g.waitForFilePickerToInitialise()},setupPreviewArea:function(){h("fieldset#id_previewareaheader div.fcontainer").append('<div class="ddarea que ddmarker">   <div id="ddm-droparea" class="droparea">       <img class="dropbackground" />       <div id="ddm-dropzone" class="dropzones">       </div>   </div></div>')},setOptionsForDragItemSelectors:function(){for(var e,t,o={0:""},r=g.form.getFormValue("noitems",[]),i=[],a=1;a<=r;a++)""!==(t=g.form.getMarkerText(a))&&(o[a]=h("<div/>").text(t).html());for(a=0;a<g.noDropZones;a++)e=h("#id_drops_"+a+"_choice"),i[a]=Number(e.val());for(a=0;a<g.noDropZones;a++){for(var s in(e=h("#id_drops_"+a+"_choice")).find("option").remove(),o){var n='<option value="'+(s=Number(s))+'">'+o[s]+"</option>",d=(e.append(n),e.find('option[value="'+s+'"]'));if(0!==s)if(s!==i[a]){var l=g.form.getFormValue("drags",[s-1,"noofdrags"]);if(0!==Number(l))for(var p in i)if(Number(i[p])===s){if(1===Number(l)){d.attr("disabled",!0);break}l--}}else d.attr("selected",!0)}0<g.dropZones.length&&g.dropZones[a].updateLabel()}},createShapes:function(){for(var e=0;e<g.noDropZones;e++)g.dropZones[e]=new t(e)},setupEventHandlers:function(){h("fieldset#id_draggableitemheader").on("change input","input, select",function(){g.setOptionsForDragItemSelectors()}),h("fieldset#id_dropzoneheader").on("change input","input, select",function(e){e=e.currentTarget.name.match(/^drops\[(\d+)]\[([a-z]*)]$/);if(e){var t=e[1],e=e[2],o=g.dropZones[t];switch(e){case"shape":o.changeShape(g.form.getSvg());break;case"coords":o.updateCoordinatesFromForm(g.form.getSvg());break;case"choice":o.updateLabel()}}});var e=h("fieldset#id_previewareaheader");e.on("click","g.dropzone",function(e){var e=h(e.currentTarget).data("dropzone-no"),t=g.dropZones[e].isActive();h(g.form.getSvg()).find(".dropzone.active").removeClass("active"),t||g.dropZones[e].setActive()}),e.on("mousedown touchstart",".dropzone .handle.move",function(e){var t=h(e.currentTarget).closest("g").data("dropzoneNo");g.dropZones[t].handleMove(e)}),e.on("mousedown touchstart",".dropzone .handle.edit",function(e){var t=h(e.currentTarget).closest("g").data("dropzoneNo"),o=e.currentTarget.getAttribute("data-edit-handle-no");g.dropZones[t].handleEdit(e,o,g.form.getSvg())})},waitForFilePickerToInitialise:function(){null!==g.fp.file("bgimage").href?(h("form.mform").on("change","#id_bgimage",g.loadPreviewImage),g.loadPreviewImage()):setTimeout(g.waitForFilePickerToInitialise,1e3)},loadPreviewImage:function(){h("fieldset#id_previewareaheader .dropbackground").one("load",g.afterPreviewImageLoaded).attr("src",g.fp.file("bgimage").href)},afterPreviewImageLoaded:function(){var e=h("fieldset#id_previewareaheader .dropbackground");g.constrainImageSize(),h("#ddm-dropzone").css("position","relative").css("top",-1*(e.height()+1)),h("#ddm-droparea").css("height",e.height()+20),g.updateSvgDisplay()},constrainImageSize:function(){var e=h("fieldset#id_previewareaheader .dropbackground"),t=Math.max(e.width()/g.maxSizes.width,e.height()/g.maxSizes.height);1<t&&e.css("width",Math.floor(e.width()/t)),e.addClass("constrained")},updateSvgDisplay:function(){var e,t=h("fieldset#id_previewareaheader .dropbackground");if(g.form.getSvg())for(e=0;e<g.noDropZones;e++)g.dropZones[e].updateSvgEl();else for(h("#ddm-dropzone").html('<svg xmlns="http://www.w3.org/2000/svg" class="dropzones" width="'+t.outerWidth()+'" height="'+t.outerHeight()+'"></svg>'),e=0;e<g.noDropZones;e++)g.dropZones[e].addToSvg(g.form.getSvg())},form:{getMarkerText:function(e){return 0===Number(e)?"":g.form.getFormValue("drags",[e-1,"label"]).replace(new RegExp("^\\s*(.*)\\s*$"),"$1")},getSvg:function(){var e=h("fieldset#id_previewareaheader svg");return 0===e.length?null:e[0]},toNameWithIndex:function(e,t){for(var o=e,r=0;r<t.length;r++)o=o+"["+t[r]+"]";return o},getEl:function(e,t){return document.getElementById("mform1").elements[this.toNameWithIndex(e,t)]},getFormValue:function(e,t){e=this.getEl(e,t);return"checkbox"===e.type?e.checked:e.value},setFormValue:function(e,t,o){e=this.getEl(e,t);"checkbox"===e.type?e.checked=o:e.value=o}},filePickers:function(){var o={},r={};return h("form.mform input.filepickerhidden").each(function(e,t){o[t.value]=t.name,r[t.name]=t.parentNode}),{file:function(e){e=h(r[e]).find("div.filepicker-filelist a");return e.length?{href:e.get(0).href,name:e.get(0).innerHTML}:{href:null,name:null}},name:function(e){return o[e]}}}};return{init:g.init}});