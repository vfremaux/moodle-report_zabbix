define(function(){"use strict";function s(t,e){this.x=t,this.y=e}function r(t,e,i){this.label=t,this.centre=new s(e||0,i||0)}function i(t,e,i,n){r.call(this,t,e,i),this.radius=n||15}function h(t,e,i,n,s){r.call(this,t,e,i),this.width=n||30,this.height=s||30}function n(t,e){r.call(this,t,0,0),this.points=e?e.slice():[new s(10,10),new s(40,10),new s(10,40)],this.normalizeShape()}function o(t){r.call(this,t)}function c(t,e){e=t.ownerDocument.createElementNS("http://www.w3.org/2000/svg",e);return t.appendChild(e),e}function e(t,e){t=c(t,"g");return c(t,e).setAttribute("class","shape"),c(t,"text").setAttribute("class","shapeLabel"),t}return s.prototype.toString=function(){return this.x+","+this.y},s.prototype.move=function(t,e){this.x+=t,this.y+=e},s.prototype.offset=function(t,e){return t instanceof s&&(e=t.y,t=t.x),new s(this.x+t,this.y+e)},s.parse=function(t){var e=t.split(",");if(2!==e.length)throw new Error(t+" is not a valid point");return new s(Math.round(e[0]),Math.round(e[1]))},r.prototype.getType=function(){throw new Error("Not implemented.")},r.prototype.getCoordinates=function(){throw new Error("Not implemented.")},r.prototype.parse=function(t){throw new Error("Not implemented.")},r.prototype.move=function(t,e,i,n){},r.prototype.edit=function(t,e,i,n,s){},r.prototype.normalizeShape=function(){},r.prototype.makeSvg=function(t){throw new Error("Not implemented.")},r.prototype.updateSvg=function(t){},r.prototype.makeSimilarCircle=function(){throw new Error("Not implemented.")},r.prototype.makeSimilarRectangle=function(){throw new Error("Not implemented.")},r.prototype.makeSimilarPolygon=function(){throw new Error("Not implemented.")},r.prototype.getHandlePositions=function(){return null},(i.prototype=new r).getType=function(){return"circle"},i.prototype.getCoordinates=function(){return this.centre+";"+Math.abs(this.radius)},i.prototype.makeSvg=function(t){t=e(t,"circle");return this.updateSvg(t),t},i.prototype.updateSvg=function(t){t.childNodes[0].setAttribute("cx",this.centre.x),t.childNodes[0].setAttribute("cy",this.centre.y),t.childNodes[0].setAttribute("r",Math.abs(this.radius)),t.childNodes[1].setAttribute("x",this.centre.x),t.childNodes[1].setAttribute("y",this.centre.y+15),t.childNodes[1].textContent=this.label},i.prototype.parse=function(t){if(!t.match(/^\d+,\d+;\d+$/))return!1;t=t.split(";");return this.centre=s.parse(t[0]),this.radius=Math.round(t[1]),!0},i.prototype.move=function(t,e,i,n){this.centre.move(t,e),this.centre.x<this.radius&&(this.centre.x=this.radius),this.centre.x>i-this.radius&&(this.centre.x=i-this.radius),this.centre.y<this.radius&&(this.centre.y=this.radius),this.centre.y>n-this.radius&&(this.centre.y=n-this.radius)},i.prototype.edit=function(t,e,i,n,s){this.radius+=e;e=Math.min(this.centre.x,this.centre.y,n-this.centre.x,s-this.centre.y);this.radius>e&&(this.radius=e),this.radius<-e&&(this.radius=-e)},i.prototype.normalizeShape=function(){this.radius=Math.abs(this.radius)},i.prototype.makeSimilarRectangle=function(){return new h(this.label,this.centre.x-this.radius,this.centre.y-this.radius,2*this.radius,2*this.radius)},i.prototype.makeSimilarPolygon=function(){return new n(this.label,[this.centre.offset(-this.radius,-this.radius),this.centre.offset(-this.radius,this.radius),this.centre.offset(this.radius,this.radius),this.centre.offset(this.radius,-this.radius)])},i.prototype.getHandlePositions=function(){return{moveHandle:this.centre,editHandles:[this.centre.offset(this.radius,0)]}},(h.prototype=new r).getType=function(){return"rectangle"},h.prototype.getCoordinates=function(){return this.centre+";"+this.width+","+this.height},h.prototype.makeSvg=function(t){t=e(t,"rect");return this.updateSvg(t),t},h.prototype.updateSvg=function(t){0<=this.width?(t.childNodes[0].setAttribute("x",this.centre.x),t.childNodes[0].setAttribute("width",this.width)):(t.childNodes[0].setAttribute("x",this.centre.x+this.width),t.childNodes[0].setAttribute("width",-this.width)),0<=this.height?(t.childNodes[0].setAttribute("y",this.centre.y),t.childNodes[0].setAttribute("height",this.height)):(t.childNodes[0].setAttribute("y",this.centre.y+this.height),t.childNodes[0].setAttribute("height",-this.height)),t.childNodes[1].setAttribute("x",this.centre.x+this.width/2),t.childNodes[1].setAttribute("y",this.centre.y+this.height/2+15),t.childNodes[1].textContent=this.label},h.prototype.parse=function(t){if(!t.match(/^\d+,\d+;\d+,\d+$/))return!1;t=t.split(";"),this.centre=s.parse(t[0]),t=s.parse(t[1]);return this.width=t.x,this.height=t.y,!0},h.prototype.move=function(t,e,i,n){this.centre.move(t,e),this.centre.x<0&&(this.centre.x=0),this.centre.x>i-this.width&&(this.centre.x=i-this.width),this.centre.y<0&&(this.centre.y=0),this.centre.y>n-this.height&&(this.centre.y=n-this.height)},h.prototype.edit=function(t,e,i,n,s){this.width+=e,this.height+=i,this.width<-this.centre.x&&(this.width=-this.centre.x),this.width>n-this.centre.x&&(this.width=n-this.centre.x),this.height<-this.centre.y&&(this.height=-this.centre.y),this.height>s-this.centre.y&&(this.height=s-this.centre.y)},h.prototype.normalizeShape=function(){this.width<0&&(this.centre.x+=this.width,this.width=-this.width),this.height<0&&(this.centre.y+=this.height,this.height=-this.height)},h.prototype.makeSimilarCircle=function(){return new i(this.label,Math.round(this.centre.x+this.width/2),Math.round(this.centre.y+this.height/2),Math.round((this.width+this.height)/4))},h.prototype.makeSimilarPolygon=function(){return new n(this.label,[this.centre,this.centre.offset(0,this.height),this.centre.offset(this.width,this.height),this.centre.offset(this.width,0)])},h.prototype.getHandlePositions=function(){return{moveHandle:this.centre.offset(this.width/2,this.height/2),editHandles:[this.centre.offset(this.width,this.height)]}},(n.prototype=new r).getType=function(){return"polygon"},n.prototype.getCoordinates=function(){for(var t="",e=0;e<this.points.length;e++)t+=this.centre.offset(this.points[e])+";";return t.slice(0,t.length-1)},n.prototype.makeSvg=function(t){t=e(t,"polygon");return this.updateSvg(t),t},n.prototype.updateSvg=function(t){t.childNodes[0].setAttribute("points",this.getCoordinates().replace(/[,;]/g," ")),t.childNodes[1].setAttribute("x",this.centre.x),t.childNodes[1].setAttribute("y",this.centre.y+15),t.childNodes[1].textContent=this.label},n.prototype.parse=function(t){if(!t.match(/^\d+,\d+(?:;\d+,\d+)*$/))return!1;for(var e=t.split(";"),i=[],n=0;n<e.length;n++)i.push(s.parse(e[n]));return this.points=i,this.centre.x=0,this.centre.y=0,this.normalizeShape(),!0},n.prototype.move=function(t,e,i,n){this.centre.move(t,e);for(var s=i,r=0,h=n,o=0,c=0;c<this.points.length;c++)s=Math.min(s,this.points[c].x),r=Math.max(r,this.points[c].x),h=Math.min(h,this.points[c].y),o=Math.max(o,this.points[c].y);this.centre.x<-s&&(this.centre.x=-s),this.centre.x>i-r&&(this.centre.x=i-r),this.centre.y<-h&&(this.centre.y=-h),this.centre.y>n-o&&(this.centre.y=n-o)},n.prototype.edit=function(t,e,i,n,s){this.points[t].move(e,i),this.points[t].x<-this.centre.x&&(this.points[t].x=-this.centre.x),this.points[t].x>n-this.centre.x&&(this.points[t].x=n-this.centre.x),this.points[t].y<-this.centre.y&&(this.points[t].y=-this.centre.y),this.points[t].y>s-this.centre.y&&(this.points[t].y=s-this.centre.y)},n.prototype.addNewPointAfter=function(t){this.points.splice(t,0,new s(this.points[t].x,this.points[t].y))},n.prototype.normalizeShape=function(){var t,e=0,i=0;if(0!==this.points.length){for(t=0;t<this.points.length;t++)e+=this.points[t].x,i+=this.points[t].y;if(e=Math.round(e/this.points.length),i=Math.round(i/this.points.length),0!==e||0!==i){for(t=0;t<this.points.length;t++)this.points[t].move(-e,-i);this.centre.move(e,i)}}},n.prototype.makeSimilarCircle=function(){return this.makeSimilarRectangle().makeSimilarCircle()},n.prototype.makeSimilarRectangle=function(){for(var t,e=0,i=0,n=0,s=0,r=0;r<this.points.length;r++)t=this.points[r],e=Math.min(e,t.x),i=Math.max(i,t.x),n=Math.min(n,t.y),s=Math.max(s,t.y);return new h(this.label,this.centre.x+e,this.centre.y+n,Math.max(i-e,10),Math.max(s-n,10))},n.prototype.getHandlePositions=function(){for(var t=[],e=0;e<this.points.length;e++)t.push(this.points[e].offset(this.centre.x,this.centre.y));return{moveHandle:this.centre,editHandles:t}},(o.prototype=new r).getType=function(){return"null"},o.prototype.getCoordinates=function(){return""},o.prototype.makeSvg=function(t){return null},o.prototype.updateSvg=function(t){},o.prototype.parse=function(t){return!1},o.prototype.makeSimilarCircle=function(){return new i(this.label)},o.prototype.makeSimilarRectangle=function(){return new h(this.label)},o.prototype.makeSimilarPolygon=function(){return new n(this.label)},{Point:s,Shape:r,Circle:i,Rectangle:h,Polygon:n,NullShape:o,createSvgElement:c,make:function(t,e){switch(t){case"circle":return new i(e);case"rectangle":return new h(e);case"polygon":return new n(e);default:return new o(e)}},getSimilar:function(t,e){if(t===e.getType())return e;switch(t){case"circle":return e.makeSimilarCircle();case"rectangle":return e.makeSimilarRectangle();case"polygon":return e.makeSimilarPolygon();default:return new o(e.label)}}}});