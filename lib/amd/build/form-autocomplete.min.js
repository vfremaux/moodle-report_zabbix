define(["jquery","core/log","core/str","core/templates","core/notification"],function(h,_,x,v,g){function w(e,t,n,r){var o=h(n).attr("data-value");return e.multiple&&r.children("option").each(function(e,t){h(t).attr("value")==o&&(h(t).prop("selected",!1),h(t).attr("data-iscustom")&&h(t).remove())}),y(e,t,r).then(function(){c(r)})}function E(r,e,o){var t=h(document.getElementById(e.inputId)),n=t.val().split(","),a=!1;return h.each(n,function(e,n){var t;""!==(n=n.trim())&&(r.multiple||o.children("option").prop("selected",!1),o.children("option").each(function(e,t){h(t).attr("value")==n&&(a=!0,h(t).prop("selected",!0))}),a||((t=h("<option>")).append(document.createTextNode(n)),t.attr("value",n),o.append(t),t.prop("selected",!0),t.attr("data-iscustom",!0)))}),y(r,e,o).then(function(){c(o)}).then(function(){t.val("")}).then(function(){return i(e)})}function B(e,t,n){var r=h(document.getElementById(t.inputId)),o=h(document.getElementById(t.suggestionsId)).children("[aria-selected=true]").attr("data-value");return e.multiple||n.children("option").prop("selected",!1),n.children("option").each(function(e,t){h(t).attr("value")==o&&h(t).prop("selected",!0)}),y(e,t,n).then(function(){c(n)}).then(function(){return e.closeSuggestionsOnSelect?(r.val(""),i(t)):(r.focus(),f(e,t,r.val(),n))})}function S(e,n,o,a,i){var c=m("updateAjax"),e=h(e.currentTarget).val();return i.transport(n.selector,e,function(e){var t,e=i.processResults(n.selector,e),r=[];a.children("option").each(function(e,t){(t=h(t)).prop("selected")?r.push(String(t.attr("value"))):t.remove()}),n.multiple||0!==a.children("option").length||(t=h("<option>"),a.append(t)),h.isArray(e)?(h.each(e,function(e,t){var n;-1===r.indexOf(String(t.value))&&((n=h("<option>")).append(t.label),n.attr("value",t.value),a.append(n))}),a.attr("data-notice","")):a.attr("data-notice",e),c.resolve(f(n,o,"",a))},function(e){c.reject(e)}),c}function j(c,u,l){var d=h(document.getElementById(u.inputId)),e=(d.on("keydown",function(t){var e,n,r,o=m("addNavigation-"+u.inputId+"-"+t.keyCode);switch(t.keyCode){case k:return c.showSuggestions?("true"===d.attr("aria-expanded")?o.resolve((e=u,n=h(document.getElementById(e.suggestionsId)),r=n.children("[aria-selected=true]"),n=n.children("[aria-hidden=false]").index(r),p(n+1,e))):!d.val()&&c.ajax?require([c.ajax],function(e){o.resolve(S(t,c,u,l,e))}):o.resolve(f(c,u,d.val(),l)),t.preventDefault(),!1):(o.resolve(),!0);case C:return o.resolve((r=u,n=h(document.getElementById(r.suggestionsId)),e=n.children("[aria-selected=true]"),n=n.children("[aria-hidden=false]").index(e),p(n-1,r))),t.preventDefault(),!1;case T:var a=h(document.getElementById(u.suggestionsId));return"true"===d.attr("aria-expanded")&&0<a.children("[aria-selected=true]").length?o.resolve(B(c,u,l)):c.tags?o.resolve(E(c,u,l)):o.resolve(),t.preventDefault(),!1;case b:return"true"===d.attr("aria-expanded")?o.resolve(i(u)):o.resolve(),t.preventDefault(),!1}return o.resolve(),!0}),d.on("keypress",function(e){return e.keyCode!==t||(c.tags&&m("keypress-"+e.keyCode).resolve(E(c,u,l)),e.preventDefault(),!1)}),d.on("blur",function(){var e=m("form-autocomplete-blur");window.setTimeout(function(){h(document.activeElement).attr("id")!=d.attr("id")&&(c.tags&&e.then(function(){return E(c,u,l)}).catch(),e.then(function(){return i(u)}).catch()),e.resolve()},500)}),c.showSuggestions&&h(document.getElementById(u.downArrowId)).on("click",function(t){var n=m("form-autocomplete-show-suggestions");d.focus(),!d.val()&&c.ajax?require([c.ajax],function(e){n.resolve(S(t,c,u,l,e))}):n.resolve(f(c,u,d.val(),l))}),h(document.getElementById(u.suggestionsId)));e.parent().prop("onclick",null).off("click"),e.parent().on("click","[role=option]",function(e){var t=m("form-autocomplete-parent"),e=h(e.currentTarget).closest("[role=option]"),e=h(document.getElementById(u.suggestionsId)).children("[aria-hidden=false]").index(e);p(e,u).then(function(){return B(c,u,l)}).then(function(){return t.resolve()}).catch()}),(e=h(document.getElementById(u.selectionId))).on("click","[role=listitem]",function(e){m("form-autocomplete-clicks").resolve(w(c,u,h(e.currentTarget),l))}),e.on("keydown",function(e){var t,n,r,o=m("form-autocomplete-keydown-"+e.keyCode);switch(e.keyCode){case k:return e.preventDefault(),o.resolve((t=u,a=h(document.getElementById(t.selectionId)),n=a.children("[data-active-selection=true]"),r=0,n?(r=a.children("[aria-selected=true]").index(n),r+=1):r=0,s(r,t))),!1;case C:return e.preventDefault(),o.resolve(function(e){var t=h(document.getElementById(e.selectionId)),n=t.children("[data-active-selection=true]");if(!n)return s(0,e);t=t.children("[aria-selected=true]").index(n);return s(t-1,e)}(u)),!1;case D:case T:var a=h(document.getElementById(u.selectionId)).children("[data-active-selection=true]");return a&&(e.preventDefault(),o.resolve(w(c,u,a,l))),!1}return o.resolve(),!0}),c.showSuggestions&&(c.ajax?require([c.ajax],function(t){var n=null,r=!1,o="autocomplete-throttledhandler",a=function(e){r=!(n=null),S(e,c,u,l,t).then(function(){return null===n&&M.util.js_complete(o),r=!1,arguments[0]}).catch(g.exception)},i=function(e){window.clearTimeout(n),n=r?window.setTimeout(i.bind(this,e),100):(null===n&&M.util.js_pending(o),window.setTimeout(a.bind(this,e),300))};d.on("input",i)}):d.on("input",function(e){var t=h(e.currentTarget).val();h(e.currentTarget).data("last-value")!==t&&f(c,u,t,l),h(e.currentTarget).data("last-value",t)}))}var k=40,T=13,D=32,b=27,t=44,C=38,I=h.now(),s=function(e,t){var n=h(document.getElementById(t.selectionId)),r=n.children("[aria-selected=true]").length;for(e%=r;e<0;)e+=r;var o=h(n.children("[aria-selected=true]").get(e)),t=t.selectionId+"-"+e;return n.children().attr("data-active-selection",!1).attr("id",""),o.attr("data-active-selection",!0).attr("id",t),n.attr("aria-activedescendant",t),h.Deferred().resolve()},y=function(e,n,t){var r="form-autocomplete-updateSelectionList-"+n.inputId,o=(M.util.js_pending(r),[]),a=h(document.getElementById(n.selectionId)),i=a.attr("aria-activedescendant"),c=!1,i=(i&&(c=h(document.getElementById(i)).attr("data-value")),t.children("option").each(function(e,t){var n;h(t).prop("selected")&&(n=h(t).data("html")?h(t).data("html"):h(t).html(),o.push({label:n,value:h(t).attr("value")}))}),h.extend({items:o},e,n));return v.render("core/form_autocomplete_selection",i).then(function(e,t){return v.replaceNodeContents(a,e,t),!1!==c&&a.children("[aria-selected=true]").each(function(e,t){h(t).attr("data-value")===c&&s(e,n)}),c}).then(function(){return M.util.js_complete(r)}).catch(g.exception)},c=function(e){void 0!==M.core_formchangechecker&&M.core_formchangechecker.set_form_changed(),e.change()},p=function(e,t){var n=h(document.getElementById(t.inputId)),r=h(document.getElementById(t.suggestionsId)),o=r.children("[aria-hidden=false]").length;for(e%=o;e<0;)e+=o;var a=h(r.children("[aria-hidden=false]").get(e)),i=h(r.children("[role=option]")).index(a),t=t.suggestionsId+"-"+i,i=(r.children().attr("aria-selected",!1).attr("id",""),a.attr("aria-selected",!0).attr("id",t),n.attr("aria-activedescendant",t),a.offset().top-r.offset().top+r.scrollTop()-r.height()/2);return r.animate({scrollTop:i},100).promise()},i=function(e){var t=h(document.getElementById(e.inputId)),n=h(document.getElementById(e.suggestionsId));return t.attr("aria-expanded",!1).attr("aria-activedescendant",e.selectionId),n.hide().attr("aria-hidden",!0),h.Deferred().resolve()},f=function(n,r,e,o){var t="form-autocomplete-updateSuggestions-"+r.inputId,a=(M.util.js_pending(t),h(document.getElementById(r.inputId))),i=h(document.getElementById(r.suggestionsId)),c=!1,u=[],l=(o.children("option").each(function(e,t){!0!==h(t).prop("selected")&&(u[u.length]={label:t.innerHTML,value:h(t).attr("value")})}),r.caseSensitive?e:e.toLocaleLowerCase()),e=h.extend({options:u},n,r);return v.render("core/form_autocomplete_suggestions",e).then(function(e,t){return v.replaceNode(i,e,t),(i=h(document.getElementById(r.suggestionsId))).show().attr("aria-hidden",!1),i.children().each(function(e,t){t=h(t),n.caseSensitive&&-1<t.text().indexOf(l)||!n.caseSensitive&&-1<t.text().toLocaleLowerCase().indexOf(l)?(t.show().attr("aria-hidden",!1),c=!0):t.hide().attr("aria-hidden",!0)}),a.attr("aria-expanded",!0),o.attr("data-notice")?i.html(o.attr("data-notice")):c?n.tags||p(0,r):x.get_string("nosuggestions","form").done(function(e){i.html(e)}),i}).then(function(){return M.util.js_complete(t)}).catch(g.exception)},m=function(e){var t="form-autocomplete:"+e,e=(M.util.js_pending(t),h.Deferred());return e.then(function(){return M.util.js_complete(t),arguments[0]}).catch(g.exception),e};return{enhance:function(e,t,n,r,o,d,s,p){var a={selector:e,tags:!1,ajax:!1,placeholder:r,caseSensitive:!1,showSuggestions:!0,noSelectionString:s},i="autocomplete-setup-"+e,c=(M.util.js_pending(i),void 0!==t&&(a.tags=t),void 0!==n&&(a.ajax=n),void 0!==o&&(a.caseSensitive=o),void 0!==d&&(a.showSuggestions=d),void 0===s&&x.get_string("noselection","form").done(function(e){a.noSelectionString=e}).fail(g.exception),h(e));if(!c)return _.debug("Selector not found: "+e),M.util.js_complete(i),!1;c.css("visibility","hidden").attr("aria-hidden",!0);var u={selectId:c.attr("id"),inputId:"form_autocomplete_input-"+I,suggestionsId:"form_autocomplete_suggestions-"+I,selectionId:"form_autocomplete_selection-"+I,downArrowId:"form_autocomplete_downarrow-"+I},f=(I++,a.multiple=c.attr("multiple"),a.closeSuggestionsOnSelect=void 0!==p?p:!a.multiple,h("[for="+u.selectId+"]")),m=[],r=(c.children("option").each(function(e,t){m[e]={label:t.innerHTML,value:h(t).attr("value")}}),h.extend({},a,u)),l=(r.options=m,r.items=[],""),t=v.render("core/form_autocomplete_input",r).then(function(e,t){return l+=t,e}),n=v.render("core/form_autocomplete_suggestions",r).then(function(e,t){return l+=t,e}),o=v.render("core/form_autocomplete_selection",r).then(function(e,t){return l+=t,e});return h.when(t,n,o).then(function(e,t,n){c.hide(),c.after(t),c.after(e),c.after(n),v.runTemplateJS(l),f.attr("for",u.inputId),j(a,u,c),h(document.getElementById(u.suggestionsId)).hide().attr("aria-hidden",!0)}).then(function(){return y(a,u,c)}).then(function(){return M.util.js_complete(i)}).catch(function(e){M.util.js_complete(i),g.exception(e)})}}});