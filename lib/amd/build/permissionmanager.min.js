define(["jquery","core/config","core/notification","core/templates","core/yui"],function(s,t,d,u,e){function f(t,i,e){e={contextid:o,roleid:i,sesskey:M.cfg.sesskey,action:e,capability:t.data("name")},s.post(r+"roles/ajax.php",e,null,"json").done(function(e){var o=e;try{var n={rolename:g[i],roleid:i,adminurl:r,imageurl:M.util.image_url("t/delete","moodle")};switch(o){case"allow":n.spanclass="allowed",n.linkclass="preventlink",n.action="prevent",n.icon="t/delete";break;case"prohibit":n.spanclass="forbidden",n.linkclass="unprohibitlink",n.action="unprohibit",n.icon="t/delete";break;case"prevent":return void t.find('a[data-role-id="'+i+'"]').first().closest(".allowed").remove();case"unprohibit":return void t.find('a[data-role-id="'+i+'"]').first().closest(".forbidden").remove();default:return}u.render("core/permissionmanager_role",n).done(function(e){"allow"==o?s(e).insertBefore(t.find(".allowmore:first")):"prohibit"==o&&(s(e).insertBefore(t.find(".prohibitmore:first")),(e=t.find(".allowedroles").first().find('a[data-role-id="'+i+'"]'))&&e.first().closest(".allowed").remove()),m.hide()}).fail(d.exception)}catch(e){d.exception(e)}}).fail(function(e,o,n){d.exception(n)})}function i(c){c.preventDefault(),e.use("moodle-core-notification-dialogue",function(){s("body").one("rolesloaded",function(){var e,o,n=s(c.currentTarget),t=n.data("action"),i=n.closest("tr.rolecap"),n={cap:i.data("humanname"),context:p},n=M.util.get_string("role"+t+"info","core_role",n),r=((m=null===m?new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,width:"450px"}):m).set("headerContent",M.util.get_string("role"+t+"header","core_role")),[]);switch(t){case"allow":o=i.find(b);break;case"prohibit":o=i.find(h)}for(e in g){var a="",l=o.filter("[data-role-id='"+e+"']").length,l={roleid:e,rolename:g[e],disabled:a=l?"disabled":a};r.push(l)}u.render("core/permissionmanager_panelcontent",{message:n,roles:r}).done(function(e){m.set("bodyContent",e),m.show(),s("div.role_buttons").delegate("input","click",function(e){e=s(e.currentTarget).data("role-id");f(i,e,t)})}).fail(d.exception)})}),n()}function a(i){i.preventDefault(),s("body").one("rolesloaded",function(){var e=s(i.currentTarget),o=e.data("action"),n=e.data("role-id"),t=e.closest("tr.rolecap"),e={role:g[n],cap:t.data("humanname"),context:p};d.confirm(M.util.get_string("confirmunassigntitle","core_role"),M.util.get_string("confirmrole"+o,"core_role",e),M.util.get_string("confirmunassignyes","core_role"),M.util.get_string("confirmunassignno","core_role"),function(){f(t,n,o)})}),n()}var o,p,r,g,l="a.allowlink, a.prohibitlink",b="a.preventlink, a.unprohibitlink",h="a.unprohibitlink",c=s.Event("rolesloaded"),m=null,n=function(){var e={contextid:o,getroles:1,sesskey:t.sesskey};s.post(r+"roles/ajax.php",e,null,"json").done(function(e){try{g=e,(n=function(){s("body").trigger(c)})()}catch(e){d.exception(e)}}).fail(function(e,o,n){d.exception(n)})};return{initialize:function(e){o=e.contextid,p=e.contextname,r=e.adminurl;e=s("body");e.delegate(l,"click",i),e.delegate(b,"click",a)}}});