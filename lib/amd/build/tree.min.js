define(["jquery"],function(a){function t(t,e){this.treeRoot=a(t),this.treeRoot.data("activeItem",null),this.selectCallback=e,this.keys={tab:9,enter:13,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,asterisk:106},this.initialiseNodes(this.treeRoot),this.setActiveItem(this.treeRoot.find(i)),this.refreshVisibleItemsCache(),this.bindEventHandlers()}var s="[role=treeitem]",n="[role=treeitem]:has([role=group]), [role=treeitem][aria-owns], [role=treeitem][data-requires-ajax=true]",r="[role=treeitem]:has([role=group])[aria-expanded=false], [role=treeitem][aria-owns][aria-expanded=false], [role=treeitem][data-requires-ajax=true][aria-expanded=false]",i="[role=treeitem]:first",e="[role=treeitem]:visible",o="[role=treeitem][data-requires-ajax=true][data-loaded=false][aria-expanded=true]";return t.prototype.registerEnterCallback=function(t){this.enterCallback=t},t.prototype.refreshVisibleItemsCache=function(){this.treeRoot.data("visibleItems",this.treeRoot.find(e))},t.prototype.getVisibleItems=function(){return this.treeRoot.data("visibleItems")},t.prototype.setActiveItem=function(t){var e=this.treeRoot.data("activeItem");t!==e&&(e&&(e.attr("tabindex","-1"),e.attr("aria-selected","false")),t.attr("tabindex","0"),t.attr("aria-selected","true"),this.treeRoot.data("activeItem",t),"function"==typeof this.selectCallback&&this.selectCallback(t))},t.prototype.isGroupItem=function(t){return t.is(n)},t.prototype.getGroupFromItem=function(t){var e=this.treeRoot.find("#"+t.attr("aria-owns")),t=t.children("[role=group]");return e.length>t.length?e:t},t.prototype.isGroupCollapsed=function(t){return"false"===t.attr("aria-expanded")},t.prototype.isGroupCollapsible=function(t){return"false"!==t.attr("data-collapsible")},t.prototype.initialiseNodes=function(t){this.removeAllFromTabOrder(t),this.setAriaSelectedFalseOnItems(t);var e=this;t.find(o).each(function(){var t=a(this);e.collapseGroup(t),e.expandGroup(t)})},t.prototype.removeAllFromTabOrder=function(t){t.find("*").attr("tabindex","-1"),this.getGroupFromItem(a(t)).find("*").attr("tabindex","-1")},t.prototype.setAriaSelectedFalseOnItems=function(t){t.find(s).attr("aria-selected","false")},t.prototype.expandAllGroups=function(){var e=this;this.treeRoot.find(r).each(function(){var t=a(this);e.expandGroup(a(this)).done(function(){e.expandAllChildGroups(t)})})},t.prototype.expandAllChildGroups=function(t){var e=this;this.getGroupFromItem(t).find(r).each(function(){var t=a(this);e.expandGroup(a(this)).done(function(){e.expandAllChildGroups(t)})})},t.prototype.expandGroup=function(e){var t,r,i=a.Deferred();return"false"!==e.attr("data-expandable")&&this.isGroupCollapsed(e)?"true"===e.attr("data-requires-ajax")&&"true"!==e.attr("data-loaded")?(e.attr("data-loaded",!1),t=e.closest("[data-ajax-loader]").attr("data-ajax-loader"),r=this,e.addClass("loading"),require([t],function(t){t.load(e).done(function(){e.attr("data-loaded",!0),r.initialiseNodes(e),r.finishExpandingGroup(e),e.removeClass("loading"),i.resolve()})})):(this.finishExpandingGroup(e),i.resolve()):i.resolve(),i},t.prototype.finishExpandingGroup=function(t){this.getGroupFromItem(t).attr("aria-hidden","false"),t.attr("aria-expanded","true"),this.refreshVisibleItemsCache()},t.prototype.collapseGroup=function(t){this.isGroupCollapsible(t)&&!this.isGroupCollapsed(t)&&(this.getGroupFromItem(t).attr("aria-hidden","true"),t.attr("aria-expanded","false"),this.refreshVisibleItemsCache())},t.prototype.toggleGroup=function(t){"true"===t.attr("aria-expanded")?this.collapseGroup(t):this.expandGroup(t)},t.prototype.handleKeyDown=function(e,t){var r=this.getVisibleItems().index(e);if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey&&t.keyCode!=this.keys.tab)return!0;switch(t.keyCode){case this.keys.home:return this.getVisibleItems().first().focus(),t.stopPropagation(),!1;case this.keys.end:return this.getVisibleItems().last().focus(),t.stopPropagation(),!1;case this.keys.enter:var i=e.children("a").length?e.children("a"):e.children().not(n).find("a");return i.length?"function"==typeof this.enterCallback?this.enterCallback(e):window.location.href=i.first().attr("href"):this.isGroupItem(e)&&this.toggleGroup(e,!0),t.stopPropagation(),!1;case this.keys.space:return this.isGroupItem(e)&&this.toggleGroup(e,!0),t.stopPropagation(),!1;case this.keys.left:function o(t){t.getVisibleItems().filter(function(){return t.getGroupFromItem(a(this)).has(e).length}).focus()}return!this.isGroupItem(e)||this.isGroupCollapsed(e)?o(this):this.collapseGroup(e),t.stopPropagation(),!1;case this.keys.right:return this.isGroupItem(e)&&(this.isGroupCollapsed(e)?this.expandGroup(e):this.getGroupFromItem(e).find(s).first().focus()),t.stopPropagation(),!1;case this.keys.up:return 0<r&&this.getVisibleItems().eq(r-1).focus(),t.stopPropagation(),!1;case this.keys.down:return r<this.getVisibleItems().length-1&&this.getVisibleItems().eq(r+1).focus(),t.stopPropagation(),!1;case this.keys.asterisk:return this.expandAllGroups(),t.stopPropagation(),!1}return!0},t.prototype.handleClick=function(t,e){return e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||(t.focus(),this.isGroupItem(t)&&this.toggleGroup(t),e.stopPropagation()),!0},t.prototype.handleFocus=function(t,e){return this.setActiveItem(t),e.stopPropagation(),!0},t.prototype.bindEventHandlers=function(){var e=this;this.treeRoot.on({click:function(t){return e.handleClick(a(this),t)},keydown:function(t){return e.handleKeyDown(a(this),t)},focus:function(t){return e.handleFocus(a(this),t)}},s)},t});