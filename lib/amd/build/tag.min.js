define(["jquery","core/ajax","core/templates","core/notification","core/str","core/modal_factory","core/modal_events"],function(i,n,c,d,r,l,s){return{initTagindexPage:function(){i("body").delegate(".tagarea[data-ta] a[data-quickload=1]","click",function(e){e.preventDefault();var e=i(this),t=e[0].search.replace(/^\?/,""),a=e.closest(".tagarea[data-ta]"),e=t.split("&").reduce(function(e,t){t=t.split("=");return e[t[0]]=decodeURIComponent(t[1]),e},{}),t=n.call([{methodname:"core_tag_get_tagindex",args:{tagindex:e}}],!0);i.when.apply(i,t).done(function(e){c.render("core_tag/index",e).done(function(e){a.replaceWith(e)})})})},initManagePage:function(){i("body").on("updated","[data-inplaceeditable]",function(t){var e;r.get_string("selecttag","core_tag",t.ajaxreturn.value).then(function(e){return i('label[for="tagselect'+t.ajaxreturn.itemid+'"]').html(e)}).fail(d.exception),r.get_string("now").done(function(e){i(t.target).closest("tr").find("td.col-timemodified").html(e)}),"tagflag"===t.ajaxreturn.itemtype&&(e=i(t.target).closest("tr"),"0"===t.ajaxreturn.value?e.removeClass("flagged-tag"):e.addClass("flagged-tag"))}),i(".tag-management-table").delegate("a.tagdelete","click",function(e){e.preventDefault();var t=i(this).attr("href");r.get_strings([{key:"delete"},{key:"confirmdeletetag",component:"tag"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){window.location.href=t})})}),i("#tag-management-delete").click(function(e){var t,a=i(this).closest("form").get(0);i(a).find("input[type=checkbox]:checked").length&&(t=i("<input type='hidden'/>").attr("name",this.name),e.preventDefault(),r.get_strings([{key:"delete"},{key:"confirmdeletetags",component:"tag"},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){t.appendTo(a),a.submit()})}))}),i("#tag-management-combine").click(function(e){e.preventDefault();var t,a,n,o=i(this).closest("form").get(0),e=i(o).find("input[type=checkbox]:checked");e.length<=1?r.get_strings([{key:"combineselected",component:"tag"},{key:"selectmultipletags",component:"tag"},{key:"ok"}]).done(function(e){d.alert(e[0],e[1],e[2])}):(t=i("<input type='hidden'/>").attr("name",this.name),a="",n=[],e.each(function(){var e=i(this).val(),t=i(".inplaceeditable[data-itemtype=tagname][data-itemid="+e+"]").attr("data-value");n.push({id:e,name:t})}),r.get_strings([{key:"combineselected",component:"tag"},{key:"continue"}]).then(function(e){var t=e[0],e=(a=e[1],{tags:n});return l.create({title:t,body:c.render("core_tag/combine_tags",e),type:l.types.SAVE_CANCEL})}).then(function(e){e.setSaveButtonText(a),e.getRoot().on(s.save,function(e){e.preventDefault(),t.appendTo(o);e=i("input[name=maintag]:checked","#combinetags_form").val();i("<input type='hidden'/>").attr("name","maintag").attr("value",e).appendTo(o),o.submit()}),e.getRoot().on(s.hidden,function(){e.destroy()}),e.show(),i("#combinetags_form input[type=radio]").first().focus().prop("checked",!0)}).catch(d.exception))}),i("body").on("updatefailed","[data-inplaceeditable][data-itemtype=tagname]",function(t){var e=t.exception,a=t.newvalue,n=i(t.target).attr("data-itemid");"namesalreadybeeingused"===e.errorcode&&(t.preventDefault(),r.get_strings([{key:"nameuseddocombine",component:"tag"},{key:"yes"},{key:"cancel"}]).done(function(e){d.confirm(t.message,e[0],e[1],e[2],function(){window.location.href=window.location.href+"&newname="+encodeURIComponent(a)+"&tagid="+encodeURIComponent(n)+"&action=renamecombine&sesskey="+M.cfg.sesskey})}))}),i("body").on("click","a[data-action=addstandardtag]",function(e){e.preventDefault();var a="";r.get_strings([{key:"addotags",component:"tag"},{key:"continue"}]).then(function(e){var t=e[0],e=(a=e[1],{actionurl:window.location.href,sesskey:M.cfg.sesskey});return l.create({title:t,body:c.render("core_tag/add_tags",e),type:l.types.SAVE_CANCEL})}).then(function(e){e.setSaveButtonText(a),e.getRoot().on(s.save,function(e){var e=i(e.currentTarget).find("#id_tagslist"),t=e.val().trim(),e=(e.val(t),i("#addtags_form"));return e.on("submit",function(e){var t=i("#addtags_form"),e=(!1===t[0].checkValidity()&&(e.preventDefault(),e.stopPropagation()),t.addClass("was-validated"),i('[data-region="tagslistinput"]').addClass("error"),i("#id_tagslist_error_message"));e.removeAttr("hidden"),e.addClass("help-block")}),e.submit(),!1}),e.getRoot().on(s.hidden,function(){e.destroy()}),e.show()}).catch(d.exception)})},initManageCollectionsPage:function(){i("body").on("updated","[data-inplaceeditable]",function(e){var t,a,e=e.ajaxreturn;"core_tag"===e.component&&"tagareaenable"===e.itemtype&&(t=i(this).attr("data-itemid"),i(".tag-collections-table ul[data-collectionid] li[data-areaid="+t+"]").hide(),"1"===e.value?(i(this).closest("tr").removeClass("dimmed_text"),a=i(this).closest("tr").find('[data-itemtype="tagareacollection"]').attr("data-value"),i(".tag-collections-table ul[data-collectionid="+a+"] li[data-areaid="+t+"]").show()):i(this).closest("tr").addClass("dimmed_text")),"core_tag"===e.component&&"tagareacollection"===e.itemtype&&(t=i(this).attr("data-itemid"),i(".tag-collections-table ul[data-collectionid] li[data-areaid="+t+"]").hide(),a=i(this).attr("data-value"),"1"===i(this).closest("tr").find('[data-itemtype="tagareaenable"]').attr("data-value")&&i(".tag-collections-table ul[data-collectionid="+a+"] li[data-areaid="+t+"]").show())}),i("body").on("click",".addtagcoll > a",function(e){e.preventDefault();var a=i(this).attr("data-url"),n="";r.get_strings([{key:"addtagcoll",component:"tag"},{key:"create"}]).then(function(e){var t=e[0],e=(n=e[1],{actionurl:a,sesskey:M.cfg.sesskey});return l.create({title:t,body:c.render("core_tag/add_tag_collection",e),type:l.types.SAVE_CANCEL})}).then(function(e){e.setSaveButtonText(n),e.getRoot().on(s.save,function(e){var e=i(e.currentTarget).find("#addtagcoll_name"),t=e.val().trim(),a=(e.val(t),i("#addtagcoll_form"));return a.on("submit",function(e){!1===a[0].checkValidity()&&(e.preventDefault(),e.stopPropagation()),a.addClass("was-validated"),i('[data-region="addtagcoll_nameinput"]').addClass("error");e=i("#id_addtagcoll_name_error_message");e.removeAttr("hidden"),e.addClass("help-block")}),a.submit(),!1}),e.getRoot().on(s.hidden,function(){e.destroy()}),e.show()}).catch(d.exception)}),i("body").on("click",".tag-collections-table .action_delete",function(e){e.preventDefault();var t=i(this).attr("data-url")+"&sesskey="+M.cfg.sesskey;r.get_strings([{key:"delete"},{key:"suredeletecoll",component:"tag",param:i(this).attr("data-collname")},{key:"yes"},{key:"no"}]).done(function(e){d.confirm(e[0],e[1],e[2],e[3],function(){window.location.href=t})})})}}});