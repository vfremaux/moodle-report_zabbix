define(["jquery","core/config","core/log","core/url"],function(c,h,d,a){function u(e){var r,o,n=this,i=null,d=0;if(e.error)for(;d<n.length;d++)(r=n[d]).deferred.reject(e);else{for(d=0;d<n.length;d++){if(r=n[d],void 0===(o=e[d])){i=new Error("missing response");break}if(!1!==o.error){i=o.exception;break}r.deferred.resolve(o.data)}null!==i&&("servicerequireslogin"===i.errorcode?window.location=a.relativeUrl("/login/index.php"):n.forEach(function(e){e.deferred.reject(i)}))}}function p(e,r,o){for(var n=0,n=0;n<this.length;n++){var i=this[n];v?(d.error("Page unloaded."),d.error(o)):i.deferred.reject(o)}}var v=!1;return{call:function(e,r,o){c(window).bind("beforeunload",function(){v=!0});var n,i=[],d=[],a=[],l="";for(void 0===o&&(o=!0),void 0===r&&(r=!0),n=0;n<e.length;n++){var t=e[n];i.push({index:n,methodname:t.methodname,args:t.args}),t.deferred=c.Deferred(),d.push(t.deferred.promise()),void 0!==t.done&&t.deferred.done(t.done),void 0!==t.fail&&t.deferred.fail(t.fail),t.index=n,a.push(t.methodname)}var l=a.length<=5?a.sort().join():a.length+"-method-calls",s={type:"POST",data:i=JSON.stringify(i),context:e,dataType:"json",processData:!1,async:r,contentType:"application/json"},f="service.php",o=h.wwwroot+"/lib/ajax/"+(f=o?f:"service-nologin.php")+"?sesskey="+h.sesskey+"&info="+l;return r?c.ajax(o,s).done(u).fail(p):(s.success=u,s.error=p,c.ajax(o,s)),d}}});