define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/icon_system","core/event","core/yui","core/log","core/truncate","core/user_date","core/pending"],function(l,o,f,m,s,e,u,g,y,i,v,b,q,D,T){function n(){this.requiredStrings=[],this.requiredJS=[],this.requiredDates=[],this.currentThemeName=""}function h(e){""!==e.trim()&&(e=o("<script>").attr("type","text/javascript").html(e),o("head").append(e))}function N(e,t,r,n){(e=o(e)).length&&(t=o(t),n?(new v.NodeList(e.children().get()).destroy(!0),e.empty(),e.append(t)):(new v.NodeList(e.get()).destroy(!0),e.replaceWith(t)),h(r),i.notifyFilterContentUpdated(t))}var r=0,a={},c={},p={},d={};n.prototype.requiredStrings=null,n.prototype.requiredDates=[],n.prototype.requiredJS=null,n.prototype.currentThemeName="",n.prototype.getTemplate=function(e){var t=e.split("/"),r=t.shift(),t=t.shift(),n=this.currentThemeName+"/"+e;if(n in c)return c[n];e=g.get("core_template/"+n);if(e)return a[n]=e,c[n]=o.Deferred().resolve(e).promise(),c[n];e=f.call([{methodname:"core_output_load_template",args:{component:r,template:t,themename:this.currentThemeName}}],!0,!1);return c[n]=e[0].then(function(e){return a[n]=e,g.set("core_template/"+n,e),e}),c[n]},n.prototype.partialHelper=function(e){var t=this.currentThemeName+"/"+e;return t in a||s.exception(new Error("Failed to pre-fetch the template: "+e)),a[t]},n.prototype.renderIcon=function(t,r,n){var e=u.iconsystemmodule,i=o.Deferred();return require([e],function(e){e=new e;e instanceof y?(d=e).init().then(i.resolve).catch(s.exception):i.reject("Invalid icon system specified"+u.iconsystemmodule)}),i.then(function(e){return this.getTemplate(e.getTemplateName())}.bind(this)).then(function(e){return d.renderIcon(t,r,n,e)})},n.prototype.pixHelper=function(e,t,r){var t=t.split(","),n="",i="",o="",r=(0<t.length&&(n=r(t.shift().trim(),e)),0<t.length&&(i=r(t.shift().trim(),e)),0<t.length&&(o=r(t.join(",").trim(),e)),d.getTemplateName()),t=this.currentThemeName+"/"+r,e=a[t],n=n.replace(/&#x2F;/gi,"/");return d.renderIcon(n,i,o,e)},n.prototype.jsHelper=function(e,t,r){return this.requiredJS.push(r(t,e)),""},n.prototype.stringHelper=function(e,t,r){var t=t.split(","),n="",i="",o="",t=(0<t.length&&(n=t.shift().trim()),0<t.length&&(i=t.shift().trim()),0===(o=""!==(o=0<t.length?t.join(",").trim():o)?r(o,e):o).indexOf("{")&&0!==o.indexOf("{{")&&(o=JSON.parse(o)),this.requiredStrings.length);return this.requiredStrings.push({key:n,component:i,param:o}),"[[_s"+t+"]]"},n.prototype.quoteHelper=function(e,t,r){return'"'+r(t.trim(),e).replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>")+'"'},n.prototype.shortenTextHelper=function(e,t,r){var t=t.match(/(.*?),(.*)/),n=t[1].trim(),r=r(t[2].trim(),e);return q.truncate(r,{length:n,words:!0,ellipsis:"..."})},n.prototype.userDateHelper=function(e,t,r){var t=t.match(/(.*?),(.*)/),n=r(t[1].trim(),e),r=r(t[2].trim(),e),t=this.requiredDates.length;return this.requiredDates.push({timestamp:n,format:r}),"[[_t_"+t+"]]"},n.prototype.addHelpers=function(e,t){this.currentThemeName=t,this.requiredStrings=[],this.requiredJS=[],e.uniqid=r++,e.str=function(){return this.stringHelper.bind(this,e)}.bind(this),e.pix=function(){return this.pixHelper.bind(this,e)}.bind(this),e.js=function(){return this.jsHelper.bind(this,e)}.bind(this),e.quote=function(){return this.quoteHelper.bind(this,e)}.bind(this),e.shortentext=function(){return this.shortenTextHelper.bind(this,e)}.bind(this),e.userdate=function(){return this.userDateHelper.bind(this,e)}.bind(this),e.globals={config:u},e.currentTheme=t},n.prototype.getJS=function(){var e="";return e=0<this.requiredJS.length?this.requiredJS.join(";\n"):e},n.prototype.treatStringsInContent=function(e,t){var r,n,i,o,s,u,h=/\[\[_s\d+\]\]/;do{for(r="",n=e.search(h);-1<n;){for(r+=e.substring(0,n),i="",s=(e=e.substr(n)).substr(o=4,1);i+=s,o++,"]"!=(s=e.substr(o,1)););void 0===(u=t[parseInt(i,10)])&&(b.debug("Could not find string for pattern [[_s"+i+"]]."),u=""),r+=u,n=(e=e.substr(6+i.length)).search(h)}}while(-1<(n=(e=r+e).search(h)));return e},n.prototype.treatDatesInContent=function(r,e){return e.forEach(function(e,t){t=new RegExp("\\[\\[_t_"+t+"\\]\\]","g");r=r.replace(t,e)}),r},n.prototype.doRender=function(t,r,n){this.currentThemeName=n;var e=d.getTemplateName(),i=new T("core/templates:doRender");return this.getTemplate(e).then(function(){this.addHelpers(r,n);var e=l.render(t,r,this.partialHelper.bind(this));return o.Deferred().resolve(e.trim(),this.getJS()).promise()}.bind(this)).then(function(e,r){return 0<this.requiredStrings.length?m.get_strings(this.requiredStrings).then(function(t){return this.requiredDates=this.requiredDates.map(function(e){return{timestamp:this.treatStringsInContent(e.timestamp,t),format:this.treatStringsInContent(e.format,t)}}.bind(this)),e=this.treatStringsInContent(e,t),r=this.treatStringsInContent(r,t),o.Deferred().resolve(e,r).promise()}.bind(this)):o.Deferred().resolve(e,r).promise()}.bind(this)).then(function(t,r){return 0<this.requiredDates.length?D.get(this.requiredDates).then(function(e){return t=this.treatDatesInContent(t,e),r=this.treatDatesInContent(r,e),o.Deferred().resolve(t,r).promise()}.bind(this)):o.Deferred().resolve(t,r).promise()}.bind(this)).then(function(e,t){return i.resolve(),o.Deferred().resolve(e,t).promise()})},n.prototype.scanForPartials=function(e){function i(e,t){for(var r,n=0;n<e.length;n++)">"!=(r=e[n])[0]&&"<"!=r[0]||t.push(r[1]),4<r.length&&i(r[4],t)}var e=l.parse(e),t=[];return i(e,t),t},n.prototype.cachePartials=function(r,n){var i=this.currentThemeName+"/"+r;return i in p||(n=n||[i],p[i]=o.Deferred(),this.getTemplate(r).then(function(e){var t=this.scanForPartials(e).filter(function(e){return!(0<=n.indexOf(this.currentThemeName+"/"+e))&&e!=r}.bind(this)).map(function(e){return n.push(this.currentThemeName+"/"+e),this.cachePartials(e,n)}.bind(this));return o.when.apply(o,t).then(function(){return p[i].resolve(e)})}.bind(this)).catch(p[i].reject)),p[i]},n.prototype.render=function(e,t,r){void 0===r&&(r=u.theme),this.currentThemeName=r;var n=u.iconsystemmodule,i=o.Deferred();return require([n],function(e){e=new e;e instanceof y?(d=e).init().then(i.resolve).catch(s.exception):i.reject("Invalid icon system specified"+u.iconsystem)}),i.then(function(){return this.cachePartials(e)}.bind(this)).then(function(e){return this.doRender(e,t,r)}.bind(this))};return{render:function(e,t,r){return(new n).render(e,t,r)},renderPix:function(e,t,r){return(new n).renderIcon(e,t,r)},runTemplateJS:h,replaceNodeContents:function(e,t,r){N(e,t,r,!0)},replaceNode:function(e,t,r){N(e,t,r,!1)},prependNodeContents:function(e,t,r){(e=o(e)).length&&(e.prepend(t),h(r),i.notifyFilterContentUpdated(e))},appendNodeContents:function(e,t,r){(e=o(e)).length&&(e.append(t),h(r),i.notifyFilterContentUpdated(e))}}});