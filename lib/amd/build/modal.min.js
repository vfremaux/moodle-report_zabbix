define(["jquery","core/templates","core/notification","core/key_codes","core/custom_interaction_events","core/modal_backdrop","core/event","core/modal_events"],function(n,r,i,e,t,l,a,h){function o(t){this.root=n(t),this.modal=this.root.find(c),this.header=this.modal.find(u),this.title=this.header.find(p),this.body=this.modal.find(g),this.footer=this.modal.find(f),this.hiddenSiblings=[],this.isAttached=!1,this.bodyJS=null,this.footerJS=null,this.modalCount=w++,this.root.is(d)||i.exception({message:"Element is not a modal container"}),this.modal.length||i.exception({message:"Container does not contain a modal"}),this.header.length||i.exception({message:"Modal is missing a header region"}),this.title.length||i.exception({message:"Modal header is missing a title region"}),this.body.length||i.exception({message:"Modal is missing a body region"}),this.footer.length||i.exception({message:"Modal is missing a footer region"}),this.registerEventListeners()}var s,d='[data-region="modal-container"]',c='[data-region="modal"]',u='[data-region="header"]',p='[data-region="title"]',g='[data-region="body"]',f='[data-region="footer"]',y='[data-action="hide"]',m="[role=dialog]",b="[role=menubar]",v=".moodle-has-zindex",C='input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]',x="core/loading",S="core/modal_backdrop",w=0;return o.prototype.attachToDOM=function(){this.isAttached||(n("body").append(this.root),this.bodyJS&&(r.runTemplateJS(this.bodyJS),this.bodyJS=null),this.footerJS&&(r.runTemplateJS(this.footerJS),this.footerJS=null),this.isAttached=!0)},o.prototype.countOtherVisibleModals=function(){var o=0;return n("body").find(d).each(function(t,e){e=n(e),!this.root.is(e)&&e.hasClass("show")&&o++}.bind(this)),o},o.prototype.getBackdrop=function(){return s=s||r.render(S,{}).then(function(t){t=n(t);return new l(t)}).fail(i.exception)},o.prototype.getRoot=function(){return this.root},o.prototype.getModal=function(){return this.modal},o.prototype.getTitle=function(){return this.title},o.prototype.getBody=function(){return this.body},o.prototype.getFooter=function(){return this.footer},o.prototype.getModalCount=function(){return this.modalCount},o.prototype.setTitle=function(t){var e=this.getTitle();this.asyncSet(t,e.html.bind(e))},o.prototype.setBody=function(e){var t,o,s=this.getBody();"string"==typeof e?(s.html(e),a.notifyFilterContentUpdated(s),this.getRoot().trigger(h.bodyRendered,this)):(t="amd-modal-js-pending-id-"+this.getModalCount(),M.util.js_pending(t),s.css("overflow","hidden"),("pending"==e.state()?(o=s.innerHeight(),s.animate({height:(o=o<100?100:o)+"px"},150),s.html(""),r.render(x,{}).then(function(t){t=n(t).hide();return s.html(t),t.fadeIn(150),n.when(t.promise(),e)}).then(function(t){return t.fadeOut(100).promise()}).then(function(){return e})):e).then(function(t,e){var o,i,n=null;return this.isVisible()?(s.css("opacity",0),o=s.innerHeight(),s.html(t),s.css("height",""),i=s.innerHeight(),s.css("height",o+"px"),n=s.animate({height:i+"px",opacity:1},{duration:150,queue:!1}).promise()):s.html(t),e&&(this.isAttached?r.runTemplateJS(e):this.bodyJS=e),a.notifyFilterContentUpdated(s),this.getRoot().trigger(h.bodyRendered,this),n}.bind(this)).fail(i.exception).always(function(){s.css("height",""),s.css("overflow",""),s.css("opacity",""),M.util.js_complete(t)}).fail(i.exception))},o.prototype.setFooter=function(e){this.showFooter();var o=this.getFooter();"string"==typeof e?o.html(e):r.render(x,{}).done(function(t){o.html(t),e.done(function(t,e){o.html(t),e&&(this.isAttached?r.runTemplateJS(e):this.footerJS=e)}.bind(this))}.bind(this))},o.prototype.hasFooterContent=function(){return!!this.getFooter().children().length},o.prototype.hideFooter=function(){this.getFooter().addClass("hidden")},o.prototype.showFooter=function(){this.getFooter().removeClass("hidden")},o.prototype.setLarge=function(){this.isLarge()||this.getModal().addClass("modal-lg")},o.prototype.isLarge=function(){return this.getModal().hasClass("modal-lg")},o.prototype.setSmall=function(){this.isSmall()||this.getModal().removeClass("modal-lg")},o.prototype.isSmall=function(){return!this.getModal().hasClass("modal-lg")},o.prototype.calculateZIndex=function(){var t=n(m+", "+b+", "+v),o=parseInt(this.root.css("z-index"));return t.each(function(t,e){e=(e=n(e)).css("z-index")?parseInt(e.css("z-index")):0;o<e&&(o=e)}),o},o.prototype.isVisible=function(){return this.root.hasClass("show")},o.prototype.hasFocus=function(){var t=n(document.activeElement);return this.root.is(t)||this.root.has(t).length},o.prototype.hasTransitions=function(){return this.getRoot().hasClass("fade")},o.prototype.show=function(){this.isVisible()||(this.hasFooterContent()?this.showFooter():this.hideFooter(),this.isAttached||this.attachToDOM(),this.getBackdrop().done(function(t){var e=this.calculateZIndex()+2,o=e-1;this.root.css("z-index",e),t.setZIndex(o),t.show(),this.root.removeClass("hide").addClass("show"),this.accessibilityShow(),this.getModal().focus(),n("body").addClass("modal-open"),this.root.trigger(h.shown,this)}.bind(this)))},o.prototype.hide=function(){this.getBackdrop().done(function(t){this.countOtherVisibleModals()||(t.hide(),n("body").removeClass("modal-open"));var e=parseInt(this.root.css("z-index"));this.root.css("z-index",""),t.setZIndex(e-3),this.accessibilityHide(),this.hasTransitions()?this.getRoot().one("transitionend webkitTransitionEnd oTransitionEnd",function(){this.getRoot().removeClass("show").addClass("hide")}.bind(this)):this.getRoot().removeClass("show").addClass("hide"),this.root.trigger(h.hidden,this)}.bind(this))},o.prototype.destroy=function(){this.root.remove(),this.root.trigger(h.destroyed,this)},o.prototype.accessibilityShow=function(){n("body").children().each(function(t,e){var o;this.root.is(e)||"true"!==(o=(e=n(e)).attr("aria-hidden"))&&(e.data("previous-aria-hidden",o),this.hiddenSiblings.push(e),e.attr("aria-hidden","true"))}.bind(this)),this.root.attr("aria-hidden","false")},o.prototype.accessibilityHide=function(){this.root.attr("aria-hidden","true"),n.each(this.hiddenSiblings,function(t,e){var o=(e=n(e)).data("previous-aria-hidden");void 0===o?e.removeAttr("aria-hidden"):e.attr("aria-hidden",o)}),this.hiddenSiblings=[]},o.prototype.handleTabLock=function(t){var e,o,i;this.hasFocus()&&(e=n(document.activeElement),o=(i=this.modal.find(C)).first(),i=i.last(),e.is(o)&&t.shiftKey?(i.focus(),t.preventDefault()):e.is(i)&&!t.shiftKey&&(o.focus(),t.preventDefault()))},o.prototype.registerEventListeners=function(){this.getRoot().on("keydown",function(t){this.isVisible()&&(t.keyCode==e.tab?this.handleTabLock(t):t.keyCode==e.escape&&this.hide())}.bind(this)),this.getRoot().click(function(t){n(t.target).closest(c).length||n(t.target).closest(d).length&&this.hide()}.bind(this)),t.define(this.getModal(),[t.events.activate]),this.getModal().on(t.events.activate,y,function(t,e){this.hide(),e.originalEvent.preventDefault()}.bind(this))},o.prototype.asyncSet=function(t,e){var o=t;return"object"==typeof t&&t.hasOwnProperty("then")||(o=n.Deferred()).resolve(t),o.then(function(t){e(t)}).fail(i.exception),o},o});