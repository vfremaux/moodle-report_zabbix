define(["jquery","core/log","core/autoscroll","core/str","core/modal_factory","core/modal_events","core/notification"],function(c,i,n,o,t,r,a){function e(i){return{setup:function(t,e,o){return!!e.includes("notPassive")&&(this.addEventListener(i,o,{passive:!1}),!0)}}}function g(t,e){this.info=null,this.proxy=null,this.proxyDelta=null,this.dragCounter=0,this.lastEvent=null,this.config=c.extend({},l,e||{}),this.config.listSelector=t,this.config.targetListSelector||(this.config.targetListSelector=t),"object"==typeof this.config.listSelector?c(this.config.listSelector).on("mousedown touchstart.notPassive",c.proxy(this.dragStartHandler,this)):c("body").on("mousedown touchstart.notPassive",this.config.listSelector,c.proxy(this.dragStartHandler,this)),null!==this.config.moveHandlerSelector&&c("body").on("click keypress",this.config.moveHandlerSelector,c.proxy(this.clickHandler,this))}var l={targetListSelector:null,moveHandlerSelector:"[data-drag-type=move]",isHorizontal:!1,autoScroll:!0},h="dragdrop-keyboard-drag",p="sortable-list-is-dragged",s="sortable-list-current-position",u="sortable-list-target",d="sortable-list-over-element";c.event.special.touchstart=e("touchstart"),c.event.special.touchmove=e("touchmove"),c.event.special.touchend=e("touchend");return g.EVENTS={DRAGSTART:"sortablelist-dragstart",DRAG:"sortablelist-drag",DROP:"sortablelist-drop",DRAGEND:"sortablelist-dragend"},g.prototype.resetDraggedClasses=function(){var t,e=[p,s,d,u];for(t in e)c("."+e[t]).removeClass(e[t]);this.proxy&&(this.proxy.remove(),this.proxy=c())},g.prototype.calculatePositionOnPage=function(t){var e;t.originalEvent&&t.originalEvent.touches&&void 0!==t.originalEvent.touches[0]&&(e=t.originalEvent.touches[0],t.pageX=e.pageX,t.pageY=e.pageY),void 0===t.pageX?(t.pageX=this.lastEvent.pageX,t.pageY=this.lastEvent.pageY):this.lastEvent=t,void 0===t.clientX&&(t.clientX=Math.round(t.pageX-c(window).scrollLeft()),t.clientY=Math.round(t.pageY-c(window).scrollTop()))},g.prototype.dragStartHandler=function(t){if(null!==this.info){if("click"===this.info.type||"touchend"===this.info.type)return;this.moveElement(this.info.sourceList,this.info.sourceNextElement),this.finishDragging()}var e,o,i;"mousedown"===t.type&&1!==t.which||(this.calculatePositionOnPage(t),(e=c(t.target).closest(c(t.currentTarget).children())).length&&(null!==this.config.moveHandlerSelector&&!c(t.target).closest(this.config.moveHandlerSelector,e).length||(t.stopPropagation(),t.preventDefault(),this.dragCounter++,this.info={element:e,sourceNextElement:e.next(),sourceList:e.parent(),targetNextElement:e.next(),targetList:e.parent(),type:t.type,dropped:!1,startX:t.pageX,startY:t.pageY,startTime:(new Date).getTime()},c(this.config.targetListSelector).addClass(u),o=e.offset(),e.addClass(s),this.proxyDelta={x:o.left-t.pageX,y:o.top-t.pageY},this.proxy=c(),i=this.dragCounter,setTimeout(c.proxy(function(){null!==this.info&&"click"!==this.info.type&&"keypress"!==this.info.type&&this.dragCounter===i&&this.createProxy()},this),500),c(window).on("mousemove touchmove.notPassive mouseup touchend.notPassive",c.proxy(this.dragHandler,this)),c(window).on("keypress",c.proxy(this.dragcancelHandler,this)),this.config.autoScroll&&n.start(function(){c(window).trigger("mousemove")}),this.executeCallback(g.EVENTS.DRAGSTART))))},g.prototype.createProxy=function(){this.proxy=this.info.element.clone(),this.info.sourceList.append(this.proxy),this.proxy.removeAttr("id").removeClass(s).addClass(p).css({position:"fixed"}),this.proxy.offset({top:this.proxyDelta.y+this.lastEvent.pageY,left:this.proxyDelta.x+this.lastEvent.pageX})},g.prototype.clickHandler=function(t){var e,o,i;"keypress"===t.type&&13!==t.originalEvent.keyCode&&32!==t.originalEvent.keyCode||null===this.info&&(o=(e=c(t.target).closest(this.config.moveHandlerSelector)).closest(this.config.listSelector),(i=e.closest(o.children())).length&&(t.preventDefault(),t.stopPropagation(),this.dragCounter++,this.info={element:i,sourceNextElement:i.next(),sourceList:o,targetNextElement:i.next(),targetList:o,dropped:!1,type:t.type,startTime:(new Date).getTime()},this.executeCallback(g.EVENTS.DRAGSTART),this.displayMoveDialogue(e)))},g.prototype.getPositionInNode=function(t,e,o){if(!o.length)return null;o=o[0].getBoundingClientRect(),e-=o.top+window.scrollY,t-=o.left+window.scrollX;return-0<=t&&t<=o.width+0&&-0<=e&&e<=o.height+0?{x:t,y:e,xRatio:o.width?t/o.width:0,yRatio:o.height?e/o.height:0}:null},g.prototype.isListHorizontal=function(t){var e=this.config.isHorizontal;return!0===e||!1===e?e:e(t)},g.prototype.dragHandler=function(t){t.preventDefault(),t.stopPropagation(),this.calculatePositionOnPage(t),this.proxy.offset({top:-1e3,left:-1e3});function e(){return this!==a}function o(){return!h||!h.length||this!==h[0]}var i,n,s,r=c(document.elementFromPoint(t.clientX,t.clientY)),a=this.info.element[0],l=r.closest("."+u+" > :not(."+p+")").filter(e),r=r.closest("."+u),h=this.proxy;c("."+d).removeClass(d),l.addClass(d),this.proxy.offset({top:this.proxyDelta.y+t.pageY,left:this.proxyDelta.x+t.pageX}),r.length&&!r.children().filter(o).length?this.moveElement(r,c()):1!==l.length||this.info.element.find(l[0]).length||(r=this.getPositionInNode(t.pageX,t.pageY,l))&&(i=l.parent(),r=this.isListHorizontal(i)?r.xRatio:r.yRatio,s=!(n=l.find("."+u)).children().filter(o).filter(e).length,n.length&&s&&.2<r&&r<.8?this.moveElement(n,c()):.5<r?this.moveElement(i,l.next().filter(o)):this.moveElement(i,l)),"mouseup"!==t.type&&"touchend"!==t.type||(this.info.endX=t.pageX,this.info.endY=t.pageY,this.info.endTime=(new Date).getTime(),this.info.dropped=!0,this.info.positionChanged=this.hasPositionChanged(this.info),s=this.info,this.executeCallback(g.EVENTS.DROP),this.finishDragging(),"touchend"===t.type&&null!==this.config.moveHandlerSelector&&s.endTime-s.startTime<500&&!s.positionChanged&&this.clickHandler(t))},g.prototype.hasPositionChanged=function(t){return t.sourceList[0]!==t.targetList[0]||t.sourceNextElement.length!==t.targetNextElement.length||t.sourceNextElement.length&&t.sourceNextElement[0]!==t.targetNextElement[0]},g.prototype.moveElement=function(t,e){var o=this.info.element;e.length&&e[0]===o[0]||t[0]===this.info.targetList[0]&&e.length===this.info.targetNextElement.length&&e[0]===this.info.targetNextElement[0]||(e.length?t[0].insertBefore(o[0],e[0]):this.proxy&&this.proxy.parent().length&&this.proxy.parent()[0]===t[0]?t[0].insertBefore(o[0],this.proxy[0]):t[0].appendChild(o[0]),this.info.targetList=t,this.info.targetNextElement=e,this.executeCallback(g.EVENTS.DRAG))},g.prototype.finishDragging=function(){this.resetDraggedClasses(),this.config.autoScroll&&n.stop(),c(window).off("mousemove touchmove.notPassive mouseup touchend.notPassive",c.proxy(this.dragHandler,this)),c(window).off("keypress",c.proxy(this.dragcancelHandler,this)),this.executeCallback(g.EVENTS.DRAGEND),this.info=null},g.prototype.executeCallback=function(t){this.info.element.trigger(t,this.info)},g.prototype.dragcancelHandler=function(t){"keypress"===t.type&&27===t.originalEvent.keyCode&&(this.moveElement(this.info.sourceList,this.info.sourceNextElement),this.finishDragging())},g.prototype.getElementName=function(t){return c.Deferred().resolve(t.text())},g.prototype.getDestinationName=function(t,e){return e.length?this.getElementName(e).then(function(t){return o.get_string("movecontentafter","moodle",t)}):o.get_string("movecontenttothetop","moodle")},g.prototype.getMoveDialogueTitle=function(t,e){return e.attr("title")?c.Deferred().resolve(e.attr("title")):this.getElementName(t).then(function(t){return o.get_string("movecontent","moodle",t)})},g.prototype.getDestinationsList=function(){var o=[],i=c(this.config.targetListSelector),n=c("<ul/>").addClass(h),e=c.when().then(function(){return n}),s=c.proxy(function(o,i,t){i.is(this.info.element)||t.is(this.info.element)||c.contains(this.info.element[0],o[0])||(e=e.then(c.proxy(function(){return this.getDestinationName(o,t)},this)).then(function(t){var e=c("<li/>").appendTo(n);return c('<a href="#"/>').attr("data-core_sortable_list-quickmove",1).appendTo(e).data("parent-element",o).data("before-element",i).text(t),n}))},this),r=function(){var e,t;-1===c.inArray(this,o)&&(o.push(this),(t=(e=c(this)).children()).each(function(){var t=c(this);s(e,t,t.prev()),t.find(i).each(r)}),s(e,c(),t.last()))};return i.each(r),e},g.prototype.displayMoveDialogue=function(o){t.create({type:t.types.CANCEL,title:this.getMoveDialogueTitle(this.info.element,o),body:this.getDestinationsList()}).then(c.proxy(function(e){var t=c.proxy(function(t){t.preventDefault(),t.stopPropagation(),this.moveElement(c(t.currentTarget).data("parent-element"),c(t.currentTarget).data("before-element")),this.info.endTime=(new Date).getTime(),this.info.positionChanged=this.hasPositionChanged(this.info),this.info.dropped=!0,o.focus(),this.executeCallback(g.EVENTS.DROP),e.hide()},this);return e.getRoot().on("click","[data-core_sortable_list-quickmove]",t),e.getRoot().on(r.hidden,c.proxy(function(){e.getRoot().off("click","[data-core_sortable_list-quickmove]",t),e.destroy(),this.finishDragging()},this)),e.setLarge(),e.show(),e},this)).catch(a.exception)},g});