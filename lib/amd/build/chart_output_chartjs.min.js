define(["jquery","core/chartjs","core/chart_axis","core/chart_bar","core/chart_output_base","core/chart_line","core/chart_pie","core/chart_series"],function(e,t,a,s,i,o,n,r){function c(t,e){return"axis-"+t+"-"+e}function l(){i.prototype.constructor.apply(this,arguments),this._canvas=this._node,"CANVAS"!=this._canvas.prop("tagName")&&(this._canvas=e("<canvas>"),this._node.append(this._canvas)),this._build()}return(l.prototype=Object.create(i.prototype))._config=null,l.prototype._chartjs=null,l.prototype._canvas=null,l.prototype._build=function(){this._config=this._makeConfig(),this._chartjs=new t(this._canvas[0],this._config)},l.prototype._cleanData=function(t){return t instanceof Array?t.map(function(t){return e("<span>").html(t).text()}):e("<span>").html(t).text()},l.prototype._getChartType=function(){var t=this._chart.getType();return this._chart.getType()===s.prototype.TYPE&&!0===this._chart.getHorizontal()?t="horizontalBar":this._chart.getType()===n.prototype.TYPE&&!0===this._chart.getDoughnut()&&(t="doughnut"),t},l.prototype._makeAxisConfig=function(t,e,s){e={id:c(e,s)};return t.getPosition()!==a.prototype.POS_DEFAULT&&(e.position=t.getPosition()),null!==t.getLabel()&&(e.scaleLabel={display:!0,labelString:this._cleanData(t.getLabel())}),null!==t.getStepSize()&&(e.ticks=e.ticks||{},e.ticks.stepSize=t.getStepSize()),null!==t.getMax()&&(e.ticks=e.ticks||{},e.ticks.max=t.getMax()),null!==t.getMin()&&(e.ticks=e.ticks||{},e.ticks.min=t.getMin()),e},l.prototype._makeConfig=function(){var a={type:this._getChartType(),data:{labels:this._cleanData(this._chart.getLabels()),datasets:this._makeDatasetsConfig()},options:{title:{display:null!==this._chart.getTitle(),text:this._cleanData(this._chart.getTitle())}}};return this._chart.getXAxes().forEach(function(t,e){var s=t.getLabels();a.options.scales=a.options.scales||{},a.options.scales.xAxes=a.options.scales.xAxes||[],a.options.scales.xAxes[e]=this._makeAxisConfig(t,"x",e),null!==s&&(a.options.scales.xAxes[e].ticks.callback=function(t,e){return s[e]||""}),a.options.scales.xAxes[e].stacked=this._isStacked()}.bind(this)),this._chart.getYAxes().forEach(function(t,e){var s=t.getLabels();a.options.scales=a.options.scales||{},a.options.scales.yAxes=a.options.scales.yAxes||[],a.options.scales.yAxes[e]=this._makeAxisConfig(t,"y",e),null!==s&&(a.options.scales.yAxes[e].ticks.callback=function(t){return s[parseInt(t,10)]||""}),a.options.scales.yAxes[e].stacked=this._isStacked()}.bind(this)),a.options.tooltips={callbacks:{label:this._makeTooltip.bind(this)}},a},l.prototype._makeDatasetsConfig=function(){return this._chart.getSeries().map(function(t){var e=t.hasColoredValues()?t.getColors():t.getColor(),e={label:this._cleanData(t.getLabel()),data:t.getValues(),type:t.getType(),fill:!1,backgroundColor:e,borderColor:this._chart.getType()==n.prototype.TYPE?"#fff":e,lineTension:this._isSmooth(t)?.3:0};return null!==t.getXAxis()&&(e.xAxisID=c("x",t.getXAxis())),null!==t.getYAxis()&&(e.yAxisID=c("y",t.getYAxis())),e}.bind(this))},l.prototype._makeTooltip=function(t,e){var s,a=this._chart.getSeries()[t.datasetIndex],i=a.getLabel(),a=a.getLabels(),e=e.datasets[t.datasetIndex].data[t.index],o=[];return""==t.xLabel&&""==t.yLabel&&(s=this._cleanData(this._chart.getLabels()),o.push(s[t.index])),null!==a?o.push(this._cleanData(a[t.index])):o.push(this._cleanData(i)+": "+e),o},l.prototype._isSmooth=function(t){var e=!1;return this._chart.getType()===o.prototype.TYPE?null===(e=t.getSmooth())&&(e=this._chart.getSmooth()):t.getType()===r.prototype.TYPE_LINE&&(e=t.getSmooth()),e},l.prototype._isStacked=function(){var t=!1;return t=this._chart.getType()===s.prototype.TYPE?this._chart.getStacked():t},l.prototype.update=function(){e.extend(!0,this._config,this._makeConfig()),this._chartjs.update()},l});