define(["jquery","core/ajax","core/templates","core/notification","core/str","core/config","core/url","core/form-autocomplete","core/pending"],function(m,v,g,y,h,b,k,_,C){return m("body").on("click keypress","[data-inplaceeditable] [data-inplaceeditablelink]",function(e){var t,c,o,l,d,s,p,r,u,f,a,n,i;"keypress"===e.type&&13!==e.keyCode||(t=new C("autocomplete-start-editing"),e.stopImmediatePropagation(),e.preventDefault(),c=m(this).closest("[data-inplaceeditable]"),o=function(e){e.addClass("updating");var t=e.find("img.spinner");t.length?t.show():(t=m("<img/>").attr("src",k.imageUrl("i/loading_small")).addClass("spinner").addClass("smallicon"),e.append(t))},l=function(e){e.removeClass("updating"),e.find("img.spinner").hide()},d=function(i,a){var n=[i.attr("data-itemid"),i.attr("data-component"),i.attr("data-itemtype")].join("-"),e=new C(n);o(i),v.call([{methodname:"core_update_inplace_editable",args:{itemid:i.attr("data-itemid"),component:i.attr("data-component"),itemtype:i.attr("data-itemtype"),value:a}}])[0].then(function(n){return g.render("core/inplace_editable",n).then(function(e,t){var a=i.attr("data-value"),e=m(e);g.replaceNode(i,e,t),e.find("[data-inplaceeditablelink]").focus(),e.trigger({type:"updated",ajaxreturn:n,oldvalue:a})})}).then(function(){return e.resolve()}).fail(function(e){var t=m.Event("updatefailed",{exception:e,newvalue:a});l(i),M.util.js_complete(n),i.trigger(t),t.isDefaultPrevented()||y.exception(e)})},s=function(e){e.find("input").off(),e.find("select").off(),e.html(e.attr("data-oldcontent")),e.removeAttr("data-oldcontent"),e.removeClass("inplaceeditingon"),e.find("[data-inplaceeditablelink]").focus()},p=function(e,t){for(var a=e,n=0;n<t;n++)a+=String(Math.floor(10*Math.random()));return 0===m("#"+a).length?a:p(e,t)},e=function(n){h.get_string("edittitleinstructions").done(function(e){var e=m('<span class="editinstructions">'+e+"</span>").attr("id",p("id_editinstructions_",20)),a=m('<input type="text"/>').attr("id",p("id_inplacevalue_",20)).attr("value",n.attr("data-value")).attr("aria-describedby",e.attr("id")).addClass("ignoredirty").addClass("form-control"),t=m('<label class="accesshide">'+c.attr("data-editlabel")+"</label>").attr("for",a.attr("id"));n.html("").append(e).append(t).append(a),a.focus(),a.select(),a.on("keyup keypress focusout",function(e){var t;b.behatsiterunning&&"focusout"===e.type||("keypress"===e.type&&13===e.keyCode&&(t=a.val(),s(n),d(n,t)),("keyup"===e.type&&27===e.keyCode||"focusout"===e.type)&&s(n))})})},r=function(e,t){s(e),d(e,t)},u=function(a,e){var t,n=m("<select></select>").attr("id",p("id_inplacevalue_",20)).addClass("custom-select"),i=m('<label class="accesshide">'+c.attr("data-editlabel")+"</label>").attr("for",n.attr("id"));for(t in e)n.append(m("<option>").attr("value",e[t].key).html(e[t].value));n.val(a.attr("data-value")),a.html("").append(i).append(n),n.focus(),n.select(),n.on("keyup change focusout",function(e){var t;b.behatsiterunning&&"focusout"===e.type||("change"===e.type&&(t=n.val(),s(a),d(a,t)),("keyup"===e.type&&27===e.keyCode||"focusout"===e.type)&&s(a))})},f=function(a,e){var t,n=m("<select></select>").attr("id",p("id_inplacevalue_",20)).addClass("form-autocomplete-original-select").addClass("custom-select"),i=m('<label class="accesshide">'+c.attr("data-editlabel")+"</label>").attr("for",n.attr("id")),o=e.options,e=e.attributes,l=m('<a href="#"></a>'),r=m('<a href="#"></a>');for(t in o)n.append(m("<option>").attr("value",o[t].key).html(o[t].value));e.multiple&&n.attr("multiple","true"),n.val(JSON.parse(a.attr("data-value"))),h.get_string("savechanges","core").then(function(e){return g.renderPix("e/save","core",e)}).then(function(e){l.append(e)}).fail(y.exception),h.get_string("cancel","core").then(function(e){return g.renderPix("e/cancel","core",e)}).then(function(e){r.append(e)}).fail(y.exception),a.html("").append(i).append(n).append(l).append(r),n.focus(),n.select(),_.enhance(n,e.tags,e.ajax,e.placeholder,e.caseSensitive,e.showSuggestions,e.noSelectionString).then(function(){a.find("[role=combobox]").focus()}).fail(y.exception),n.on("keyup",function(e){("keyup"===e.type&&27===e.keyCode||"focusout"===e.type)&&s(a)}),l.on("click",function(e){var t=JSON.stringify(n.val());n.empty(),s(a),d(a,t),e.preventDefault()}),r.on("click",function(e){n.empty(),s(a),e.preventDefault()})},m("span.inplaceeditable.inplaceeditingon").each(function(){s(m(this))}),(a=c).addClass("inplaceeditingon"),a.attr("data-oldcontent",a.html()),n=a.attr("data-type"),i=a.attr("data-options"),"toggle"===n?r(a,i):"select"===n?u(a,m.parseJSON(i)):"autocomplete"===n?f(a,m.parseJSON(i)):e(a),t.resolve())}),{}});