define(["jquery","core/ajax","core/localstorage"],function(m,h,f){var u=[];return{get_string:function(e,n,t,o){return this.get_strings([{key:e,component:n,param:t,lang:o}]).then(function(e){return e[0]})},get_strings:function(n){var e,t,o=m.Deferred(),r=[],c=0,a=!1;for(c=0;c<n.length;c++)void 0===(t=n[c]).lang&&(t.lang=m("html").attr("lang").replace(/-/g,"_")),t.cacheKey="core_str/"+t.key+"/"+t.component+"/"+t.lang,void 0!==M.str[t.component]&&void 0!==M.str[t.component][t.key]||((e=f.get(t.cacheKey))?(void 0===M.str[t.component]&&(M.str[t.component]=[]),M.str[t.component][t.key]=e):a=!0);if(a){function l(e){this.resolve(e)}function p(e){this.reject(e)}for(var i,s=[],g=[],c=0;c<n.length;c++)t=n[c],void 0!==u[t.cacheKey]||(i=m.Deferred(),s.push({methodname:"core_get_string",args:{stringid:t.key,component:t.component,lang:t.lang,stringparams:[]},done:l.bind(i),fail:p.bind(i)}),u[t.cacheKey]=i.promise()),g.push(u[t.cacheKey]);0<s.length&&h.call(s,!0,!1),m.when.apply(null,g).done(function(){for(var e=0,e=0;e<arguments.length;e++)t=n[e],void 0===M.str[t.component]&&(M.str[t.component]=[]),M.str[t.component][t.key]=arguments[e],f.set("core_str/"+t.key+"/"+t.component+"/"+t.lang,arguments[e]),r[e]=M.util.get_string(t.key,t.component,t.param).trim();o.resolve(r)}).fail(function(e){o.reject(e)})}else{for(c=0;c<n.length;c++)t=n[c],r[c]=M.util.get_string(t.key,t.component,t.param);o.resolve(r)}return o.promise()}}});