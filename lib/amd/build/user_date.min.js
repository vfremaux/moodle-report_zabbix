define(["jquery","core/ajax","core/sessionstorage","core/config"],function(c,t,i,r){var n=86400,s={},u=function(e){return"core_user_date/"+c("html").attr("lang").replace(/-/g,"_")+"/"+r.usertimezone+"/"+e.timestamp+"/"+e.format},f=function(e,t){i.set(e,t)};return{get:function(e){var n,o=[],a=[];return e.forEach(function(e){var t,r,n=u(e);void 0!==s[n]?a.push(s[n]):(t=c.Deferred(),(r=i.get(n))?t.resolve(r):(e.deferred=t,o.push(e)),r=n,e=t.promise(),s[r]=e,a.push(t.promise()))}),o.length&&(e=(n=o).map(function(e){return{timestamp:e.timestamp,format:e.format}}),e={methodname:"core_get_user_dates",args:{contextid:r.contextid,timestamps:e}},t.call([e],!0,!0)[0].then(function(e){e.dates.forEach(function(e,t){var t=n[t],r=u(t);f(r,e),t.deferred.resolve(e)})}).catch(function(t){n.forEach(function(e){e.deferred.reject(t)})})),c.when.apply(c,a).then(function(){return 1===arguments.length?[arguments[0]]:Array.apply(null,arguments)})},getUserMidnightForTimestamp:function(e,t){var r=t<e,e=Math.abs(e-t),e=(r?Math.floor(e/n):Math.ceil(e/n))*n;return r?t+e:t-e}}});