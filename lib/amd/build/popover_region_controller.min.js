define(["jquery","core/str","core/custom_interaction_events"],function(o,t,e){function n(t){this.root=o(t),this.content=this.root.find(i),this.contentContainer=this.root.find(s),this.menuContainer=this.root.find(r),this.menuToggle=this.root.find(a),this.isLoading=!1,this.promises={closeHandlers:o.Deferred(),navigationHandlers:o.Deferred()},this.registerBaseEventListeners()}var i=".popover-region-content",s=".popover-region-content-container",r=".popover-region-container",a=".popover-region-toggle",u='input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]';return n.prototype.events=function(){return{menuOpened:"popoverregion:menuopened",menuClosed:"popoverregion:menuclosed",startLoading:"popoverregion:startLoading",stopLoading:"popoverregion:stopLoading"}},n.prototype.getContentContainer=function(){return this.contentContainer},n.prototype.getContent=function(){return this.content},n.prototype.isMenuOpen=function(){return!this.root.hasClass("collapsed")},n.prototype.toggleMenu=function(){this.isMenuOpen()?this.closeMenu():this.openMenu()},n.prototype.closeMenu=function(){this.isMenuOpen()&&(this.root.addClass("collapsed"),this.menuContainer.attr("aria-expanded","false"),this.menuContainer.attr("aria-hidden","true"),this.updateButtonAriaLabel(),this.root.trigger(this.events().menuClosed))},n.prototype.openMenu=function(){this.isMenuOpen()||(this.root.removeClass("collapsed"),this.menuContainer.attr("aria-expanded","true"),this.menuContainer.attr("aria-hidden","false"),this.updateButtonAriaLabel(),this.promises.closeHandlers.resolve(),this.promises.navigationHandlers.resolve(),this.root.trigger(this.events().menuOpened))},n.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?t.get_string("hidepopoverwindow").done(function(t){this.menuToggle.attr("aria-label",t)}.bind(this)):t.get_string("showpopoverwindow").done(function(t){this.menuToggle.attr("aria-label",t)}.bind(this))},n.prototype.startLoading=function(){this.isLoading=!0,this.getContentContainer().addClass("loading"),this.getContentContainer().attr("aria-busy","true"),this.root.trigger(this.events().startLoading)},n.prototype.stopLoading=function(){this.isLoading=!1,this.getContentContainer().removeClass("loading"),this.getContentContainer().attr("aria-busy","false"),this.root.trigger(this.events().stopLoading)},n.prototype.focusMenuToggle=function(){this.menuToggle.focus()},n.prototype.contentItemHasFocus=function(){return 0<this.getContentItemWithFocus().length},n.prototype.getContentItemWithFocus=function(){var t=o(document.activeElement),e=this.getContent().children(),n=e.filter(t);return n=n.length?n:e.has(t)},n.prototype.focusContentItem=function(t){(t.is(u)?t:t.find(u).first()).focus()},n.prototype.focusFirstContentItem=function(){this.focusContentItem(this.getContent().children().first())},n.prototype.focusLastContentItem=function(){this.focusContentItem(this.getContent().children().last())},n.prototype.focusNextContentItem=function(){var t=this.getContentItemWithFocus();t.length&&t.next()&&this.focusContentItem(t.next())},n.prototype.focusPreviousContentItem=function(){var t=this.getContentItemWithFocus();t.length&&t.prev()&&this.focusContentItem(t.prev())},n.prototype.registerBaseEventListeners=function(){e.define(this.root,[e.events.activate,e.events.escape]),this.root.on(e.events.activate,a,function(){this.toggleMenu()}.bind(this)),this.promises.closeHandlers.done(function(){this.root.on(e.events.escape,function(){this.closeMenu(),this.focusMenuToggle()}.bind(this)),o("html").click(function(t){t=o(t.target);this.root.is(t)||this.root.has(t).length||this.closeMenu()}.bind(this)),e.define(this.getContentContainer(),[e.events.scrollBottom])}.bind(this))},n.prototype.registerListNavigationEventListeners=function(){e.define(this.root,[e.events.down]),this.root.on(e.events.down,function(t,e){this.isMenuOpen()?this.contentItemHasFocus()?this.focusNextContentItem():this.focusFirstContentItem():(this.openMenu(),this.focusFirstContentItem()),e.originalEvent.preventDefault()}.bind(this)),this.promises.navigationHandlers.done(function(){e.define(this.root,[e.events.up,e.events.home,e.events.end]),this.root.on(e.events.up,function(t,e){this.focusPreviousContentItem(),e.originalEvent.preventDefault()}.bind(this)),this.root.on(e.events.home,function(t,e){this.focusFirstContentItem(),e.originalEvent.preventDefault()}.bind(this)),this.root.on(e.events.end,function(t,e){this.focusLastContentItem(),e.originalEvent.preventDefault()}.bind(this))}.bind(this))},n});