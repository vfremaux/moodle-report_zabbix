define(["jquery","core/log","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/tree"],function(i,s,e,t,r,o,n,p){"use strict";function h(e,t,r,o){this.elementId=e,this.elementLabel=t,this.onlyTypes=r,this.allowAll=o,this.inputField=i("#"+e),this.wrapperBrowserTrigger=i('[data-filetypesbrowser="'+e+'"]'),this.wrapperDescriptions=i('[data-filetypesdescriptions="'+e+'"]'),this.wrapperBrowserTrigger.length&&(this.inputField.length&&this.wrapperDescriptions.length?this.prepareBrowserTrigger().then(function(){return this.prepareBrowserModal()}.bind(this)).then(function(){return this.prepareBrowserTree()}.bind(this)):s.error("core_form/filetypes: Unexpected DOM structure, unable to enhance filetypes field "+e))}return h.prototype.prepareBrowserTrigger=function(){return n.render("core_form/filetypes-trigger",{}).then(function(e){this.wrapperBrowserTrigger.html(e),this.browserTrigger=this.wrapperBrowserTrigger.find('[data-filetypeswidget="browsertrigger"]')}.bind(this))},h.prototype.prepareBrowserModal=function(){return t.create({type:t.types.SAVE_CANCEL,title:this.elementLabel}).then(function(e){this.browserModal=e}.bind(this)).then(function(){this.browserModal.getRoot().on(r.hidden,function(){this.browserTrigger.focus()}.bind(this)),this.browserModal.getRoot().on(r.save,function(){this.saveBrowserModal()}.bind(this))}.bind(this))},h.prototype.prepareBrowserTree=function(){return this.browserTrigger.on("click",function(e){e.preventDefault(),this.inputField.is("[disabled]")||((e=this.loadBrowserModalBody()).then(function(){this.browserTree=new p(this.browserModal.getBody()),this.browserTree.handleKeyDown=function(e,t){t.keyCode==this.browserTree.keys.enter||t.keyCode==this.browserTree.keys.space?(t.preventDefault(),t.stopPropagation(),this.toggleCheckbox(e.attr("data-filetypesbrowserkey"))):p.prototype.handleKeyDown.call(this.browserTree,e,t)}.bind(this),this.allowAll&&(this.hideOrShowItemsDependingOnAllowAll(this.browserModal.getRoot().find('input[type="checkbox"][data-filetypesbrowserkey="*"]:first')),this.browserModal.getRoot().on("change",'input[type="checkbox"][data-filetypesbrowserkey="*"]',function(e){this.hideOrShowItemsDependingOnAllowAll(i(e.currentTarget))}.bind(this))),this.browserModal.getRoot().on("change",'input[type="checkbox"][data-filetypesbrowserkey]',function(e){var e=i(e.currentTarget),t=e.attr("data-filetypesbrowserkey");this.browserModal.getRoot().find('input[type="checkbox"][data-filetypesbrowserkey="'+t+'"]').prop("checked",e.prop("checked"))}.bind(this))}.bind(this)).then(function(){this.browserModal.show()}.bind(this)),this.browserModal.setBody(e))}.bind(this)),i.when()},h.prototype.loadBrowserModalBody=function(){var e={onlytypes:this.onlyTypes.join(),allowall:this.allowAll,current:this.inputField.val()};return o.call([{methodname:"core_form_get_filetypes_browser_data",args:e}])[0].then(function(e){return n.render("core_form/filetypes-browser",{elementid:this.elementId,groups:e.groups})}.bind(this))},h.prototype.toggleCheckbox=function(e){e=this.browserModal.getRoot().find('input[type="checkbox"][data-filetypesbrowserkey="'+e+'"]:first');e.prop("checked",!e.prop("checked"))},h.prototype.saveBrowserModal=function(){if(this.allowAll){var e=this.browserModal.getRoot().find('input[type="checkbox"][data-filetypesbrowserkey="*"]');if(e.length&&e.prop("checked"))return this.inputField.val("*"),void this.updateDescriptions(["*"])}var r=[];this.browserModal.getRoot().find('input[type="checkbox"]').each(function(){var e=i(this),t=e.attr("data-filetypesbrowserkey");e.prop("checked")&&r.push(t)}),r=r.filter(function(e,t,r){return r.indexOf(e)==t}),this.inputField.val(r.join(" ")),this.updateDescriptions(r)},h.prototype.updateDescriptions=function(e){var t=[],e=(e.forEach(function(e){t.push({description:this.browserModal.getRoot().find('[data-filetypesname="'+e+'"]:first').text().trim(),extensions:this.browserModal.getRoot().find('[data-filetypesextensions="'+e+'"]:first').text().trim()})}.bind(this)),{hasdescriptions:0<t.length,descriptions:t});return n.render("core_form/filetypes-descriptions",e).then(function(e){this.wrapperDescriptions.html(e)}.bind(this))},h.prototype.hideOrShowItemsDependingOnAllowAll=function(e){var t=this.browserModal.getRoot().find('[role="treeitem"][data-filetypesbrowserkey!="*"]');e.prop("checked")?t.hide():t.show()},{init:function(e,t,r,o){new h(e,t,r,o)}}});