define(["jquery","core/templates"],function(e,s){function t(t){this.wrapperSelector='[data-passwordunmask="wrapper"][data-passwordunmaskid="'+t+'"]',this.wrapper=e(this.wrapperSelector),this.editorSpace=this.wrapper.find('[data-passwordunmask="editor"]'),this.editLink=this.wrapper.find('a[data-passwordunmask="edit"]'),this.editInstructions=this.wrapper.find('[data-passwordunmask="instructions"]'),this.displayValue=this.wrapper.find('[data-passwordunmask="displayvalue"]'),this.inputFieldLabel=e('label[for="'+t+'"]'),this.inputField=this.editorSpace.find(document.getElementById(t)),this.inputField.attr("type","hidden"),this.inputField.removeClass("hiddenifjs"),this.editInstructions.attr("id")||this.editInstructions.attr("id",t+"_instructions"),this.editInstructions.hide(),this.setDisplayValue(),this.addListeners()}return t.prototype.addListeners=function(){return this.wrapper.on("click keypress",'[data-passwordunmask="edit"]',e.proxy(function(t){"keypress"===t.type&&13!==t.keyCode||(t.stopImmediatePropagation(),t.preventDefault(),"hidden"!==this.inputField.attr("type")?"click"===t.type||e(t.relatedTarget).is(":input")?this.turnEditingOff(!1):this.turnEditingOff(!0):this.turnEditingOn())},this)),this.wrapper.on("click keypress",'[data-passwordunmask="unmask"]',e.proxy(function(t){"keypress"===t.type&&13!==t.keyCode||(t.stopImmediatePropagation(),t.preventDefault(),this.wrapper.data("unmasked",!this.wrapper.data("unmasked")),this.setDisplayValue())},this)),this.wrapper.on("keydown","input",e.proxy(function(t){"keydown"===t.type&&13!==t.keyCode||(t.stopImmediatePropagation(),t.preventDefault(),this.turnEditingOff(!0))},this)),this.inputFieldLabel.on("click",e.proxy(function(t){t.preventDefault(),this.turnEditingOn()},this)),this},t.prototype.checkFocusOut=function(i){this.isEditing()&&window.setTimeout(e.proxy(function(){var t=i.relatedTarget||document.activeElement;this.wrapper.has(e(t)).length||this.turnEditingOff(!e(t).is(":input,a"))},this),100)},t.prototype.passwordVisible=function(){return!!this.wrapper.data("unmasked")},t.prototype.isEditing=function(){return"hidden"!==this.inputField.attr("type")},t.prototype.turnEditingOn=function(){var t=this.getDisplayValue();return this.passwordVisible()?this.inputField.attr("type","text"):this.inputField.attr("type","password"),this.inputField.val(t),this.inputField.attr("size",this.inputField.attr("data-size")),this.editInstructions.length&&(this.inputField.attr("aria-describedby",this.editInstructions.attr("id")),this.editInstructions.show()),this.wrapper.attr("data-passwordunmask-visible",1),this.editLink.hide(),this.inputField.focus().select(),e("body").on("focusout",this.wrapperSelector,e.proxy(this.checkFocusOut,this)),this},t.prototype.turnEditingOff=function(t){e("body").off("focusout",this.wrapperSelector,this.checkFocusOut);var i=this.getDisplayValue();return this.inputField.attr("type","hidden").attr("aria-describedby",null),this.inputField.val(i),this.editInstructions.hide(),this.wrapper.removeAttr("data-passwordunmask-visible"),this.inputField.removeAttr("size"),this.editLink.show(),this.setDisplayValue(),t&&this.editLink.focus(),this},t.prototype.getDisplayValue=function(){return this.inputField.val()},t.prototype.setDisplayValue=function(){var t=this.getDisplayValue();return this.isEditing()&&(this.wrapper.data("unmasked")?this.inputField.attr("type","text"):this.inputField.attr("type","password"),this.inputField.val(t)),t&&this.wrapper.data("unmasked")?this.displayValue.text(t):(t=t||"",s.render("core_form/element-passwordunmask-fill",{element:{frozen:this.inputField.is("[readonly]"),value:t,valuechars:t.split("")}}).done(e.proxy(function(t,i){this.displayValue.html(t),s.runTemplateJS(i)},this))),this},t});