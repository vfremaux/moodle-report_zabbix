define(["jquery","core/templates","core/str","core/notification","core_calendar/repository","core_calendar/events","core_calendar/selectors","core/modal_factory","core/modal_events","core_calendar/summary_modal"],function(c,u,t,f,l,p,s,v,y,w){function n(i){(i=c(i)).on("click",s.links.eventLink,function(e){var n,r,t=c(e.target),a=null,i=t.is(s.actions.viewEvent)?t:t.closest(s.actions.viewEvent);(a=(i.length?i:t.find(s.actions.viewEvent)).data("eventId"))&&(e.preventDefault(),e.stopPropagation(),n=a,r="",l.getEventById(n).then(function(e){if(!e.event)throw new Error("Error encountered while trying to fetch calendar event with ID: "+n);var t=e.event;return r=C(t.eventtype),D(t.eventtype).then(function(e){return t.eventtype=e,t})}).then(function(e){e={title:e.name,type:w.TYPE,body:u.render("core_calendar/event_summary_body",e),templateContext:{canedit:e.canedit,candelete:e.candelete,headerclasses:r,isactionevent:e.isactionevent,url:e.url}};return v.create(e)}).done(function(e){e.getRoot().on(y.hidden,function(){e.destroy()}),e.show()}).fail(f.exception))}),i.on("click",s.links.navLink,function(e){var t=i.find(s.wrapper),n=t.data("view"),r=t.data("courseid"),t=t.data("categoryid"),a=c(e.currentTarget);"month"===n?(m(i,a.attr("href"),a.data("year"),a.data("month"),r,t),e.preventDefault()):"day"===n&&(_(i,a.attr("href"),a.data("year"),a.data("month"),a.data("day"),r,t),e.preventDefault())})}function m(e,t,n,r,a,i){return o(e,n,r,a,i).then(function(){return t.length&&"#"!==t&&window.history.pushState({},"",t),arguments}).then(function(){return c("body").trigger(p.monthChanged,[n,r,a,i]),arguments})}function _(e,t,n,r,a,i,o){return d(e,n,r,a,i,o).then(function(){return t.length&&"#"!==t&&window.history.pushState({},"",t),arguments}).then(function(){return c("body").trigger(p.dayChanged,[n,r,a,i,o]),arguments})}function r(e){switch(e){case"user":return"user";case"site":return"site";case"group":return"group";case"category":return"category";default:return"course"}}var o=function(t,e,n,r,a,i){h(t),i=i||t.find(s.wrapper),M.util.js_pending([t.get("id"),e,n,r].join("-"));var o=t.data("includenavigation"),d=t.data("mini");return l.getCalendarMonthData(e,n,r,a,o,d).then(function(e){return u.render(t.attr("data-template"),e)}).then(function(e,t){return u.replaceNode(i,e,t)}).then(function(){c("body").trigger(p.viewUpdated)}).always(function(){return M.util.js_complete([t.get("id"),e,n,r].join("-")),g(t)}).fail(f.exception)},d=function(t,e,n,r,a,i,o){h(t),o=o||t.find(s.wrapper),M.util.js_pending([t.get("id"),e,n,r,a,i].join("-"));var d=t.data("includenavigation");return l.getCalendarDayData(e,n,r,a,i,d).then(function(e){return u.render(t.attr("data-template"),e)}).then(function(e,t){return u.replaceNode(o,e,t)}).then(function(){c("body").trigger(p.viewUpdated)}).always(function(){return M.util.js_complete([t.get("id"),e,n,r,a,i].join("-")),g(t)}).fail(f.exception)},h=function(e){e.find(s.containers.loadingIcon).removeClass("hidden")},g=function(e){e.find(s.containers.loadingIcon).addClass("hidden")},C=function(e){return"calendar_event_"+r(e)},D=function(e){e="type"+r(e);return t.get_string(e,"core_calendar").then(function(e){return e})};return{init:function(e){n(e)},reloadCurrentMonth:function(e,t,n){var r=e.find(s.wrapper).data("year"),a=e.find(s.wrapper).data("month");return void 0===t&&(t=e.find(s.wrapper).data("courseid")),void 0===n&&(n=e.find(s.wrapper).data("categoryid")),o(e,r,a,t,n)},changeMonth:m,refreshMonthContent:o,reloadCurrentDay:function(e,t,n){var r=e.find(s.wrapper),a=r.data("year"),i=r.data("month"),r=r.data("day");return t=t||e.find(s.wrapper).data("courseid"),void 0===n&&(n=e.find(s.wrapper).data("categoryid")),d(e,a,i,r,t,n)},changeDay:_,refreshDayContent:d,reloadCurrentUpcoming:function(t,e,n){h(t);var r=t.find(s.wrapper);return void 0===e&&(e=t.find(s.wrapper).data("courseid")),void 0===n&&(n=t.find(s.wrapper).data("categoryid")),l.getCalendarUpcomingData(e,n).then(function(e){return u.render(t.attr("data-template"),e)}).then(function(e,t){return u.replaceNode(r,e,t)}).then(function(){c("body").trigger(p.viewUpdated)}).always(function(){return g(t)}).fail(f.exception)}}});