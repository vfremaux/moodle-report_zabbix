define(["jquery","core/notification","core/str","core_calendar/events","core_calendar/drag_drop_data_store"],function(o,m,u,i,s){function l(t){return(t=o(t.target).closest(v.DROP_ZONE)).length?t:null}function c(){o(v.ROOT).find(v.DROP_ZONE).each(function(t,e){(e=o(e)).removeClass(p)})}function E(){o(v.ROOT).find(v.DROP_ZONE).each(function(t,e){e=o(e),f(e)||g(e,!1)})}function t(t){var e,a,n,r,d,i=o(t.target).closest(v.DRAGGABLE);i.length&&(e=i.find("[data-event-id]").attr("data-event-id"),a=i.attr("data-min-day-timestamp"),n=i.attr("data-max-day-timestamp"),r=i.attr("data-min-day-error"),i=i.attr("data-max-day-error"),d=v.ROOT+' [data-event-id="'+e+'"]',d=o(d).length,s.setEventId(e),s.setDurationDays(d),a&&s.setMinTimestart(a),n&&s.setMaxTimestart(n),r&&s.setMinError(r),i&&s.setMaxError(i),t.dataTransfer.effectAllowed="move",t.dataTransfer.dropEffect="move",t.dataTransfer.setData("text/plain",e),t.dropEffect="move",E())}function e(t){s.hasEventId()&&(t.preventDefault(),(t=l(t))&&g(t,!0))}function a(t){var e;!s.hasEventId()||(e=l(t))&&(g(e,!1),t.preventDefault())}function n(t){if(s.hasEventId()){var e,a,n,r,d=l(t);if(!d)return s.clearAll(),void c();f(d)?(n=s.getEventId(),a=v.ROOT+' [data-event-id="'+n+'"]',r=null,(a=o(a)).length&&(r=a.closest(v.DROP_ZONE)),o("body").trigger(i.moveEvent,[n,r,d])):(a=(a=d).attr("data-day-timestamp"),n=s.getMinTimestart(),r=s.getMaxTimestart(),e=n&&a<n?s.getMinError():r&&r<a?s.getMaxError():null,u.get_string("errorinvaliddate","calendar").then(function(t){m.exception({name:t,message:e||t})})),s.clearAll(),c(),t.preventDefault()}}function O(){s.clearAll(),c()}function h(){E()}var v={ROOT:"[data-region='calendar']",DRAGGABLE:'[draggable="true"][data-region="event-item"]',DROP_ZONE:'[data-drop-zone="month-view-day"]',WEEK:'[data-region="month-view-week"]'},D="bg-faded",r="bg-danger text-white",d="bg-primary text-white",p=D+" "+r+" "+d,T=!1,f=function(t){var t=t.attr("data-day-timestamp"),e=s.getMinTimestart(),a=s.getMaxTimestart();return!(e&&t<e)&&!(a&&a<t)},g=function(t,e,a){void 0===a&&(a=s.getDurationDays());var n=f(t);t.removeClass(p),e?n?t.addClass(d):t.addClass(r):(t.removeClass(d+" "+r),n||t.addClass(D)),0<--a&&((n=t.next()).length||(t=t.closest(v.WEEK).next()).length&&(n=t.children(v.DROP_ZONE).first()),n.length&&g(n,e,a))};return{init:function(){T||(document.addEventListener("dragstart",t,!1),document.addEventListener("dragover",e,!1),document.addEventListener("dragleave",a,!1),document.addEventListener("drop",n,!1),document.addEventListener("dragend",O,!1),o("body").on(i.monthChanged,h),T=!0)}}});