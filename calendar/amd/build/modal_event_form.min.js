define(["jquery","core/event","core/str","core/notification","core/templates","core/custom_interaction_events","core/modal","core/modal_registry","core/fragment","core_calendar/events","core_calendar/repository"],function(i,l,t,n,u,e,o,r,s,a,c){function d(t){o.call(this,t),this.eventId=null,this.startTime=null,this.courseId=null,this.categoryId=null,this.contextId=null,this.reloadingBody=!1,this.reloadingTitle=!1,this.saveButton=this.getFooter().find(h)}var h='[data-action="save"]',p='[data-region="loading-icon-container"]';return d.TYPE="core_calendar-modal_event_form",((d.prototype=Object.create(o.prototype)).constructor=d).prototype.setContextId=function(t){this.contextId=t},d.prototype.getContextId=function(){return this.contextId},d.prototype.setCourseId=function(t){this.courseId=t},d.prototype.getCourseId=function(){return this.courseId},d.prototype.setCategoryId=function(t){this.categoryId=t},d.prototype.getCategoryId=function(){return this.categoryId},d.prototype.hasCourseId=function(){return null!==this.courseId},d.prototype.hasCategoryId=function(){return null!==this.categoryId},d.prototype.setEventId=function(t){this.eventId=t},d.prototype.getEventId=function(){return this.eventId},d.prototype.hasEventId=function(){return null!==this.eventId},d.prototype.setStartTime=function(t){this.startTime=t},d.prototype.getStartTime=function(){return this.startTime},d.prototype.hasStartTime=function(){return null!==this.startTime},d.prototype.getForm=function(){return this.getBody().find("form")},d.prototype.disableButtons=function(){this.saveButton.prop("disabled",!0)},d.prototype.enableButtons=function(){this.saveButton.prop("disabled",!1)},d.prototype.reloadTitleContent=function(){return this.reloadingTitle||(this.reloadingTitle=!0,this.hasEventId()?this.titlePromise=t.get_string("editevent","calendar"):this.titlePromise=t.get_string("newevent","calendar"),this.titlePromise.then(function(t){return this.setTitle(t),t}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(n.exception)),this.titlePromise},d.prototype.reloadBodyContent=function(t){if(this.reloadingBody)return this.bodyPromise;this.reloadingBody=!0,this.disableButtons();var e={};return this.hasEventId()&&(e.eventid=this.getEventId()),this.hasStartTime()&&(e.starttime=this.getStartTime()),this.hasCourseId()&&(e.courseid=this.getCourseId()),this.hasCategoryId()&&(e.categoryid=this.getCategoryId()),void 0!==t&&(e.formdata=t),this.bodyPromise=s.loadFragment("calendar","event_form",this.getContextId(),e),this.setBody(this.bodyPromise),this.bodyPromise.then(function(){this.enableButtons()}.bind(this)).fail(n.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(n.exception),this.bodyPromise},d.prototype.reloadAllContent=function(){return i.when(this.reloadTitleContent(),this.reloadBodyContent())},d.prototype.show=function(){this.reloadAllContent(),o.prototype.show.call(this)},d.prototype.hide=function(){o.prototype.hide.call(this),this.setEventId(null),this.setStartTime(null),this.setCourseId(null),this.setCategoryId(null)},d.prototype.getFormData=function(){return this.getForm().serialize()},d.prototype.save=function(){var t=this.saveButton.find(p),o=(t.removeClass("hidden"),this.disableButtons(),this.getFormData());return c.submitCreateUpdateForm(o).then(function(t){var e;t.validationerror?this.reloadBodyContent(o):(e=this.hasEventId(),this.hide(),e?i("body").trigger(a.updated,[t.event]):i("body").trigger(a.created,[t.event]))}.bind(this)).always(function(){t.addClass("hidden"),this.enableButtons()}.bind(this)).fail(n.exception)},d.prototype.registerEventListeners=function(){o.prototype.registerEventListeners.call(this),this.getModal().on(e.events.activate,h,function(t,e){this.getForm().submit(),e.originalEvent.preventDefault(),t.stopPropagation()}.bind(this)),this.getModal().on("submit",function(t){this.save(),t.preventDefault(),t.stopPropagation()}.bind(this))},r.register(d.TYPE,d,"calendar/modal_event_form"),d});