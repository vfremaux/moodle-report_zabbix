define(["jquery","core/notification","core/custom_interaction_events","core/str","core/templates","block_timeline/event_list","core_course/repository","block_timeline/calendar_events_repository"],function(d,o,n,f,s,l,e,i){function u(t){t.find(c.COURSE_ITEMS_LOADING_PLACEHOLDER).addClass("hidden")}function O(t,n,e,r){return t={courseids:t,starttime:n,limit:e},r&&(t.endtime=r),i.queryByCourses(t)}function v(t,n){t.data("last-event-load-time",n)}function a(t){t.attr("data-seen")||((R(t)?B:r)(t),t.attr("data-seen",!0))}var c={MORE_COURSES_BUTTON:'[data-action="more-courses"]',MORE_COURSES_BUTTON_CONTAINER:'[data-region="more-courses-button-container"]',NO_COURSES_EMPTY_MESSAGE:'[data-region="no-courses-empty-message"]',COURSES_LIST:'[data-region="courses-list"]',COURSE_ITEMS_LOADING_PLACEHOLDER:'[data-region="course-items-loading-placeholder"]',COURSE_EVENTS_CONTAINER:'[data-region="course-events-container"]',COURSE_NAME:'[data-region="course-name"]',LOADING_ICON:".loading-icon"},S="block_timeline/course-items",m="core/loading",C="inprogress",h="fullname asc",E=5,p=function(t){var n=t.find(c.MORE_COURSES_BUTTON);n.prop("disabled",!0),s.render(m,{}).then(function(t){return n.append(t),t}).catch(function(){return!1})},N=function(t){t=t.find(c.MORE_COURSES_BUTTON);t.prop("disabled",!1),t.find(c.LOADING_ICON).remove()},R=function(t){return 0<t.find(c.COURSE_EVENTS_CONTAINER).length},g=function(t){return parseInt(t.attr("data-offset"),10)},T=function(t,n){t.attr("data-offset",n)},U=function(t){return parseInt(t.attr("data-limit"),10)},I=function(t){return parseInt(t.attr("data-days-offset"),10)},y=function(t){t=t.attr("data-days-limit");return null!=t?parseInt(t,10):void 0},_=function(t){return parseInt(t.attr("data-midnight"),10)},A=function(t){return _(t)+86400*I(t)},M=function(t){var n=_(t),t=y(t);return null!=t&&n+86400*t},D=function(t,n){return t.data("last-event-load-time")>n},b=function(t,n,e){t=t.map(function(t){return t.id});return O(t,n,E+1,e)},L=function(n,r,t,e,i,a){return s.render(S,{courses:n,midnight:t,hasdaysoffset:!0,hasdayslimit:null!=i,daysoffset:e,dayslimit:i,nodayslimit:null==i,urls:{noevents:a}}).then(function(t){var n,e;return u(r),t?(e=t,n=(n=r).find(c.COURSES_LIST),s.appendNodeContents(n,e,"")):R(r)||r.find(c.NO_COURSES_EMPTY_MESSAGE).removeClass("hidden"),t}).then(function(t){return n.length<2?r.find(c.MORE_COURSES_BUTTON_CONTAINER).addClass("hidden"):r.find(c.MORE_COURSES_BUTTON_CONTAINER).removeClass("hidden"),t}).catch(function(){u(r)})},r=function(u){var t=g(u),n=U(u);return e.getEnrolledCoursesByTimelineClassification(C,n,t,h).then(function(t){var n=Date.now(),e=t.courses,t=t.nextoffset,r=I(u),i=y(u),a=_(u),o=A(u),s=M(u),c=u.attr("data-no-events-url"),t=(T(u,t),b(e,o,s)),o=L(e,u,a,r,i,c);return d.when(t,o).then(function(o){return D(u,n)||e.forEach(function(t){var n=t.id,e=[],r=u.find('[data-region="course-events-container"][data-course-id="'+n+'"]').find(l.rootSelector),i=o.groupedbycourse.filter(function(t){return t.courseid==n}),a=(i.length&&(e=i[0].events),d.Deferred().resolve({events:e}).promise());f.get_string("ariaeventlistpaginationnavcourses","block_timeline",t.fullnamedisplay).then(function(t){return l.init(r,E,{1:a},t),t}).catch(function(){l.init(r,E,{1:a})})}),o})}).catch(o.exception)},B=function(t){var n=Date.now(),e=A(t),r=M(t),i=t.find(c.COURSE_EVENTS_CONTAINER),a=i.map(function(){return d(this).attr("data-course-id")}).get();return v(t,n),O(a,e,E+1,r).then(function(s){return D(t,n)||i.each(function(t,n){var e=(n=d(n)).attr("data-course-id"),r=n.find(c.COURSE_NAME).text(),i=n.find(l.rootSelector),a=d.Deferred(),n=[],o=s.groupedbycourse.filter(function(t){return t.courseid==e});o.length&&(n=o[0].events),a.resolve({events:n}),f.get_string("ariaeventlistpaginationnavcourses","block_timeline",r).then(function(t){return l.init(i,E,{1:a.promise()},t),t}).catch(function(){l.init(i,E,{1:a.promise()})})}),s}).catch(o.exception)};return{init:function(t){var e;t=d(t),v(t,Date.now()),t.hasClass("active")&&(r(t),t.attr("data-seen",!0)),e=t,n.define(e,[n.events.activate]),e.on(n.events.activate,c.MORE_COURSES_BUTTON,function(t,n){p(e),r(e).then(function(){N(e)}).catch(function(){N(e)}),n&&(n.originalEvent.preventDefault(),n.originalEvent.stopPropagation()),t.stopPropagation()})},reset:function(t){t.removeAttr("data-seen"),t.hasClass("active")&&a(t)},shown:a}});