define(["jquery","core/notification","core/templates","core/paged_content_factory","core/str","core/user_date","block_timeline/calendar_events_repository"],function(C,O,I,S,b,i,u){var A={EMPTY_MESSAGE:'[data-region="empty-message"]',ROOT:'[data-region="event-list-container"]',EVENT_LIST_CONTENT:'[data-region="event-list-content"]',EVENT_LIST_LOADING_PLACEHOLDER:'[data-region="event-list-loading-placeholder"]'},o="block_timeline/event-list-content",P={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,ariaLabels:{itemsperpagecomponents:"ariaeventlistpagelimit, block_timeline"}},M=function(e,t){n=t,r={},a={eventsbyday:[]},e.forEach(function(e){var t=i.getUserMidnightForTimestamp(e.timesort,n);r[t]?r[t].push(e):r[t]=[e]}),Object.keys(r).forEach(function(e){var t=r[e];a.eventsbyday.push({past:e<n,dayTimestamp:e,events:t})});var n,r,a,t=a,e=o;return I.render(e,t)},V=function(e,t,n,r,a,i,o,l){for(var s=e.pageNumber,d=e.limit,c=s;!r.hasOwnProperty(c);)c--;e=r[c];return(a&&a.hasOwnProperty(s)?a[s]:function(e,t,n,r,a,i){r=null!=r&&e+86400*r,e={starttime:e+86400*n,limit:t};return a&&(e.aftereventid=a),r&&(e.endtime=r),i?(e.courseid=i,u.queryByCourse(e)):u.queryByTime(e)}(n,d+1,o,l,e,i)).then(function(e){if(!e.events.length)return t.allItemsLoaded(s),[];e=e.events;return e.length<=d?t.allItemsLoaded(s):e.pop(),e})};return{init:function(r,l,u,f,h){r=C(r);var e,t,a,i,n,m,E,p,T,o,s,d,v=C.Deferred(),_=r.find(A.EVENT_LIST_CONTENT),g=r.find(A.EVENT_LIST_LOADING_PLACEHOLDER),N=r.attr("data-course-id"),y=parseInt(r.attr("data-days-offset"),10),c=r.attr("data-days-limit"),L=parseInt(r.attr("data-midnight"),10);return r.find(A.EVENT_LIST_CONTENT).empty(),(e=r).find(A.EVENT_LIST_CONTENT).removeClass("hidden"),e.find(A.EMPTY_MESSAGE).addClass("hidden"),g.removeClass("hidden"),null!=c&&(c=parseInt(c,10)),t=l,a=u,i=L,n=v,m=N,E=y,p=c,T=f,s=!(o={1:0}),d=C.extend({},P,h),b.get_string("ariaeventlistpagelimit","block_timeline",C.isArray(t)?t[0].value:t).then(function(e){return d.ariaLabels.itemsperpage=e,d.ariaLabels.paginationnav=T,e}).then(function(){return S.createWithLimit(t,function(e,t){var r=[];return e.forEach(function(e){var n=e.pageNumber,e=V(e,t,i,o,a,m,E,p).then(function(e){var t;return e.length?(s=!0,t=e[e.length-1].id,o[n+1]=t,M(e,i)):e}).catch(O.exception);r.push(e)}),C.when.apply(C,r).then(function(){n.resolve(s)}).catch(function(){n.resolve(s)}),r},d)}).then(function(n,e){return(n=C(n)).addClass("hidden"),I.replaceNodeContents(_,n,e),v.then(function(e){var t;return n.removeClass("hidden"),g.addClass("hidden"),e||((t=r).find(A.EVENT_LIST_CONTENT).addClass("hidden"),t.find(A.EMPTY_MESSAGE).removeClass("hidden")),e}).catch(function(){return!1}),n}).catch(O.exception)},rootSelector:A.ROOT}});