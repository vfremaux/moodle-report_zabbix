define(["jquery","block_myoverview/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events"],function(u,E,h,s,o,d,c,C,l,n){function p(e,t){return e.find(f.FAVOURITE_ICON+'[data-course-id="'+t+'"]')}function I(e,t){return e.find('[data-region="paged-content-page"][data-page="'+t+'"]')}function e(e,t){return e.find('[data-action="add-favourite"][data-course-id="'+t+'"]')}function t(e,t){return e.find('[data-action="remove-favourite"][data-course-id="'+t+'"]')}function m(r,i){return E.setFavouriteCourses({courses:[{id:r,favourite:i}]}).then(function(e){return 0==e.warnings.length&&(v.forEach(function(n){n.courses.forEach(function(e,t){e.id==r&&(n.courses[t].isfavourite=i)})}),!0)}).catch(d.exception)}function i(e){var s,t,n,r,i,a;e=u(e),v=[],_=g=0,T="block_myoverview_"+(s=e).attr("id")+"_"+Math.random(),t=R,(n=parseInt(s.find(l.courseView.region).attr("data-paging"),10))&&(t=R.map(function(e){return{value:e,active:e==n?!0:!1}})),r=A(s),(i=u.extend({},N)).eventNamespace=T,h.createWithLimit(t,function(e,c){var t=[];return e.forEach(function(a){var o=a.pageNumber,e=a.limit;if(S!=e&&(v=[],g=_=0),g==o)return c.allItemsLoaded(g),void t.push(w(s,v[o]));S=e,null==v[o+1]&&null==v[o]&&(e*=2);e=U(r,e).then(function(e){var t=e.courses,n=0,r=[],i=(null!=v[o]?(i=(r=v[o].courses).length)<a.limit&&(n=a.limit-i,r=u.merge(v[o].courses,t.slice(0,n))):(n=a.limit,r=t.slice(0,a.limit)),v[o]={courses:r},t.slice(n,t.length));return i.length&&(v[o+1]={courses:i}),v[o].courses.length<a.limit?(g=o,c.allItemsLoaded(o)):null!=v[o+1]&&v[o+1].courses.length<a.limit&&(g=o+1),_=e.nextoffset,w(s,v[o])}).catch(d.exception);t.push(e)}),t},i).then(function(e,t){return D(s,T),c.replaceNodeContents(s.find(l.courseView.region),e,t)}).catch(d.exception),e.attr("data-init")||(a=e,o.define(a,[o.events.activate]),a.on(o.events.activate,f.ACTION_ADD_FAVOURITE,function(e,t){e=u(e.target).closest(f.ACTION_ADD_FAVOURITE),e=O(e);V(a,e),t.originalEvent.preventDefault()}),a.on(o.events.activate,f.ACTION_REMOVE_FAVOURITE,function(e,t){e=u(e.target).closest(f.ACTION_REMOVE_FAVOURITE),e=O(e);y(a,e),t.originalEvent.preventDefault()}),a.on(o.events.activate,f.FAVOURITE_ICON,function(e,t){t.originalEvent.preventDefault()}),a.on(o.events.activate,f.ACTION_HIDE_COURSE,function(e,t){var e=u(e.target).closest(f.ACTION_HIDE_COURSE),n=O(e);E.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+n,value:!0}]}),b(a,e),t.originalEvent.preventDefault()}),a.on(o.events.activate,f.ACTION_SHOW_COURSE,function(e,t){var e=u(e.target).closest(f.ACTION_SHOW_COURSE),n=O(e);E.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+n,value:null}]}),b(a,e),t.originalEvent.preventDefault()}),e.attr("data-init",!0))}var f={COURSE_REGION:'[data-region="course-view-content"]',ACTION_HIDE_COURSE:'[data-action="hide-course"]',ACTION_SHOW_COURSE:'[data-action="show-course"]',ACTION_ADD_FAVOURITE:'[data-action="add-favourite"]',ACTION_REMOVE_FAVOURITE:'[data-action="remove-favourite"]',FAVOURITE_ICON:'[data-region="favourite-icon"]',ICON_IS_FAVOURITE:'[data-region="is-favourite"]',ICON_NOT_FAVOURITE:'[data-region="not-favourite"]',PAGED_CONTENT_CONTAINER:'[data-region="page-container"]'},a={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"block_myoverview/no-courses"},R=[12,24,48],v=[],_=0,g=0,S=0,T=null,A=function(e){e=e.find(l.courseView.region);return{display:e.attr("data-display"),grouping:e.attr("data-grouping"),sort:e.attr("data-sort")}},N={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},U=function(e,t){return E.getEnrolledCoursesByTimeline({offset:_,limit:t,classification:e.grouping,sort:e.sort})},O=function(e){return e.attr("data-course-id")},V=function(n,r){var i=t(n,r),a=e(n,r);m(r,!0).then(function(e){var t;e?(s.publish(C.favourited),i.removeClass("hidden"),a.addClass("hidden"),(t=(e=p(e=n,t=r)).find(f.ICON_IS_FAVOURITE)).removeClass("hidden"),t.attr("aria-hidden",!1),(t=e.find(f.ICON_NOT_FAVOURITE)).addClass("hidden"),t.attr("aria-hidden",!0)):d.alert("Starring course failed","Could not change favourite state")}).catch(d.exception)},y=function(n,r){var i=t(n,r),a=e(n,r);m(r,!1).then(function(e){var t;e?(s.publish(C.unfavorited),i.addClass("hidden"),a.removeClass("hidden"),(t=(e=p(e=n,t=r)).find(f.ICON_IS_FAVOURITE)).addClass("hidden"),t.attr("aria-hidden",!0),(t=e.find(f.ICON_NOT_FAVOURITE)).removeClass("hidden"),t.attr("aria-hidden",!1)):d.alert("Starring course failed","Could not change favourite state")}).catch(d.exception)},b=function(n,e){var t,r=O(e),e=n.find('[data-region="paging-bar"]'),i=parseInt(e.attr("data-active-page-number")),e=v[i].courses.reduce(function(e,t){return r!=t.id&&e.push(t),e},[]),a=(null!=v[i+1]&&(t=v[i+1].courses.slice(0,1),v.forEach(function(e,t){var n;i<t&&(n=[],null!=v[t+1]&&(n=v[t+1].courses.slice(0,1)),v[t].courses=u.merge(v[t].courses.slice(1),n))}),e=u.merge(e,t)),g==i+1&&0==v[i+1].courses.length&&(t=n.find('[data-region="paged-content-container"]'),h.resetLastPageNumber(u(t).attr("id"),i)),v[i].courses=e,_--,I(n,i));w(n,v[i]).then(function(e,t){return c.replaceNodeContents(a,e,t)}).catch(d.exception),v.forEach(function(e,t){i<t&&I(n,t).remove()})},w=function(e,t){var n=A(e),r="",r="cards"==n.display?a.COURSES_CARDS:"list"==n.display?a.COURSES_LIST:a.COURSES_SUMMARY;return t.courses.length?c.render(r,{courses:t.courses}):(n=e.find(l.courseView.region).attr("data-nocoursesimg"),c.render(a.NOCOURSES,{nocoursesimg:n}))},D=function(e,t){t+=n.SET_ITEMS_PER_PAGE_LIMIT;s.subscribe(t,function(e){this.find(l.courseView.region).attr("data-paging",e)}.bind(e))};return{init:i,reset:function(r){0<v.length?v.forEach(function(e,t){var n=I(r,t);w(r,e).then(function(e,t){return c.replaceNodeContents(n,e,t)}).catch(d.exception)}):i(r)}}});