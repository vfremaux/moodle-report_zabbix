define(["jquery","core/config","core/str","core/log"],function(i,n,e,d){var a={dhxWins:"",selectedRow:0,menu:null,toolbar:null,mygrid:null,init:function(t){var o;a.dhxWins=new dhtmlXWindows,a.selectedRow=null,a.params=t,a.strs=[];e.get_strings([{key:"reply",component:"block_livedesk"},{key:"discard",component:"block_livedesk"},{key:"discardbefore",component:"block_livedesk"},{key:"emailuser",component:"block_livedesk"},{key:"message",component:"block_livedesk"},{key:"user",component:"block_livedesk"},{key:"messagetime",component:"block_livedesk"},{key:"origin",component:"block_livedesk"},{key:"lockedby",component:"block_livedesk"},{key:"livequeue",component:"block_livedesk"},{key:"livedeskinfo",component:"block_livedesk"},{key:"onlineusers",component:"block_livedesk"},{key:"monitoredplugins",component:"block_livedesk"},{key:"refreshposts",component:"block_livedesk"},{key:"onlineuserscount",component:"block_livedesk"},{key:"onlineattenderscount",component:"block_livedesk"},{key:"showhideanswered",component:"block_livedesk"},{key:"showhidediscarded",component:"block_livedesk"},{key:"showhidelocked",component:"block_livedesk"},{key:"configurations",component:"block_livedesk"},{key:"statistics",component:"block_livedesk"},{key:"managelivedesks",component:"block_livedesk"}]).done(function(e){a.strs=e,d.debug(JSON.stringify(a.strs)),d.debug(JSON.stringify(t)),d.debug("Start Livedesk construction"),a.menu=new dhtmlXMenuObject,a.menu.setIconsPath("pix/"),a.menu.setSkin("dhx_web"),a.menu.renderAsContextMenu(),a.menu.addNewChild(null,1,"reply_post",a.strs[0],!1,"reply_mail.png"),a.menu.addNewChild(null,2,"discard_post",a.strs[1],!1,"discard_mail.png"),a.menu.addNewChild(null,3,"discard_posts_before",a.strs[2],!1,"discard_mail.png"),a.menu.addNewChild(null,4,"send_email",a.strs[3],!1,"mail.png"),a.menu.attachEvent("onClick",a.onContextMenuClick),d.debug("Start Grid construction"),a.mygrid=new dhtmlXGridObject("livedesk-postsgrid"),a.mygrid.setImagePath("js/dhtmlx/3.0/dhtmlxGrid/codebase/imgs/");var e="#,,"+a.strs[4]+","+a.strs[5],e=(e+=","+a.strs[6]+","+a.strs[7]+","+a.strs[8],a.mygrid.setHeader(e),a.mygrid.setInitWidths("30,40,320,100,150,200,*"),a.mygrid.setColAlign("right,left,left,left,left,left,left"),a.mygrid.setColTypes("ro,ro,ro,ro,ro,ro,ro"),a.mygrid.setColSorting("int,str,str,str,str,str,str"),a.mygrid.init(),a.mygrid.setSkin("dhx_web"),a.mygrid.enableContextMenu(a.menu),d.debug("Loading posts"),o=n.wwwroot+"/blocks/livedesk/ajax/service.php?",o=(o+="action=load_liveentries&")+("bid="+a.params.bid),a.mygrid.load(o,"xml"),a.mygrid.attachEvent("onBeforeContextMenu",a.onBeforeContextMenuHandler),a.mygrid.attachEvent("onRowDblClicked",a.onRowDblClicked),a.mygrid.attachEvent("onBeforeContextMenu",a.onBeforeContextMenu),d.debug("Creating layout"),new dhtmlXLayoutObject("livedesk-masterlayout","4C")),e=(e.setSkin("dhx_web"),e.cells("a").setWidth("800"),e.cells("a").setHeight(800),e.cells("b").setWidth("250"),e.cells("c").setWidth("250"),e.cells("d").setWidth("250"),e.cells("b").setHeight("90"),e.cells("c").setHeight(130),e.cells("a").attachObject("livedesk-postsgrid"),e.cells("c").attachObject("livedesk-onlineuserscount"),e.cells("b").attachObject("livedesk-info"),e.cells("d").attachObject("livedesk-plugins"),e.cells("a").setText(a.strs[9]),e.cells("b").setText(a.strs[10]),e.cells("c").setText(a.strs[11]),e.cells("d").setText(a.strs[12]),d.debug("Creating toolbar"),e.attachToolbar()),s=(e.setIconsPath("pix/"),e.setSkin("dhx_web"),e.addButton("posts_refresh",2,a.strs[13],"refresh.png"),3);a.params.canviewsettings&&(e.addButton("settings",s,a.strs[19],"settings.png",null),s++),a.params.canviewstats&&(e.addButton("view_statistics",s,a.strs[20],"statistics.png",null),s++),a.params.canmanage&&(e.addButton("manage_livedesks",s,a.strs[21],"manage.png",null),s++),e.addButtonTwoState("show_answered",s,"","show_answered_on.png","show_answered_off.png"),s++,e.setItemToolTip("show_answered",a.strs[16]),a.params.show_answered?(e.setItemState("show_answered",!0),e.setItemImage("show_answered","show_answered_on.png")):(e.setItemState("show_answered",!1),e.setItemImage("show_answered","show_answered_off.png")),e.addButtonTwoState("show_discarded",s,"","show_discarded_on.png","show_discarded_off.png"),s++,e.setItemToolTip("show_discarded",a.strs[17]),a.params.show_discarded?(e.setItemState("show_discarded",!0),e.setItemImage("show_discarded","show_discarded_on.png")):(e.setItemState("show_discarded",!1),e.setItemImage("show_discarded","show_discarded_off.png")),e.addButtonTwoState("show_locked",s,"","show_locked_on.png","show_locked_off.png"),s++,e.setItemToolTip("show_locked",a.strs[18]),a.params.show_locked?(e.setItemState("show_locked",!0),e.setItemImage("show_locked","show_locked_on.png")):(e.setItemState("show_locked",!1),e.setItemImage("show_locked","show_locked_off.png")),e.attachEvent("onClick",a.toolbarClickHandler),e.attachEvent("onStateChange",a.toolbarStateChange),a.toolbar=e,a.getMonitoredPlugins(),a.refreshOnlineUsersCount(),0<a.params.refresh&&(d.debug("Installing livedesk updater"),setInterval(function(){a.refreshGrid(),a.refreshOnlineUsersCount()},a.params.refresh)),0<a.params.keepalive&&(d.debug("Installing livedesk keepalive signal"),setInterval(function(){a.keepMeAlive()},a.params.keepalive)),i(".noty_message").bind("click",function(){i(this).find(".noty_message_num").val()}),d.debug("Block Livedesk AMD initialized")})},onBeforeContextMenu:function(e){return a.selectedRow=e,!0},onContextMenuClick:function(e){switch(e){case"reply_post":return s=a.selectedRow,a.reply_post(s),!0;case"discard_post":a.discard_post(a.selectedRow);break;case"discard_posts_before":var s=a.mygrid.getUserData(a.selectedRow,"timecreated"),t=(a.dhxWins.createWindow("discard_messages",400,100,400,130),a.dhxWins.window("discard_messages").setModal(!0),n.wwwroot+"/blocks/livedesk/pix/discard_mail.png");a.dhxWins.window("discard_messages").setIcon(t),a.dhxWins.window("discard_messages").setText(a.strs[2]);t=(t=n.wwwroot+"/blocks/livedesk/discard_messages_before.php?")+("bid="+a.params.bid+"&")+("date="+s);return a.dhxWins.window("discard_messages").attachURL(t,!0),!0}},onBeforeContextMenuHandler:function(e){return 0==a.mygrid.getUserData(e,"status_id")?(a.menu.hideItem("disable_post"),a.menu.showItem("enable_post")):(a.menu.hideItem("enable_post"),a.menu.showItem("disable_post")),!0},toolbarClickHandler:function(e){var s;switch(e){case"posts_refresh":a.refreshGrid();break;case"view_statistics":var t=a.dhxWins.createWindow("view_statistics",400,100,850,400),o=(t.setModal(!0),n.wwwroot+"/blocks/livedesk/pix/statistics.png"),o=(t.setIcon(o),t.setText("Statistics"),n.wwwroot+"/blocks/livedesk/statistics.php?");return o+="bid="+a.params.bid,t.attachURL(o,!0),!0;case"settings":return s=n.wwwroot+"/course/view.php?",s=(s=(s+="id="+a.params.courseid)+("&bui_editid="+a.params.bid))+("&sesskey="+n.sesskey),window.location=s,!0;case"manage_livedesks":return s=n.wwwroot+"/blocks/livedesk/manage.php",window.location=s,!0}},toolbarStateChange:function(e,s){s?a.toolbar.setItemImage(e,e+"_on.png"):a.toolbar.setItemImage(e,e+"_off.png");var t=(t=(t=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=change_state&"+("item="+e+"&"))+("state="+s+"&")+("bid="+a.params.bid);return i.post(t,function(){}),a.refreshGrid(),!0},refreshGrid:function(){var e=(e=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=load_liveentries&"+("bid="+a.params.bid);return _isIE?a.mygrid.clearAndLoad(e,"xml"):i.post(e,function(e){a.mygrid.clearAll(),a.mygrid.parse(e)}),!0},onRowDblClicked:function(e){a.reply_post(e)},reply_post:function(e){var s=a.mygrid.getUserData(e,"itemid"),t=a.mygrid.getUserData(e,"messageid"),o=a.mygrid.getUserData(e,"cmid"),i=Math.floor(101*Math.random())+350,n=Math.floor(101*Math.random())+50,e=a.dhxWins.createWindow("reply_post"+e,i,n,800,450);e.messageid=t,e.closing=!1,e.setModal(!1),e.setText("Reply"),e.attachURL("reply.php?reply="+s+"&cmid="+o,!1),a.dhxWins.attachEvent("onClose",a.unlockItem)},generateNoty:function(e,s){return noty({text:e,timeout:5e3,closeWith:["button"],type:s,dismissQueue:!0,layout:"bottomRight",theme:"defaultTheme"})},refreshOnlineUsersCount:function(){var e=(e=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=get_online_users_count&"+("bid="+a.params.bid);i.post(e,function(e){e=JSON.parse(e);var s='<div class="online_users">',s=(s+='<img src="pix/user.png" /> ')+(a.strs[14]+" : "+e.users_count)+"</div>";if(i("#livedesk-onlineuserscont").html(s),s='<div class="online_users">',s=(s+='<img src="pix/user-black.png" /> ')+(a.strs[15]+" : "+e.attenders_count)+"</div>",i("#livedesk-onlineuserscount").append(s),0<e.attenders_count){for(var t='<ul class="livedesk-userlist">',o=0;o<e.attenders.length;o++)t=(t+='<li class="online_users '+e.attenders[o].className+'">')+e.attenders[o].name+"</li>";i("#livedesk-onlineuserscount").append(t+"</ul>")}})},keepMeAlive:function(){var e=(e=(e=(e=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=keep_me_live&"+("bid="+a.params.bid+"&"))+("livedeskid="+a.params.livedeskid+"&"))+("courseid="+a.params.courseid);i.post(e,function(e){i("#livedesk-onlineuserscount").html(a.strs[11]+e)})},getMonitoredPlugins:function(){var e=(e=(e=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=get_monitored_plugins&"+("livedeskid="+a.params.livedeskid+"&"))+("bid="+a.params.bid);i.post(e,function(e){e=JSON.parse(e),i("#livedesk-plugins").html("");var s,t=n.wwwroot+"/blocks/livedesk/pix/block.png";for(s in e){var o='<div class="online_users">';o=(o=(o=(o+='<img src="'+t+'" />')+('<a target="_blank" href="'+(n.wwwroot+"/mod/forum/view.php?id="+e[s].cmid)+'" > '))+e[s].name)+"</a>"+"</div>",i("#livedesk-plugins").append(o)}})},unlockItem:function(e){var s;return e.closing||(e.closing=!0,s=(s=(s=(s=(s=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=unlock_item&bid="+a.params.bid+"&")+"livedeskid="+a.params.livedeskid+"&")+"courseid="+a.params.courseid+"&")+"messageid="+e.messageid,i.post(s,function(){a.refreshGrid()})),!0},discard_post:function(){var e=a.mygrid.getUserData(a.selectedRow,"messageid"),s=(s=(s=(s=n.wwwroot+"/blocks/livedesk/ajax/service.php?")+"action=discard_post&"+("bid="+a.params.bid+"&"))+("livedeskid="+a.params.livedeskid+"&"))+("courseid="+a.params.courseid+"&");i.post(s+="messageid="+e,function(){a.refreshGrid()})}};return a});