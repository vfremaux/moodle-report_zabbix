define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui","core/modal_factory","core/modal_events","core/key_codes"],function(m,a,s,I,c,e,r,n,d,u){function l(t){var n;return r.use("moodle-course-util",function(e){n=e.Moodle.core_course.util.cm.getId(e.Node(t.get(0)))}),n}function f(e){return e.addClass(v.EDITINPROGRESS),(e=e.find(g.ACTIONAREA).get(0))?((e=M.util.add_spinner(r,r.Node(e))).show(),e):null}function o(e){return(e=M.util.add_lightbox(r,r.Node(e.get(0)))).show(),e}function h(e,t,n){window.setTimeout(function(){e.removeClass(v.EDITINPROGRESS),t&&t.hide()},n)}function p(e,t){e&&window.setTimeout(function(){e.hide()},t)}function N(r,e,t){var c,s=t.attr("data-keepopen"),d=t.attr("data-action"),u=f(r),e=a.call([{methodname:"core_course_edit_module",args:{id:e,action:d,sectionreturn:t.attr("data-sectionreturn")?t.attr("data-sectionreturn"):0}}],!0);"duplicate"===d&&(c=o(t.closest(g.SECTIONLI))),m.when.apply(m,e).done(function(e){t=r,n=m("a:visible"),o=!1,i=null,n.each(function(){if(m.contains(t[0],this))o=!0;else if(o)return i=this,!1});var t,n,o,i,a=i;r.replaceWith(e),m("<div>"+e+"</div>").find(g.ACTIVITYLI).each(function(e){var t;_(m(this).attr("id"),s),0===e&&(e=m(this).attr("id"),t=d,e=m("#"+e),t="groupsseparate"!==t&&"groupsvisible"!==t&&"groupsnone"!==t?"[data-action="+t+"]":"[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]",(e.find(t).is(":visible")?e.find(t):e.find(g.MENU).find(g.TOGGLE)).focus(),a=null)}),a&&a.focus(),h(r,u,400),p(c,400),r.trigger(m.Event("coursemoduleedited",{ajaxreturn:e,action:d}))}).fail(function(e){h(r,u),p(c);var t=m.Event("coursemoduleeditfailed",{exception:e,action:d});r.trigger(t),t.isDefaultPrevented()||I.exception(e)})}function E(e,t){var n,o,i=e.attr("class").match(/modtype_([^\s]*)/)[1],a=(n=e,r.use("moodle-course-util",function(e){o=e.Moodle.core_course.util.cm.getName(e.Node(n.get(0)))}),o);c.get_string("pluginname",i).done(function(e){c.get_strings([{key:"confirm"},{key:null===a?"deletechecktype":"deletechecktypename",param:{type:e,name:a}},{key:"yes"},{key:"no"}]).done(function(e){I.confirm(e[0],e[1],e[2],e[3],t)})})}function C(c,e,s,d){var u=s.attr("data-action"),t=s.attr("data-sectionreturn")?s.attr("data-sectionreturn"):0,l=((n=c).addClass(v.EDITINPROGRESS),(n=n.find(g.SECTIONACTIONMENU).get(0))?((n=M.util.add_spinner(r,r.Node(n))).show(),n):null),n=a.call([{methodname:"core_course_edit_section",args:{id:e,action:u,sectionreturn:t}}],!0),f=o(c);m.when.apply(m,n).done(function(e){var e=m.parseJSON(e),t=(h(c,l),p(f),c.find(g.SECTIONACTIONMENU).find(g.TOGGLE).focus(),m.Event("coursesectionedited",{ajaxreturn:e,action:u}));if(c.trigger(t),!t.isDefaultPrevented()){var n,t=c,o=s,i=e,e=d,a=o.attr("data-action");if("hide"===a||"show"===a){if("hide"===a?(t.addClass("hidden"),T(o,"i/show","showfromothers","format_"+e,null,null,"show")):(t.removeClass("hidden"),T(o,"i/hide","hidefromothers","format_"+e,null,null,"hide")),void 0!==i.modules)for(var r in i.modules)y(i.modules[r]);void 0!==i.section_availability&&t.find(".section_availability").first().replaceWith(i.section_availability)}else"setmarker"===a?(n=(e=m(g.SECTIONLI+".current")).find(g.SECTIONACTIONMENU+" a[data-action=removemarker]"),e.removeClass("current"),T(n,"i/marker","highlight","core","markthistopic","core","setmarker"),t.addClass("current"),T(o,"i/marked","highlightoff","core","markedthistopic","core","removemarker")):"removemarker"===a&&(t.removeClass("current"),T(o,"i/marker","highlight","core","markthistopic","core","setmarker"))}}).fail(function(e){h(c,l),p(f);var t=m.Event("coursesectioneditfailed",{exception:e,action:u});c.trigger(t),t.isDefaultPrevented()||I.exception(e)})}var v={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},g={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display,.dropdown-toggle",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",ADDSECTIONS:"#changenumsections [data-add-sections]"},_=(r.use("moodle-course-coursebase",function(){var e=M.course.format.get_section_selector();e&&(g.SECTIONLI=e)}),function(e,t){r.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+e)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(r.one("#"+e)),!t||(t=r.one("#"+e+" "+g.MENU).one(g.TOGGLE))&&t.simulate&&t.simulate("click")}),T=function(n,o,e,t,i,a,r){e=[{key:e,component:t}];return i&&e.push({key:i,component:a}),c.get_strings(e).then(function(e){n.find("span.menu-action-text").html(e[0]),n.attr("title",e[0]);var t="";return i&&(t=e[1],n.attr("title",t)),s.renderPix(o,"core",t)}).then(function(e){n.find(".icon").replaceWith(e),n.attr("data-action",r)}).catch(I.exception)},y=function(t){m("<div>"+t+"</div>").find(g.ACTIVITYLI).each(function(){var e=m(this).attr("id");m(g.ACTIVITYLI+"#"+e).replaceWith(t),_(e,!1)})};return r.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(e){var t,n,o,e=m(e.element.getDOMNode()),i=l(e);i&&(n=e.find("."+v.EDITINGMOVE).attr("data-sectionreturn"),i=i,n=n,o=f(t=e),i=a.call([{methodname:"core_course_get_module",args:{id:i,sectionreturn:n}}],!0),m.when.apply(m,i).done(function(e){h(t,o,400),y(e)}).fail(function(){h(t,o)}))}})}),{initCoursePage:function(r){m("body").on("click keypress",g.ACTIVITYLI+" "+g.ACTIVITYACTION+"[data-action]",function(e){if("keypress"!==e.type||13===e.keyCode){var t=m(this),n=t.closest(g.ACTIVITYLI),o=t.attr("data-action"),i=l(n);switch(o){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}i&&(e.preventDefault(),"delete"===o?E(n,function(){N(n,i,t)}):N(n,i,t))}}),m("body").on("click keypress",g.SECTIONLI+" "+g.SECTIONACTIONMENU+"[data-sectionid] a[data-action]",function(e){var t,n,o,i,a;"keypress"===e.type&&13!==e.keyCode||(t=m(this),n=t.closest(g.SECTIONLI),o=t.closest(g.SECTIONACTIONMENU).attr("data-sectionid"),e.preventDefault(),t.attr("data-confirm")?(i=t.attr("data-confirm"),a=function(){C(n,o,t,r)},c.get_strings([{key:"confirm"},{key:"yes"},{key:"no"}]).done(function(e){I.confirm(e[0],i,e[1],e[2],a)})):C(n,o,t,r))}),c.get_string("numberweeks").done(function(e){var o=m(g.ADDSECTIONS),i=o.attr("data-add-sections"),t=o.attr("new-sections"),t=m('<div><label for="add_section_numsections"></label> <input id="add_section_numsections" type="number" min="1" max="'+t+'" value="1"></div>');t.find("label").html(e),n.create({title:i,type:n.types.SAVE_CANCEL,body:t.html()},o).done(function(e){function t(){""+parseInt(n.val())===n.val()&&1<=parseInt(n.val())&&(document.location=o.attr("href")+"&numsections="+parseInt(n.val()))}var n=m(e.getBody()).find("#add_section_numsections");e.setSaveButtonText(i),e.getRoot().on(d.shown,function(){n.focus().select().on("keydown",function(e){e.keyCode===u.enter&&t()})}),e.getRoot().on(d.save,function(e){e.preventDefault(),t()})})})},replaceSectionActionItem:function(e,t,n,o,i,a,r,c){e=e.find(g.SECTIONACTIONMENU+" "+t);T(e,n,o,i,a,r,c)}}});